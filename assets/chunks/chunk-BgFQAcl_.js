import{oS as O,af as a,ag as o,oT as k,gz as L,ai as T,aG as $,dW as I,aM as P,oU as v,gj as N,oV as S,v as F,oW as U,aL as w,f$ as b,gv as E,oX as D,oY as x,oZ as V,o_ as q,o$ as W,p0 as j,p1 as f,p2 as Q,p3 as G,p4 as y,gk as R,dA as A,g9 as _,p5 as B,j as C}from"./chunk-CuaFhuP3.js";import"./chunk-Dpk1TJd9.js";import{e as H}from"./chunk-iL5WjyEH.js";import{E as M}from"./chunk-B4mRqufT.js";import{e as z}from"./chunk-BqZ3Zt75.js";function Z(h,i){if(i.type!=="feature"&&i.type!=="subtype-group")return[];if(!i.url)return[];const t="utilityNetworks"in h.map?h.map.utilityNetworks??[]:[];for(const e of t)if(e.isUtilityLayer(i)){const r=i.fieldsIndex.get("assetgroup"),n=i.fieldsIndex.get("assettype");return[r?.name,n?.name].filter((u=>u!=null))}return[]}class J{constructor(i){this._fieldsIndex=i,this._clauses=[]}async finish(){return{requiresCurrentUser:(await Promise.all(this._clauses)).some((i=>i.currentUserRequired))}}visitClientWhereClause(i){i&&this._clauses.push(O(i,this._fieldsIndex))}visitFeatureReduction(i){if(i)switch(i.type){case"binning":case"cluster":this.visitLabelingInfo(i.labelsVisible,i.labelingInfo)}}visitLabelingInfo(i,t){if(i&&t!=null)for(const e of t)this.visitClientWhereClause(e.where)}visitDisplayFilter(i,t){if(i)for(const e of t?.filters??[])this.visitClientWhereClause(e.where)}visitFilter(i){this.visitClientWhereClause(i?.where)}visitTrackInfo(i){i!=null&&(this.visitLabelingInfo(i?.latestObservations.labelsVisible,i?.latestObservations.labelingInfo),this.visitLabelingInfo(i?.previousObservations.labelsVisible,i?.previousObservations.labelingInfo),this.visitLabelingInfo(i?.trackLines.labelsVisible,i?.trackLines.labelingInfo))}}const ie=h=>{let i=class extends h{constructor(...t){super(...t),this._updatingRequiredPromise=null,this.filter=null,this.layer=null,this.requiresCurrentUser=!1,this.requiredFields=[],this.view=null}initialize(){this.addHandles([$((()=>{const t=this.layer,e=this.view;return[t&&"elevationInfo"in t?t.elevationInfo?.featureExpressionInfo:null,t&&"displayField"in t?t.displayField:null,t&&"timeInfo"in t&&t.timeInfo,t&&"renderer"in t&&t.renderer,t&&"labelingInfo"in t&&t.labelingInfo,t&&"floorInfo"in t&&t.floorInfo,e?.requiredFieldsOptions?.featureTitleFields&&t&&"featureTitleFields"in t&&t.featureTitleFields,e?.requiredFieldsOptions?.utilityNetworkFields&&Z(e,t),t.displayFilterInfo,this.displayFilterEnabled,this.filter,this.featureEffect,this.timeExtent,t?.type==="knowledge-graph-sublayer"&&t.parentCompositeLayer.type==="link-chart"&&t.parentCompositeLayer.linkChart?.linkChartProperties.nonspatialDataDisplay?.mode,t?.type==="parquet"&&t.popupTemplate]}),(()=>this._handleChange()),P),I((()=>this.view?.floors),"change",(()=>this._handleChange())),I((()=>this.layer.displayFilterInfo?.filters),"change",(()=>this._handleChange())),I((()=>this.layer&&"sublayers"in this.layer?this.layer.sublayers:null),"change",(()=>this._handleChange()))])}get availableFields(){if(!this.layer)return[];const{layer:t,layer:{fieldsIndex:e},requiredFields:r}=this;return"outFields"in t&&t.outFields?v(e,[...N(e,t.outFields),...r]):v(e,r)}get displayFilterEnabled(){return(this.view?.displayFilterEnabled??!0)&&(!("displayFilterEnabled"in this.layer)||(this.layer?.displayFilterEnabled??!0))}get effectiveDisplayFilter(){const t=this.layer;return this.displayFilterEnabled&&t.displayFilterInfo?S(t.displayFilterInfo,this.view):null}get featureEffect(){return this.layer&&"featureEffect"in this.layer?this.layer.featureEffect:null}set featureEffect(t){this._override("featureEffect",t)}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(t){F.getLogger(this).error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported")}get maximumNumberOfFeaturesExceeded(){return!1}get signedInUser(){return this.layer?.url?U(this.layer.url):Promise.resolve(null)}highlight(t,e){throw new Error("missing implementation")}createQuery(){const t={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},e=this.filter!=null?this.filter.createQuery(t):new w(t);return"floorInfo"in this.layer&&this.layer.floorInfo&&(e.where=b(e.where,E(this))),this.displayFilterEnabled&&(e.where=b(e.where,this.effectiveDisplayFilter?.where)),this.timeExtent!=null&&(e.timeExtent=e.timeExtent!=null?e.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),e}createAggregateQuery(){const t={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference};return new w(t)}queryFeatures(t,e){throw new Error("missing implementation")}queryObjectIds(t,e){throw new Error("missing implementation")}queryFeatureCount(t,e){throw new Error("missing implementation")}queryExtent(t,e){throw new Error("missing implementation")}async fetchPopupFeaturesFromGraphics(t,e){const r=await this._createPopupQuery(t.map((n=>n.origin?.layer??n.layer)),e);return await D(this.layer,t,r,{getPopupTemplate:n=>n&&"popupEnabled"in n&&n.popupEnabled?_(n,e):null,hasRequiredFields:(n,u)=>this._popupFeatureHasRequiredFields(n,u),...e})}_handleChange(){const t=Promise.all([this._updateRequiredFields(),this._updateClientWhereClauseRequirements()]).then((()=>{}));return this._set("_updatingRequiredPromise",t),t.then((()=>{this._updatingRequiredPromise===t&&this._set("_updatingRequiredPromise",null)})),t}async _updateClientWhereClauseRequirements(){if(!this.layer||!this.view)return;const{layer:t}=this,e=new J(t.fieldsIndex);if(e.visitFilter(this.filter),"featureReduction"in t&&e.visitFeatureReduction(t.featureReduction),"labelingInfo"in t&&e.visitLabelingInfo(t.labelsVisible,t.labelingInfo),"trackInfo"in t&&e.visitTrackInfo(t.trackInfo),this.view.type==="2d"&&(e.visitFilter(this.featureEffect?.filter),e.visitDisplayFilter(this.displayFilterEnabled,t.displayFilterInfo),"featureReduction"in t&&e.visitFeatureReduction(t.featureReduction)),t.type==="subtype-group")for(const r of t.sublayers)e.visitLabelingInfo(r.labelsVisible,r.labelingInfo);try{const r=await e.finish();this._set("requiresCurrentUser",r.requiresCurrentUser)}catch(r){F.getLogger(this).error(r)}}async _updateRequiredFields(){if(!this.layer||!this.view)return;const t=this.view.type==="3d",{layer:e,layer:{fieldsIndex:r}}=this,n="renderer"in e&&e.renderer,u="orderBy"in e&&e.orderBy,c="featureReduction"in e?e.featureReduction:null,s=new Set,d=[n?n.collectRequiredFields(s,r):null,x(s,e),t&&"elevationInfo"in e?V(s,e):null,this.filter!=null?q(s,e,this.filter):null,t||this.featureEffect==null?null:q(s,e,this.featureEffect.filter),!t&&c?W(s,e,c):null,!t&&u?j(s,e,u):null];if("timeInfo"in e&&e.timeInfo&&this.timeExtent&&f(s,e.fieldsIndex,[e.timeInfo.startField,e.timeInfo.endField]),"timeInfo"in e&&e.timeInfo&&"trackInfo"in e&&e.trackInfo){const{trackInfo:l}=e;f(s,e.fieldsIndex,[e.timeInfo.trackIdField]),e.type!=="feature"&&l.timeField!=="startTimeField"||f(s,e.fieldsIndex,[e.timeInfo.startField]),l.timeField==="endTimeField"&&f(s,e.fieldsIndex,[e.timeInfo.endField]),await Q(s,e)}if("floorInfo"in e&&e.floorInfo&&f(s,e.fieldsIndex,[e.floorInfo.floorField]),"featureTitleFields"in e&&this.view?.requiredFieldsOptions?.featureTitleFields&&e.featureTitleFields&&f(s,e.fieldsIndex,e.featureTitleFields),e.type==="feature"&&e.globalIdField&&this.view?.requiredFieldsOptions?.globalIdField&&f(s,e.fieldsIndex,[e.globalIdField]),this.displayFilterEnabled&&d.push(G(s,e,e.displayFilterInfo)),e.type==="feature"&&t&&e.infoFor3D!=null&&(e.globalIdField==null&&F.getLogger(this).error("globalIdField missing on 3DObjectFeatureLayer"),f(s,e.fieldsIndex,[e.globalIdField])),e.type==="subtype-group"){y(s,r,e.subtypeField);const l=e.sublayers.map((p=>Promise.all([p.renderer?.collectRequiredFields(s,r),x(s,p)])));d.push(Promise.all(l))}if(e.type==="catalog-footprint"&&e.parent){const l=e.parent;f(s,r,[l.itemNameField,l.itemSourceField,l.itemTypeField,l.maxScaleField,l.minScaleField])}e.type==="knowledge-graph-sublayer"&&e.parentCompositeLayer.type==="link-chart"&&y(s,r,M),e.type==="parquet"&&d.push(R(e,e.popupTemplate).then((l=>{for(const p of l)s.add(p)})));const m=await Promise.allSettled(d);if(t)y(s,r,e.objectIdField);else for(const l of H(z(e)))y(s,r,l);t&&"displayField"in e&&e.displayField&&y(s,r,e.displayField);for(const l of m)l.status==="rejected"&&F.getLogger(this).error(l.reason);const g=Array.from(s).sort();this._set("requiredFields",g)}_popupFeatureHasRequiredFields(t,e){return A(t,e)}async _createPopupQuery(t,e){const r=this.layer.createQuery(),n=new Set;let u=!1;const c=t??[this.layer];for(const s of c){if(!("popupEnabled"in s))continue;const d=_(s,e);if(d==null)continue;const m=await B(d);C(e);const g=m&&m.arcadeUtils.hasGeometryOperations(d);u=!(this.layer.geometryType!=="point"&&!g);const l=await R(this.layer,d);C(e);for(const p of l)n.add(p)}return r.returnGeometry=u,r.returnZ=u,r.returnM=u,r.outFields=Array.from(n),r.outSpatialReference=this.view.spatialReference,"floorInfo"in this.layer&&this.layer.floorInfo&&(r.where=b(r.where,E(this))),r}canResume(){return!!super.canResume()&&(this.timeExtent==null||!this.timeExtent.isEmpty)}getTest(){}get test(){}};return a([o()],i.prototype,"_updatingRequiredPromise",void 0),a([o({readOnly:!0})],i.prototype,"availableFields",null),a([o({readOnly:!0})],i.prototype,"displayFilterEnabled",null),a([o({readOnly:!0})],i.prototype,"effectiveDisplayFilter",null),a([o({type:k})],i.prototype,"featureEffect",null),a([o({type:L})],i.prototype,"filter",void 0),a([o()],i.prototype,"layer",void 0),a([o({type:Number})],i.prototype,"maximumNumberOfFeatures",null),a([o({readOnly:!0,type:Boolean})],i.prototype,"maximumNumberOfFeaturesExceeded",null),a([o()],i.prototype,"requiresCurrentUser",void 0),a([o({readOnly:!0})],i.prototype,"requiredFields",void 0),a([o({readOnly:!0})],i.prototype,"signedInUser",null),a([o()],i.prototype,"suspended",void 0),a([o()],i.prototype,"view",void 0),i=a([T("esri.views.layers.FeatureLayerView")],i),i};export{ie as S};
