import{h as B,b as S,d as L,aU as j,aV as O,aW as K,aX as z,c as N,o as P,w as J,r as W,T as X,u as U}from"./chunk-DdHotv1K.js";import{T as G,n as H}from"./chunk-Ci1O_Xdl.js";let F=0;class Q{constructor(t){this.requestingMap=S({}),this.request=(a,i,r)=>{const{request:c}=this.config,{onUpdate:g,onSuccess:m,onError:d,onStream:q}=i,p=F;F+=1,this.requestingMap.value[p]=!0,c?.(a,{onStream:o=>{this.requestingMap.value[p]&&q?.(o)},onUpdate:o=>{this.requestingMap.value[p]&&g(o)},onSuccess:o=>{this.requestingMap.value[p]&&(m(o),this.finishRequest(p))},onError:o=>{this.requestingMap.value[p]&&(d(o),this.finishRequest(p))}},r)},this.config=t}finishRequest(t){delete this.requestingMap.value[t]}isRequesting(){return Object.keys(this.requestingMap.value).length>0}}function Y(e){const{request:t,...a}=e;return[B(()=>new Q({request:t||G({baseURL:a.baseURL,model:a.model,dangerouslyApiKey:a.dangerouslyApiKey}).create,...a}))]}function Z(e,t){const a=S(e);function i(r){const c=typeof r=="function"?r(a.value):r;c!==a.value&&t(c,a.value),a.value=c}return[a,i]}function ee(e){return Array.isArray(e)?e:[e]}function te(e){const{defaultMessages:t,agent:a,requestFallback:i,requestPlaceholder:r,parser:c,transformMessage:g,transformStream:m,resolveAbortController:d}=e,q=S(0),p=B(()=>(t||[]).map((n,s)=>({id:`default_${s}`,status:"local",...n}))),[o,f]=Z(p.value,()=>{}),v=(n,s)=>{const A={id:`msg_${q.value}`,message:n,status:s};return q.value+=1,A},b=B(()=>{const n=[];return o.value.forEach(s=>{const A=c?c(s.message):s.message,E=ee(A);E.forEach((w,T)=>{let u=s.id;E.length>1&&(u=`${u}_${T}`),n.push({id:u,message:w,status:s.status})})}),n}),y=n=>n.filter(s=>s.status!=="loading"&&s.status!=="error").map(s=>s.message),k=()=>y(o.value),M=n=>typeof g=="function"?g(n):n.currentMessage;return{onRequest:H(n=>{if(!a)throw new Error("The agent parameter is required when using the onRequest method in an agent generated by useXAgent.");let s=null,A,E={};if(typeof n=="object"&&n!=null&&n.message){const{message:u,...l}=n;A=u,E=l}else A=n;f(u=>{let l=[...u,v(A,"local")];if(r){let h;typeof r=="function"?h=r(A,{messages:y(l)}):h=r;const _=v(h,"loading");s=_.id,l=[...l,_]}return l});let w=null;const T=(u,l)=>{let h=o.value.find(_=>_.id===w);return h?f(_=>_.map(C=>{if(C.id===w){const V=M({originMessage:C.message,currentMessage:u,status:l});return{...C,message:V,status:l}}return C})):(M({currentMessage:u,status:l}),h=v(u,l),f(_=>[..._.filter(C=>C.id!==s),h]),w=h.id),h};a.request({message:A,messages:k(),...E},{onUpdate:u=>{T(u,"loading")},onSuccess:u=>{T(u,"success")},onError:async u=>{if(i){let l;typeof i=="function"?l=await i(A,{error:u,messages:k()}):l=i,f(h=>[...h.filter(_=>_.id!==s&&_.id!==w),v(l,"error")])}else f(l=>l.filter(h=>h.id!==s&&h.id!==w))},onStream:u=>{d?.(u)}},m)}),messages:o,parsedMessages:b,setMessages:f}}async function ne(e,t){return j.reader({url:"/application/chat_message/231593fc-1b84-11f0-9ed6-10ffe00db574",onmessage:e},{headers:{authorization:"application-18a5cf747c3dfc2689cb4b5880c2db02"},data:t})}var R=(e=>(e.User="user",e.Assistant="assistant",e.Broadcasting="broadcasting",e))(R||{});const se=[{label:"用户",value:"user",isMarkdown:!1,placement:"end",templateType:"Typewriter"},{label:"AI 助手",value:"assistant",isMarkdown:!0,placement:"start",typing:!0,templateType:"Typewriter"},{label:"播报",value:"broadcasting",placement:"start",templateType:"VkBroadcastingMarkdown"}],ae=se.reduce((e,t)=>(e[t.value]=t,e),{}),D="vk_agent_chat_inject_key";function re(e){return Y({request:e})}function oe(e,t){const[a]=re(e),i=te({agent:a.value,parser:t}),r=d=>{i.onRequest({role:R.User,content:d})},c=B(()=>i.parsedMessages.value.map(d=>({key:d.id,...ae[d.message.role],...d.message}))),m={agent:a,chat:i,simplicity:{onRequest:r,items:c}};return K(D,m),m}function he(){const e=O(D,null);if(!e)throw new Error("useAgentChat must be used within a provider");return e}var $=L({name:"VkAgentChatProvider",props:{request:{type:Function},parser:{type:Function}},emits:{load:e=>e},setup(e,{slots:t,emit:a}){const i=(g,m)=>{const{message:d}=g,{onSuccess:q,onUpdate:p}=m;if(!d?.content)return;let o="";const f=R.Broadcasting;let v="",b="start",y=!0;const k=()=>{p({role:f,content:o,thinkingContent:v,thinkingStatus:b,seviceLoading:y})},M=()=>{q({role:f,content:o,thinkingContent:v,thinkingStatus:b,seviceLoading:y,seviceEnd:!0})};k(),ne(n=>{let s={content:"",reasoning_content:""};if(typeof n.data=="string"&&(s=JSON.parse(n.data)),s.is_end){M();return}s.reasoning_content&&(v+=s.reasoning_content,b="thinking",y=!1,k()),s.content&&(o+=s.content,y=!1,k()),v&&s.content&&(b="end",k())},{message:d?.content})},r=g=>{const m=[{...g,loading:g.seviceLoading}];return g.thinkingContent&&m.unshift({role:R.Broadcasting,content:"您好，请让我先思考一下这个问题，再给您回答",seviceLoading:!1,seviceEnd:!0,loading:!1,meta:{metahumanStatus:2}}),m},c=oe(e.request??i,e.parser??r);return a("load",c),t.default}});$.install=e=>{e.component($.name||"VkAgentChatProvider",$)};var I=(e=>(e.User="user",e.Assistant="assistant",e))(I||{});const ue=[{label:"用户",value:"user",isMarkdown:!1,placement:"end",templateType:"Typewriter"},{label:"助手",value:"assistant",placement:"start",templateType:"VkMarkdown"}],ie=ue.reduce((e,t)=>(e[t.value]=t,e),{}),ce="1284bf40-44d3-11f0-b87e-e2bb3033b0f6",x="application-75e669f4809759ce384605945f907cf8";async function le(e){return z({method:"GET",url:`/application/${e.application_id}/chat/open`,headers:{authorization:x}}).then(t=>t.data)}async function de(e,t,a){return j.reader({url:`/application/chat_message/${t.chatId}`,onmessage:e,abortController:a},{headers:{authorization:x},data:{message:t.message}})}function pe(){const e=S(""),t=S(!1);return le({application_id:ce}).then(r=>{e.value=r,t.value=!0}),{request:(r,c)=>{const{message:g}=r,{onSuccess:m,onUpdate:d}=c;if(!g?.content)return;const q=new AbortController;let p="";const o=I.Assistant;let f="",v="start",b=!0;const y=()=>{d({role:o,content:p,thinkingContent:f,thinkingStatus:v,seviceLoading:b,abortController:q})},k=()=>{m({role:o,content:p,thinkingContent:f,thinkingStatus:"end",seviceLoading:!1,seviceEnd:!0,abortController:q})};y(),de(M=>{let n={content:"",reasoning_content:""};if(typeof M.data=="string"&&(n=JSON.parse(M.data)),n.is_end){k();return}n.reasoning_content&&(f+=n.reasoning_content,v="thinking",b=!1,y()),n.content&&(p+=n.content,b=!1,y()),f&&n.content&&(v="end",y())},{message:g?.content,chatId:e.value},q).catch(()=>{k()})},parser:r=>[{...r,...ie[r.role],loading:r.seviceLoading}],ready:t}}const me=L({__name:"index",setup(e){const{ready:t,request:a,parser:i}=pe();return(r,c)=>(P(),N(U($),{parser:U(i),request:U(a)},{default:J(()=>[U(t)?W(r.$slots,"default",{key:0}):X("",!0)]),_:3},8,["parser","request"]))}});export{me as _,he as u};
