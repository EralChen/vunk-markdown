import{as as D,aj as s,ak as o,am as E,ba as m,y as N,mS as ot,fI as Gt,zk as Ft,h as jt,zl as Ut,cX as Bt,cY as rt,cS as Nt,cU as Wt,cV as qt,a3 as Rt,zm as Jt,zn as pt,c_ as Q,eT as at,wd as Zt,cq as C,gC as lt,bc as G,bb as F,cs as St,co as $t,b3 as At,aq as ct,b_ as ht,my as X,b$ as W,cr as B,zi as k,A as tt,ti as gt,bT as q,eY as J,ar as P,aO as Et,bY as ut,gg as Yt,c1 as Kt,e3 as Qt,zo as Xt,uL as te,eR as ee,zp as vt,zq as ie,ek as mt,au as v,zc as ne,zr as se,zs as x,kO as Ht,aK as oe,cu as re,dd as ae,aQ as le,aD as R,cv as ue,zt as et,o8 as _t,bk as yt,zu as de,wV as ce,jh as pe,nu as S,V as he}from"./chunk-XGpVqsM_.js";import{o as ge,s as ve,m as me,f as _e,d as ye}from"./chunk-BQX0bexy.js";import{m as be,d as bt}from"./chunk-CRnD7zvj.js";import{t as ft,e as Mt,f as Dt,a as kt,d as it}from"./chunk-CPywTGCC.js";import{u as Ct,l as wt}from"./chunk-UGnQnI4w.js";import{r as zt}from"./chunk-B22oev-Y.js";import{c as fe}from"./chunk-BmWCw_dr.js";import{p as Ot}from"./chunk-Qdx-kEuS.js";import{S as Tt}from"./chunk-DfQdlTo5.js";import"./chunk-DyqHK6XP.js";import"./chunk-Dix477Sg.js";/* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              */import"./chunk-CrMA_peF.js";import"./chunk-FFoKj2y0.js";import"./chunk-B_0s3AtF.js";import"./chunk-C2sPCKi2.js";import"./chunk-DTv8BWs_.js";import"./chunk-BaoKPrO7.js";let $=class extends D{constructor(e){super(e),this.target=null,this.intersectedGraphic=null,this.intersectedLocation=null,this.elevationAlignedTargetLocation=null,this.visible=void 0}};s([o()],$.prototype,"target",void 0),s([o()],$.prototype,"intersectedGraphic",void 0),s([o()],$.prototype,"intersectedLocation",void 0),s([o()],$.prototype,"elevationAlignedTargetLocation",void 0),s([o({type:Boolean})],$.prototype,"visible",void 0),$=s([E("esri.views.3d.analysis.LineOfSightAnalysisResult")],$);let A=class extends D{constructor(e){super(e),this.elevationAlignedTargetLocation=null,this.inputPoints={isValid:!1,observer:m(),observerSurfaceNormal:null,observerFeatureId:null,target:m(),targetSurfaceNormal:null,targetFeatureId:null,observerAdjusted:m(),targetAdjusted:m()},this.computationResult={start:m(),end:m(),intersection:m(),isValid:!1,isTargetVisible:!1},this.result=null}notifyResultChanged(){this.notifyChange("computationResult")}notifyInputPointsChanged(){this.notifyChange("inputPoints")}};s([o()],A.prototype,"target",void 0),s([o()],A.prototype,"elevationAlignedTargetLocation",void 0),s([o()],A.prototype,"inputPoints",void 0),s([o()],A.prototype,"computationResult",void 0),s([o()],A.prototype,"result",void 0),A=s([E("esri.views.3d.analysis.LineOfSight.LineOfSightComputation")],A);var dt;let I=dt=class extends D{constructor(t){super(t)}clone(){return new dt({type:this.type,id:N(this.id),mapPoint:N(this.mapPoint),renderPoint:ot(this.renderPoint),normal:N(this.normal),ray:N(this.ray),graphic:this.graphic})}equals(t){return this.type===t.type&&this.id===t.id&&Gt(this.mapPoint,t.mapPoint)&&Ft(this.renderPoint,t.renderPoint)&&jt(this.normal,t.normal)&&Ut(this.ray,t.ray)&&this.graphic===t.graphic}};s([o()],I.prototype,"type",void 0),s([o({constructOnly:!0})],I.prototype,"id",void 0),s([o({constructOnly:!0})],I.prototype,"mapPoint",void 0),s([o({constructOnly:!0})],I.prototype,"renderPoint",void 0),s([o({constructOnly:!0})],I.prototype,"normal",void 0),s([o({constructOnly:!0})],I.prototype,"graphic",void 0),s([o({constructOnly:!0})],I.prototype,"ray",void 0),I=dt=s([E("esri.views.3d.analysis.LineOfSight.LineOfSightIntersectionResult")],I);let z=class extends D{constructor(e){super(e),this._terrainIntersectionOptionsLayerUids=new Set(["terrain"])}initialize(){this.intersector=new Bt(this.view.state.viewingMode),this.intersector.options.hud=!1,this.intersector.options.store=rt.MIN}getScreenPointIntersection(e){const i=Nt(e,Wt.get()),n=qt(this.view.state.camera,i,nt);return this._getRayIntersection(n)}_getRayIntersection(e,i){const{view:n,intersector:l}=this;if(e==null||n.sceneIntersectionHelper==null)return null;l.options.store=rt.MIN,n.sceneIntersectionHelper.intersectToolIntersectorRay(e,l,i);const a=l.results.min;if(a.target==null)return null;const r=m();if(!a.getIntersectionPoint(r)||i?.maxDistance!=null&&!a.withinDistance(i.maxDistance))return null;const p=n.renderCoordsHelper.fromRenderCoords(r,new Rt({spatialReference:n.spatialReference})),c=ot(a.normal);if(Jt(a))return new I({type:Q.TERRAIN,id:a.target.lij.slice(),mapPoint:p,renderPoint:r,normal:c,ray:pt(e),graphic:null});const d=at(a,n);if(d==null)return null;const{layer:u,sourceLayer:h}=d,g=h?.type==="scene"?Zt(d,h.objectIdField):d.uid;return new I({type:Q.OBJECT,id:`${u?.uid}/${g}`,mapPoint:p,renderPoint:r,normal:c,ray:pt(e),graphic:d})}updateFromGroundIntersection(e,i,n){const l=Ce,a=we,r=Oe,p=It;C(a,e),this.view.renderCoordsHelper.worldUpAtPosition(a,r),lt(r,r);const c=this.view.basemapTerrain.visibleElevationBounds,d=(i>=0?1:-1)*((c?Math.abs(c.max-c.min):100)+Math.abs(i));G(p,r,d),F(l,a,p),St(l,a,nt);const u=this._getRayIntersection(nt,{include:this._terrainIntersectionOptionsLayerUids,maxDistance:d});if(u!=null){const h=It;return G(h,r,i),F(n,u.renderPoint,h),ot(u.normal)}return C(n,e),null}};s([o()],z.prototype,"view",void 0),s([o()],z.prototype,"intersector",void 0),z=s([E("esri.views.3d.analysis.LineOfSight.LineOfSightRayIntersector")],z);const Ce=m(),we=m(),Oe=m(),It=m(),nt=$t();let _=class extends At.EventedMixin(D){constructor(t){super(t),this.updateOnCameraChange=!0,this._observerGroundOffsetRenderSpace=0,this._effectiveObserverElevationMode="absolute-height",this._observerFeatureId=null,this._updatingHandles=new ct,this._frameTask=ht,this._computationHandles=new X,this._externalObserverUpdate=!0}initialize(){const t=this.view.resourceController?.scheduler;this._frameTask=t?t.registerTask(W.LINE_OF_SIGHT_TOOL):ht,this._intersector=new z({view:this.view}),this.addHandles([this._connectObserver(),this._connectComputations(),this._connectTargets()])}destroy(){this._computationHandles.destroy(),this._computations.removeAll(),this._updatingHandles.destroy()}get updating(){return this._frameTask.updating||this._updatingHandles.updating}get priority(){return this._frameTask.priority}set priority(t){this._frameTask.priority=t}get _computations(){return this.analysisViewData.computations}get _elevationAlignedObserverPositionRenderSpace(){return this.analysisViewData.observerEngineLocation}set _elevationAlignedObserverPositionRenderSpace(t){this.analysisViewData.observerEngineLocation=t}get _screenPixelSize(){return this.view.state.camera.computeScreenPixelSizeAt(this._elevationAlignedObserverPositionRenderSpace)}_computeResult(t){const e=t.computation,{inputPoints:i,computationResult:n}=e,{observerAdjusted:l,targetAdjusted:a}=i,{start:r,end:p}=n;C(r,l),C(p,a),this._canCompute(e)?this._computeIntersection(t):Te(t),e.notifyResultChanged(),this.emit("result-changed",{target:t.computation.target,result:e.result})}_adjustStartEndPositions(t){const{view:e}=this,{inputPoints:i}=t,{observer:n,target:l,observerAdjusted:a,targetAdjusted:r}=i;C(a,n),C(r,l),be(e,this._intersector.intersector,i);const{observerSurfaceNormal:p,targetSurfaceNormal:c}=i,d=this._screenPixelSize,u=K;p!=null?C(u,p):B(u,r,a);const h=d;lt(u,u),G(u,u,Math.min(h,1)),F(a,a,u),c!=null?C(u,c):B(u,a,r);const g=e.state.camera.computeScreenPixelSizeAt(r);lt(u,u),G(u,u,Math.min(g,1)),F(r,r,u)}_computeIntersection({computation:t,interpolationInfo:e}){const{view:i}=this,{sceneIntersectionHelper:n,renderCoordsHelper:l}=i;if(n==null)return;const a=this._intersector.intersector,{computationResult:r,inputPoints:p}=t,{observer:c,target:d}=p,{start:u,end:h}=r,g=St(u,h,Pe);a.options.store=rt.MIN,n.intersectToolIntersectorRay(g,a);const L=a.results.min,O=r.intersection,j=K;let y=!0;if(L!=null&&L.getIntersectionPoint(O)){C(e.originalIntersection,O),C(e.originalObserver,u),C(e.originalTarget,h),l.fromRenderCoords(O,j,i.spatialReference);const w=1-k(h,d)/k(u,d);y=k(c,O)>=w*k(c,d)}const H=new Rt(j,i.spatialReference);{const{result:w,target:V}=t;w!=null?(w.target=V,w.intersectedGraphic=y?null:at(L,i),w.intersectedLocation=y?null:H,w.visible=y):t.result=new $({target:V,elevationAlignedTargetLocation:t.elevationAlignedTargetLocation,intersectedGraphic:y?null:at(L,i),intersectedLocation:y?null:H,visible:y})}r.isValid=p.isValid=!0,r.isTargetVisible=y}_canCompute(t){const e=this.analysisViewData.elevationAlignedObserver,i=this.view.frustum;if(e==null||t.elevationAlignedTargetLocation==null||i==null)return!1;const{observerAdjusted:n,targetAdjusted:l}=t.inputPoints,a=i.intersectsPoint(n),r=i.intersectsPoint(l);return a&&r}_onObserverPositionChange(t,e,i,n,l){if(this._externalObserverUpdate=l,t==null)return this.analysisViewData.elevationAlignedObserver=null,void(this._observerFeatureId=null);if(e==null)return ft(this.analysis,t.spatialReference,tt.getLogger(this)),void(this.analysisViewData.elevationAlignedObserver=null);const a=Pt(e,i),{absoluteZ:r,elevation:p}=gt(e.x,e.y,e.z,this.view.spatialReference,this.view,a),c=e.clone();c.z=r,this._effectiveObserverElevationMode=a.mode,this.analysisViewData.elevationAlignedObserver=c;const d=m();this.view.renderCoordsHelper.toRenderCoords(c,d),this._elevationAlignedObserverPositionRenderSpace=d,this._observerGroundOffsetRenderSpace=r-p,this._observerFeatureId=bt(n),this.priority=W.LINE_OF_SIGHT_TOOL_INTERACTIVE}_onObserverRenderSpacePositionChangeForComputation(t,e,i,n,l){const{inputPoints:a}=t;switch(C(a.observer,e),a.observerFeatureId=l,a.observerSurfaceNormal=null,n){case"on-the-ground":case"relative-to-ground":{const r=this._intersector.updateFromGroundIntersection(a.observer,i,a.observer);a.observerFeatureId==null&&(a.observerSurfaceNormal=r)}}this._adjustStartEndPositions(t),t.notifyInputPointsChanged(),this.priority=W.LINE_OF_SIGHT_TOOL_INTERACTIVE}_onTargetPositionChange(t,e,i,n,l,a=!0){const r=t.inputPoints;if(a&&(r.isValid=!1),i==null)return e!=null&&ft(this.analysis,e.spatialReference,tt.getLogger(this)),t.elevationAlignedTargetLocation=null,void t.notifyInputPointsChanged();const p=Pt(i,n),{absoluteZ:c,elevation:d}=gt(i.x,i.y,i.z,this.view.spatialReference,this.view,p),u=i.clone();switch(u.z=c,t.elevationAlignedTargetLocation=u,this.view.renderCoordsHelper.toRenderCoords(t.elevationAlignedTargetLocation,r.target),r.targetFeatureId=bt(l),r.targetSurfaceNormal=null,p.mode){case"on-the-ground":case"relative-to-ground":{const h=this._intersector.updateFromGroundIntersection(r.target,c-d,r.target);r.targetFeatureId==null&&(r.targetSurfaceNormal=h)}}this._adjustStartEndPositions(t),t.notifyInputPointsChanged(),this.priority=W.LINE_OF_SIGHT_TOOL_INTERACTIVE}_connectComputationToTarget(t){return q([this._updatingHandles.add((()=>({computation:t,targetPosition:t.target.position,targetElevationInfo:t.target.elevationInfo,targetFeatureInfo:t.target.feature,projectedTargetPosition:J(t.target.position,this.view.spatialReference)})),(({computation:e,targetPosition:i,targetElevationInfo:n,targetFeatureInfo:l,projectedTargetPosition:a})=>{a.pending==null?this._onTargetPositionChange(e,i,a.geometry,n,l):this._updatingHandles.addPromise(a.pending)}),P)])}_connectComputationToObserver(t){return this._updatingHandles.add((()=>({computation:t,observer:this.analysisViewData.elevationAlignedObserver})),(({computation:e})=>{this._externalObserverUpdate&&(e.inputPoints.isValid=!1,e.notifyInputPointsChanged())}),P)}_connectComputationToRenderSpaceObserver(t){return this._updatingHandles.add((()=>({computation:t,observer:this._elevationAlignedObserverPositionRenderSpace,observerGroundOffset:this._observerGroundOffsetRenderSpace,observerElevationMode:this._effectiveObserverElevationMode,observerFeatureId:this._observerFeatureId})),(({computation:e,observer:i,observerGroundOffset:n,observerElevationMode:l,observerFeatureId:a})=>{this._onObserverRenderSpacePositionChangeForComputation(e,i,n,l,a)}),P)}_connectComputationToCamera(t){return this._updatingHandles.add((()=>({camera:this.view.state.camera,isDirty:this._isCameraDirty})),(({isDirty:e})=>{!this.updateOnCameraChange||t.inputPoints.isValid&&!e||t.notifyInputPointsChanged()}))}_connectComputationToSlicePlane(t){return this._updatingHandles.add((()=>this.view.slice.plane),(()=>{t.inputPoints.isValid=!1,t.notifyInputPointsChanged()}))}_connectComputationToElevation(t){const e=(i,n)=>{const l=this.analysis.observer,a=t.target;let r=null,p=null,c=null,d=null,u=null,h=null;if(l?.position!=null){const g=J(l.position,this.view.spatialReference);if(g.pending!=null)return this._updatingHandles.addPromise(g.pending),void g.pending.finally((()=>e(i,n)));r=g.geometry,p=l.elevationInfo,c=l.feature}if(a.position!=null){const g=J(a.position,this.view.spatialReference);if(g.pending!=null)return this._updatingHandles.addPromise(g.pending),void g.pending.finally((()=>e(i,n)));d=g.geometry,u=a.elevationInfo,h=a.feature}r==null&&d==null||(te(i,n,Z,this.view.spatialReference),r!=null&&vt(Z,r)&&this._onObserverPositionChange(l!=null?l.position:null,r,p,c,!1),d!=null&&vt(Z,d)&&this._onTargetPositionChange(t,a.position,d,u,h,!1),r!=null&&d!=null&&ie(Z,r,d)&&t.notifyInputPointsChanged())};return this.view.elevationProvider.on("elevation-change",(({extent:i,spatialReference:n})=>e(i,n)))}_connectComputationToTask(t){let e=null;const i={computation:t,interpolationInfo:{originalIntersection:m(),originalObserver:m(),originalTarget:m()}};return q([this._updatingHandles.add((()=>t.inputPoints),(()=>{e=ut(e),e=Yt((async n=>{await Kt(this._frameTask.schedule((()=>this._computeResult(i)),n))}))}),{initial:!0,equals:()=>!1}),Et((()=>e=ut(e)))])}_connectComputationToContent(t){return Qt((()=>this.view.pointsOfInterest?.contentGeometryUpdates.events),"request-update",(e=>{const i=e?.renderBounds,{observerAdjusted:n,targetAdjusted:l}=t.inputPoints;(i==null||Xt(i,n,l))&&(t.inputPoints.isValid=!1,t.notifyInputPointsChanged())}))}_connectComputation(t){const e=this._computationHandles;e.has(t)||e.add([this._connectComputationToTarget(t),this._connectComputationToObserver(t),this._connectComputationToRenderSpaceObserver(t),this._connectComputationToCamera(t),this._connectComputationToSlicePlane(t),this._connectComputationToElevation(t),this._connectComputationToTask(t),this._connectComputationToContent(t)],t)}_disconnectComputation(t){this._computationHandles.remove(t)}_onComputationCollectionChange({added:t,removed:e}){for(const i of e)this._disconnectComputation(i);for(const i of t)this._connectComputation(i)}_onTargetCollectionChange({added:t,removed:e}){for(const i of e)this._removeTarget(i);for(const i of t)this._addTarget(i)}_onCursorTargetChange(t,e){e!=null&&this._removeTarget(e),t!=null&&this._addTarget(t)}_addTarget(t){this._computations.some((e=>e.target===t))||this._computations.add(new A({target:t}))}_removeTarget(t){const e=this._computations.findIndex((i=>i.target===t));this._computations.removeAt(e)}_connectObserver(){return q([this._updatingHandles.add((()=>({observerPosition:this.analysis.observer!=null?this.analysis.observer.position:null,projectedObserverPosition:J(this.analysis.observer!=null?this.analysis.observer.position:null,this.view.spatialReference),observerElevationInfo:this.analysis.observer!=null?this.analysis.observer.elevationInfo:null,observerFeatureInfo:this.analysis.observer!=null?this.analysis.observer.feature:null})),(({observerPosition:t,projectedObserverPosition:e,observerElevationInfo:i,observerFeatureInfo:n})=>{e.pending==null?this._onObserverPositionChange(t,e.geometry,i,n,!0):this._updatingHandles.addPromise(e.pending)}),P)])}_connectComputations(){return this._updatingHandles.addOnCollectionChange((()=>this._computations),(t=>this._onComputationCollectionChange(t)),{initial:!0,final:!0})}_connectTargets(){return q([this._updatingHandles.addOnCollectionChange((()=>this.analysis.targets),(t=>this._onTargetCollectionChange(t)),{initial:!0,final:!0}),this._updatingHandles.add((()=>this.analysisViewData.cursorTarget),((t,e)=>{this._onCursorTargetChange(t,e)}))])}get _isCameraDirty(){const t=this.analysisViewData.elevationAlignedObserver,{view:e}=this,{renderCoordsHelper:i}=e;if(t==null||i==null)return!1;const n=K;i.toRenderCoords(t,n);const l=e.state.camera.computeScreenPixelSizeAt(n);return Math.abs((l-this._screenPixelSize)/this._screenPixelSize)>Ie}};function Pt(t,e){return t.hasZ?e??{mode:"absolute-height",offset:0}:{mode:"on-the-ground",offset:0}}function Te({computation:t,interpolationInfo:e}){const{computationResult:i,inputPoints:n}=t,{start:l,end:a,intersection:r}=i,{originalIntersection:p,originalObserver:c,originalTarget:d}=e;if(C(r,p),n.isValid){const u=K,h=k(c,p)/k(c,d);mt(u,l,c),G(u,u,1-h),F(r,r,u),mt(u,a,d),G(u,u,h),F(r,r,u),i.isValid=!0}else t.result=null,i.isValid=!1,i.isTargetVisible=!1}s([o({constructOnly:!0})],_.prototype,"analysis",void 0),s([o({constructOnly:!0})],_.prototype,"analysisViewData",void 0),s([o({constructOnly:!0})],_.prototype,"view",void 0),s([o()],_.prototype,"updating",null),s([o()],_.prototype,"priority",null),s([o()],_.prototype,"updateOnCameraChange",void 0),s([o()],_.prototype,"_computations",null),s([o()],_.prototype,"_elevationAlignedObserverPositionRenderSpace",null),s([o()],_.prototype,"_observerGroundOffsetRenderSpace",void 0),s([o()],_.prototype,"_effectiveObserverElevationMode",void 0),s([o()],_.prototype,"_observerFeatureId",void 0),s([o()],_.prototype,"_screenPixelSize",null),s([o({readOnly:!0})],_.prototype,"_updatingHandles",void 0),s([o()],_.prototype,"_frameTask",void 0),s([o()],_.prototype,"_isCameraDirty",null),_=s([E("esri.views.3d.analysis.LineOfSight.LineOfSightController")],_);const Ie=.1,K=m(),Pe=$t(),Z=ee();let Le=class{constructor(){this.glowWidth=8,this.innerWidth=.75}};const Ve=new Le;function Re(t){const e=t.accentColor;return{glowColor:e,innerColor:ne(e),globalAlpha:.75*e.a}}class Se{constructor(){this.size=.5}}const $e=new Se;function Lt(t){return se(t.accentColor,.75)}class Ae{constructor(){this.size=.5,this.visibleColor=new v([3,252,111,.75]),this.occludedColor=new v([252,3,69,.75]),this.undefinedColor=new v([127,127,127,.75])}}const Ee=new Ae;let He=class{constructor(){this.innerWidth=2,this.outerWidth=8,this.visibleInnerColor=new v([3,252,111,1]),this.visibleOuterColor=new v([3,252,111,.15]),this.occludedInnerColor=new v([252,3,69,1]),this.occludedOuterColor=new v([252,3,69,.1]),this.undefinedInnerColor=new v([255,255,255,1]),this.undefinedOuterColor=new v([127,127,127,.2])}};const Y=new He;let Me=class extends Mt{constructor(e,i){const n=Dt(Lt(e.effectiveTheme)),l=Ht(n,$e.size,32,32),a=new kt(l);super({view:e,renderObjects:[a],metadata:i,elevationInfo:{mode:"absolute-height",offset:0}}),zt(this),this.themeHandle=oe((()=>({color:Lt(e.effectiveTheme)})),(r=>{n.setParameters(r)}))}destroy(){this.themeHandle.remove(),super.destroy()}};class De extends Mt{constructor(e,i){const{size:n,visibleColor:l,occludedColor:a,undefinedColor:r}=Ee;super({view:e,renderObjects:[st(n,l,x.Custom1),st(n,a,x.Custom2),st(n,r,x.Custom3)],metadata:i,elevationInfo:{mode:"absolute-height",offset:0}}),zt(this)}}function st(t,e,i){return new kt(Ht(Dt(v.toUnitRGBA(e)),t,32,32),i)}var M;(function(t){t.Ready="ready",t.Creating="creating",t.Created="created"})(M||(M={}));let f=class extends ge{constructor(t){super(t),this._creationMode=!1,this.removeIncompleteOnCancel=!1,this.analysisViewData=null,this._latestPointerMovePointerType=null,this._laserlineVisualElement=null,this._grabbedManipulator=null,this._analysisHandles=new X,this._updatingHandles=new ct,this._manipulatorHandles=new X,this._targetTrackerManipulator=null}initialize(){this._intersector=new z({view:this.view}),this.addHandles(ae((()=>this.state===M.Created),(()=>this.finishToolCreation()),le)),this._observerManipulator=this._createObserverManipulator(),this._createLaserLine(),this.addHandles([this._updatingHandles.add((()=>this.analysisViewData?.elevationAlignedObserver),(t=>this._onObserverLocationChange(t)),P),this._updatingHandles.add((()=>Re(this.view.effectiveTheme)),(({glowColor:t,innerColor:e,globalAlpha:i})=>this._updateLaserLineStyle(t,e,i)),P),this._updatingHandles.add((()=>this._laserLineRendererDependencies()),(t=>this._updateLaserLineRenderer(t))),this._connectComputations(),this._updatingHandles.addWhen((()=>!this._shouldRenderTracker),(()=>this._clearCursorTracker()),P),this._updatingHandles.add((()=>({active:this.active,hasGrabbedManipulators:this.hasGrabbedManipulators})),(({active:t,hasGrabbedManipulators:e})=>{this._creationMode=!!t&&(this._creationMode||!e)}),P)])}destroy(){this._updatingHandles=R(this._updatingHandles),this._manipulatorHandles=R(this._manipulatorHandles),this._analysisHandles=R(this._analysisHandles),this._observerManipulator=null,this._clearCursorTracker(),this._removeLaserLine(),this._intersector=null,this._set("analysis",null)}get state(){return this.active?!this.hasGrabbedManipulators||this._creationMode?M.Creating:M.Created:this.analysis.observer?.position!=null?M.Created:M.Ready}get cursor(){return this.active&&this._showTracker?"crosshair":null}get updating(){return this.analysisViewData!=null&&this.analysisViewData.updating||this._updatingHandles.updating}get _showTracker(){return this.active&&this._latestPointerMovePointerType==="mouse"}get _shouldRenderTracker(){return this._showTracker&&this.analysis.observer?.position!=null&&!this.hasGrabbedManipulators}continue(){this.view.activeTool=this}stop(){this.view.activeTool=null}onEditableChange(){this.analysisViewData.editable=this.internallyEditable}onInputEvent(t){switch(t.type){case"immediate-double-click":this._doubleClickHandler(t);break;case"pointer-move":this._pointerMoveHandler(t)}}onInputEventAfter(t){t.type==="immediate-click"&&this._clickHandler(t)}onShow(){}onHide(){}onDeactivate(){this._clearCursorTracker()}_connectComputations(){return this._updatingHandles.addOnCollectionChange((()=>this.analysisViewData.computations),(t=>this._onComputationsCollectionChange(t)),{initial:!0,final:!0})}_onComputationsCollectionChange({added:t,removed:e}){for(const i of e)this._disconnectComputation(i);for(const i of t)this._connectComputation(i)}_connectComputation(t){if(this.destroyed)return void tt.getLogger(this).warn("Attempting to connect an analysis to a destroyed LineOfSight tool. Ignoring.");const e=this._analysisHandles;if(e.has(t))return;const i=this._createTargetManipulator(t.target);this._targetTrackerManipulator==null&&i.metadata.target===this.analysisViewData.cursorTarget&&(this._targetTrackerManipulator=i,this._targetTrackerManipulator.available=!1,this._targetTrackerManipulator.interactive=!1,this._updateLaserLineRenderer()),e.add([this._updatingHandles.add((()=>xe(t)),(()=>ze(i,t)),P),this._updatingHandles.add((()=>t.elevationAlignedTargetLocation),(n=>this._onTargetLocationChange(n,i)),P)],t)}_disconnectComputation(t){if(this.destroyed)return void tt.getLogger(this).warn("Attempting to disconnect an analysis from a destroyed LineOfSight tool. Ignoring.");this._analysisHandles.remove(t);const e=this._getTargetManipulator(t.target);e!=null&&(this.manipulators.remove(e),this._manipulatorHandles.remove(e),this._targetTrackerManipulator!=null&&this._targetTrackerManipulator===e&&(this._targetTrackerManipulator=null))}_clearCursorTracker(){this.analysisViewData.cursorTarget=R(this.analysisViewData.cursorTarget)}_createTargetManipulator(t){const e={target:t,type:"target"},i=new De(this.view,e);return this._manipulatorHandles.add([this._createTargetManipulatorDragPipeline(i),i.events.on("grab-changed",(n=>this._manipulatorGrabChanged(i,n))),i.events.on("immediate-click",(n=>this._manipulatorClick(i,n)))],i),this.manipulators.add(i),t.position!=null?i.elevationAlignedLocation=t.position:i.available=!1,i}_getTargetManipulator(t){let e=null;return this.manipulators.forEach((i=>{const n=i.manipulator;e==null&&n.metadata.type==="target"&&n.metadata.target===t&&(e=n)})),e}_createObserverManipulator(){const t=new Me(this.view,{type:"observer",intersection:null});return this._manipulatorHandles.add([this._createObserverManipulatorDragPipeline(t),t.events.on("grab-changed",(e=>this._manipulatorGrabChanged(t,e))),t.events.on("immediate-click",(e=>this._manipulatorClick(t,e)))],t),this.manipulators.add(t),t}_screenToIntersection(){return t=>{const e=this._intersector.getScreenPointIntersection(t.screenEnd);return e==null?null:{...t,intersection:e}}}_createTargetManipulatorDragPipeline(t){return Ot(t,((e,i,n)=>{i.next(this._screenToIntersection()).next(this._updateTargetDragStep(t)).next((()=>this._updateLaserLineRenderer())),n.next(ke(t.metadata.target)).next((()=>this._updateLaserLineRenderer()))}))}_createObserverManipulatorDragPipeline(t){return Ot(t,((e,i,n)=>{i.next(this._screenToIntersection()).next(this._updateObserverDragStep()).next((()=>this._updateLaserLineRenderer())),n.next(this._cancelObserverDragStep()).next((()=>this._updateLaserLineRenderer()))}))}_updateObserverDragStep(){return t=>(t.intersection.mapPoint!=null?(this.analysis.observer==null&&(this.analysis.observer=new Ct),this._updateFromIntersection(this.analysis.observer,t.intersection)):this.analysis.observer=null,t)}_cancelObserverDragStep(){const t=this.analysis.observer?.position!=null?this.analysis.observer.clone():null;return e=>(this.analysis.observer=t,e)}_updateTargetDragStep(t){return e=>{this._updateFromIntersection(t.metadata.target,e.intersection);const i=e.intersection.mapPoint;return i!=null&&(t.elevationAlignedLocation=i),e}}_manipulatorGrabChanged(t,e){switch(e.action){case"start":this._grabbedManipulator=t;break;case"end":this._grabbedManipulator===t&&(this._grabbedManipulator=null)}}_laserLineRendererDependencies(){return{laserlineVisualElement:this._laserlineVisualElement,grabbedManipulator:this._grabbedManipulator,shouldRenderTracker:this._shouldRenderTracker,observerPosition:this.analysis.observer!=null?this.analysis.observer.position:null,visible:this.visible}}_updateLaserLineRenderer(t=this._laserLineRendererDependencies()){const{laserlineVisualElement:e,grabbedManipulator:i,shouldRenderTracker:n,observerPosition:l,visible:a}=t;if(e==null)return;const r=i??(n&&l!=null?this._targetTrackerManipulator:null);r!=null&&a?(e.visible=!0,e.heightManifoldTarget=r.renderLocation,r!==this._observerManipulator?e.lineVerticalPlaneSegment=ue(this._observerManipulator.renderLocation,r.renderLocation,Ge):e.lineVerticalPlaneSegment=null):(e.visible=!1,e.heightManifoldTarget=null,e.lineVerticalPlaneSegment=null)}_createLaserLine(){this._removeLaserLine();const{glowWidth:t,innerWidth:e}=Ve;this._laserlineVisualElement=new fe({view:this.view,attached:!0,visible:this.visible,style:{glowWidth:t,innerWidth:e},isDecoration:!0})}_removeLaserLine(){this._laserlineVisualElement!=null&&(this._laserlineVisualElement.destroy(),this._laserlineVisualElement=null)}_updateLaserLineStyle(t,e,i){const n=this._laserlineVisualElement;if(n==null)return;const l=n.style;n.style={...l,glowColor:v.toUnitRGB(t),innerColor:v.toUnitRGB(e),globalAlpha:i}}_onObserverLocationChange(t){t!=null?(this._observerManipulator.metadata.intersection=null,this._observerManipulator.available=!0,this._observerManipulator.elevationAlignedLocation=t):this._observerManipulator.available=!1}_onTargetLocationChange(t,e){t!=null?(e.elevationAlignedLocation=t,e!==this._targetTrackerManipulator&&(e.available=!0)):e.available=!1}_addPointFromClickEvent(t){const e=this._intersector.getScreenPointIntersection(t);if(e?.mapPoint!=null)if(this.analysis.observer?.position!=null){this._clearCursorTracker();const i=new wt;this._updateFromIntersection(i,e),this.analysis.targets.add(i)}else{const i=new Ct;this._updateFromIntersection(i,e),this.analysis.observer=i}}_clickHandler(t){this.active&&t.button!==et.Right&&(this._addPointFromClickEvent(_t(t)),t.stopPropagation())}_doubleClickHandler(t){this.active&&t.button!==et.Right&&(this.stop(),t.stopPropagation())}_pointerMoveHandler(t){if(this.hasGrabbedManipulators||(this._latestPointerMovePointerType=t.pointerType,this._updateLaserLineRenderer(),!this._showTracker||this.analysis.observer?.position==null))return;const e=_t(t),i=this._intersector.getScreenPointIntersection(e);i?.mapPoint!=null&&(this.analysisViewData.cursorTarget==null&&(this.analysisViewData.cursorTarget=new wt),this._updateFromIntersection(this.analysisViewData.cursorTarget,i),this._updateLaserLineRenderer())}_updateFromIntersection(t,e){if(e.mapPoint==null)return t.position=null,t.elevationInfo=null,void(t.feature=null);switch(e.type){case Q.OBJECT:if(e.graphic!=null){const n=e.graphic,l=de(n);l.mode==="on-the-ground"&&(l.mode="relative-to-ground",l.offset=0),t.elevationInfo=new yt(l),t.feature=n}else t.elevationInfo=null,t.feature=null;break;case Q.TERRAIN:t.elevationInfo=new yt({mode:"on-the-ground"}),t.feature=null;break;default:t.elevationInfo=null,t.feature=null}const i=e.mapPoint.clone();i.z=ce(this.view,i,{mode:"absolute-height",offset:0},t.elevationInfo),t.position=i}_manipulatorClick(t,e){if(t.metadata.type==="observer"||t.grabbing||t.dragging||e.button!==et.Right||this.analysis.targets.length<=1)return;const{target:i}=t.metadata;this.analysis.targets.remove(i),e.stopPropagation()}get testInfo(){}};function ke(t){const e=t.position?.clone();return i=>(t.position=e,i)}function ze(t,e){const{isValid:i,isTargetVisible:n}=e.computationResult;t.state=i?n?x.Custom1:x.Custom2:x.Custom3}function xe(t){const{isValid:e,isTargetVisible:i}=t.computationResult;return{isValid:e,isTargetVisible:i}}s([o({constructOnly:!0})],f.prototype,"view",void 0),s([o({constructOnly:!0})],f.prototype,"analysis",void 0),s([o()],f.prototype,"_creationMode",void 0),s([o({readOnly:!0})],f.prototype,"state",null),s([o({readOnly:!0})],f.prototype,"cursor",null),s([o()],f.prototype,"removeIncompleteOnCancel",void 0),s([o({readOnly:!0})],f.prototype,"updating",null),s([o({constructOnly:!0})],f.prototype,"analysisViewData",void 0),s([o({readOnly:!0})],f.prototype,"_showTracker",null),s([o()],f.prototype,"_latestPointerMovePointerType",void 0),s([o()],f.prototype,"_shouldRenderTracker",null),s([o()],f.prototype,"_laserlineVisualElement",void 0),s([o()],f.prototype,"_grabbedManipulator",void 0),f=s([E("esri.views.3d.analysis.LineOfSight.LineOfSightTool")],f);const Ge=re();class Fe{constructor(e,i,n,l){this.visibleLineVisualElement=e,this.occludedLineVisualElement=i,this.undefinedLineVisualElement=n,this.targetVisualElement=l}destroy(){this.visibleLineVisualElement.destroy(),this.occludedLineVisualElement.destroy(),this.undefinedLineVisualElement.destroy(),this.targetVisualElement.destroy()}}let T=class extends D{constructor(t){super(t),this._lineOfSightVisualElements=new Array,this._computationHandles=new X,this._updatingHandles=new ct}initialize(){this.addHandles(this._connectComputations()),this._createObserverVisualization()}destroy(){this._updatingHandles=R(this._updatingHandles),this._computationHandles=R(this._computationHandles),this._observerVisualElement=R(this._observerVisualElement)}get visible(){return this.analysisViewData.visible}get updating(){return this._updatingHandles.updating}get interactiveAndEditable(){return this.analysisViewData.interactive&&this.analysisViewData.editable}get test(){}_createLineOfSightVisualization(){const t=Y,e=this.view,i=this.isDecoration,n={view:e,attached:!0,width:t.outerWidth,innerWidth:t.innerWidth,isDecoration:i},l=v.toUnitRGBA(t.visibleOuterColor),a=v.toUnitRGBA(t.visibleInnerColor),r=v.toUnitRGBA(t.occludedOuterColor),p=v.toUnitRGBA(t.occludedInnerColor),c=v.toUnitRGBA(t.undefinedOuterColor),d=v.toUnitRGBA(t.undefinedInnerColor),u=new it({...n,color:l,innerColor:a}),h=new it({...n,color:r,innerColor:p}),g=new it({...n,color:c,innerColor:d}),L=new Tt({view:e,attached:!0,...Vt,size:8,isDecoration:i}),O=new Fe(u,h,g,L);return this._lineOfSightVisualElements.push(O),O}_destroyLineOfSightVisualization(t){t.destroy(),this._lineOfSightVisualElements.splice(this._lineOfSightVisualElements.indexOf(t),1)}_updateLineOfSightVisualization(t,e,i){const n=Y,{computationResult:l,inputPoints:a}=t,{start:r,end:p,intersection:c,isValid:d,isTargetVisible:u}=l,{observer:h}=a,g=Ne;g[12]=h[0],g[13]=h[1],g[14]=h[2];const L=B(je,r,h),O=B(Ue,p,h),j=B(Be,c,h),{visibleLineVisualElement:y,occludedLineVisualElement:H,undefinedLineVisualElement:w,targetVisualElement:V}=e,xt=this.analysisViewData.elevationAlignedObserver==null||t.elevationAlignedTargetLocation==null,U=this.visible&&!xt;y.visible=U,H.visible=U,w.visible=U,V.visible=U,V.attached=!i.interactiveAndEditable,U&&(y.geometry=null,H.geometry=null,w.geometry=null,V.geometry=t.elevationAlignedTargetLocation,d?u?(y.geometry=[[S(L),S(O)]],y.transform=g,y.color=v.toUnitRGBA(n.visibleOuterColor),V.color=v.toUnitRGBA(n.visibleInnerColor)):(y.geometry=[[S(L),S(j)]],y.transform=g,y.color=v.toUnitRGBA(n.occludedOuterColor),H.geometry=[[S(j),S(O)]],H.transform=g,V.color=v.toUnitRGBA(n.occludedInnerColor)):(w.geometry=[[S(L),S(O)]],w.transform=g,V.color=v.toUnitRGBA(n.undefinedInnerColor)))}_getLineOfSightVisualizationDependencies(t){const{computationResult:e}=t,{occludedOuterColor:i,visibleOuterColor:n}=Y;return{computationResult:e,occludedOuterColor:i,visibleOuterColor:n,visible:this.visible,interactiveAndEditable:this.interactiveAndEditable}}_connectComputation(t){const e=this._computationHandles;if(e.has(t))return;const i=this._createLineOfSightVisualization();e.add([this._updatingHandles.add((()=>this._getLineOfSightVisualizationDependencies(t)),(n=>this._updateLineOfSightVisualization(t,i,n)),{initial:!0,equals:()=>!1}),Et((()=>this._destroyLineOfSightVisualization(i)))],t)}_disconnectComputation(t){this._computationHandles.remove(t)}_connectComputations(){return this._updatingHandles.addOnCollectionChange((()=>this.analysisViewData.computations),(t=>this._onComputationsCollectionChange(t)),{initial:!0,final:!0})}_onComputationsCollectionChange({added:t,removed:e}){for(const i of e)this._disconnectComputation(i);for(const i of t)this._connectComputation(i)}_createObserverVisualization(){const t=v.toUnitRGBA(Y.visibleInnerColor),e=new Tt({view:this.view,color:t,...Vt,isDecoration:this.isDecoration});this._observerVisualElement=e,this.addHandles(this._updatingHandles.add((()=>({observer:this.analysisViewData.elevationAlignedObserver,interactiveAndEditable:this.interactiveAndEditable,visible:this.visible})),(({observer:i,interactiveAndEditable:n,visible:l})=>{i!=null&&!n&&l?(e.geometry=i,this._observerVisualElement.attached=!0):e.attached=!1}),P))}};s([o({constructOnly:!0})],T.prototype,"analysis",void 0),s([o({constructOnly:!0})],T.prototype,"analysisViewData",void 0),s([o({constructOnly:!0})],T.prototype,"view",void 0),s([o({readOnly:!0})],T.prototype,"visible",null),s([o({constructOnly:!0})],T.prototype,"isDecoration",void 0),s([o()],T.prototype,"updating",null),s([o()],T.prototype,"interactiveAndEditable",null),s([o()],T.prototype,"test",null),T=s([E("esri.views.3d.analysis.LineOfSight.LineOfSightVisualization")],T);const Vt={size:6,pixelSnappingEnabled:!1,primitive:"circle",elevationInfo:{mode:"absolute-height",offset:0},outlineSize:0},je=m(),Ue=m(),Be=m(),Ne=pe();let b=class extends ve(At.EventedMixin(D)){constructor(t){super(t),this.type="line-of-sight-view-3d",this.analysis=null,this.tool=null,this.computations=new he,this.cursorTarget=null,this.editable=!0,this.elevationAlignedObserver=null,this.observerEngineLocation=m(),this.userOperation=null}initialize(){const t=this.view,e=this.analysis;this._analysisController=new _({analysis:e,analysisViewData:this,view:t}),this._analysisVisualization=new T({analysis:e,analysisViewData:this,view:t,isDecoration:!this.parent}),this.addHandles([this._analysisController.on("result-changed",(i=>{i.target!==this.cursorTarget&&this.emit("result-changed",i)})),me(this,f)])}destroy(){_e(this),this.userOperation=ut(this.userOperation),this._analysisController=R(this._analysisController),this._analysisVisualization=R(this._analysisVisualization)}get results(){return this.computations.map((t=>t.result))}get priority(){return this._analysisController.priority}set priority(t){this._analysisController.priority=t}get updating(){return this._analysisController!=null&&this._analysisController.updating||this._analysisVisualization!=null&&this._analysisVisualization.updating}place(t){return ye(this,{placementOptions:t})}getResultForTarget(t){return this.computations.find((e=>e.target===t))?.result}get testInfo(){}};s([o({readOnly:!0})],b.prototype,"type",void 0),s([o({constructOnly:!0,nonNullable:!0})],b.prototype,"analysis",void 0),s([o()],b.prototype,"tool",void 0),s([o({readOnly:!0})],b.prototype,"results",null),s([o()],b.prototype,"priority",null),s([o()],b.prototype,"computations",void 0),s([o()],b.prototype,"cursorTarget",void 0),s([o()],b.prototype,"editable",void 0),s([o()],b.prototype,"elevationAlignedObserver",void 0),s([o()],b.prototype,"observerEngineLocation",void 0),s([o()],b.prototype,"updating",null),s([o()],b.prototype,"userOperation",void 0),s([o()],b.prototype,"_analysisController",void 0),s([o()],b.prototype,"_analysisVisualization",void 0),b=s([E("esri.views.3d.analysis.LineOfSightAnalysisView3D")],b);const Ki=b;export{Ki as default};
