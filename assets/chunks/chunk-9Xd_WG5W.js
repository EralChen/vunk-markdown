import{hZ as z,j as N,bZ as O,sl as A,s8 as E,t8 as U,t9 as j,ta as G,tb as Z,tc as W,td as K,te as Y,lF as q,sa as y,h3 as M,q8 as Q,pz as w,s as J,tf as X,tg as ee,da as te,aG as ie,aM as le,si as $,fI as se,bR as re,az as P,d8 as ae,af as d,ag as g,ai as ne}from"./chunk-CuaFhuP3.js";import{a0 as k}from"./chunk-Dpk1TJd9.js";import{p as oe,t as he}from"./chunk-fUZPwjMI.js";import{p as ce}from"./chunk-tLiXu_Cv.js";import{l as ue}from"./chunk-CK-Bcvbn.js";import{p as de}from"./chunk-D1Gs7Etu.js";import"./chunk-iOPJXyP1.js";import"./chunk-DGmg3LSc.js";/* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              */import"./chunk-CUzevAry.js";import"./chunk-HW0UV52H.js";import"./chunk-Cb59EICm.js";class me{constructor(e,t,s){this._scale=e,this._shift=t,this._levelShift=s}getLevelRowColumn(e){const t=this.getLevelShift(e[0]),s=this._shift+t;return s?[e[0]-t,e[1]>>s,e[2]>>s]:e}getLevelShift(e){return Math.min(e,this._levelShift)}getOffset(e,t){let s=0,l=0;const i=this._shift+this.getLevelShift(e[0]);if(i){const n=(1<<i)-1,r=t/(this._scale*(1<<i-1));s=(e[2]&n)*r,l=(e[1]&n)*r}return[s,l]}getScale(e){return this._scale*(1<<this._shift+this.getLevelShift(e))}}class B extends oe{constructor(e,t,s,l){super(e,t,s,e.tileInfo.lods.length-1),this._memCache=l,this._ongoingTileRequests=new Map,this._ongoingRequestToController=new Map,this._tileInfoView=new he(e.tileInfo,e.fullExtent)}destroy(){super.destroy(),this._ongoingRequestToController.forEach((e=>e.abort())),this._ongoingRequestToController.clear(),this._ongoingTileRequests.clear()}async getVectorTile(e,t){const s=new z(e[0],e[1],e[2],0);let l=this._memCache.get(s.id);if(l)return l.retain(),l;const i=await this._getVectorTileData(s);if(N(t),!this._layer)return null;if(l=this._memCache.get(s.id),l)return l.retain(),l;const n=this._layer.tileInfo.getTileBounds(O(),s),r=this._tileInfoView.getTileResolution(e[0]);return l=new A(s,r,n[0],n[3],E,E,this._styleRepository,this._memCache),l.setData(i),i&&(l.retain(),this._memCache.put(s.id,l,U)),l.neededForCoverage=!0,l.transforms.tileUnitsToPixels=j(1/8,0,0,0,1/8,0,0,0,1),l}_getVectorTileData(e){const t=e.id;if(this._ongoingTileRequests.has(t))return this._ongoingTileRequests.get(t);const s=new AbortController,l={signal:s.signal},i=this._getParsedVectorTileData(e,l).then((n=>(this._ongoingTileRequests.delete(t),this._ongoingRequestToController.delete(t),n))).catch((()=>(this._ongoingTileRequests.delete(t),this._ongoingRequestToController.delete(t),null)));return this._ongoingTileRequests.set(t,i),this._ongoingRequestToController.set(t,s),i}_getParsedVectorTileData(e,t){return this.fetchTileData(e,t).then((s=>this.parseTileData({key:e,data:s},t)))}}const v={vtlBackground:Z,vtlFill:Y,vtlLine:K,vtlCircle:W,vtlSymbol:G},f=1e-6;class D{constructor(e,t){this.spriteMosaic=e,this.glyphMosaic=t,this._brushCache={vtlBackground:null,vtlFill:null,vtlLine:null,vtlCircle:null,vtlSymbol:null},this._vtlMaterialManager=new ce}dispose(){this._brushCache.vtlBackground?.dispose(),this._brushCache.vtlFill?.dispose(),this._brushCache.vtlLine?.dispose(),this._brushCache.vtlCircle?.dispose(),this._brushCache.vtlSymbol?.dispose(),this._brushCache=null,this._vtlMaterialManager=q(this._vtlMaterialManager),this.spriteMosaic.dispose(),this.glyphMosaic.dispose()}get vectorTilesMaterialManager(){return this._vtlMaterialManager}drawSymbols(e,t,s){const l=s.layers;e.renderPass="translucent";let i=this._brushCache.vtlSymbol;i==null&&(i=new v.vtlSymbol,this._brushCache.vtlSymbol=i),m[0]=t;for(let n=0;n<l.length;n++){const r=l[n];if(r.type!==y.SYMBOL)continue;const o=r.getLayoutProperty("visibility");if(o&&o.getValue()===M.NONE)continue;const h=e.displayLevel;r.minzoom!==void 0&&r.minzoom>h+f||r.maxzoom!==void 0&&r.maxzoom<=h-f||(e.styleLayerUID=r.uid,e.styleLayer=r,i.drawMany(e,m))}m[0]=null}drawBackground(e,t,s){if(s.backgroundBucketIds.length===0)return;const{context:l,displayLevel:i,requiredLevel:n}=e;t.key.level=n,l.setBlendingEnabled(!0),l.setDepthTestEnabled(!1),l.setStencilTestEnabled(!1),e.renderPass="background";let r=this._brushCache.vtlBackground;r==null&&(r=new v.vtlBackground,this._brushCache.vtlBackground=r),m[0]=t,s.backgroundBucketIds.forEach((o=>{const h=s.getLayerById(o);if(h.type!==y.BACKGROUND)return;const C=h.getLayoutProperty("visibility");C&&C.getValue()===M.NONE||h.minzoom!==void 0&&h.minzoom>i+f||h.maxzoom!==void 0&&h.maxzoom<=i-f||(e.styleLayerUID=h.uid,e.styleLayer=h,r.drawMany(e,m))})),m[0]=null}drawTile(e,t,s,l){const{context:i}=e,n=s.layers;i.setBlendingEnabled(!1),i.setDepthTestEnabled(!0),i.setDepthWriteEnabled(!0),i.setDepthFunction(Q.LEQUAL);const r=n.filter((o=>l!=null&&l!==o.type||!t.layerData.has(o.uid)?!1:o.getLayoutProperty("visibility")?.getValue()!==M.NONE));e.renderPass="opaque";for(let o=r.length-1;o>=0;--o)this._renderStyleLayer(r[o],e,t);i.setDepthWriteEnabled(!1),i.setBlendingEnabled(!0),i.setBlendFunctionSeparate(w.ONE,w.ONE_MINUS_SRC_ALPHA,w.ONE,w.ONE_MINUS_SRC_ALPHA),e.renderPass="translucent",r.forEach((o=>this._renderStyleLayer(o,e,t))),i.setDepthTestEnabled(!1),i.bindVAO()}_renderStyleLayer(e,t,s){const{renderPass:l}=t;let i;switch(e.type){case y.BACKGROUND:if(l!=="background")return;i=this._brushCache.vtlBackground,i||(i=new v.vtlBackground,this._brushCache.vtlBackground=i);break;case y.FILL:if(l!=="opaque"&&t.renderPass!=="translucent")return;i=this._brushCache.vtlFill,i==null&&(i=new v.vtlFill,this._brushCache.vtlFill=i);break;case y.LINE:if(l!=="translucent")return;i=this._brushCache.vtlLine,i==null&&(i=new v.vtlLine,this._brushCache.vtlLine=i);break;case y.CIRCLE:if(l!=="translucent")return;i=this._brushCache.vtlCircle,i==null&&(i=new v.vtlCircle,this._brushCache.vtlCircle=i);break;case y.SYMBOL:if(l!=="translucent")return;i=this._brushCache.vtlSymbol,i==null&&(i=new v.vtlSymbol,this._brushCache.vtlSymbol=i)}const{displayLevel:n}=t,{minzoom:r,maxzoom:o}=e;if(r!==void 0&&r>n+f||o!==void 0&&o<=n-f)return;const{context:h}=t;h.setStencilTestEnabled(!1),h.setStencilWriteMask(0),t.styleLayerUID=e.uid,t.styleLayer=e,m[0]=s,i.drawMany(t,m),m[0]=null}}const m=[null];let c=class extends de(ue(ae)){constructor(){super(...arguments),this._tileHandlerController=null,this.type="vector-tile-3d",this.levelShift=k("disable-feature:vtl-level-shift")?0:1}initialize(){if(this.layer.fullExtent==null)return void this.addResolvingPromise(Promise.reject(new J("vectortilelayerview:full-extent-undefined","This layer view's layer does not define a fullExtent.")));const{basemapTerrain:a,spatialReference:e,state:t,viewingMode:s}=this.view,l=s==="local"&&!X(e)||ee.force512VTL?this.layer.tileInfo:this.layer.tileInfo.getCompatibleForVTL(256),i=this._getTileInfoSupportError(l,this.layer.fullExtent);if(i!=null)return this.addResolvingPromise(Promise.reject(i));const n=te((()=>this.view?.basemapTerrain?.tilingSchemeLocked)).then((()=>{const u=a.tilingScheme,p=u.pixelSize,T=p===256?1:2,_=a.spatialReference?.isGeographic&&p===256?1:0,S=a.spatialReference?.isGeographic||p!==256?0:1;let b;this.schemaHelper=new me(T,_,this.levelShift+S),b=p===256||p===512?this.layer.tileInfo.getCompatibleForVTL(p):this.layer.tileInfo;const L=this._getTileInfoCompatibilityError(b,u);if(L)throw L;this.tileInfo=b}));this._tileHandlerController=new AbortController;const r=this.view.resourceController;this._memCache=r.memoryController.newCache(`vtl-${this.layer.uid}`,(u=>u.release())),this.addHandles(ie((()=>this.view.qualitySettings.memoryLimit),(u=>this._memCache.maxSize=Math.ceil(u/10*1048576)),le));const o=new $(this.layer.currentStyleInfo.style);this._tileHandler=new B(this.layer,o,t.contentPixelRatio,this._memCache);const h=this._tileHandlerController.signal,C=pe(r),I=this._tileHandler.start({signal:h,schedule:C}),x=this._tileHandler.spriteMosaic;x.then((u=>{!se(h)&&this._tileHandler&&(this.painter=new D(u,this._tileHandler.glyphMosaic))})),I.then((()=>this._tileHandlerController=null));const R=()=>{this._tileHandlerController&&this._tileHandlerController.abort(),this._tileHandlerController=new AbortController,this._memCache.clear();const u=this.layer.currentStyleInfo.style,p=this.view.state?.contentPixelRatio??1,T=new $(u),_=new B(this.layer,T,p,this._memCache),S=_.start({signal:this._tileHandlerController.signal,schedule:C}),b=_.spriteMosaic;S.then((()=>this._tileHandlerController=null)),this._updatingHandles.addPromise(Promise.all([S,b]).then((([,L])=>{const F=this._tileHandler,H=this.painter;this.painter=new D(L,_.glyphMosaic),this._tileHandler=_,this.emit("data-changed"),F.destroy(),H&&H.dispose()})))};this._updatingHandles.add((()=>({style:this.layer.currentStyleInfo.style,pixelRatio:this.view.state?.contentPixelRatio})),R),this.addHandles([this.layer.on("paint-change",(()=>this.emit("data-changed"))),this.layer.on("style-layer-change",R),this.layer.on("delete-style-layer",R),this.layer.on("spriteSource-change",(()=>this.emit("data-changed"))),this.layer.on("layout-change",(()=>this.emit("data-changed"))),this.layer.on("style-layer-visibility-change",(()=>this.emit("data-changed")))]);const V=Promise.all([n,I,x]);this.addResolvingPromise(V)}destroy(){this.painter=q(this.painter),this._tileHandlerController=re(this._tileHandlerController),this._tileHandler=P(this._tileHandler),this._memCache=P(this._memCache)}get contentZoom(){return k("disable-feature:vtl-level-shift")?1:this.view.qualitySettings.tiledSurface.vtlContentZoom}get displayLevelRange(){const a=this.tileInfo.lods,e=this.layer.minScale||a[0].scale,t=this.layer.maxScale||a[a.length-1].scale,s=this.levelRangeFromScaleRange(e,t);return this.layer.maxScale?s.maxLevel++:s.maxLevel+=this.levelShift,s}get dataScaleRange(){const a=this.tileInfo.lods;return{minScale:a[0].scale,maxScale:a[a.length-1].scale}}get dataLevelRange(){const{minScale:a,maxScale:e}=this.dataScaleRange,t=this.levelRangeFromScaleRange(a,e);return t.minLevel===1&&this.tileInfo.size[0]===256&&(t.minLevel=0),t.maxLevel+=this.levelShift,t}async fetchTile(a,e){const t=this.schemaHelper.getLevelRowColumn(a);return this._tileHandler.getVectorTile(t,e)}get hasVisibleFeatures(){return!0}};d([g()],c.prototype,"layer",void 0),d([g()],c.prototype,"levelShift",void 0),d([g()],c.prototype,"contentZoom",null),d([g()],c.prototype,"displayLevelRange",null),d([g()],c.prototype,"tileInfo",void 0),d([g()],c.prototype,"dataScaleRange",null),d([g()],c.prototype,"dataLevelRange",null),d([g()],c.prototype,"updatingProgressValue",void 0),c=d([ne("esri.views.3d.layers.VectorTileLayerView3D")],c);const ot=c;function pe(a){return e=>a.immediate.schedule(e)}export{ot as default};
