import{d0 as y,aq as ie,ky as It,a_ as ne,e7 as q,tq as K,j4 as S,cX as ti,cY as Lt,cV as Ut,gs as ue,b3 as p,cj as B,b$ as we,JN as ii,JO as si,JQ as Se,c$ as fe,eb as P,cD as Ke,b4 as G,b5 as j,mj as Oe,az as C,bM as kt,yL as ce,JR as De,xc as jt,ts as Te,b2 as Q,yM as Le,b6 as ai,aG as M,an as x,kb as Ue,cm as ri,xn as ke,ci as J,tp as je,yS as tt,nE as Ve,JS as W,yJ as oi,AK as me,eJ as ni,JT as li,kz as hi,af as n,ag as c,ao as be,aM as de,bR as Be,HC as ci,B5 as di,c8 as it,g6 as ui,jI as pi,j as vi,De as wi,ai as se,lA as Ge,d5 as ge,aH as Bt,rf as st,$ as We,zw as fi,eK as mi,aK as gi,C0 as _i,b8 as Vi,bi,bg as Mi,mC as Wt,cr as Qe,fB as yi,cW as Si,na as Di,xz as Oi,xB as Ti,kx as at,JU as rt,JV as $i,JW as xi,JX as Ri,JY as ot,s9 as nt,fZ as Ai,Ix as Ci,JZ as Pi,J_ as Fi,J$ as Ei,rA as Nt,nq as qt,HN as Ne,ka as lt,HO as Hi,K0 as zi,K1 as Ii,K2 as Li,K3 as Ui,IY as ht,HX as xe,I_ as Re,HM as ki,IH as ct,K4 as dt,K5 as ji,K6 as Bi,HY as Wi,HZ as Ni,H$ as qi,JE as Ji,I1 as Ki,K7 as Gi,V as Qi,K8 as Ae,K9 as ut,lF as Xi,qL as Yi,AN as Zi,k8 as es,kw as pt,cQ as ts,cR as is,c1 as ss,eP as as,uo as rs,Ka as os,eI as ns,v as ls,eh as hs,eS as cs}from"./chunk-CuaFhuP3.js";import{d as ds,m as us}from"./chunk-NDm1DwyJ.js";import{S as ps,bH as vs,a0 as ws}from"./chunk-Dpk1TJd9.js";import{o as fs,s as ms,m as gs,f as _s,d as vt}from"./chunk-BrlCBmiQ.js";import{O as Vs,w as bs,a as oe,e as $e,f as Ms,c as ys,d as ae,t as Ss}from"./chunk-bnxLL64Y.js";import{c as Ds}from"./chunk-DMTlERZL.js";import{T as wt,A as Os}from"./chunk-B4acbyk_.js";import{B as Jt,A as ee,o as Kt,a as Ts,u as $s,j as xs}from"./chunk-Bplja-Ta.js";import{p as ye,M as Rs,h as Ce,f as As}from"./chunk-DBIOSom4.js";import{s as Xe}from"./chunk-Cw3swYQH.js";import{A as Gt}from"./chunk-Cwyf4XaO.js";import{E as Cs}from"./chunk-BlkaH78C.js";import{G as Ps}from"./chunk-B3xdXfS3.js";import{c as Fs}from"./chunk-DpLds6Zo.js";import{o as Es}from"./chunk-FQCx7Mu7.js";import{S as Hs}from"./chunk-CPxyAGgv.js";import{h as zs}from"./chunk-CCavR4OV.js";import{_ as Is}from"./chunk-iOPJXyP1.js";import"./chunk-DGmg3LSc.js";/* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              */import"./chunk-CpdoPF2G.js";import"./chunk-DwTaIoG6.js";import"./chunk-B6pR6iCC.js";import"./chunk-DZlnYJxS.js";const ft=2,Ls=4,Qt=y(2),Us=1.5;let ks=class{constructor(){this.collisionRadius=5,this.fovUnfocusedArcWidth=Ls,this.fovFocusedArcWidth=ft*this.fovUnfocusedArcWidth,this.scaleOrientSize=90,this.scaleOrientHandleRadius=.025,this.scaleOrientMinDistance=1,this.scaleOrientArrowTipLength=.3,this.scaleOrientArrowTipFocusMultiplier=ft/1.5,this.observerSize=5,this.hoverTimeoutMilliseconds=1e3,this.viewAngleThreshold=10}getFovArcWidth(t){return t?this.fovFocusedArcWidth:this.fovUnfocusedArcWidth}getScaleOrientArrowTipLength(t){return this.scaleOrientArrowTipLength*(t?this.scaleOrientArrowTipFocusMultiplier:1)}};const H=new ks;class js{constructor(){this.frameWidthNotSelected=.3,this.frameWidthSelected=1,this.frameColor=new ie([255,255,255,.99]),this.observerPointConfiguration={size:6,pixelSnappingEnabled:!1,primitive:"circle",elevationInfo:{mode:"absolute-height",offset:0},outlineSize:0,color:ie.toUnitRGBA(new ie([3,252,111,1]))},this.shapeMaterialParameters={color:[.33,.33,.33,.25],renderOccluded:ne.Occlude,cullFace:It.Back,writeDepth:!1}}}const Y=new js;function Ye({tiltedUpVector:i,rightVector:t,observerRenderSpace:e},s){const a=Vs(i,t,e,s);return a[12]=0,a[13]=0,a[14]=0,a}function qe(i,t,e,s){const a=p(),r=ti(e.plane),o=Bs(t,r);let l;if(Math.abs(o)>H.viewAngleThreshold)l=i.next(wt(t,e.plane));else{const d=Lt(s.targetRenderSpace,e.basis1,Ut()),u=ue(Xt,e.basis1),h=ue(Ws,e.basis2);l=i.next(wt(t,d)).next((v=>{const w=T=>{const D=fe(P(mt,T,e.origin),h),R=Math.acos(Ke(D/s.farDistanceRenderSpace,-1,1)),F=Math.sin(R)*s.farDistanceRenderSpace;return G(p(),e.origin,G(p(),j(mt,u,F),j(Ns,h,D)))},f=w(v.renderStart),m=w(v.renderEnd);return{...v,renderStart:f,renderEnd:m}}))}return l.next((d=>{d.action==="start"&&B(a,d.renderStart);const u=we(bs(a,d.renderEnd,e.origin,r));return{...d,deltaAngle:u}}))}function Bs(i,t){const e=Xt;i.renderCoordsHelper.toRenderCoords(i.camera.position,e);const s=ii(i,e,i.camera.heading,i.camera.tilt,si()).direction;return we(Se(s,t))-90}function te(i,t,e,s){return K(gt,e,s),q(i,t,gt)}const Xt=p(),Ws=p(),mt=p(),Ns=p(),gt=S();let qs=class extends Jt{constructor(t){super(),this._handles=new Oe,this._tool=t.tool,this._view=t.view,this._focusedArcMaterial=this._createArcMaterial(!0),this._unfocusedArcMaterial=this._createArcMaterial(!1),this._createManipulators(),this.forEachManipulator((e=>this._tool.manipulators.add(e)))}destroy(){this._handles=C(this._handles),this.forEachManipulator((t=>{this._tool.manipulators.remove(t),t.destroy()})),this._tool=null,this._view=null,this._manipulators=null}createDragPipeline(t,e){const s=Object.values(this._manipulators);return kt(s.map((({manipulator:a,side:r})=>ye(a,((o,l,d,u,h)=>{const v=Ys(r,e),w=l.next((m=>({...m,manipulatorType:ee.SCALE,side:r}))),f=qe(w,this._view,v,e);t(o,f,d)})))))}updateManipulatorsTransform(t){t.arcCentersPoints(_t),this._forEachManipulatorInfo((e=>this._updateArcManipulatorTransform(e,t,_t[e.side])))}updateManipulatorVisuals(t){this._forEachManipulatorInfo((e=>this._updateArcManipulatorVisuals(e,t)))}_updateArcManipulatorVisuals({manipulator:t,side:e},s){const a=[];if(s!=null){const[r,o]=Js(e,s,this._unfocusedArcMaterial);a.push(new oe(r,ce.Unfocused),new oe(r.instantiate({material:this._focusedArcMaterial}),ce.Focused)),t.collisionType={type:"line",paths:[o]}}t.renderObjects=a,t.radius=H.collisionRadius}_updateArcManipulatorTransform({manipulator:t,side:e},s,a){const r=s.horizontalFieldOfView,o=y(s.verticalFieldOfView/2),l=y(r/2),d=_e(e);t.renderLocation=a;const u=S(),h=T=>{Ue(u,T,u)};h(De(le,y(-90))),d||h(jt(le,o));const v=s.farDistanceRenderSpace;let w,f;h(Te(le,Q(Yt,v,v,v))),h(Le(le,Qs(e))),h(Ye(s,le)),d?(w=l,f=s.tiltedUpVector):(f=s.rightVector,w=o),w*=e==="right"||e==="bottom"?-1:1;const m=K(le,w,f);m!=null&&h(m),t.modelTransform=u}_createManipulators(){const t=this._createArcManipulator("left"),e=this._createArcManipulator("right"),s=this._createArcManipulator("top"),a=this._createArcManipulator("bottom");this._manipulators={left:t,right:e,top:s,bottom:a},[[a.manipulator,s.manipulator],[t.manipulator,e.manipulator]].forEach((([r,o])=>{r.metadata={pairedManipulator:o},o.metadata={pairedManipulator:r}}))}_createArcManipulator(t){const e=new $e({view:this._view,autoScaleRenderObjects:!1,worldSized:!0}),s={manipulator:e,side:t};return this._updateArcManipulatorVisuals(s),this._handles.add(e.events.on("focus-changed",(a=>{const r=e.metadata?.pairedManipulator;r!=null&&(r.hovering!==e.hovering&&(r.hovering=e.hovering),r.grabbing!==e.grabbing&&(r.grabbing=e.grabbing))}))),s}_createArcMaterial(t){const e=H.getFovArcWidth(t),s=new ai({renderOccluded:ne.OccludeAndTransparent,isDecoration:!0,width:e});return this._handles.add(M((()=>ie.toUnitRGBA(this._view.effectiveTheme.accentColor)),(a=>s.setParameters({color:a})),x)),s}forEachManipulator(t){Object.values(this._manipulators).forEach((({manipulator:e})=>t(e,ee.SCALE)))}_forEachManipulatorInfo(t){Object.values(this._manipulators).forEach((e=>t(e)))}get test(){return{manipulators:this._manipulators}}};function Js(i,t,e){const{horizontalFieldOfView:s,verticalFieldOfView:a}=t,r=_e(i),o=y(Ke((r?a:s)/2,0,15)),l=Ks(-o/2,o/2,r?1:Math.max(Math.sin(y(90-a/2)),.1));return[ri(e,l),l]}function Ks(i,t,e,s=10){ke(s>1,"createArcPolylineGeometry() needs at least 2 for numVertices");const a=t-i;if(a<=0||e<=0)return[J(0,0,.01),J(0,0,-.01)];const r=[],o=a/s;for(let l=0;l<s;l++){let d=i+l*o;l===s-1&&(d=t);const u=Math.cos(d)*e,h=Math.sin(d)*e,v=J(u-e,0,h);r.push(v)}return r}function Gs(i){switch(i){case"left":return 0;case"bottom":return 1;case"right":return 2;case"top":return 3}}function Qs(i){return Gs(i)*Zs}function _e(i){return i==="left"||i==="right"}function Xs(i){return i==="left"?"right":i==="right"?"left":i==="top"?"bottom":"top"}function Ys(i,{observerRenderSpace:t,targetRenderSpace:e,tiltedUpVector:s,rightVector:a,farDistanceRenderSpace:r}){const o=P(Yt,e,t),l=_e(i)?a:s,d=j(ea,l,r);return je(t,o,d)}const Zs=Math.PI/2,le=S(),Yt=p(),ea=p(),_t={top:p(),bottom:p(),left:p(),right:p()};let Pe=class extends $e{constructor(t,e){super({view:t,autoScaleRenderObjects:!1,worldSized:!1,radius:H.collisionRadius}),this._handles=new Oe,this._setupManipulatorVisual(e)}destroy(){this._handles.remove(),super.destroy()}_setupManipulatorVisual(t){const e=this._createMaterial(),s=1,a=[J(0,0,0),J(0,0,s)],r=tt(e,a,t,16,!1),o=tt(e,a,t*Xe,16,!1),l=Vt(!1,e,t),d=Vt(!0,e,t),u=S();Ve(u,a[a.length-1]),W(u,u,jt(bt,Math.PI/2)),W(u,u,De(bt,Math.PI/2)),l.transformation=u,d.transformation=u,this.renderObjects=[new oe(r,ce.Unfocused),new oe(o,ce.Focused),new oe(l,ce.Unfocused),new oe(d,ce.Focused)];const h=J(0,H.getScaleOrientArrowTipLength(!0),0),v=q(h,h,u),w=[...a,v];this.collisionType={type:"line",paths:[w]}}_createMaterial(){const t=new Gt({cullFace:It.Back,renderOccluded:ne.OccludeAndTransparent,isDecoration:!0});return this._handles.add(M((()=>ie.toUnitRGBA(this.view.effectiveTheme.accentColor)),(e=>t.setParameters({color:e})),x)),t}};function Vt(i,t,e){const s=H.getScaleOrientArrowTipLength(i);let a=2*e;i&&(a*=Xe);const r=s/2;return oi(t,s,r,r,a,0)}const bt=S();let ta=class extends Jt{constructor(t){super(),this._handles=new Oe,this._tool=t.tool,this._view=t.view;const e=H.scaleOrientHandleRadius;this._manipulatorHeading=new Pe(this._view,e),this._manipulatorTilt=new Pe(this._view,e),this._manipulatorDistance=new Pe(this._view,e),this.forEachManipulator((s=>this._tool.manipulators.add(s)))}destroy(){this._handles.destroy(),this.forEachManipulator((t=>{this._tool.manipulators.remove(t),t.destroy()})),this._manipulatorHeading=null,this._manipulatorTilt=null,this._manipulatorDistance=null,this._tool=null,this._view=null}createHeadingDragPipeline(t,e){return ye(this._manipulatorHeading,((s,a,r,o,l)=>{const d=this._view,{tiltParallelToSurface:u,farDistanceRenderSpace:h,upVector:v,observerRenderSpace:w,targetRenderSpace:f,rightVector:m}=e,T=Math.sin(y(u))*h,D=G(Me,w,j(Fe,v,T)),R=P(Fe,f,D),F=j(ia,m,me(R)),A=je(D,R,F),z=qe(a,d,A,e).next((I=>({...I,manipulatorType:ee.ROTATE})));t(s,z,r)}))}createTiltDragPipeline(t,e){return ye(this._manipulatorTilt,((s,a,r,o,l)=>{const{observerRenderSpace:d,farDistanceRenderSpace:u,upVector:h,targetDirection:v}=e,w=fe(v,h),f=ni(Me,v,h,-w);j(f,ue(f,f),u);const m=j(Fe,h,u),T=je(d,f,m),D=qe(a,this._view,T,e).next((R=>({...R,manipulatorType:ee.ROTATE})));t(s,D,r)}))}createDistanceDragPipeline(t,e){return ye(this._manipulatorDistance,((s,a,r,o,l)=>{const d=li(e.observerRenderSpace,e.targetDirection),u=a.next(Rs(this._view,s.location)).next(Os(this._view,d)).next((h=>({...h,manipulatorType:ee.SCALE})));t(s,u,r)}))}updateManipulators(t){const{targetRenderSpace:e}=t;this._manipulatorHeading.renderLocation=e,this._manipulatorTilt.renderLocation=e,this._manipulatorDistance.renderLocation=e;const s=S(),a=h=>{Ue(s,h,s)},r=H.scaleOrientSize*(Kt/Ts);a(Te(pe,Q(Me,r,r,r))),a(Ye(t,pe));const o=H.scaleOrientHandleRadius*Xe*r,l=j(Me,t.targetDirection,o);a(Ve(pe,l));const d=Le(pe,-Ee);W(d,d,De(Mt,-Ee)),this._manipulatorHeading.modelTransform=W(S(),s,d);const u=De(pe,Ee);W(u,u,Le(Mt,Math.PI)),this._manipulatorTilt.modelTransform=Ue(S(),s,u),this._manipulatorDistance.modelTransform=s}forEachManipulator(t){t(this._manipulatorHeading,ee.ROTATE),t(this._manipulatorTilt,ee.ROTATE),t(this._manipulatorDistance,ee.SCALE)}};const pe=S(),Mt=S(),Me=p(),Fe=p(),ia=p(),Ee=Math.PI/2;let Zt=class extends $e{constructor(t,e){super({view:t,autoScaleRenderObjects:!1,worldSized:!1,radius:H.observerSize,interactive:!1}),this._handles=new Oe;const s=Ms(this._color);this.renderObjects=[new oe(hi(s,H.observerSize,32,32))],e.manipulators.add(this),this._handles.add([M((()=>this._color),(a=>{s.setParameters({color:a})}),x)])}destroy(){this._handles.remove(),super.destroy()}get _color(){return ie.toUnitRGBA(this.view.effectiveTheme.accentColor)}};n([c()],Zt.prototype,"_color",null);const yt=Symbol("dragHandles"),St=Symbol("hideManipulators"),Dt=Symbol("hideFoVManipulators"),Ot=Symbol("hideObserverManipulator");let L=class extends be{constructor(t){super(t),this._moveManipulation=null,this._observerManipulator=null,this._fieldOfViewManipulation=null,this._scaleOrientManipulation=null,this._forceHoveringTask=null,this._forceHoveringTestPromise=null,this._grabbing=!1,this.viewshedComputedData=null}initialize(){this._moveManipulation=this._createMoveManipulation(),this._fieldOfViewManipulation=new qs({view:this.view,tool:this.parentTool}),this._scaleOrientManipulation=new ta({view:this.view,tool:this.parentTool}),this._observerManipulator=new Zt(this.view,this.parentTool),this.addHandles([M((()=>this.viewshedComputedData?.observerRenderSpace),(e=>{e!=null&&(this._moveManipulation.renderLocation=e,this._observerManipulator.renderLocation=e)}),de),M((()=>this.viewshedComputedData?.heading),(e=>{e&&(this._moveManipulation.angle=y(90-e))}),x),M((()=>{const{viewshedComputedData:e}=this;return{viewshedComputedData:e,observer:e?.observer}}),(({viewshedComputedData:e,observer:s},a)=>{this._grabbing&&s!==a?.observer||(this.removeHandles(yt),e?.valid&&this.addHandles([this._buildObserverDragPipeline(e),this._buildFOVDragPipeline(e),this._buildScaleOrientDragPipeline(e)].filter(ps),yt))}),x),M((()=>{const e=this.viewshedComputedData;return e?.valid?{viewshedCompData:e,target:e.targetRenderSpace,hFOV:e.horizontalFieldOfView,vFOV:e.verticalFieldOfView}:null}),(e=>{e!=null&&this._fieldOfViewManipulation.updateManipulatorsTransform(e.viewshedCompData)}),x),M((()=>{const e=this.viewshedComputedData;return e?.valid?{viewshedCompData:e,hFOV:e.horizontalFieldOfView,vFOV:e.verticalFieldOfView,tilt:e.tilt}:null}),(e=>{e!=null&&this._fieldOfViewManipulation.updateManipulatorVisuals(e.viewshedCompData)}),x),M((()=>{const e=this.analysisViewData.visible&&(this.viewshedComputedData?.valid??!1),s=this.parentTool.selectedViewshedComputedData===this.viewshedComputedData;return{fovManipulationAvailable:e&&!this.parentTool.isPlacingTarget,nonFOVManipulationAvailable:e&&(!this.parentTool.creating||s)}}),(({fovManipulationAvailable:e,nonFOVManipulationAvailable:s})=>{this._moveManipulation.available=s,this._scaleOrientManipulation.available=s,this._observerManipulator.available=s,this._fieldOfViewManipulation.available=e}),x),M((()=>{const e=this.viewshedComputedData;if(!e?.valid)return null;const{observer:s,target:a,verticalFieldOfView:r,horizontalFieldOfView:o}=e;return{viewshedCompData:e,observer:s,target:a,verticalFieldOfView:r,horizontalFieldOfView:o}}),(e=>{e!=null&&this._scaleOrientManipulation.updateManipulators(e.viewshedCompData)}),x)]);const t=e=>{const s=this.analysisViewData;this.addHandles([e.events.on("focus-changed",(()=>{const a=this._someManipulatorHovering();a&&this.parentTool.subToolHandles.forEach((({subTool:r})=>{r._resetHoveringTask()})),this._someManipulatorSelected()||a||(this._forceHoveringTask=ui((async r=>{await(this._forceHoveringTestPromise??pi(H.hoverTimeoutMilliseconds,r)),vi(r),this._forceHoveringTask=null,this._updateManipulatorVisibility()})))})),e.events.on("grab-changed",(a=>{this._grabbing=a.action==="start",a.action==="end"&&s.tool?.updateInteractionVisualsVisibility(),this.parentTool.subToolHandles.forEach((({subTool:r})=>{r!==this&&r._setInteractive(!this._grabbing)})),this._setInteractive((r=>r.hasManipulator(e)||!this._grabbing))})),e.events.on("drag",(a=>{a.action==="start"&&s.tool?.updateInteractionVisualsVisibility()}))])};this._forEachManipulator(t)}destroy(){this._forceHoveringTask=Be(this._forceHoveringTask),this._moveManipulation=C(this._moveManipulation),this._fieldOfViewManipulation=C(this._fieldOfViewManipulation),this._scaleOrientManipulation=C(this._scaleOrientManipulation),this.parentTool.manipulators.remove(this._observerManipulator),this._observerManipulator=C(this._observerManipulator)}get viewshed(){return this.viewshedComputedData?.viewshed}get grabbing(){return this._grabbing}get observer(){return this.viewshed?.observer}set observer(t){const e=this.viewshed;e!=null&&(e.observer=t)}get discManipulator(){return this._moveManipulation.xyManipulation.discManipulator}get moveInteractionState(){const{dragging:t,grabbing:e}=this._moveManipulation;return{dragging:t,grabbing:e}}get scaleOrientInteractionState(){const{dragging:t,grabbing:e}=this._scaleOrientManipulation;return{dragging:t,grabbing:e}}_setInteractive(t){const e=typeof t=="boolean";this._forEachManipulation((s=>s.interactive=e?t:t(s)))}onManipulatorSelectionChanged(){this._updateManipulatorVisibility(),!this._someManipulatorSelected()&&(this.analysisViewData.selectedViewshed===this.viewshed&&(this.analysisViewData.selectedViewshed=null),this._resetHoveringTask())}hasManipulator(t){let e=!1;return this._forEachManipulator((s=>{e=e||s===t})),e}_someManipulatorSelected(){return this._moveManipulation.selected||this._fieldOfViewManipulation.selected||this._scaleOrientManipulation.selected}_someManipulatorHovering(){return this._moveManipulation.hovering||this._fieldOfViewManipulation.hovering||this._scaleOrientManipulation.hovering}_createMoveManipulation(){return new $s({view:this.view,tool:this.parentTool,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:Kt})}_buildObserverDragPipeline(t){const e={mode:"absolute-height",offset:0},s=t.observer;if(s==null)return null;const a=this.view.spatialReference;return this._moveManipulation.createDragPipeline(((r,o,l,d,u)=>{d=d.next(Ce(this,["observer"]));const h=ci(s,a);if(h==null)return{steps:l,cancel:d};const v=Cs.fromGeometry(h,di(this.view.viewingMode));return{steps:l.next(As({operations:v})).next((w=>(this.observer=v.data.geometry,w))),cancel:d}}),e,a,void 0)}_buildFOVDragPipeline(t){let e=0,s=0;return this._fieldOfViewManipulation.createDragPipeline(((a,r,o)=>{if(t==null)return{steps:r,cancel:o};const l=t.viewshed;let d=null;return o=o.next(Ce(l,["horizontalFieldOfView","verticalFieldOfView"])),{steps:r.next((u=>{u.action==="start"&&(d=null,e=t.horizontalFieldOfView,s=t.verticalFieldOfView);const h=u.deltaAngle;if(d==null&&h!==0){const f=u.side==="bottom"||u.side==="left"?h>0:h<0;d=_e(u.side)?e===0&&f||e===360&&!f:s===0&&f}const v=d?Xs(u.side):u.side;let w=0;switch(v){case"left":w=e/2-h;break;case"right":w=e/2+h;break;case"top":w=s+2*h;break;case"bottom":w=s-2*h}return _e(v)?(w=it.normalize(w),w=w>270?0:w>180?180:w,l.horizontalFieldOfView=2*w):l.verticalFieldOfView=w,u})),cancel:o}}),t)}_buildScaleOrientDragPipeline(t){let e=0,s=0;const a=(r,o)=>(l,d,u)=>{if(t==null)return{steps:d,cancel:u};const h=t.viewshed;return u=u.next(Ce(h,[r])),{steps:d=d.next(o(h,t)),cancel:u}};return kt([this._scaleOrientManipulation.createHeadingDragPipeline(a("heading",((r,o)=>l=>(l.action==="start"&&(s=t.heading),r.heading=it.normalize(s+l.deltaAngle),l))),t),this._scaleOrientManipulation.createTiltDragPipeline(a("tilt",((r,o)=>l=>{l.action==="start"&&(e=t.tilt);let d=e+l.deltaAngle;return d<-90?d=180:d>270&&(d=0),r.tilt=aa.clamp(d),l})),t),this._scaleOrientManipulation.createDistanceDragPipeline(a("farDistance",((r,o)=>l=>{const d=P(sa,l.renderEnd,o.observerRenderSpace),u=me(d)*o.metersPerUnit,h=fe(d,o.targetDirection)<0?H.scaleOrientMinDistance:u;return r.farDistance=h,l})),t)])}_updateManipulatorVisibility(){const t=this._someManipulatorSelected(),e=this._forceHoveringTask!=null||this._someManipulatorHovering(),s=this._fieldOfViewManipulation.hovering,a=this.parentTool.creating;let r=[];const o=l=>{r.push(l.disableDisplay())};t||!a&&e?this.removeHandles(St):(this._scaleOrientManipulation.forEachManipulator(o),this._moveManipulation.forEachManipulator(o),this.addHandles(r,St),r=[]),t||!a&&e||a&&s?this.removeHandles(Dt):(this._fieldOfViewManipulation.forEachManipulator(o),this.addHandles(r,Dt)),t||!a?this.removeHandles(Ot):this.addHandles(this._observerManipulator.disableDisplay(),Ot)}_resetHoveringTask(){this._forceHoveringTask=Be(this._forceHoveringTask),this._updateManipulatorVisibility()}_forEachManipulator(t){this._forEachManipulation((e=>{e.forEachManipulator(t)})),t(this._observerManipulator)}_forEachManipulation(t){t(this._moveManipulation),t(this._fieldOfViewManipulation),t(this._scaleOrientManipulation)}get test(){return{moveManipulation:this._moveManipulation,fieldOfViewManipulation:this._fieldOfViewManipulation,scaleOrientManipulation:this._scaleOrientManipulation,viewshedComputedData:this.viewshedComputedData,setHoveringTimeoutPromise:t=>{this._forceHoveringTestPromise=t}}}};n([c({constructOnly:!0})],L.prototype,"analysis",void 0),n([c({constructOnly:!0})],L.prototype,"analysisViewData",void 0),n([c({constructOnly:!0})],L.prototype,"parentTool",void 0),n([c({constructOnly:!0,nonNullable:!0})],L.prototype,"view",void 0),n([c()],L.prototype,"viewshed",null),n([c()],L.prototype,"_grabbing",void 0),n([c()],L.prototype,"grabbing",null),n([c()],L.prototype,"viewshedComputedData",void 0),n([c()],L.prototype,"observer",null),L=n([se("esri.views.3d.analysis.Viewshed.ViewshedSubTool")],L);const sa=p(),aa=new wi(0,180),He=Symbol("interactionVisuals");let O=class extends fs{constructor(i){super(i),this.removeIncompleteOnCancel=!1,this.automaticManipulatorSelection=!1,this._stagedViewshed=null,this._stagedViewshedComputedData=null,this._placementMode=xt,this._creationState=!1,this._interactionVisualElements=null,this._settings=new xs({getTheme:()=>this.view.effectiveTheme}),this._selectedManipulator=null}initialize(){this._intersector=Es(this.view.state.viewingMode),this._createInteractionVisuals();const i=this.analysisViewData.viewshedComputedDataHandles;this.subToolHandles=Ge((()=>i),(({viewshedComputedData:t})=>{const e=new L({analysis:this.analysis,analysisViewData:this.analysisViewData,parentTool:this,view:this.view,viewshedComputedData:t});return{subTool:e,remove:()=>{this.selectedViewshed===t.viewshed&&(this.selectedViewshed=null),e.destroy()}}})),this.addHandles([ge((()=>this._valid),(()=>this.finishToolCreation()),de),M((()=>this._stagedViewshed),(t=>{const e=this.analysisViewData.viewshedComputedDataHandles;this._stagedViewshedComputedData=t!=null&&e!=null?this._findSubTool(t)?.viewshedComputedData:null}),de),this.analysis.viewsheds.on("after-remove",(t=>{const e=this._stagedViewshed;e!=null&&t.item===e&&this.analysis.viewsheds.add(e)})),M((()=>this.firstGrabbedManipulator),(t=>{if(t!=null){const e=this._findSubTool(t)?.viewshed;this.selectedViewshed=e,this._selectManipulator(t)}else this._selectedSubTool?.onManipulatorSelectionChanged()}),Bt),M((()=>this.view.activeTool),(t=>{t!==this&&t!=null&&(this.selectedViewshed=null)})),ge((()=>{const t=this.selectedViewshedComputedData;return t==null?null:{subTool:this._selectedSubTool,observer:t.observerRenderSpace,target:t.targetRenderSpace}}),(t=>{const{subTool:e,observer:s,target:a}=t;e?.moveInteractionState.dragging?this._updateInteractionVisualsLocation(s,!0):e?.scaleOrientInteractionState.dragging&&this._updateInteractionVisualsLocation(a,!1)}),x),M((()=>this.creating),(()=>this.updateInteractionVisualsVisibility())),M((()=>this.selectedViewshed),(t=>{const e=this._selectedManipulator,s=this._selectedSubTool;t==null?this._selectManipulator(null):e!=null&&s.hasManipulator(e)||this._selectManipulator(s.discManipulator)}),x)])}destroy(){this.subToolHandles=C(this.subToolHandles),this.removeHandles(He)}onDeactivate(){this.removeStaged(),this._creationState=!1}get _valid(){return this.analysisViewData.viewshedComputedDataHandles?.some((i=>i.viewshedComputedData.valid))??!1}get cursor(){return this.creating?"crosshair":null}get _selectedSubTool(){return this._findSubTool(this.selectedViewshed)}_selectManipulator(i){const t=this._selectedManipulator;t!==i&&(this._selectedManipulator=i,t!=null&&(t.selected=!1),i!=null&&(i.selected=!0),this._findSubTool(t)?.onManipulatorSelectionChanged(),this._selectedSubTool?.onManipulatorSelectionChanged())}get selectedViewshed(){return this.analysisViewData.selectedViewshed}set selectedViewshed(i){this.analysisViewData.selectedViewshed=i}get selectedViewshedComputedData(){return this._selectedSubTool?.viewshedComputedData}get stagedViewshed(){return this._stagedViewshed}get grabbing(){return this.subToolHandles.some((({subTool:i})=>i.grabbing))}get creating(){return this._creationState&&this.active}get isPlacingTarget(){return this._creationState==="placing-target"}place(i){this.selectedViewshed=null,this._placementMode=i,this._creationState="placing-observer",this._finishToolCreationIfValid()}onManipulatorSelectionChanged(){this.subToolHandles.forEach((i=>i.subTool.onManipulatorSelectionChanged()))}onInputEvent(i){switch(i.type){case"immediate-double-click":this._doubleClickHandler(i);break;case"pointer-move":this._pointerMoveHandler(i);break;case"key-down":st.cancel===i.key?this._cancelKeyHandler(i):st.delete.includes(i.key)&&this._deleteKeyHandler();break;case"hold":this.updateInteractionVisualsVisibility(!0)}}onInputEventAfter(i){i.type==="immediate-click"&&this._clickPlacementHandler(i)}onActivate(){this._placementMode=xt}_clickPlacementHandler(i){if(!this.creating||this.hasFocusedManipulators)return;const t=this._intersectScreen(i,$t);if(t!=null){if(this._creationState==="placing-observer"){t.mapPoint.z=(t.mapPoint.z??0)+Us;const e=new Ds({observer:t.mapPoint.clone(),feature:t.feature});this.analysis.viewsheds.add(e),this._stagedViewshed=e,this._creationState="placing-target",this._updateStagedViewshed(t.scenePoint)}else if(this._creationState==="placing-target"){this._updateStagedViewshed(t.scenePoint);const e=this._stagedViewshed;this._stagedViewshed=null,this._placementMode==="multiple"?this._creationState="placing-observer":(this._creationState=!1,this._stagedViewshed=null,this._finishToolCreationIfValid(),this.view.activeTool=null),this.selectedViewshed=e}i.stopPropagation()}}_doubleClickHandler(i){this.creating&&(this.removeStaged(),this._creationState=!1,this.view.activeTool=null,i.stopPropagation())}_pointerMoveHandler(i){if(!this.creating)return;const t=this._intersectScreen(i,$t);t!=null&&(this._updateInteractionVisualsLocation(t.scenePoint,!1),this._updateStagedViewshed(t.scenePoint))}_cancelKeyHandler(i){this.creating?this._onCancelWhileCreating(i):this.grabbing||(this.selectedViewshed=null,i.stopPropagation())}_onCancelWhileCreating(i){const t=this.removeStaged();this._finishToolCreationIfValid(),t?(this._creationState="placing-observer",this.selectedViewshed=null,this._placementMode==="multiple"&&i.stopPropagation()):this._creationState=!1}_deleteKeyHandler(){this.creating&&(this.removeStaged(),this._creationState="placing-observer"),this.selectedViewshed!=null&&this.analysis.viewsheds.remove(this.selectedViewshed)}_finishToolCreationIfValid(){this._valid&&this.finishToolCreation()}_updateStagedViewshed(i){const t=this._stagedViewshed,e=this._stagedViewshedComputedData;if(t==null||e==null)return;const{heading:s,tilt:a,farDistance:r}=ra(this.view,e,i);t.farDistance=r,t.tilt=a,t.heading=s}removeStaged(){const i=this._stagedViewshed;return i!=null&&(this._stagedViewshed=null,this.analysis.viewsheds.remove(i),!0)}_intersectScreen(i,t){const e=fi(i);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(e,this._intersector);const s=this._intersector.results.min,a=t.scenePoint;if(!s.getIntersectionPoint(a))return null;const r=t.mapPoint;return r.spatialReference=this.view.spatialReference,this.view.renderCoordsHelper.fromRenderCoords(a,r),r==null?null:(t.feature=mi(s,this.view),t)}_createInteractionVisuals(){this.removeHandles(He);const i=this._settings.visualElements,t=new Fs({view:this.view,attached:!1,style:{glowWidth:i.heightPlane.glowWidth,innerWidth:i.heightPlane.innerWidth},isDecoration:!0}),e=new Ps({view:this.view,extensionType:i.zVerticalLine.extensionType,attached:!1,innerWidth:1,writeDepthEnabled:!1,renderOccluded:ne.OccludeAndTransparent,isDecoration:!0});this._interactionVisualElements={laserline:t,verticalLine:e},this.addHandles([M((()=>i.zVerticalLine),(s=>s.apply(e)),de),M((()=>i.heightPlane),(s=>s.apply(t)),de),gi((()=>{t.destroy(),e.destroy(),this._interactionVisualElements=null}))],He)}updateInteractionVisualsVisibility(i=!1){const t=this.creating,e=this.analysisViewData.visible,s=this._selectedSubTool,a=this.selectedViewshedComputedData,r=(v,w)=>{const f=this._interactionVisualElements;f!=null&&(f.verticalLine.attached=w,f.laserline.attached=v)};if(t)return void r(e,!1);if(s==null||a==null)return void r(!1,!1);const o=s.moveInteractionState,l=i?o.grabbing:o.dragging,d=s.scaleOrientInteractionState,u=i?d.grabbing:d.dragging,h=e&&(l||u);if(r(h,l),h){const v=l?a.observerRenderSpace:a.targetRenderSpace;this._updateInteractionVisualsLocation(v,l)}}_updateInteractionVisualsLocation(i,t){const e=this._interactionVisualElements;if(e==null)return;const{laserline:s,verticalLine:a}=e;s.heightManifoldTarget=i,s.intersectsWorldUpAtLocation=t?i:null,i!=null&&a.setStartEndFromWorldDownAtLocation(i)}_findSubTool(i){if(i==null)return null;const t=i instanceof $e?e=>e.subTool.hasManipulator(i):e=>e.subTool.viewshed===i;return this.subToolHandles?.find(t)?.subTool}get test(){}};function ra(i,t,e){const s=t.observerRenderSpace,a=P(oa,e,s),r=me(a)*t.metersPerUnit,o=i.renderCoordsHelper.basisMatrixAtPosition(s,ha),l=Q(na,o[8],o[9],o[10]),d=Lt(s,l,ca),u=_i(d,e,la),h=P(u,u,s),v=(me(h)<1e-4?90:we(Se(a,h)))*(fe(l,a)<0?-1:1)+90,w=Q(Tt,o[4],o[5],o[6]),f=we(Se(w,h)),m=Q(Tt,o[0],o[1],o[2]);return{heading:fe(h,m)<0?360-f:f,tilt:v,farDistance:r}}n([c({constructOnly:!0})],O.prototype,"view",void 0),n([c()],O.prototype,"analysisViewData",void 0),n([c()],O.prototype,"removeIncompleteOnCancel",void 0),n([c()],O.prototype,"automaticManipulatorSelection",void 0),n([c({constructOnly:!0})],O.prototype,"analysis",void 0),n([c()],O.prototype,"subToolHandles",void 0),n([c()],O.prototype,"_stagedViewshed",void 0),n([c()],O.prototype,"_stagedViewshedComputedData",void 0),n([c()],O.prototype,"_placementMode",void 0),n([c()],O.prototype,"_creationState",void 0),n([c()],O.prototype,"_valid",null),n([c({readOnly:!0})],O.prototype,"cursor",null),n([c()],O.prototype,"_selectedManipulator",void 0),n([c()],O.prototype,"_selectedSubTool",null),n([c()],O.prototype,"selectedViewshed",null),n([c()],O.prototype,"selectedViewshedComputedData",null),n([c()],O.prototype,"stagedViewshed",null),n([c()],O.prototype,"grabbing",null),n([c()],O.prototype,"creating",null),n([c()],O.prototype,"isPlacingTarget",null),O=n([se("esri.views.3d.analysis.Viewshed.ViewshedTool")],O);const oa=p(),na=p(),la=p(),Tt=p(),ha=S(),ca=Ut(),$t={mapPoint:new We,scenePoint:p(),feature:null},xt="multiple";class da extends ys{constructor(t){super(t),this._material=null,this._viewshedComputedData=null,this._material=new Gt({...Y.shapeMaterialParameters,isDecoration:this.isDecoration,writeDepth:!1}),this.applyProperties(t)}get viewshedComputedData(){return this._viewshedComputedData}set viewshedComputedData(t){this._viewshedComputedData=t,this.updateTransform()}updateTransform(){const t=this._viewshedComputedData;if(t==null)return;const e=S(),s=t.farDistanceRenderSpace;Te(e,J(s,s,s)),Ye(t,ve),W(e,ve,e),Ve(ve,this._viewshedComputedData.observerRenderSpace),W(e,ve,e),this.transform=e}createExternalResources(){}destroyExternalResources(){}forEachMaterial(t){t(this._material)}createGeometries(t){const{_material:e,viewshedComputedData:s}=this;s==null||e==null||!s.valid||ua(e,s).forEach((a=>t.addGeometry(a)))}}function ua(i,t){const{horizontalFieldOfView:e,verticalFieldOfView:s}=t,a=Q(pa,0,0,1),r=Q(At,0,1,0),o=Q(Ct,1,0,0);te(a,a,y(s/2),r),te(a,a,y(e/2),o);const l=b=>Math.ceil(Math.abs(b)/Qt)+1,d=y(e),u=B(va,o),h=l(d),v=Rt(-d/(h-1)),w=K(ve,v,u),f=y(-s),m=l(f),T=Rt(f/(m-1)),D=B(At,r),R=K(Pt,y(e)/2,o);q(D,D,R);const F=Pt,A=[],z=B(Ct,a);for(let b=0;b<h;b++){K(F,T,D);for(let _=0;_<m;_++){const V=3*(_*h+b);A[V]=z[0],A[V+1]=z[1],A[V+2]=z[2],q(z,z,F)}q(D,D,w),q(a,a,w),B(z,a)}const I=h*m;A[3*I]=0,A[3*I+1]=0,A[3*I+2]=0;const N=[];for(let b=0;b<h-1;b++)for(let _=0;_<m-1;_++){const V=6*(_*(h-1)+b);N[V]=_*h+b,N[V+1]=(_+1)*h+b,N[V+2]=_*h+b+1,N[V+3]=_*h+b+1,N[V+4]=(_+1)*h+b,N[V+5]=(_+1)*h+b+1}const X=[N];if(e!==360&&s!==0){const b=[],_=[];for(let V=0;V<m-1;V++){const $=3*V;b[$]=I,b[$+1]=(V+1)*h,b[$+2]=V*h,_[$]=I,_[$+1]=V*h+h-1,_[$+2]=(V+1)*h+h-1}X.push(b,_)}if(s!==180&&e!==0){const b=[],_=[];for(let V=0;V<h-1;V++){const $=3*V;b[$]=I,b[$+1]=V,b[$+2]=V+1,_[$]=I,_[$+1]=V+(m-1)*h+1,_[$+2]=V+(m-1)*h}X.push(b,_)}return X.map((b=>{const _=[[Vi.POSITION,new bi(A,b,3,!0)]];return new Mi(i,_)}))}function Rt(i){return isNaN(i)?1:i}const pa=p(),At=p(),Ct=p(),va=p(),ve=S(),Pt=S();let U=class extends be{constructor(t){super(t),this.visible=!0,this._viewshedCorners={topLeft:p(),topRight:p(),bottomLeft:p(),bottomRight:p()},this._arcCenterPoints={top:p(),bottom:p(),left:p(),right:p()},this._parallelCenters={top:p(),bottom:p()}}initialize(){const t={view:this.view,isDecoration:!0},e={...t,color:this._color,renderOccluded:ne.OccludeAndTransparent},s={...e,stipplePattern:zs(2)};this._observerVisualElement=new Hs({...t,...Y.observerPointConfiguration}),this._shapeVisualElement=new da({...t,isDecoration:this.isDecoration}),this._frameLinesVisualElement=new ae(e),this._leftArcVisualElement=new ae(e),this._rightArcVisualElement=new ae(e),this._topArcVisualElement=new ae(e),this._bottomArcVisualElement=new ae(e),this._centralLongitude=new ae(s),this._centralLatitude=new ae(s),this.addHandles([M((()=>{const a=this.viewshedComputedData;if(!a?.valid)return null;const r=this._viewshedCorners,o=this._arcCenterPoints,l=this._parallelCenters;return a.cornerPoints(r),a.arcCentersPoints(o),a.parallelCenterPoints(l),{viewshedComputedData:a,corners:r,arcCenters:o,parallelCenters:l,interactive:this.analysisViewData.interactive,selected:this._selected}}),(a=>{const r=a!=null;this._forEachVisualElement((o=>o.attached=r)),r&&this._updateVisualElements(a)}),{initial:!0,equals:vs}),M((()=>{const{viewshedComputedData:a}=this,{horizontalFieldOfView:r,verticalFieldOfView:o}=a??{};return{viewshedComputedData:a,horizontalFieldOfView:r,verticalFieldOfView:o}}),(({viewshedComputedData:a})=>{const{_shapeVisualElement:r}=this;a!==r.viewshedComputedData&&(r.viewshedComputedData=a),this._shapeVisualElement.recreateGeometry()}),x),M((()=>{const{interactive:a}=this.analysisViewData;return{visible:this.visible,selected:a&&this._selected,staged:a&&this._staged,horFovNot360:this.viewshedComputedData?.horizontalFieldOfView!==360}}),(({visible:a,selected:r,staged:o,horFovNot360:l})=>{const d=r||o;this._shapeVisualElement.visible=a,this._topArcVisualElement.visible=a,this._bottomArcVisualElement.visible=a,this._frameLinesVisualElement.visible=a&&l;const u=a&&(r||l);this._leftArcVisualElement.visible=u,this._rightArcVisualElement.visible=u,this._forEachLineVisualElement((h=>{h.width=d?Y.frameWidthSelected:Y.frameWidthNotSelected,h.renderOccluded=r?ne.OccludeAndTransparent:ne.Occlude})),[this._centralLatitude,this._centralLongitude].forEach((h=>{h.width=2*(d?Y.frameWidthSelected:Y.frameWidthNotSelected),h.visible=a&&r}))}),x),M((()=>{const{analysisViewData:{interactive:a,tool:r},_selected:o,visible:l}=this,d=this.view.activeTool,u=!r?.active&&d instanceof O&&d.creating;return{observerVisible:l&&!o&&(!a||(r?.creating??!1)||u),color:this._color}}),(({observerVisible:a,color:r})=>{this._observerVisualElement.visible=a,this._forEachLineVisualElement((o=>o.color=r))}),x)])}get _color(){const{viewshedComputedData:t,_selected:e,analysisViewData:s}=this;if(t==null)return ie.toUnitRGBA(Y.frameColor);const a=s.tool?.active||s.interactive,r=t.viewshed===s.tool?.stagedViewshed,o=a&&(e||r)?this.view.effectiveTheme.accentColor:Y.frameColor;return ie.toUnitRGBA(o)}get _selected(){const{viewshedComputedData:t,analysisViewData:{selectedViewshedComputedData:e}}=this;return t!=null&&t===e}get _staged(){const{analysisViewData:{tool:t},viewshedComputedData:e}=this;return t!=null&&t.creating&&t.stagedViewshed===e?.viewshed}destroy(){this._observerVisualElement=C(this._observerVisualElement),this._shapeVisualElement=C(this._shapeVisualElement),this._frameLinesVisualElement=C(this._frameLinesVisualElement),this._leftArcVisualElement=C(this._leftArcVisualElement),this._rightArcVisualElement=C(this._rightArcVisualElement),this._topArcVisualElement=C(this._topArcVisualElement),this._bottomArcVisualElement=C(this._bottomArcVisualElement),this._centralLongitude=C(this._centralLongitude),this._centralLatitude=C(this._centralLatitude)}_forEachLineVisualElement(t){[this._frameLinesVisualElement,this._leftArcVisualElement,this._rightArcVisualElement,this._topArcVisualElement,this._bottomArcVisualElement,this._centralLatitude,this._centralLongitude].forEach(t)}_forEachVisualElement(t){this._forEachLineVisualElement(t),t(this._observerVisualElement),t(this._shapeVisualElement)}_updateVisualElements(t){const{viewshedComputedData:e,corners:s,arcCenters:a,parallelCenters:r}=t,o=Wt(e.observerRenderSpace);this._observerVisualElement.geometry=e.observer,this._shapeVisualElement.updateTransform(),this._updateFrameLines(o,s),this._updateFrameArcs(e,s,r),this._updateCentralHelperArcs(e,a)}_updateFrameLines(t,e){this._frameLinesVisualElement.geometry=[[t,e.topLeft],[t,e.topRight],[t,e.bottomLeft],[t,e.bottomRight]]}_updateFrameArcs(t,e,s){const{observerRenderSpace:a,rightVector:r,horizontalFieldOfView:o,tiltedUpVector:l}=t,d=y(o),u=p(),h=S();K(h,d/2,l),q(u,r,h),he(this._leftArcVisualElement,a,e.bottomLeft,e.topLeft,"forward",u),K(h,-d/2,l),Q(u,0,0,0),q(u,r,h),he(this._rightArcVisualElement,a,e.bottomRight,e.topRight,"forward",u);const v=o>180?"backward":"forward";he(this._topArcVisualElement,s.top,e.topRight,e.topLeft,v,l),he(this._bottomArcVisualElement,s.bottom,e.bottomRight,e.bottomLeft,v,l)}_updateCentralHelperArcs(t,e){const s=t.observerRenderSpace,a=t.horizontalFieldOfView>=180?"backward":"forward";he(this._centralLatitude,s,e.right,e.left,a,t.tiltedUpVector),he(this._centralLongitude,s,e.top,e.bottom,"forward",t.leftVector)}get test(){}};function he(i,t,e,s,a,r,o=Qt){const l=p();P(l,e,t);const d=me(l),u=p();P(u,s,t),ue(u,u),j(u,u,d);let h=Se(l,u);const v=Wt(r);a==="backward"&&(Qe(v,v),h=-(2*Math.PI-h));const w=[],f=Math.ceil(Math.abs(h)/o),m=S();K(m,h/f,v);const T=p();B(T,l);const D=p();B(D,e);for(let R=0;R<f;R++){const F=p();B(F,D),q(T,T,m),G(D,t,T);const A=p();B(A,D),w.push([F,A])}i.geometry=w}n([c()],U.prototype,"view",void 0),n([c({constructOnly:!0})],U.prototype,"isDecoration",void 0),n([c()],U.prototype,"analysisViewData",void 0),n([c()],U.prototype,"viewshedComputedData",void 0),n([c()],U.prototype,"visible",void 0),n([c()],U.prototype,"_color",null),n([c()],U.prototype,"_selected",null),n([c()],U.prototype,"_staged",null),U=n([se("esri.views.3d.analysis.Viewshed.ViewshedVisualization")],U);let re=class extends be{get visible(){return this.analysisViewData.visible}constructor(i){super(i)}initialize(){const i=this.analysisViewData,t=Ge((()=>this.analysisViewData.viewshedComputedDataHandles),(({viewshedComputedData:e})=>{const s=new U({view:this.view,viewshedComputedData:e,analysisViewData:i,isDecoration:this.isDecoration});return{visualization:s,remove:()=>s.destroy()}}));this._viewshedVisualizations=t,this.addHandles([yi(t),M((()=>this.visible),(e=>this._viewshedVisualizations.forEach((({visualization:s})=>s.visible=e))),x)])}get test(){}};n([c({constructOnly:!0})],re.prototype,"analysisViewData",void 0),n([c({constructOnly:!0,nonNullable:!0})],re.prototype,"view",void 0),n([c({constructOnly:!0})],re.prototype,"isDecoration",void 0),n([c()],re.prototype,"visible",null),re=n([se("esri.views.3d.analysis.Viewshed.ViewshedAnalysisVisualization")],re);var Je;let g=Je=class extends be{constructor(i){super(i),this.observerRenderSpaceOverride=null,this.needUpdateByFeature=!1}get observer(){return this.viewshed.observer??new We}get effectiveObserverRenderSpace(){return this.observerRenderSpaceOverride??this.observerRenderSpace}get effectiveObserver(){return this.renderSpaceToPoint(this.effectiveObserverRenderSpace,this.observer.spatialReference)}get effectiveTargetRenderSpace(){return this._computeTargetRenderSpace(this.effectiveObserverRenderSpace)}get farDistance(){return this.viewshed.farDistance}get farDistanceRenderSpace(){return this.farDistance/this.metersPerUnit}get heading(){return this.viewshed.heading}get tilt(){return this.viewshed.tilt}get feature(){return this.viewshed.feature}get tiltParallelToSurface(){return this.tilt-90}get horizontalFieldOfView(){return this.viewshed.horizontalFieldOfView}get verticalFieldOfView(){return this.viewshed.verticalFieldOfView}get observerRenderSpace(){return this._pointToRenderSpace(this.observer,p())}get target(){const i=this.targetRenderSpace;return this.renderSpaceToPoint(i,this.observer.spatialReference)}get targetRenderSpace(){return this._computeTargetRenderSpace(this.observerRenderSpace)}get targetDirection(){const i=P(p(),this.targetRenderSpace,this.observerRenderSpace);return ue(i,i)}get tiltedUpVector(){const i=te(p(),this.upVector,-y(this.tiltParallelToSurface),this.leftVector);return ue(i,i)}get _basis(){return this.renderCoordsHelper.basisMatrixAtPosition(this.observerRenderSpace,S())}get upVector(){const i=this._basis;return J(i[8],i[9],i[10])}get northVector(){const i=this._basis;return J(i[4],i[5],i[6])}get leftVector(){const i=this.upVector,t=te(p(),this.northVector,-y(this.heading),i);return Si(t,i,t)}get rightVector(){return Qe(p(),this.leftVector)}clone(){return new Je({renderCoordsHelper:this.renderCoordsHelper,viewshed:this.viewshed.clone()})}get valid(){return this.viewshed.valid}get metersPerUnit(){return this.renderCoordsHelper.spatialReference.metersPerUnit}pointOnSphere(i,t,e){const{observerRenderSpace:s,targetRenderSpace:a}=this,r=P(ze,a,s);return te(r,r,-y(t),this.leftVector),te(r,r,-y(i),this.tiltedUpVector),G(e,r,s)}cornerPoints(i){const t=this.horizontalFieldOfView/2,e=this.verticalFieldOfView/2;this.pointOnSphere(-t,e,i.topLeft),this.pointOnSphere(t,e,i.topRight),this.pointOnSphere(-t,-e,i.bottomLeft),this.pointOnSphere(t,-e,i.bottomRight)}arcCentersPoints(i){const t=this.horizontalFieldOfView/2,e=this.verticalFieldOfView/2;this.pointOnSphere(0,e,i.top),this.pointOnSphere(0,-e,i.bottom),this.pointOnSphere(-t,0,i.left),this.pointOnSphere(t,0,i.right)}parallelCenterPoints(i){const t=this.observerRenderSpace,e=this.farDistanceRenderSpace*Math.sin(y(this.verticalFieldOfView/2)),s=j(ze,this.tiltedUpVector,e);G(i.top,t,s),P(i.bottom,t,s)}renderSpaceToPoint(i,t){const e=ze;return this.renderCoordsHelper.fromRenderCoords(i,e,t),new We(e[0],e[1],e[2],t)}_pointToRenderSpace(i,t){const e=Di(i.toArray());return this.renderCoordsHelper.toRenderCoords(e,i.spatialReference,t),t}_computeTargetRenderSpace(i){const{leftVector:t,northVector:e,upVector:s}=this,a=this.farDistanceRenderSpace,r=p();return j(r,e,a),te(r,r,-y(this.heading),s),te(r,r,-y(this.tiltParallelToSurface),t),G(r,i,r),r}};n([c()],g.prototype,"renderCoordsHelper",void 0),n([c()],g.prototype,"viewshed",void 0),n([c()],g.prototype,"observerRenderSpaceOverride",void 0),n([c()],g.prototype,"needUpdateByFeature",void 0),n([c()],g.prototype,"observer",null),n([c()],g.prototype,"effectiveObserverRenderSpace",null),n([c()],g.prototype,"effectiveObserver",null),n([c()],g.prototype,"effectiveTargetRenderSpace",null),n([c()],g.prototype,"farDistance",null),n([c()],g.prototype,"farDistanceRenderSpace",null),n([c()],g.prototype,"heading",null),n([c()],g.prototype,"tilt",null),n([c()],g.prototype,"feature",null),n([c()],g.prototype,"tiltParallelToSurface",null),n([c()],g.prototype,"horizontalFieldOfView",null),n([c()],g.prototype,"verticalFieldOfView",null),n([c()],g.prototype,"observerRenderSpace",null),n([c()],g.prototype,"target",null),n([c()],g.prototype,"targetRenderSpace",null),n([c()],g.prototype,"targetDirection",null),n([c()],g.prototype,"tiltedUpVector",null),n([c()],g.prototype,"_basis",null),n([c()],g.prototype,"upVector",null),n([c()],g.prototype,"northVector",null),n([c()],g.prototype,"leftVector",null),n([c()],g.prototype,"rightVector",null),n([c()],g.prototype,"valid",null),n([c()],g.prototype,"metersPerUnit",null),g=Je=n([se("esri.views.3d.analysis.Viewshed.ViewshedComputedData")],g);const ze=p();let Z=class extends Oi{constructor(){super(...arguments),this.sectionAngles=Ti()}get sectionAnglesDeg(){return at(this.sectionAngles.map((t=>we(t))))}set sectionAnglesDeg(t){this.sectionAngles=at(t.map((e=>y(e))))}get projectionMatrix(){return W(S(),this.sectionMatrix,this._projectionMatrixInternal)}get sectionMatrix(){const t=this.sectionAngles[0],e=this.sectionAngles[1],s=this.sectionAngles[2],a=this.sectionAngles[3];ke(t<=e),ke(s<=a);const r=2*Math.tan(this.fovX/2),o=2*Math.tan(this.fovY/2),l=Math.tan(t),d=Math.tan(e),u=Math.tan(s),h=d-l,v=Math.tan(a)-u,w=r/h,f=o/v,m=-(l+h/2)/r*2,T=-(u+v/2)/o*2,D=S();Ve(D,[m,T,0]);const R=S();Te(R,[w,f,1]);const F=S();return W(F,R,D)}get _sectionRatioX(){const t=Math.tan(this.sectionAngles[0]),e=Math.tan(this.sectionAngles[1]),s=2*Math.tan(this.fovX/2);return Math.min(1,(e-t)/s)}setViewport(t,e){const s=e*this._sectionRatioX;return this.viewport=[t[0],t[1],s,e],s}};n([c()],Z.prototype,"sectionAngles",void 0),n([c()],Z.prototype,"sectionAnglesDeg",null),n([c()],Z.prototype,"projectionMatrix",null),n([c()],Z.prototype,"sectionMatrix",null),n([c()],Z.prototype,"_sectionRatioX",null),Z=n([se("esri.views.3d.webgl-engine.lib.ViewshedFaceCamera")],Z);class wa{constructor(){this.textureSizeQuality=1,this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.textureSizeMultiple=128,this.toleranceSides=5,this.toleranceBottomTop=10}textureSizeModifier(t){const e=t?this.textureSizeModHighQuality:this.textureSizeModLowQuality;return this.textureSizeQuality*e}textureResizeModulo(t){return Math.ceil(t/this.textureSizeMultiple)*this.textureSizeMultiple}}const Ft=["front","left","right","back","top","bottom"];function fa(i){return!["top","bottom"].includes(i)}class ma{constructor(t){this._fbos=t,this._faces={},this._width=0,this._height=0,this.settings=new wa,this._maxTextureSize=Math.min(ws("esri-mobile")?4096:16384,t.rctx.parameters.maxTextureSize)}get depthTexture(){return this._handle?.getTexture(rt)}get ready(){return this.depthTexture!=null&&this._width!==0&&this._height!==0}get nearFar(){const t=this.faces;return t.length===0?null:t[0].nearFar}get numActiveFaces(){const t=this._faces;let e=0;return Object.keys(t).forEach((s=>{t[s]&&(e+=1)})),e}get faces(){const t=this._faces,e=[];for(const s of Ft){const a=t[s];a&&e.push(a)}return e}get atlasRegions(){return this.faces.map((t=>[t.x/this._width,(t.x+t.width)/this._width,t.y/this._height,(t.y+t.height)/this._height]))}get viewshedProjectionMatrices(){return this.faces.map((t=>t.projectionMatrix))}get viewshedViewMatrices(){return this.faces.map((t=>t.viewMatrix))}_setupFaceCamera(t,e,s,a){const{effectiveObserverRenderSpace:r,tiltedUpVector:o,targetRenderSpace:l,farDistanceRenderSpace:d,horizontalFieldOfView:u,verticalFieldOfView:h}=e,v=p();P(v,l,r);const w=p(),f=p(),m=(_,V)=>{const $=p(),et=S();return K(et,_,V),q($,v,et),G($,r,$),$};let T,D=o;const R=Math.min(90,u),F=Math.min(90,Math.max(0,(u-90)/2));let A=-45,z=45,I=-45,N=45;if(fa(t)){const _=V=>Ke(V,-45,45);I=_(-h/2)-this.settings.toleranceBottomTop,N=_(+h/2)+this.settings.toleranceBottomTop}switch(t){case"front":T=l,A=-R/2,z=R/2;break;case"left":T=m(Math.PI/2,o),A=45-F;break;case"right":T=m(-Math.PI/2,o),z=-45+F;break;case"top":T=G(w,r,o),D=Qe(f,v);break;case"bottom":T=P(w,r,o),D=v;break;case"back":T=m(Math.PI,o)}const X=new Z({center:T,eye:r,up:D,far:d});X.sectionAnglesDeg=[A-this.settings.toleranceSides,z+this.settings.toleranceSides,I,N],X.fovY=Math.PI/2;const b=X.setViewport(s,a);return this._faces[t]=X,b}isActive(t){return this._computeActiveFaces(t).size>0}_computeActiveFaces(t){const e=new Set,{horizontalFieldOfView:s,verticalFieldOfView:a}=t,r=-a/2,o=a/2;return s===0||a===0||(r<=45&&o>=-45&&e.add("front"),s>90&&(e.add("left"),e.add("right")),s>270&&e.add("back"),o>45-this.settings.toleranceBottomTop&&e.add("top"),r<-45+this.settings.toleranceBottomTop&&e.add("bottom")),e}_computeBaseTextureSize({pixelRatio:t,fullWidth:e,fullHeight:s},a,r,o){const l=a/t,d=this.settings.textureSizeModifier(r);return $i(Math.max(e,s)*l*d,this._maxTextureSize/o)}_ensureFBO(t){const e=this._width,s=this._height,a=this._handle?.fbo;a&&a.width===e&&a.height===s&&t===xi(a.depthStencilTexture?.descriptor?.internalFormat??Ri.DEPTH_COMPONENT16)||(this._handle?.release(),this._handle=this._allocateFBO(t))}_allocateFBO(t){const{_width:e,_height:s}=this,a=t?ot.DEPTH24_STENCIL8:ot.DEPTH16,r=this._fbos.acquire(e,s,"viewshed shadow map",a);return r.getTexture(rt)?.setShadowFiltering(!1),r}clearFBO(t){const e=this._fbos.rctx;this._ensureFBO(t),e.bindFramebuffer(this._handle?.fbo),e.setClearColor(1,1,1,1),e.clear(nt.COLOR|nt.DEPTH)}dispose(){this._debugFBO||(this._handle=Ai(this._handle))}start(t,e,s,a,r=!1){this._faces={};const o=this._computeActiveFaces(e),l=o.size;if(l===0)return!1;const d=this._computeBaseTextureSize(t,a,s,l);let u=0,h=0,v=0;return Ft.filter((w=>o.has(w))).forEach((w=>{const f=ga(w,l);f>h&&(v=Math.max(v,u),u=0),h=f;const m=f*d;u+=this._setupFaceCamera(w,e,[u,m],d)})),v=Math.max(v,u),this._width=this.settings.textureResizeModulo(v),this._height=_a(l)*d,this.clearFBO(r),!0}finish(){}get test(){}}function ga(i,t){if(t<4)return 0;const e=i==="front"||i==="left";return t===4?e?0:1:e||i==="right"?0:1}function _a(i){return i<4?1:2}class Va extends Ci{constructor(){super(...arguments),this.localOrigin=Pi()}}function ba(i){i.include(Fi),i.fragment.uniforms.add(new Ei("inverseViewMatrix",((t,e)=>{const s=Nt(S(),e.camera.viewMatrix,t.localOrigin);return qt(s,s)}))).code.add(Ne`vec4 reconstructLocalPosition(vec2 coord, float linearDepth) {
vec4 cameraSpace = vec4(reconstructPosition(coord, linearDepth), 1.0);
return inverseViewMatrix * cameraSpace;
}`)}let Ze=class extends Va{constructor(){super(...arguments),this.shadowMap={depthTexture:null,nearFar:[1,100],numActiveFaces:1,atlasRegions:[[0,0,1,1]]},this.targetVector=[1,0,0],this.upVector=[0,0,1],this.fovs=[45,45],this.headingAndTilt=[0,0],this.observerOffset=[0,0,0],this.projectionMatrices=lt.flat(),this.viewMatrices=lt.flat(),this.volumeOffset=0}};function ei(){const i=new Hi,t=i.fragment;return i.include(zi),i.include(ba),t.include(Ii),t.include(Li),t.uniforms.add(new Ui("depthTexture",(e=>e.depth?.attachment)),new ht("inverseProjectionMatrix",(e=>e.camera.inverseProjectionMatrix)),new ht("inverseViewNormalMatrix",(({camera:e})=>qt(Ma,e.viewInverseTransposeMatrix))),new xe("viewshedObserverOffset",(e=>e.observerOffset)),new xe("viewshedTargetVector",(e=>e.targetVector)),new xe("viewshedUpVector",(e=>e.upVector)),new Re("viewshedFOVs",(e=>e.fovs)),new Re("viewshedHeadingAndTilt",(e=>e.headingAndTilt)),new Re("viewshedNearFar",(e=>e.shadowMap.nearFar??[1,100])),new ki("viewshedVolumeOffset",(e=>e.volumeOffset)),new ct("viewshedShadowMap",(e=>e.shadowMap.depthTexture)),new dt("viewshedProjectionMatrices",(e=>e.projectionMatrices),6),new dt("viewshedViewMatrices",(e=>e.viewMatrices),6),new ji("viewshedNumFaces",(e=>e.shadowMap.numActiveFaces)),new Bi("viewshedAtlasRegions",(e=>e.shadowMap.atlasRegions.flat()),24),new ct("normalMap",(e=>e.normals))),t.constants.add("visibleColor","vec4",[0,1,0,.5]),t.constants.add("occludedColor","vec4",[1,0,0,.5]),t.code.add(Ne`vec2 getViewshedUv(vec4 worldPosition, int face) {
mat4 viewshedMatrix = viewshedProjectionMatrices[face];
vec4 viewshedUv4 = viewshedMatrix * worldPosition;
vec3 viewshedUv = viewshedUv4.xyz / viewshedUv4.w;
return viewshedUv.xy;
}
float viewshedDepthToFloat(float depth) {
return (depth - viewshedNearFar[0]) / (viewshedNearFar[1] - viewshedNearFar[0]);
}
float getOrthographicDepthToViewshed(vec4 worldPosition, int face) {
mat4 viewshedViewMatrix = viewshedViewMatrices[face];
vec4 viewshedUv4 = viewshedViewMatrix * worldPosition;
vec3 viewshedUv = viewshedUv4.xyz / viewshedUv4.w;
float depth = -viewshedUv.z;
return viewshedDepthToFloat(depth);
}
float viewshedReadShadowMapDepth(sampler2D _viewshedShadowmap, ivec2 uv) {
return texelFetch(_viewshedShadowmap, uv, 0).r;
}
float viewshedFilterShadow(sampler2D _viewshedShadowmap, vec2 uv) {
vec2 uvScaled = uv * vec2(textureSize(_viewshedShadowmap, 0));
vec2 st    = fract(uvScaled);
ivec2 base = ivec2(uvScaled);
float s00 = viewshedReadShadowMapDepth( _viewshedShadowmap, ivec2(base.x,     base.y    ));
float s10 = viewshedReadShadowMapDepth( _viewshedShadowmap, ivec2(base.x + 1, base.y    ));
float s11 = viewshedReadShadowMapDepth( _viewshedShadowmap, ivec2(base.x + 1, base.y + 1));
float s01 = viewshedReadShadowMapDepth( _viewshedShadowmap, ivec2(base.x,     base.y + 1));
return mix(mix(s00, s10, st.x), mix(s01, s11, st.x), st.y);
}
float viewshedTextureAtlasLookup(sampler2D _viewshedShadowmap, vec2 uv, vec4 atlasRegion) {
vec2 atlasScale = atlasRegion.zw - atlasRegion.xy;
vec2 uvAtlas = fract(uv) * atlasScale + atlasRegion.xy;
return viewshedFilterShadow(_viewshedShadowmap, uvAtlas);
}
float getDepthFromShadowMap(vec2 uv, int face) {
int index = 4 * face;
float umin = viewshedAtlasRegions[index];
float umax = viewshedAtlasRegions[index + 1];
float vmin = viewshedAtlasRegions[index + 2];
float vmax = viewshedAtlasRegions[index + 3];
vec4 atlasRegion = vec4(umin, vmin, umax, vmax);
return viewshedTextureAtlasLookup(viewshedShadowMap, uv, atlasRegion);
}
struct ViewshedPoint {
int face;
vec2 uv;
bool isWithin;
float orthographicDepth;
};
mat3 rotationMatrix(vec3 axis, float angle)
{
float s = sin(angle);
float c = cos(angle);
float oc = 1.0 - c;
return mat3(
oc * axis.xxz * axis.xyx + vec3(c, axis.zy) * vec3(1., -s, s),
oc * axis.xyy * axis.yyz + vec3(axis.z, c, axis.x) * vec3(s, 1., -s),
oc * axis.zyz * axis.xzz + vec3(axis.yx, c) * vec3(-s, s, 1.)
);
}
float distanceToPlane(vec3 position, vec3 normal) {
return dot(position, normal);
}
bool outsideViewshed(float distance) {
return distance > -viewshedVolumeOffset;
}
bool isWithinViewshed(vec3 position) {
float positionLength = length(position - viewshedObserverOffset);
float farSphereDistance = positionLength - viewshedNearFar[1];
if (outsideViewshed(farSphereDistance)) { return false; }
float nearSphereDistance = viewshedNearFar[0] - positionLength;
if (outsideViewshed(nearSphereDistance)) { return false; }
vec3 westVector = normalize(cross(viewshedUpVector, viewshedTargetVector));
bool leftOfTarget = distanceToPlane(position, westVector) > 0.0;
if (viewshedFOVs[0] < TWO_PI) {
float horAngle = viewshedFOVs[0] / 2.0;
horAngle = leftOfTarget ? horAngle : -horAngle;
vec3 sideVector = viewshedTargetVector * rotationMatrix(viewshedUpVector, horAngle);
bool inFront = distanceToPlane(position, sideVector) > 0.0;
if (inFront) {
vec3 sideNormal = cross(viewshedUpVector, sideVector) * (leftOfTarget ? 1. : -1.);
float sideDistance = distanceToPlane(position, normalize(sideNormal));
if (outsideViewshed(sideDistance)) { return false; }
} else if (viewshedFOVs[0] < PI) { return false; }
}
if (viewshedFOVs[1] < PI) {
float t = dot(viewshedUpVector, position);
vec3 nProjVector = normalize(position - t * viewshedUpVector);
float heading = acos(clamp(dot(normalize(viewshedTargetVector), nProjVector), -1.0, 1.0));
heading = leftOfTarget ? heading : -heading;
bool aboveTarget = distanceToPlane(position, viewshedUpVector) > 0.0;
float verFOV = viewshedFOVs[1] / 2.0;
verFOV = aboveTarget ? -verFOV : verFOV;
mat3 rotateByHeading = rotationMatrix(viewshedUpVector, heading);
vec3 sideVector = viewshedTargetVector * rotationMatrix(westVector, verFOV) * rotateByHeading;
vec3 leftVector = westVector * rotateByHeading;
vec3 sideNormal = cross(sideVector, leftVector) * (aboveTarget ? 1. : -1.);
float sideDistance = distanceToPlane(position, normalize(sideNormal));
if (outsideViewshed(sideDistance)) { return false; }
}
return true;
}
bool getViewshedPoint(vec4 localPosition, out ViewshedPoint point) {
for(int i=0; i < viewshedNumFaces; i++) {
vec2 viewshedUv = getViewshedUv(localPosition, i);
if (viewshedUv.x > 0. && viewshedUv.x < 1. && viewshedUv.y > 0. && viewshedUv.y < 1.) {
float orthoDepth = getOrthographicDepthToViewshed(localPosition, i);
if (orthoDepth >= 0.) {
bool isWithin = isWithinViewshed(localPosition.xyz);
point = ViewshedPoint(i, viewshedUv, isWithin, orthoDepth);
return true;
}
}
}
return false;
}
float normalCosAngle(float linearDepth, vec3 localPosition) {
vec4 normal4 = texture(normalMap, uv);
vec3 normalN = normalize(normal4.xyz * 2.0 - 1.0);
vec3 normal =  normalize((inverseViewNormalMatrix * vec4(normalN, 1.0)).xyz);
vec3 viewingDir = normalize(localPosition);
return dot(normal, viewingDir);
}`),t.main.add(Ne`float depth = depthFromTexture(depthTexture, uv);
if (depth >= 1.0 || depth <= 0.0) {
return;
}
float linearDepth = linearizeDepth(depth);
vec4 localPosition = reconstructLocalPosition(gl_FragCoord.xy, linearDepth);
ViewshedPoint point;
bool foundFace = getViewshedPoint(localPosition, point);
if (!foundFace || !point.isWithin) {
return;
}
float viewshedDepth = getDepthFromShadowMap(point.uv, point.face);
float distance = point.orthographicDepth;
bool visible = distance < viewshedDepth;
fragColor = visible ? visibleColor : occludedColor;
float cosAngle = normalCosAngle(linearDepth, localPosition.xyz);
float threshold = -0.01;
if (cosAngle > threshold) {
fragColor = occludedColor;
}`),i}const Ma=S(),ya=Object.freeze(Object.defineProperty({__proto__:null,ViewshedPassParameters:Ze,build:ei},Symbol.toStringTag,{value:"Module"}));class Et extends Wi{constructor(t,e){super(t,e,new Ni(ya,(()=>Is(()=>Promise.resolve().then(()=>xa),void 0))))}initializePipeline(){return qi({colorWrite:Ki,blending:Ji})}}let k=class extends Gi{get shadowMap(){return this._shadowMap}get hasViewsheds(){return this._viewsheds.length>0}get _contentPixelRatio(){return this.view.state.contentPixelRatio}get _viewshedsInView(){return this._viewsheds.items.filter((i=>Oa(this.view,i)))}constructor(i){super(i),this.isDecoration=!1,this._passParameters=new Ze,this._viewsheds=new Qi,this._shadowMap=null,this.consumes={required:[Ae.VIEWSHED,"normals"]},this.produces=Ae.VIEWSHED,this.requireGeometryDepth=!0}initialize(){this._shadowMap=new ma(this.fboCache),this.addHandles([M((()=>this.view.resolutionScale),(i=>{const t=this._shadowMap;t&&(t.settings.textureSizeQuality=i)}),x),ge((()=>!this.hasViewsheds),(()=>this._shadowMap?.dispose())),M((()=>this._viewshedsInView.map((i=>[i.observerRenderSpace,i.heading,i.tilt,i.farDistance,i.horizontalFieldOfView,i.verticalFieldOfView]))),(()=>this.requestRender(ut.UPDATE)),Bt)])}destroy(){this._shadowMap=Xi(this._shadowMap)}precompile(){if(this.hasViewsheds){this.techniques.precompile(Et);for(const i of this._viewshedsInView)if(this._shadowMap?.isActive(i))return void this.view.stage.renderer.precompileViewshedShadowMap()}}render(i){const t=this.bindParameters,e=this.renderingContext,s=i.find((({name:o})=>o===Ae.VIEWSHED));if(!this.hasViewsheds||!t.depth||this.isDecoration&&!t.decorations)return s;this._passParameters.shadowMap=this._shadowMap??this._passParameters.shadowMap,this._passParameters.normals=i.find((({name:o})=>o==="normals"))?.getTexture();const a=this.techniques.get(Et);if(!a?.compiled)return this.requestRender(ut.UPDATE),s;const r=this.view.stage.renderer.isFeatureEnabled(Yi.HighResolutionViewshed);for(const o of this._viewshedsInView){if(!this._renderShadowCubeMap(t,o,r)||!this._shadowMap?.ready)continue;const l=this._setupViewshedParameters(o,t.camera);e.bindTechnique(a,t,l),e.bindFramebuffer(s.fbo),e.screen.draw()}return this.shadowMap?.dispose(),s}updateViewsheds(i){const t=this._viewsheds,{removes:e,adds:s}=i;if(e&&(Array.isArray(e)?t.removeMany(e):t.remove(e)),s)if(Array.isArray(s)){const a=s.filter((r=>!t.includes(r)));t.addMany(a)}else t.includes(s)||t.add(s)}_renderShadowCubeMap(i,t,e){const s=this._shadowMap;if(!s)return!1;const a=this.view.basemapTerrain.hasStencilEnabledExtents,r=s.start(i.camera,t,e,this._contentPixelRatio,a);return r&&s.faces.forEach((o=>this.view.stage.renderer.renderViewshedShadowMap(o))),s.finish(),r}_setupViewshedParameters(i,t){const e=this._shadowMap;if(!e)return this._passParameters;const s=this._passParameters,a=i.effectiveObserverRenderSpace;s.localOrigin=a,s.observerOffset=P($a,i.observerRenderSpace,i.effectiveObserverRenderSpace),s.fovs=[y(i.horizontalFieldOfView),y(i.verticalFieldOfView)],s.headingAndTilt=[y(i.heading),y(i.tiltParallelToSurface)],s.upVector=i.tiltedUpVector;const r=Sa(i.targetRenderSpace,a);s.targetVector=r;const o=new Array,l=new Array;for(let d=0;d<e.numActiveFaces;d++)Nt(Ie,e.viewshedViewMatrices[d],a),o.push(...Ie),Da(e.viewshedProjectionMatrices[d],Ie,Ht),l.push(...Ht);return s.viewMatrices=o,s.projectionMatrices=l,s.volumeOffset=this.selectedViewshed?.()===i.viewshed?Ta(i,this.view,t.eye):0,s}get test(){return{viewsheds:this._viewsheds,shadowMap:this._shadowMap,viewshedsInView:this._viewshedsInView}}};function Sa(i,t){const e=p();return P(e,i,t)}function Da(i,t,e){const s=J(.5,.5,.5);return Ve(e,s),es(e,e,s),W(e,e,i),W(e,e,t),e}function Oa(i,t){const e=Zi(t.observerRenderSpace,t.farDistanceRenderSpace);return!!i.ready&&i.frustum.intersectsSphere(e)}function Ta(i,t,e){if(i==null)return 0;const{observerRenderSpace:s,targetRenderSpace:a}=i,r=pt(e,s)>pt(e,a)?i.observer:i.target;return t.pixelSizeAt(r)}n([c()],k.prototype,"selectedViewshed",void 0),n([c()],k.prototype,"isDecoration",void 0),n([c()],k.prototype,"shadowMap",null),n([c()],k.prototype,"hasViewsheds",null),n([c()],k.prototype,"_contentPixelRatio",null),n([c()],k.prototype,"_viewshedsInView",null),n([c()],k.prototype,"consumes",void 0),n([c()],k.prototype,"produces",void 0),k=n([se("esri.views.3d.webgl-engine.lib.Viewshed")],k);const $a=p(),Ie=S(),Ht=S();let E=class extends ms(be){constructor(i){super(i),this.type="viewshed-view-3d",this.analysis=null,this.tool=null,this._selectedViewshed=null,this.viewshedComputedDataHandles=null,this.userOperation=null,this._viewshedRenderer=null,this._intersector=null}get selectedViewshed(){return this._selectedViewshed}set selectedViewshed(i){this._unselectOtherViewsheds(i),this._selectedViewshed=i}get selectedViewshedComputedData(){return this.tool?.selectedViewshedComputedData}get _isDecoration(){return!this.parent}initialize(){const i=this.view;this._viewshedRenderer=new k({view:i,selectedViewshed:()=>this.selectedViewshed??this.tool?.stagedViewshed,isDecoration:this._isDecoration}),this._intersector=new ts(this.view.state.viewingMode),this._intersector.options.hud=!1,this._intersector.options.store=is.MIN,this.viewshedComputedDataHandles=Ge((()=>this.analysis.viewsheds),(t=>{const e=new g({renderCoordsHelper:i.renderCoordsHelper,viewshed:t}),s=Symbol();return this.addHandles([M((()=>({valid:e.valid,canProject:hs(e.observer?.spatialReference,this.view.spatialReference)||cs()})),(({valid:a,canProject:r},o)=>{this.visible&&(a&&r?this._addViewshedsToRenderer(e):o?.valid&&o?.canProject&&this._removeViewshedsFromRenderer(e),r||Ss(this.analysis,e.observer.spatialReference,ls.getLogger(this)))}),x),...this._createFeatureReferenceHandles(e)],s),{viewshedComputedData:e,remove:()=>{this.removeHandles(s),this._removeViewshedsFromRenderer(e),e.destroy()}}})),this._analysisVisualization=new re({view:i,analysisViewData:this,isDecoration:this._isDecoration}),this.addHandles([M((()=>this.visible),(t=>{const e=this.viewshedComputedDataHandles;if(e==null)return;t||(this.selectedViewshed=null);const s=e.map((a=>a.viewshedComputedData)).filter((a=>a.valid)).toArray();t?this._addViewshedsToRenderer(s):this._removeViewshedsFromRenderer(s)})),M((()=>i.renderCoordsHelper),(t=>{this.viewshedComputedDataHandles?.forEach((({viewshedComputedData:e})=>e.renderCoordsHelper=t))})),gs(this,O),ge((()=>this.interactive),(()=>{this._unselectOtherViewsheds(this.selectedViewshed)}),de)])}destroy(){this.userOperation=Be(this.userOperation),_s(this),this._analysisVisualization=C(this._analysisVisualization);const i=this.viewshedComputedDataHandles;i!=null&&this._removeViewshedsFromRenderer(i.map((t=>t.viewshedComputedData)).toArray())}_createFeatureReferenceHandles(i){const{view:t}=this;return[M((()=>[t.state.camera,t.slice.plane,i.viewshed.observer,i.targetRenderSpace,i.verticalFieldOfView,i.horizontalFieldOfView,i.feature]),(()=>{this._updateObserverFromFeature(t,i)}),x),this._createElevationUpdateHandle(i),ge((()=>i.needUpdateByFeature),(()=>{this._updateObserverFromFeature(t,i),i.needUpdateByFeature=!1}))]}_createElevationUpdateHandle(i){const t=(e,s)=>{const{view:a}=this,{observer:r}=i;if(r==null)return;const o=as(r,a.spatialReference);if(o.pending!=null)return void o.pending.finally((()=>t(e,s)));const l=o.geometry;l!=null&&(rs(e,s,zt,a.spatialReference),os(zt,[l.x,l.y])&&(i.needUpdateByFeature=!0))};return this.view.elevationProvider.on("elevation-change",(({extent:e,spatialReference:s})=>t(e,s)))}async createViewsheds(i){await vt(this,{placementOptions:i,onToolActivated:t=>t.place("multiple")})}place(i){return vt(this,{placementOptions:i,onToolActivated:t=>t.place("single")})}_addViewshedsToRenderer(i){this._viewshedRenderer.updateViewsheds({adds:i})}_removeViewshedsFromRenderer(i){this._viewshedRenderer.updateViewsheds({removes:i})}_updateObserverFromFeature(i,t){const e=t.observerRenderSpace,s=t.targetRenderSpace,a=B(p(),e),r={observer:e,observerSurfaceNormal:null,observerAdjusted:a,observerFeatureId:ds(t.feature),target:s,targetSurfaceNormal:null,targetAdjusted:B(p(),s),targetFeatureId:null};us(i,this._intersector,r,(o=>Math.min(o,.05*t.farDistanceRenderSpace))),t.observerRenderSpaceOverride=ss(a,e)?null:a}_unselectOtherViewsheds(i){if(i!=null)for(const t of this.view.tools.items)t!==this.tool&&t instanceof O&&(t.analysisViewData.selectedViewshed=null)}get test(){}};n([c({readOnly:!0})],E.prototype,"type",void 0),n([c({constructOnly:!0,nonNullable:!0})],E.prototype,"analysis",void 0),n([c()],E.prototype,"tool",void 0),n([c()],E.prototype,"_selectedViewshed",void 0),n([c()],E.prototype,"selectedViewshed",null),n([c()],E.prototype,"selectedViewshedComputedData",null),n([c()],E.prototype,"viewshedComputedDataHandles",void 0),n([c()],E.prototype,"userOperation",void 0),n([c()],E.prototype,"_analysisVisualization",void 0),n([c()],E.prototype,"_viewshedRenderer",void 0),E=n([se("esri.views.3d.analysis.ViewshedAnalysisView3D")],E);const Wr=E,zt=ns(),xa=Object.freeze(Object.defineProperty({__proto__:null,ViewshedPassParameters:Ze,build:ei},Symbol.toStringTag,{value:"Module"}));export{Wr as default};
