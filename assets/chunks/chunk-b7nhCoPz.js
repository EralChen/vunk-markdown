import{Y as zt,a1 as Ut,be as O,bo as L,bm as tt,bn as et,j$ as Tt,k3 as Ot,bl as Ct,bf as V,bx as Vt,bg as Nt,by as kt,bz as N,ns as Gt,nt as jt,s as Ft,nu as Ht,nv as Wt,nw as qt,nx as lt,kN as K,ny as ut,nz as ht,k1 as Zt,y as Y,nA as Jt,eA as Kt,bq as Yt,b9 as I,ki as Qt,jg as X,kj as Xt,kb as te,ka as ee,nB as ne,nC as se,am as pt,kv as ae,nD as ie,nE as oe,nF as re,nG as ce,nH as le,at as ue,nI as he,b8 as k,ef as W,ej as dt,d0 as Et,gB as nt,nJ as pe,nK as de,nL as ge,nM as me,kU as ye,nN as fe,cp as be,cq as gt}from"./chunk-CET6Djna.js";import{t as _e,e as mt}from"./chunk-DGkpYqI6.js";import{a as xe}from"./chunk-BADwmne0.js";import{c as Se,a as It,p as At}from"./chunk-DEsgwh2_.js";function Fe(t,e,n){const a=(e.length>0?e[0]:t.length/3)-1,s=Se(t,a,n);if(s!==Tt.Z){t=t.slice();for(let i=0;i<t.length;i+=3)t[i+s]=t[i+2]}return Ot(t,e,3)}function He(t){const e=[[O.POSITION,new L(t.attributeData.position,t.indices,3,!0)]],n=Ct(t.indices.length);return t.attributeData.colorFeature!=null?e.push([O.COLORFEATUREATTRIBUTE,new L([t.attributeData.colorFeature],n,1,!0)]):t.attributeData.color&&e.push([O.COLOR,new L(t.attributeData.color,n,4,!0)]),t.attributeData.uvMapSpace&&e.push([O.UVMAPSPACE,new L(t.attributeData.uvMapSpace,t.indices,4,!0)]),t.attributeData.boundingRect&&e.push([O.BOUNDINGRECT,new L(t.attributeData.boundingRect,t.indices,9,!0)]),new tt(t.material,e,t.mapPositions,et.Mesh,t.attributeData.objectAndLayerIdColor)}function We(t,e=null){const n=[[O.POSITION,new L(t.attributeData.position,t.indices,3,!0)],[O.UV0,new L(t.attributeData.uv0,t.indices,2,!0)]];return new tt(t.material,n,t.mapPositions,et.Mesh,e)}function Pe(t){switch(t.type){case"extent":if(t instanceof zt)return Ut.fromExtent(t);break;case"polygon":return t}return null}let qe=class{constructor(e,n,a){this.renderData=e,this.layerViewUid=n,this.graphicUid=a,this.outGeometries=new Array}};function we(t,e,n,a){const s=It(t.rings,!!t.hasZ&&a.mode!=="on-the-ground",At.CCW_IS_HOLE,t.spatialReference),i=V(s.position.length),o=Vt(s.position,t.spatialReference,0,i,0,s.position,0,s.position.length/3,e,n,a),c=o!=null;return new Ee(s.position,i,Mt(s.polygons,s.position,i),vt(s.outlines,s.position,i),c,o)}function Je(t,e){const n=It(t.rings,!1,At.CCW_IS_HOLE),a=Nt(n.position,t.spatialReference,0,n.position,e,0);for(let s=2;s<n.position.length;s+=3)n.position[s]=kt;return{position:n.position,polygons:Mt(n.polygons,n.position),outlines:vt(n.outlines,n.position),projectionSuccess:a}}function vt(t,e,n=null){return t.filter((({count:a})=>a>1)).map((({index:a,count:s})=>{const i=3*a,o=3*s;return n!=null?new $t(a,s,N(e,i,o),N(n,i,o)):new st(a,s,N(e,i,o))}))}function Mt(t,e,n=null){const a=new Array;for(const{index:s,count:i,holeIndices:o,pathLengths:c}of t){if(i<=1)continue;const l=3*s,_=3*i,f=o.map((d=>d-s)),b=n!=null?new Oe(s,i,N(e,3*s,3*i),N(n,l,_),f,c):new Ce(s,i,N(e,3*s,3*i),f,c);a.push(b)}return a}class st{constructor(e,n,a){this.index=e,this.count=n,this.position=a}}class $t extends st{constructor(e,n,a,s){super(e,n,a),this.mapPositions=s}}class Oe extends $t{constructor(e,n,a,s,i,o){super(e,n,a,s),this.holeIndices=i,this.pathLengths=o}}class Ce extends st{constructor(e,n,a,s,i){super(e,n,a),this.holeIndices=s,this.pathLengths=i}}class Ee{constructor(e,n,a,s,i,o){this.position=e,this.mapPositions=n,this.polygons=a,this.outlines=s,this.projectionSuccess=i,this.sampledElevation=o}}const Ie=["polygon","extent"];class Ke extends Gt{constructor(e,n,a,s){super(e,n,a,s,Re(n)),this.ensureDrapedStatus(!1)}async doLoad(){if(!this._drivenProperties.size){const d=jt(this._getSymbolSize());if(d)throw new Ft("graphics3dextrudesymbollayer:invalid-size",d)}const e=this.symbolLayer,n=e?.material,a=n?.color,s=this._getCombinedOpacityAndColor(a),i=Ht(s),o=s[3],c=this.needsDrivenTransparentPass,l=n?.emissive,_={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,diffuse:i,ambient:i,opacity:o,drivenOpacity:c,hasVertexColors:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:e.castShadows,emissiveStrength:l?.strength??0,emissiveSource:qt.Color,offsetTransparentBackfaces:!0,normalType:Wt.Compressed},f=new lt(_,this._context);f.setParameters({cullFace:f.transparent?K.None:K.Back});const b=new lt({..._,cullFace:K.Back},this._context);this._materials[$.Main]=f,this._materials[$.Bottom]=b}destroy(){super.destroy(),this._materials.length=0}createGraphics3DGraphic(e){const n=e.graphic;if(!this._validateGeometry(n.geometry,Ie,this.symbolLayer.type))return null;const a=this._getVertexOpacityAndColor(e.renderingInfo,this._getFallbackOpacityAndColor(),255),s=this.setGraphicElevationContext(n);return this._createAs3DShape(n,e.renderingInfo,a,s,n.uid)}layerOpacityChanged(e,n){const a=this.symbolLayer?.material?.color,s=this._getCombinedOpacity(a);this._materials[$.Main]?.setParameters({opacity:s}),this._materials[$.Bottom]?.setParameters({opacity:s});const i=this._getLayerOpacity();e?.forEach((o=>n(o)?.layerOpacityChanged(i,this._context.isAsync)))}layerElevationInfoChanged(e,n){return this.updateGraphics3DGraphicElevationInfo(e,n,ut)}slicePlaneEnabledChanged(e,n){return this._materials[$.Main]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),this._materials[$.Bottom]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),e?.forEach((a=>{const s=n(a);s?.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)})),!0}physicalBasedRenderingChanged(){const e={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0};return this._materials[$.Main]?.setParameters(e),this._materials[$.Bottom]?.setParameters(e),!0}_getExtrusionSize(e){let n;return n=e.size&&this._drivenProperties.size?xe(e.size,2)??0:this._getSymbolSize(),n/=this._context.renderCoordsHelper.unitInMeters,n}applyRendererDiff(e,n){return this._drivenPropertiesChanged(n)?ht.RecreateSymbol:ht.RecreateGraphics}async queryForSnapping(e,n,a,s){const i=this._getExtrusionSize(a)*this._context.renderCoordsHelper.unitInMeters/Zt(n),{objectId:o,target:c}=e,l=Y(c);switch(l.z=(l.z??0)+i,e.type){case"edge":{const{start:_,end:f}=e,b=Y(_),d=Y(f);return b.z=(b.z??0)+i,d.z=(d.z??0)+i,[mt(o,l,1/0,b,d)]}case"vertex":return[_e(o,l,1/0),mt(o,c,1/0,c,l)];default:return[]}}_getSymbolSize(){return this.symbolLayer.size??1}_createAs3DShape(e,n,a,s,i){const o=Pe(e.geometry);if(o==null)return null;if(o.rings.length===0||!o.rings.some((A=>A.length>0)))return this._logGeometryValidationWarnings(o.rings,"rings","ExtrudeSymbol3DLayer"),null;const c=we(o,this._context.elevationProvider,this._context.renderCoordsHelper,s);this._logGeometryCreationWarnings(c,o.rings,"rings","ExtrudeSymbol3DLayer");const l=Jt(o);if(l==null)return null;const _=new Array,f=new Array,b=Kt(),d=X(),E=I(),u=this._context.renderCoordsHelper.viewingMode===Yt.Global;u||this._context.renderCoordsHelper.worldUpAtPosition(null,E),Qt(o.spatialReference,[l.x,l.y,0],d,this._context.renderCoordsHelper.spatialReference);const m=X();Xt(m,d);const g=ee();te(g,m);const{polygons:x,mapPositions:p,position:y}=c,h=new Map,P=this._materials[$.Main];for(const A of x){const D=A.count;if(this._context.clippingExtent&&(ne(A.mapPositions,b),!se(b,this._context.clippingExtent)))continue;const B=Ot(A.mapPositions,A.holeIndices,3);if(B.length===0)continue;const z=B.length,R=6*D,U=pt(R+z),q=pt(z),j=V(3*R),at=V(3*R),it=V(3*R),ot=V(R);Ae(y,p,B,A,j,it,at,ot,U,q,this._getExtrusionSize(n),E,u),ae(j,j,m);const rt=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:i,layerViewUid:this._context.layerViewUid}),Z=new Te(j,it,ie(at),ot),J=yt(P,U,U.length-q.length,Z,a,rt),Lt=D,Dt=D,Bt=2*A.count,ct=new Ve(Lt,Dt,Bt,z/3);Rt(J,ct,d),h.set(J,ct),_.push(J,yt(this._materials[$.Bottom],q,0,Z,a,rt)),f.push(Z.heights)}if(_.length===0)return null;const r=new oe({geometries:_,layerViewUid:this._context.layerViewUid,graphicUid:i,isElevationSource:!0});r.transformation=d;const S=re(this.symbolLayer,{opacity:this._getLayerOpacity()}),w=S?new ce(this._materials[$.Main],S,this._context.slicePlaneEnabled):null,v=new le(this,r,null,((A,D,B,z,R)=>$e(A,D,B,z,R,f,h)),s,w);return v.alignedSampledElevation=c.sampledElevation,v.needsElevationUpdates=ut(s.mode),v}_getFallbackOpacityAndColor(){const e=this.symbolLayer?.material?.color;return ue.toUnitRGBA(e)??he}}function yt(t,e,n,a,s,i){const o=Ct(e.length),c=[[O.POSITION,new L(a.positions,e,3,!0)],[O.NORMALCOMPRESSED,new L(a.normals,e,2,!0)],[O.COLOR,new L(s,o,4,!0)]];return new tt(t,c,a.elevation,et.Mesh,i,n)}function Ae(t,e,n,a,s,i,o,c,l,_,f,b,d){const E=n.length/3;let u=2*a.count;ve(t,e,a.index,a.count,n,0,E,s,i,o,c,l,_,u,f,b,d);let m=0,g=2*a.count;u=0;const x=a.pathLengths[0];ft(s,i,c,o,m,x,a.count,g,l,u,f),g+=4*x,u+=2*x,m+=x;for(let p=1;p<a.pathLengths.length;++p){const y=a.pathLengths[p];ft(s,i,c,o,m,y,a.count,g,l,u,f),g+=4*y,u+=2*y,m+=y}}function ve(t,e,n,a,s,i,o,c,l,_,f,b,d,E,u,m,g){be(M,m),l??=[],_??=[],f??=[];const x=u>0?1:-1;let p=3*n,y=0,h=3*y,P=a,r=3*P;for(let v=0;v<a;++v){const A=t[p],D=t[p+1],B=t[p+2];g&&(M[0]=A,M[1]=D,M[2]=B,nt(M,M)),c[h+0]=A,c[h+1]=D,c[h+2]=B;const z=e[p+0],R=e[p+1],U=e[p+2];l[h+0]=z,l[h+1]=R,l[h+2]=U,_[h+0]=-x*M[0],_[h+1]=-x*M[1],_[h+2]=-x*M[2],f[y]=0,c[r+0]=A+u*M[0],c[r+1]=D+u*M[1],c[r+2]=B+u*M[2],l[r+0]=z,l[r+1]=R,l[r+2]=U,f[P]=u,h+=3,r+=3,p+=3,y+=1,P+=1}p=3*i,h=0,r=3*E;const S=u<0?wt:Pt,w=u<0?Pt:wt;for(let v=0;v<o;++v)d[h]=s[p+S[0]],d[h+1]=s[p+S[1]],d[h+2]=s[p+S[2]],b[r]=s[p+w[0]]+a,b[r+1]=s[p+w[1]]+a,b[r+2]=s[p+w[2]]+a,h+=3,r+=3,p+=3}function F(t,e,n,a,s,i,o){a[i]=a[o],o*=3,t[i*=3]=t[o],t[i+1]=t[o+1],t[i+2]=t[o+2],e[i]=e[o],e[i+1]=e[o+1],e[i+2]=e[o+2],n[i]=s[0],n[i+1]=s[1],n[i+2]=s[2]}const G=I();function ft(t,e,n,a,s,i,o,c,l,_,f){e??=[],n??=[],a??=[];let b=s,d=s+1,E=s+o,u=s+o+1,m=c,g=c+1,x=c+2*i,p=c+2*i+1;f<0&&(b=s+o+1,u=s);let y=3*_;for(let h=0;h<i;++h)h===i-1&&(d=s,f>0?u=s+o:b=s+o),Me(t,b,d,E,G),F(t,e,a,n,G,m,b),F(t,e,a,n,G,g,d),F(t,e,a,n,G,x,E),F(t,e,a,n,G,p,u),l[y]=m,l[y+1]=x,l[y+2]=p,l[y+3]=m,l[y+4]=p,l[y+5]=g,y+=6,b++,d++,E++,u++,m+=2,g+=2,x+=2,p+=2}const Q=I(),bt=I(),_t=I(),xt=I(),St=I();function Me(t,e,n,a,s){e*=3,n*=3,a*=3,k(Q,t[e++],t[e++],t[e++]),k(bt,t[n++],t[n++],t[n++]),k(_t,t[a++],t[a++],t[a++]),gt(xt,bt,Q),gt(St,_t,Q),Et(s,St,xt),nt(s,s)}const T=I();function $e(t,e,n,a,s,i,o){const c=t.stageObject,l=c.geometries,_=l.length,f=e.mode!=="absolute-height";let b=0;const d=c.transformation,E=de(X(),d);for(let u=0;u<_;u+=2){const m=l[u];if(!ge(m))continue;const g=m.getMutableAttribute(O.POSITION).data,x=i[u/2],p=new me(m.mapPositions),y=g.length/3;let h=!1,P=0;{let r=0;for(let S=0;S<y;S++){T[0]=g[r],T[1]=g[r+1],T[2]=g[r+2],a(p,H),f&&(P+=H.sampledElevation),fe.TESTS_DISABLE_OPTIMIZATIONS?(k(C,p.array[p.offset],p.array[p.offset+1],H.z+x[r/3]),n!=null&&s.toRenderCoords(C,n,C),W(C,C,E)):(k(C,g[r],g[r+1],g[r+2]),W(C,C,d),s.setAltitude(C,H.z+x[r/3]),W(C,C,E)),g[r]=C[0],g[r+1]=C[1],g[r+2]=C[2];const w=Le/s.unitInMeters;(Math.abs(T[0]-g[r])>=w||Math.abs(T[1]-g[r+1])>=w||Math.abs(T[2]-g[r+2])>=w)&&(h=!0),p.offset+=3,r+=3}}if(h){const r=o.get(m);r&&Rt(m,r,d),c.geometryVertexAttributeUpdated(l[u],O.NORMALCOMPRESSED),m.invalidateBoundingInfo(),c.geometryVertexAttributeUpdated(l[u],O.POSITION),l[u+1].invalidateBoundingInfo(),c.geometryVertexAttributeUpdated(l[u+1],O.POSITION)}b+=P/y}return b/_}function Rt(t,e,n){const a=t.getMutableAttribute(O.POSITION),s=t.getMutableAttribute(O.NORMALCOMPRESSED).data,{topVertexStart:i,topVertexCount:o,topFaceStart:c,topFaceCount:l}=e,_=a.data,f=o,b=t.attributes.get(O.POSITION).indices,d=c+l,E=i+o,u=V(3*f);for(let h=0;h<f;++h){const P=3*h;u[P+0]=0,u[P+1]=0,u[P+2]=0}const m=De,g=Be,x=ze,p=Ue,y=M;for(let h=c;h<d;++h){const P=3*h;for(let r=0;r<3;++r){const S=b[P+r];p[r]=S;const w=3*S;k(C,_[w+0],_[w+1],_[w+2]),W(m[r],C,n)}dt(g,m[1],m[0]),dt(x,m[2],m[0]),Et(y,g,x),nt(y,y);for(let r=0;r<3;++r){const S=3*(p[r]-i);u[S+0]+=y[0],u[S+1]+=y[1],u[S+2]+=y[2]}}for(let h=i;h<E;++h){const P=3*(h-i),r=u[P+0],S=u[P+1],w=u[P+2],v=Math.sqrt(r*r+S*S+w*w);pe(s,h,r/v,S/v,w/v)}}function Re(t){return(t.material?.color?.a??1)===1}const C=I(),M=I(),H=new ye,Pt=[0,2,1],wt=[0,1,2],Le=.01,De=[I(),I(),I()],Be=I(),ze=I(),Ue=[0,0,0];var $;(function(t){t[t.Main=0]="Main",t[t.Bottom=1]="Bottom"})($||($={}));class Te{constructor(e,n,a,s){this.positions=e,this.elevation=n,this.normals=a,this.heights=s}}class Ve{constructor(e,n,a,s){this.topVertexStart=e,this.topVertexCount=n,this.topFaceStart=a,this.topFaceCount=s}}export{We as a,Pe as b,Je as c,qe as g,Fe as l,He as m,Ae as n,we as p,Ke as s};
