import{ao as q,aI as W,th as be,v as O,aG as y,aH as P,ti as d,tj as he,af as l,ag as r,ai as H,tk as De,mp as Me,d5 as Te,aM as x,az as L,nQ as b,tl as u,tm as D,ch as Ce,c$ as C,tn as F,cZ as T,to as J,cj as Q,cG as c,b5 as R,b4 as X,tp as Y,cV as K,cP as k,b3 as U,cX as I,tq as Ee,tr as f,e7 as ee,mC as Se,gs as te,mL as $e,bS as ie,cL as xe,cN as ke,b2 as ue,ts as pe,kb as ce,b1 as Le,no as de,fB as ae}from"./chunk-CuaFhuP3.js";import{aH as He}from"./chunk-Dpk1TJd9.js";import{o as ze,s as Oe,m as Re,f as Ie,d as Ge,y as Ae}from"./chunk-BrlCBmiQ.js";import{x as Be,L as Fe,V as Ke,R as ye,I as Ue,H as je,w as se,v as Ne,j as _e,A as ve,l as ne,_ as le,s as qe,r as Ze,M as E,e as We,C as g,c as j,u as Je,m as Qe,p as Xe,g as Ye,a as we,t as me,b as et,d as tt}from"./chunk-C6CF7gEh.js";import{t as it,w as at}from"./chunk-bnxLL64Y.js";import{l as st,n as nt}from"./chunk-fuCO_HNs.js";import{m as lt,M as ge,r as G,t as A,p as rt,f as ot,h as ht,j as ut}from"./chunk-Cw3swYQH.js";import{T as S}from"./chunk-B4acbyk_.js";import{p as $}from"./chunk-DBIOSom4.js";import{o as pt}from"./chunk-FQCx7Mu7.js";import{h as ct}from"./chunk-CCavR4OV.js";import"./chunk-iOPJXyP1.js";import"./chunk-DGmg3LSc.js";/* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              */import"./chunk-CRe5xk_G.js";import"./chunk-6vejsciN.js";import"./chunk-B6pR6iCC.js";import"./chunk-Cwyf4XaO.js";import"./chunk-CpdoPF2G.js";import"./chunk-DwTaIoG6.js";import"./chunk-BlkaH78C.js";function dt(e){switch(e.type){case"building-scene":case"catalog":case"catalog-dynamic-group":case"catalog-footprint":case"csv":case"dimension":case"feature":case"geo-rss":case"geojson":case"graphics":case"group":case"integrated-mesh":case"integrated-mesh-3dtiles":case"kml":case"knowledge-graph":case"link-chart":case"knowledge-graph-sublayer":case"line-of-sight":case"map-notes":case"ogc-feature":case"oriented-imagery":case"point-cloud":case"route":case"scene":case"stream":case"viewshed":case"voxel":case"subtype-group":case"unknown":case"unsupported":case"wfs":case"parquet":case null:return!1;case"base-dynamic":case"base-elevation":case"base-tile":case"bing-maps":case"elevation":case"imagery":case"imagery-tile":case"map-image":case"media":case"open-street-map":case"tile":case"vector-tile":case"video":case"wcs":case"web-tile":case"wms":case"wmts":return!0;default:return He(e.type),!1}}let w=class extends q{constructor(e){super(e),this._internalChange=!1,this._currentSlicePlane=null}initialize(){this.addHandles(this.analysis.excludedLayers.on("before-add",(e=>{const t=e.item;t!=null&&(t instanceof W||t instanceof be)?t instanceof W&&dt(t)?(O.getLogger(this).error("excludedLayers",`Layer '${t.title}, id:${t.id}' of type '${t.type}' can not be individually excluded from slicing. Use 'excludeGroundSurface' instead.`),e.preventDefault()):this.analysis.excludedLayers.includes(t)&&e.preventDefault():(O.getLogger(this).error("excludedLayers","Invalid layer type, layer must derive from Layer or BuildingComponentSublayer"),e.preventDefault())}))),vt(this.view,this),this.addHandles([y((()=>this.analysisViewData.plane),(()=>{this._internalChange||this._updateSlicePlaneFromBoundedPlane(),this._updateLayerViews()}),P),y((()=>this.analysis.excludeGroundSurface),(()=>this._updateLayerViews()),P),this.analysis.excludedLayers.on("change",(()=>this._updateLayerViews())),y((()=>[this.analysisViewData.active,this.analysisViewData.visible]),(()=>{this._updateActiveController(),this._updateViewSlicePlane(),this._updateViewSlicePlaneDecoration()}),P),y((()=>this._allLayerAndSubLayerViews),(()=>this._updateLayerViews()))]),this.addHandles([y((()=>this.analysis.shape),(()=>{this._internalChange||(this._updateBoundedPlaneFromSlicePlane(),this._updateViewSlicePlane())}),P),y((()=>this.analysis.origin?.type!=="web-scene"),(()=>this._updateViewSlicePlaneDecoration()),P)],"analysis"),this._updateActiveController(),this._updateBoundedPlaneFromSlicePlane(),this._updateViewSlicePlane(),this._updateViewSlicePlaneDecoration()}destroy(){this.analysisViewData.active&&(this.analysisViewData.active=!1,this.view.slice.plane=null,this._updateActiveController(),this._updateViewSlicePlane()),wt(this.view,this),this.set("view",null)}get _allLayerAndSubLayerViews(){const e=this.view.allLayerViews.items;return e.concat(e.filter(Be).flatMap((({sublayerViews:t})=>t.items)))}_updateBoundedPlaneFromSlicePlane(){const e=this.analysis.shape,t=this._currentSlicePlane;if(t==null&&e==null||t!=null&&e!=null&&e.equals(t))return;let i=null,a=null;if(e?.position!=null){const s=e.position.spatialReference,n=Fe(e,this.view);n==null&&it(this.analysis,s,O.getLogger(this)),i=Ke(n,this.view,{tiltEnabled:this.analysis.tiltEnabled},d()),i!=null&&(a={heading:e.heading,tilt:e.tilt,position:e.position,width:e.width,height:e.height})}this._currentSlicePlane=a,this._internalChange=!0,this.analysisViewData.plane=i,this._internalChange=!1}_updateSlicePlaneFromBoundedPlane(){const e=this.analysisViewData.plane,t=ye(e,this.view,this.view.spatialReference,new he);let i=null;t!=null&&(i={heading:t.heading,tilt:t.tilt,position:t.position,width:t.width,height:t.height}),this._currentSlicePlane=i,this._internalChange=!0,this.analysis.shape=t,this._internalChange=!1,this._updateViewSlicePlane()}_updateActiveController(){if(B)return;const e=Z(this.view);if(e)if(this.analysisViewData.active)e.activeController!=null&&e.activeController!==this?(B=!0,e.activeController.analysisViewData.active=!1,B=!1):e.activeController!=null&&e.activeController,this._updateLayerViews(),e.activeController=this;else{if(e.activeController!=null&&e.activeController!==this)return;e.activeController!=null&&e.activeController===this&&(e.activeController=null,this._updateLayerViews())}}_updateViewSlicePlane(){yt(this.view)}_updateViewSlicePlaneDecoration(){_t(this.view)}_updateLayerViews(){const e=this.analysisViewData.plane!=null&&this.analysisViewData.visible&&this.analysisViewData.active,t=[],i=a=>{"layers"in a?a.layers.forEach(i):t.push(a)};this.analysis.excludedLayers.forEach(i),this.view.allLayerViews.forEach((a=>{a.destroyed||("slicePlaneEnabled"in a&&(a.slicePlaneEnabled=e&&!t.includes(a.layer)),"sublayerViews"in a&&a.sublayerViews.forEach((s=>{s.slicePlaneEnabled=e&&!t.includes(s.sublayer)})))})),this.view.basemapTerrain!=null&&(this.view.basemapTerrain.slicePlaneEnabled=e&&!this.analysis.excludeGroundSurface)}};l([r()],w.prototype,"view",void 0),l([r()],w.prototype,"analysis",void 0),l([r()],w.prototype,"analysisViewData",void 0),l([r()],w.prototype,"_allLayerAndSubLayerViews",null),w=l([H("esri.views.3d.analysis.Slice.SliceController")],w);const m=new Map;let B=!1;function yt(e){const t=Z(e),i=t?.activeController;i?.analysisViewData.plane!=null&&i.analysisViewData.visible?e.slice.plane=i.analysisViewData.plane:e.slice.plane=null}function _t(e){const t=Z(e),i=t?.activeController;e.slice.isDecoration=i?.analysis.origin?.type!=="web-scene"}function vt(e,t){m.has(e)||m.set(e,{all:[],activeController:null}),m.get(e)?.all.push(t)}function Z(e){return m.get(e)}function wt(e,t){if(!m.has(e))throw new Error("view expected in global slice register");const i=m.get(e),a=i?.all.lastIndexOf(t)??-1;if(!i||a===-1)throw new Error("controller expected in global slice register");i.all.splice(a,1),i.all.length===0&&m.delete(e)}var N;let o=class extends ze{static{N=this}constructor(e){super(e),this._clock=De,this._previewPlaneOpacity=1,this.removeIncompleteOnCancel=!1,this._mode="none",this.shiftManipulator=null,this.rotateHeadingManipulator=null,this.rotateTiltManipulator=null,this.resizeManipulators=null,this._frameTask=null,this._pointerMoveTimerMs=lt,this._prevPointerMoveTimeout=null,this._previewPlaneGridVisualElement=null,this._previewPlaneOutlineVisualElement=null,this._startPlane=d(),this._previewPlane=null,this._activeKeyModifiers={},this._lastCursorPosition=Me(),this._resizeHandles=[{direction:[1,0]},{direction:[1,1]},{direction:[0,1]},{direction:[-1,1]},{direction:[-1,0]},{direction:[-1,-1]},{direction:[0,-1]},{direction:[1,-1]}],this._intersector=pt(e.view.state.viewingMode)}initialize(){if(this.analysis==null)throw new Error("SliceTool requires valid analysis, but null was provided.");const e=n=>{this._updateManipulatorsInteractive(n),n.grabbing||(this.analysisViewData.plane!=null&&u(this.analysisViewData.plane,this._startPlane),this.inputState=null)},t=new Ue(this.view,je.CENTER_ON_ARROW);this.shiftManipulator=t,this.manipulators.add(t),this.addHandles([this._createShiftDragPipeline(t),t.events.on("grab-changed",(n=>{this._onShiftGrab(n),e(t)}))]);const i=!this.view.stage?.renderView.renderingContext.driverTest.svgPremultipliesAlpha.result,a=new se(this.view,((n,h)=>st(this.view.stage.textures,{accentColor:n,contrastColor:h,preMultiplyAlpha:i})));this.rotateHeadingManipulator=a,this.manipulators.add(a),this.addHandles([this._createRotateHeadingDragPipeline(a),a.events.on("grab-changed",(n=>{this._onRotateHeadingGrab(n),e(a)}))]);const s=new se(this.view,((n,h)=>nt(this.view.stage.textures,{accentColor:n,contrastColor:h,preMultiplyAlpha:i})));this.rotateTiltManipulator=s,this.manipulators.add(s),this.addHandles([this._createRotateTiltDragPipeline(s),s.events.on("grab-changed",(n=>{this._onRotateTiltGrab(n),e(s)}))]),this.resizeManipulators=this._resizeHandles.map(((n,h)=>{const _=new Ne(this.view,n);return this.addHandles([this._createResizeDragPipeline(_),_.events.on("grab-changed",(V=>{this._onResizeGrab(V,h),e(_)}))]),_})),this.manipulators.addMany(this.resizeManipulators),this._previewPlaneGridVisualElement=_e(this.view),this._previewPlaneOutlineVisualElement=ve(this.view),this._previewPlaneOutlineVisualElement.width=ge,this.addHandles(y((()=>[this.analysisViewData.plane,this.analysis.tiltEnabled]),(()=>this._updateManipulators()),P)),this.addHandles([Te((()=>this.state==="sliced"),(()=>{this.finishToolCreation(),this.stop()}),x),y((()=>this.view.state.camera),(()=>this._onCameraChange()))])}destroy(){this._removeFrameTask(),this._clearPointerMoveTimeout(),this._previewPlaneOutlineVisualElement=L(this._previewPlaneOutlineVisualElement),this._previewPlaneGridVisualElement=L(this._previewPlaneGridVisualElement)}get state(){const e=!!this.analysisViewData.plane,t=!!this.inputState;return e?e&&t?"slicing":e&&!t?"sliced":"ready":"ready"}get cursor(){return this.active?this._placingSlicePlane||this.mode==="exclude"?"crosshair":this._creatingPointerId!=null?"grabbing":null:null}set analysis(e){if(e==null)throw new Error("SliceTool requires valid analysis, but null was provided.");this.removeHandles("analysis"),this._set("analysis",e)}get mode(){return this._mode}static{this.disableEngineLayers=!1}get inputState(){return this._get("inputState")}set inputState(e){this._set("inputState",e),this.analysisViewData.showGrid=e!=null&&e.type==="resize",this._updateMaterials()}get _placingSlicePlane(){return this.active&&!this.inputState&&this._mode==="place"}get _creatingPointerId(){return this.inputState!=null&&this.inputState.type==="shift"?this.inputState.creatingPointerId:null}start(e){this._finishToolCreationIfValid(),this._mode=e,this.active||(this.view.activeTool=this)}stop(){this.active&&(this.view.activeTool=null)}onActivate(){this._finishToolCreationIfValid(),this._mode==="none"&&this.analysisViewData.plane==null&&(this._mode="place")}onDeactivate(){this._mode="none",this._updatePreviewPlane(null)}onShow(){this._updateVisibility(!0)}onHide(){this._updateVisibility(!1)}_updateVisibility(e){this._updateManipulators(),e||this._clearPointerMoveTimeout()}onInputEvent(e){switch(e.type){case"pointer-drag":if(!oe(e))return;this._placingSlicePlane?this._onClickPlacePlane(e)&&e.stopPropagation():this._onPointerDrag(e)&&e.stopPropagation();break;case"pointer-move":this._onPointerMove(e);break;case"pointer-up":this._onPointerUp(e)&&e.stopPropagation();break;case"immediate-click":if(!oe(e))return;this._mode==="exclude"?e.defer((async()=>{await this._onClickExcludeLayer(e)&&e.stopPropagation()})):this._onClickPlacePlane(e)&&e.stopPropagation();break;case"drag":this.inputState&&e.stopPropagation();break;case"key-down":this._onKeyDown(e)&&e.stopPropagation();break;case"key-up":this._onKeyUp(e)&&e.stopPropagation()}}onEditableChange(){this.analysisViewData.editable=this.internallyEditable}_onPointerDrag(e){const t=this.inputState;if(e.pointerId===this._creatingPointerId&&t!=null&&t.type==="shift"){const i=b(e);return this.shiftManipulator.events.emit("drag",{action:t.hasBeenDragged?"update":"start",pointerType:e.pointerType,start:i,screenPoint:i}),t.hasBeenDragged=!0,!0}return!1}_onPointerMove(e){this._lastCursorPosition.x=e.x,this._lastCursorPosition.y=e.y,this._resetPointerMoveTimeout(),e.pointerType!=="touch"&&this._updatePreviewPlane(b(e),this._activeKeyModifiers)}_onCameraChange(){this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),this._updateManipulators()}_onPointerUp(e){if(e.pointerId===this._creatingPointerId&&this.analysisViewData.plane!=null){const t=b(e);return this.shiftManipulator.events.emit("drag",{action:"end",start:t,screenPoint:t}),u(this.analysisViewData.plane,this._startPlane),this.inputState=null,!0}return!1}_onClickPlacePlane(e){if(!this._placingSlicePlane)return!1;const t=b(e),i=d();if(this._pickPlane(t,!1,this._activeKeyModifiers,i)){if(e.type==="pointer-drag"){const a=D(this.view.state.camera,t,M);this.inputState=re(a,e.pointerId,i.origin,i)}return u(i,this._startPlane),this.analysis.shape=ye(i,this.view,this.view.spatialReference,new he),e.type!=="pointer-drag"&&this.stop(),!0}return!1}async _onClickExcludeLayer(e){if(this.mode!=="exclude")return!1;const t=await this.view.hitTest(b(e)),i=t.results.at(0);if(i){const a=i.type==="graphic"&&i.graphic;if(a){const s=a.sourceLayer||a.layer;s&&this.analysis.excludedLayers.push(s)}}else t.ground.layer?this.analysis.excludedLayers.push(t.ground.layer):this.analysis.excludeGroundSurface=!0;return this.stop(),!0}_onKeyDown(e){return(e.key===G||e.key===A)&&(this._activeKeyModifiers[e.key]=!0,this._previewPlane!=null&&this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),!0)}_onKeyUp(e){return!(e.key!==G&&e.key!==A||!this._activeKeyModifiers[e.key])&&(delete this._activeKeyModifiers[e.key],this._previewPlane!=null&&this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),!0)}_onShiftGrab(e){if(e.action!=="start"||this.analysisViewData.plane==null||!e.screenPoint)return;const t=D(this.view.state.camera,e.screenPoint,M);u(this.analysisViewData.plane,this._startPlane),this.inputState=re(t,null,this.shiftManipulator.renderLocation,this.analysisViewData.plane)}_createShiftDragPipeline(e){return $(e,((t,i,a)=>{const s=this.inputState;if(s==null||s.type!=="shift")return;const n=this.analysisViewData.plane!=null?u(this.analysisViewData.plane,d()):null;i.next(S(this.view,s.shiftPlane)).next(this._shiftDragAdjustSensitivity(s)).next(this._shiftDragUpdatePlane(s)),a.next((()=>{n!=null&&this._updateBoundedPlane(n)}))}))}_shiftDragAdjustSensitivity(e){return t=>{if(this.analysisViewData.plane==null)return null;const i=.001,a=Math.min((1-Math.abs(C(F(this.analysisViewData.plane),t.ray.direction)/T(t.ray.direction)))/i,1),s=-J(this._startPlane.plane,t.renderEnd),n=-J(this._startPlane.plane,e.startPoint);return e.depth=e.depth*(1-a)+s*a-n,t}}_shiftDragUpdatePlane(e){return()=>{if(this.analysisViewData.plane==null)return;const t=Q(c.get(),this._startPlane.origin),i=Q(c.get(),F(this._startPlane));R(i,i,-e.depth),X(i,i,t);const a=Y(i,this.analysisViewData.plane.basis1,this.analysisViewData.plane.basis2,d());this._updateBoundedPlane(a)}}_onRotateHeadingGrab(e){if(e.action!=="start"||this.analysisViewData.plane==null||!e.screenPoint)return;const t=ne(this.analysisViewData.plane,this.view.renderCoordsHelper,le.HEADING,K()),i=D(this.view.state.camera,e.screenPoint,M),a=U();k(t,i,a)&&(u(this.analysisViewData.plane,this._startPlane),this.inputState={type:"rotate",rotatePlane:t,startPoint:a})}_createRotateHeadingDragPipeline(e){return $(e,((t,i,a)=>{const s=this.inputState;if(s==null||s.type!=="rotate")return;const n=this.analysisViewData.plane!=null?u(this.analysisViewData.plane,d()):null;i.next(S(this.view,s.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(s)).next(this._rotateDragUpdatePlaneFromRotate()),a.next((()=>{n!=null&&this._updateBoundedPlane(n)}))}))}_onRotateTiltGrab(e){if(e.action!=="start"||this.analysisViewData.plane==null||!e.screenPoint)return;const t=ne(this.analysisViewData.plane,this.view.renderCoordsHelper,le.TILT,K()),i=D(this.view.state.camera,e.screenPoint,M),a=U();k(t,i,a)&&(u(this.analysisViewData.plane,this._startPlane),this.inputState={type:"rotate",rotatePlane:t,startPoint:a})}_createRotateTiltDragPipeline(e){return $(e,((t,i,a)=>{const s=this.inputState;if(s==null||s.type!=="rotate")return;const n=this.analysisViewData.plane!=null?u(this.analysisViewData.plane,d()):null;i.next(S(this.view,s.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(s)).next(this._rotateDragUpdatePlaneFromRotate()),a.next((()=>{n!=null&&this._updateBoundedPlane(n)}))}))}_rotateDragRenderPlaneToRotate(e){return t=>{if(this.analysisViewData.plane==null)return null;const i=I(e.rotatePlane),a=at(e.startPoint,t.renderEnd,this.analysisViewData.plane.origin,i);return{...t,rotateAxis:i,rotateAngle:a}}}_rotateDragUpdatePlaneFromRotate(){return e=>{if(this.analysisViewData.plane==null)return;const t=Ee(f.get(),e.rotateAngle,e.rotateAxis);if(t==null)return;const i=ee(c.get(),this._startPlane.basis1,t),a=ee(c.get(),this._startPlane.basis2,t),s=Y(this.analysisViewData.plane.origin,i,a,d());this._updateBoundedPlane(s)}}_onResizeGrab(e,t){if(e.action!=="start"||this.analysisViewData.plane==null||!e.screenPoint)return;const i=D(this.view.state.camera,e.screenPoint,M),a=c.get();k(this.analysisViewData.plane.plane,i,a)&&(u(this.analysisViewData.plane,this._startPlane),this.inputState={type:"resize",activeHandleIdx:t,startPoint:Se(a)})}_createResizeDragPipeline(e){return $(e,((t,i,a)=>{const s=this.inputState;if(s==null||s.type!=="resize"||this.analysisViewData.plane==null)return;const n=u(this.analysisViewData.plane,d());i.next(S(this.view,this.analysisViewData.plane.plane)).next(this._resizeDragUpdatePlane(s)),a.next((()=>{this._updateBoundedPlane(n)}))}))}_resizeDragUpdatePlane(e){return t=>{if(this.analysisViewData.plane==null)return;const i=this._resizeHandles[e.activeHandleIdx],a=qe(i,e.startPoint,t.renderEnd,this.view.state.camera,this._startPlane,u(this.analysisViewData.plane));this._updateBoundedPlane(a)}}_updateBoundedPlane(e){const t=this.analysisViewData;if(t==null)throw new Error("valid internal object expected");t.plane=e}_updatePreviewPlane(e,t={}){if(this.mode==="exclude")return;let i=this._previewPlane;if(this._previewPlane=null,e==null)return this._removeFrameTask(),void this._updateManipulators();if(this.active){const a=i??d();if(i=i!=null?u(i,mt):null,this._pickPlane(e,!0,t,a)){const s=ot;let n=!1;i!=null&&(n=C(I(i.plane),I(a.plane))<s||C(te(c.get(),i.basis1),te(c.get(),a.basis1))<s),n&&(this._previewPlaneOpacity=0),this._previewPlane=a}}this._previewPlane!=null&&this._frameTask==null&&this._previewPlaneOpacity===0?this._frameTask=$e({update:({deltaTime:a})=>{this._previewPlaneOpacity=Math.min(this._previewPlaneOpacity+a/(1e3*rt),1),this._updateManipulators(),this._previewPlaneOpacity===1&&this._removeFrameTask()}}):this._previewPlane==null&&this._frameTask!=null?this._removeFrameTask():this._previewPlane!=null&&this._updateManipulators()}_removeFrameTask(){this._frameTask=ie(this._frameTask)}_pickMinResult(e){const t=xe(e,ke.get());return this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(t,this._intersector),this._intersector.results.min}_pickPlane(e,t,i,a){const s=this._pickMinResult(e),n=c.get();if(!s.getIntersectionPoint(n))return!1;const h=s.getTransformedNormal(c.get()),_=this.view.state.camera;C(h,_.viewForward)>0&&R(h,h,-1);const V=Ze(n,_),Pe=(t?1:-1)*V*ht,z=R(c.get(),h,Pe);X(z,z,n);const fe=this.analysis.tiltEnabled?E.TILTED:E.HORIZONTAL_OR_VERTICAL,Ve=i[G]?E.VERTICAL:i[A]?E.HORIZONTAL:fe;return We(z,h,V,V,_,Ve,this.view.renderCoordsHelper,a),!0}_clearPointerMoveTimeout(){this._prevPointerMoveTimeout=ie(this._prevPointerMoveTimeout)}_resetPointerMoveTimeout(){this._clearPointerMoveTimeout(),this.shiftManipulator.state|=g,this.rotateHeadingManipulator.state|=g,this.rotateTiltManipulator.state|=g,this._prevPointerMoveTimeout=this._clock.setTimeout((()=>{this.shiftManipulator.state&=~g,this.rotateHeadingManipulator.state&=~g,this.rotateTiltManipulator.state&=~g}),this._pointerMoveTimerMs)}_updateManipulators(){if(N.disableEngineLayers)return;let e,t,i=!1;if(this.analysisViewData.plane!=null)e=this.analysisViewData.plane,t=this._previewPlane??e,i=!1;else{if(this._previewPlane==null)return this._setManipulatorVisibility(!1),void this._setPreviewPlaneVisibility(!1);t=e=this._previewPlane,i=!0}if(this._setManipulatorVisibility(!i),!i){const a=j(e,f.get());Je(this.shiftManipulator,a,e,this.view.state.camera),Qe(this.rotateHeadingManipulator,a,e,this.view.renderCoordsHelper),Xe(this.rotateTiltManipulator,a,e),this.resizeManipulators.forEach(((s,n)=>Ye(s,this._resizeHandles[n],a,e)))}this._setPreviewPlaneVisibility(!this._creatingPointerId&&(i||this._mode==="place")),this._updatePreviewPlaneTransform(t),this._updateMaterials()}_setManipulatorVisibility(e){this.shiftManipulator.available=e,this.rotateHeadingManipulator.available=e,this.rotateTiltManipulator.available=e&&this.analysis.tiltEnabled,this.resizeManipulators.forEach((t=>t.available=e))}_updatePreviewPlaneTransform(e){const t=j(e,f.get()),i=ue(c.get(),T(e.basis1),T(e.basis2),1),a=pe(f.get(),i),s=ce(a,t,a);this._previewPlaneOutlineVisualElement.transform=s,this._previewPlaneGridVisualElement.transform=s}_setPreviewPlaneVisibility(e){const t=this._previewPlaneOutlineVisualElement,i=this._previewPlaneGridVisualElement;e&&(t.attached=!0,i.attached=!0),t.visible=e,i.visible=e}_updateMaterials(){const e=we(this.view.effectiveTheme);e[3]*=this._previewPlaneOpacity;const t=Le(me);t[3]*=this._previewPlaneOpacity,this._previewPlaneOutlineVisualElement.color=e,this._previewPlaneGridVisualElement.backgroundColor=t,this._previewPlaneGridVisualElement.gridColor=de}_updateManipulatorsInteractive(e){if(!e.grabbing)return this.shiftManipulator.interactive=!0,this.rotateHeadingManipulator.interactive=!0,this.rotateTiltManipulator.interactive=!0,void this.resizeManipulators.forEach((t=>{t.interactive=!0}));this.shiftManipulator.interactive=this.shiftManipulator===e,this.rotateHeadingManipulator.interactive=this.rotateHeadingManipulator===e,this.rotateTiltManipulator.interactive=this.rotateTiltManipulator===e,this.resizeManipulators.forEach((t=>{t.interactive=t===e}))}_finishToolCreationIfValid(){this.analysis.valid&&this.finishToolCreation()}get test(){return{plane:this.analysisViewData.plane,setPointerMoveTimerMs:e=>{this._pointerMoveTimerMs=e}}}};function re(e,t,i,a){const s=et(i,F(a),e.direction,K()),n=U();return k(s,e,n)?{type:"shift",creatingPointerId:t,hasBeenDragged:!1,shiftPlane:s,depth:0,startPoint:n}:null}function oe(e){return e.pointerType!=="mouse"||e.button===0}l([r()],o.prototype,"_clock",void 0),l([r({constructOnly:!0})],o.prototype,"view",void 0),l([r()],o.prototype,"analysisViewData",void 0),l([r({readOnly:!0})],o.prototype,"state",null),l([r({readOnly:!0})],o.prototype,"cursor",null),l([r()],o.prototype,"analysis",null),l([r()],o.prototype,"removeIncompleteOnCancel",void 0),l([r()],o.prototype,"_mode",void 0),l([r()],o.prototype,"mode",null),l([r({value:null})],o.prototype,"inputState",null),l([r()],o.prototype,"_placingSlicePlane",null),l([r()],o.prototype,"_creatingPointerId",null),o=N=l([H("esri.views.3d.analysis.Slice.SliceTool")],o);const mt=d(),M=Ce();let v=class extends q{constructor(e){super(e),this._gridVisualElement=null,this._outlineVisualElement=null,this.showGrid=!1,this.preview=!0}initialize(){const e=this.analysisViewData;if(e==null)throw new Error("expected internal object to be valid");this._gridVisualElement=_e(this.view),this._outlineVisualElement=ve(this.view),this.addHandles([y((()=>{const t=e.plane!=null&&this.analysisViewData.visible,{active:i}=this.analysisViewData,{preview:a,showGrid:s,view:n}=this,{effectiveTheme:h}=n;return{visible:t,active:i,preview:a,showGrid:s,gridColor:tt(h),outlineColor:we(h)}}),(t=>this._updateMaterials(t)),x),y((()=>e.plane),(t=>this._updatePlane(t)),x),ae(this._gridVisualElement),ae(this._outlineVisualElement),y((()=>this.analysis?.origin?.type!=="web-scene"),(t=>{this._gridVisualElement.isDecoration=t,this._outlineVisualElement.isDecoration=t}),x)])}destroy(){this.set("view",null)}_updatePlane(e){if(e==null)return;this._gridVisualElement.attached=!0,this._outlineVisualElement.attached=!0;const t=ue(c.get(),T(e.basis1),T(e.basis2),1),i=pe(f.get(),t),a=j(e,f.get()),s=ce(i,a,i);this._outlineVisualElement.transform=s,this._gridVisualElement.transform=s}_updateMaterials({visible:e,active:t,preview:i,showGrid:a,gridColor:s,outlineColor:n}){this._outlineVisualElement.color=n,this._outlineVisualElement.width=i?ge:ut,this._outlineVisualElement.stipplePattern=t?null:ct(5),this._gridVisualElement.backgroundColor=me,this._gridVisualElement.gridColor=a?s:de,this._gridVisualElement.visible=e,this._outlineVisualElement.visible=e}};l([r()],v.prototype,"view",void 0),l([r()],v.prototype,"analysis",void 0),l([r()],v.prototype,"analysisViewData",void 0),l([r()],v.prototype,"showGrid",void 0),l([r()],v.prototype,"preview",void 0),v=l([H("esri.views.3d.analysis.Slice.SliceVisualization")],v);let p=class extends Oe(q){constructor(e){super(e),this.type="slice-view-3d",this.analysis=null,this.tool=null,this.plane=null,this.active=!0,this.userOperation=null,this._analysisVisualization=null,this._analysisController=null}initialize(){this._analysisVisualization=new v({view:this.view,analysis:this.analysis,analysisViewData:this}),this._analysisController=new w({view:this.view,analysis:this.analysis,analysisViewData:this}),this.addHandles(Re(this,o))}destroy(){Ie(this),this._analysisVisualization=L(this._analysisVisualization),this._analysisController=L(this._analysisController)}get editable(){return!this._analysisVisualization.preview}set editable(e){this._analysisVisualization.preview=!e}get showGrid(){return this._analysisVisualization?.showGrid??!1}set showGrid(e){this._analysisVisualization&&(this._analysisVisualization.showGrid=e)}get testData(){}place(e){return this.active=!0,Ge(this,{placementOptions:e,onToolActivated:t=>t.start("place")})}async pickLayerToExclude(e){return this.active=!0,Ae(this,{abortOptions:e,onToolActivated:t=>t.start("exclude")})}};l([r({readOnly:!0})],p.prototype,"type",void 0),l([r({constructOnly:!0,nonNullable:!0})],p.prototype,"analysis",void 0),l([r()],p.prototype,"tool",void 0),l([r()],p.prototype,"plane",void 0),l([r()],p.prototype,"active",void 0),l([r()],p.prototype,"editable",null),l([r()],p.prototype,"showGrid",null),l([r()],p.prototype,"userOperation",void 0),l([r()],p.prototype,"_analysisVisualization",void 0),l([r()],p.prototype,"_analysisController",void 0),p=l([H("esri.views.3d.analysis.SliceAnalysisView3D")],p);const fi=p;export{fi as default};
