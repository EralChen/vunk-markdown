import{b as C,_ as T,a as b}from"./chunk-CZ531eoq.js";import{V as j,M as B}from"./chunk-P3cDqhc5.js";import{V as $,a as x}from"./chunk-BJUmiKhw.js";import{T as M}from"./chunk-68dipXmU.js";import{a6 as N,d as P,c as R,o as w,w as f,a,u as o,b as A,j as E,g as L}from"./chunk-DpJVogQA.js";import{_ as S}from"./chunk-AcizThcS.js";async function q(V,_,m){return N.reader({url:"/application/chat_message/d72c0954-819e-11f0-8636-062fece26b16",onmessage:V,abortController:m},{headers:{authorization:"application-9888ea942ed566bce1f7dc8cba294b46"},data:_})}const J={key:0},H=P({__name:"AgentChatProvider",setup(V){const _=({message:e},{onSuccess:i,onError:t,onUpdate:c})=>{if(!e?.content)return;const r=[],v="assistant";let g=!0,h=!1;const n=new B,k=new AbortController;k.signal.addEventListener("abort",()=>{h=!0,g=!1,n.allViewUpdated(),n.getViews().length===0&&n.upsertView({content:"对话已取消",type:"text",updating:!1}),l()}),l(),q(u=>{let s={content:"",reasoning_content:""};if(typeof u.data=="string")try{s=JSON.parse(u.data)}catch(d){t(d)}s.reasoning_content&&(g=!1,n.upsertView({content:s.reasoning_content,type:"thinking",updating:!0},{onCreate(d){const p=n.getPrevView(d);p&&(p.updating=!1)}}),l()),s.content&&(g=!1,n.upsertView({content:s.content,type:"text",updating:!0},{onCreate(d){const p=n.getPrevView(d);p&&(p.updating=!1)}}),l()),s.is_end&&(h=!0,n.allViewUpdated(),l(),y())},{message:e.content},k);function l(){const u={role:v,seviceLoading:g,seviceEnd:h,views:n.getViews(),abortController:k};c(u),r.push(u)}function y(){i(r)}},m=e=>{const i=e.views;let t=e.content??"";return i&&(t=i.reduce((c,r)=>(r.type==="thinking"?c+=[`:::thinking ${r.updating?"thinking":"end"}`,"```md",r.content,"```",":::"].join(`
`):c+=`
${r.content}`,c),"")),{role:e.role??"assistant",loading:e.seviceLoading===!0,content:t,abortController:e.abortController}};return(e,i)=>(w(),R(o(j),{request:_,parser:m},{default:f(()=>[a(o($),null,{default:f(()=>[a(o(x),{"markdown-props":{containers:["thinking"],fences:["json"]}}),a(o(C),null,{default:f(()=>[a(o(T)),a(o(b),{type:"container:thinking"},{default:f(({raw:t})=>[a(o(M),{content:t.children[0].content,status:t.open.info.split(" ")[1]||"thinking"},null,8,["content","status"])]),_:1}),a(o(b),{type:"fence:json"},{default:f(({raw:t})=>[t.info.split(" ")[1]==="layer"?(w(),E("ul",J,[a(S,{data:JSON.parse(t.content)},null,8,["data"])])):L("",!0)]),_:1}),A(e.$slots,"default")]),_:3})]),_:3})]),_:3}))}});export{H as _};
