import{i as T,b5 as K,f as x,_ as B,aa as I,d as z,a6 as D,b6 as J}from"./chunk-D2wkNa4R.js";import{n as N}from"./chunk-BffEhEhR.js";const X=`

`,G=`
`,H=":",j=t=>(t??"").trim()!=="";function Q(){let t="";return new TransformStream({transform(e,s){t+=e;const a=t.split(X);a.slice(0,-1).forEach(o=>{j(o)&&s.enqueue(o)}),t=a[a.length-1]},flush(e){j(t)&&e.enqueue(t)}})}function W(){return new TransformStream({transform(t,e){const s=t.split(G).reduce((a,o)=>{const i=o.indexOf(H);if(i===-1)throw new Error(`The key-value separator "${H}" is not found in the sse line chunk!`);const r=o.slice(0,i);if(!j(r))return a;const n=o.slice(i+1);return{...a,[r]:n}},{});Object.keys(s).length!==0&&e.enqueue(s)}})}function $(t){const{readableStream:e,transformStream:s}=t;if(!(e instanceof ReadableStream))throw new Error("The options.readableStream must be an instance of ReadableStream.");const a=new TextDecoderStream,o=s?e.pipeThrough(a).pipeThrough(s):e.pipeThrough(a).pipeThrough(Q()).pipeThrough(W());return o[Symbol.asyncIterator]=async function*(){const i=this.getReader();for(;;){const{done:r,value:n}=await i.read();if(r)break;n&&(yield n)}},o}const Y=async(t,e={})=>{const{fetch:s=globalThis.fetch,middlewares:a={},...o}=e;if(typeof s!="function")throw new Error("The options.fetch must be a typeof fetch function!");let i=[t,o];typeof a.onRequest=="function"&&(i=await a.onRequest(...i));let r=await s(...i);if(typeof a.onResponse=="function"){const n=await a.onResponse(r);if(!(n instanceof Response))throw new Error("The options.onResponse must return a Response instance!");r=n}if(!r.ok)throw new Error(`Fetch failed with status ${r.status}`);if(!r.body)throw new Error("The response body is empty.");return r};class O{constructor(e){this.create=async(r,n,l)=>{var g,d;const c=new AbortController,w={method:"POST",body:JSON.stringify({model:this.model,...r}),headers:this.defaultHeaders,signal:c.signal};(g=n?.onStream)==null||g.call(n,c);try{const y=await Y(this.baseURL,{fetch:this.customOptions.fetch,...w});if(l){await this.customResponseHandler(y,n,l);return}const b=y.headers.get("content-type")||"";switch(b.split(";")[0].trim()){case"text/event-stream":await this.sseResponseHandler(y,n);break;case"application/json":await this.jsonResponseHandler(y,n);break;default:throw new Error(`The response content-type: ${b} is not support!`)}}catch(y){const b=y instanceof Error?y:new Error("Unknown error!");throw(d=n?.onError)==null||d.call(n,b),b}},this.customResponseHandler=async(r,n,l)=>{var g,d;const c=[];for await(const w of $({readableStream:r.body,transformStream:l}))c.push(w),(g=n?.onUpdate)==null||g.call(n,w);(d=n?.onSuccess)==null||d.call(n,c)},this.sseResponseHandler=async(r,n)=>{var l,g;const d=[];for await(const c of $({readableStream:r.body}))d.push(c),(l=n?.onUpdate)==null||l.call(n,c);(g=n?.onSuccess)==null||g.call(n,d)},this.jsonResponseHandler=async(r,n)=>{var l,g;const d=await r.json();(l=n?.onUpdate)==null||l.call(n,d),(g=n?.onSuccess)==null||g.call(n,[d])};const{baseURL:s,model:a,dangerouslyApiKey:o,...i}=e;this.baseURL=e.baseURL,this.model=e.model,this.defaultHeaders={"Content-Type":"application/json",...e.dangerouslyApiKey&&{Authorization:e.dangerouslyApiKey}},this.customOptions=i}static init(e){if(!e.baseURL||typeof e.baseURL!="string")throw new Error("The baseURL is not valid!");return new O(e)}}const Z=t=>T(()=>O.init(K(t)));let F=0;class ee{constructor(e){this.requestingMap=x({}),this.request=(s,a,o)=>{const{request:i}=this.config,{onUpdate:r,onSuccess:n,onError:l,onStream:g}=a,d=F;F+=1,this.requestingMap.value[d]=!0,i?.(s,{onStream:c=>{this.requestingMap.value[d]&&g?.(c)},onUpdate:c=>{this.requestingMap.value[d]&&r(c)},onSuccess:c=>{this.requestingMap.value[d]&&(n(c),this.finishRequest(d))},onError:c=>{this.requestingMap.value[d]&&(l(c),this.finishRequest(d))}},o)},this.config=e}finishRequest(e){delete this.requestingMap.value[e]}isRequesting(){return Object.keys(this.requestingMap.value).length>0}}function te(t){return[T(()=>{const{request:e,...s}=K(t);return new ee({request:e||Z({baseURL:s.baseURL,model:s.model,dangerouslyApiKey:s.dangerouslyApiKey}).value.create,...s})})]}function ne(t,e){const s=x(t);function a(o){const i=typeof o=="function"?o(s.value):o;i!==s.value&&e(i,s.value),s.value=i}return[s,a]}function se(t){return Array.isArray(t)?t:[t]}function ae(t){const{defaultMessages:e,agent:s,requestFallback:a,requestPlaceholder:o,parser:i,transformMessage:r,transformStream:n,resolveAbortController:l}=t,g=x(0),d=T(()=>(e||[]).map((p,h)=>({id:`default_${h}`,status:"local",...p}))),[c,w]=ne(d.value,()=>{}),y=(p,h)=>{const u={id:`msg_${g.value}`,message:p,status:h};return g.value+=1,u},b=T(()=>{const p=[];return c.value.forEach(h=>{const u=i?i(h.message):h.message,m=se(u);m.forEach((R,_)=>{let f=h.id;m.length>1&&(f=`${f}_${_}`),p.push({id:f,message:R,status:h.status})})}),p}),S=p=>p.filter(h=>h.status!=="loading"&&h.status!=="error").map(h=>h.message),A=()=>S(c.value),U=p=>{const{chunk:h,chunks:u,originMessage:m}=p;if(typeof r=="function")return r(p);if(h)return h;if(Array.isArray(u)){const R=u?.length>0?u?.[u?.length-1]:void 0;return m||R}return u};return{onRequest:N(p=>{if(!s)throw new Error("The agent parameter is required when using the onRequest method in an agent generated by useXAgent.");let h=null,u,m={};if(p&&typeof p=="object"&&"message"in p){const{message:f,...v}=p;u=f,m=v}else u=p;w(f=>{let v=[...f,y(u,"local")];if(o){let k;typeof o=="function"?k=o(u,{messages:S(v)}):k=o;const q=y(k,"loading");h=q.id,v=[...v,q]}return v});let R=null;const _=(f,v,k)=>{let q=c.value.find(E=>E.id===R);if(q)w(E=>E.map(M=>{if(M.id===R){const C=U({originMessage:M.message,chunk:v,chunks:k,status:f});return{...M,message:C,status:f}}return M}));else{const E=U({chunk:v,status:f,chunks:k});q=y(E,f),w(M=>[...M.filter(C=>C.id!==h),q]),R=q.id}return q};s.request({message:u,messages:A(),...m},{onUpdate:f=>{_("loading",f,[])},onSuccess:f=>{_("success",void 0,f)},onError:async f=>{if(a){let v;typeof a=="function"?v=await a(u,{error:f,messages:A()}):v=a,w(k=>[...k.filter(q=>q.id!==h&&q.id!==R),y(v,"error")])}else w(v=>v.filter(k=>k.id!==h&&k.id!==R))},onStream:f=>{l?.(f)}},n)}),messages:c,parsedMessages:b,setMessages:w}}async function re(t,e){return D.reader({url:"/application/chat_message/69e23792-8162-11f0-8a7b-dee062287042",onmessage:t},{headers:{authorization:"application-8259214f7c6f2777658809d71bdfada3"},data:e})}var V=(t=>(t.User="user",t.Assistant="assistant",t.Broadcasting="broadcasting",t))(V||{});const oe=[{label:"用户",value:"user",isMarkdown:!1,placement:"end",templateType:"VkMarkdown"},{label:"AI 助手",value:"assistant",isMarkdown:!0,placement:"start",typing:!0,templateType:"VkMarkdown"}],ie=oe.reduce((t,e)=>(t[e.value]=e,t),{}),P="vk_agent_chat_inject_key";function ue(t){return te({request:t})}function le(t,e){const[s]=ue(t),a=ae({agent:s.value,parser:e}),o=l=>{a.onRequest({role:V.User,content:l})},i=T(()=>a.parsedMessages.value.map(l=>({key:l.id,...ie[l.message.role],...l.message}))),n={agent:s,chat:a,simplicity:{onRequest:o,items:i}};return J(P,n),n}function he(){const t=I(P,null);if(!t)throw new Error("useAgentChat must be used within a provider");return t}var ce=z({name:"VkAgentChatProvider",props:{request:{type:Function},parser:{type:Function}},emits:{load:null},setup(t,{slots:e,emit:s}){const a=(r,n)=>{const{message:l}=r,{onSuccess:g,onUpdate:d}=n,c=[];if(!l?.content)return;let w="";const y=V.Assistant;let b="",S="start",A=!0,U=!1;const p=()=>{const u={role:y,content:w,thinkingContent:b,thinkingStatus:S,seviceLoading:A,seviceEnd:U};d(u),c.push(u)},h=()=>{g(c)};p(),re(u=>{let m={content:"",reasoning_content:""};typeof u.data=="string"&&(m=JSON.parse(u.data)),m.reasoning_content&&(b+=m.reasoning_content,S="thinking",A=!1,p()),m.content&&(w+=m.content,A=!1,p()),b&&m.content&&(S="end",p()),m.is_end&&(U=!0,p(),h())},{message:l?.content})},o=r=>[{...r,role:r.role??V.User,content:r.content??"",loading:r.seviceLoading}],i=le(t.request??a,t.parser??o);return s("load",i),e.default}}),L=B(ce,[["__file","/home/runner/work/vunk-plus/vunk-plus/packages/components/agent-chat-provider/src/index.vue"]]);class fe{constructor(){this.views=[]}getViews(){return this.views}createView(e){this.views.push(e)}upsertView(e,s={}){let a=this.getLastUpdatingView(e.type);return a?(a.content+=e.content,a.updating=e.updating,s.onUpdate?.(a)):(a=e,this.createView(a),s.onCreate?.(a)),a}getPrevView(e){const s=this.views.indexOf(e);if(s>0)return this.views[s-1]}getLastUpdatingView(e){return this.views.findLast(s=>s.updating&&s.type===e)}allViewUpdated(){this.views.forEach(e=>{e.updating=!1})}}L.install=t=>{t.component(L.name||"VkAgentChatProvider",L)};export{fe as M,L as V,he as u};
