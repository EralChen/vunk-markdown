import{as as _,aq as b,fL as v,ar as E,L as f,a2 as M,a3 as $,fW as x,f2 as j,aj as r,ak as i,am as g,ut as R,b3 as P,aK as O,aL as G,kL as V,kr as L,ba as S,e3 as A,aQ as D}from"./chunk-XGpVqsM_.js";import{o as k}from"./chunk-DG01pWx_.js";import{p as T,E as z}from"./chunk-BaoKPrO7.js";import{U as N,V as I}from"./chunk-CHS0xj9Y.js";import"./chunk-DyqHK6XP.js";import"./chunk-Dix477Sg.js";/* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              */import"./chunk-CrMA_peF.js";import"./chunk-BRuaCZxn.js";import"./chunk-bVDAhtkp.js";import"./chunk-CTxi0THw.js";import"./chunk-DhkGovhm.js";import"./chunk-BoY5tY6Y.js";import"./chunk-CFw9_Mlk.js";import"./chunk-DTv8BWs_.js";import"./chunk-Bf2VBVmS.js";import"./chunk-BJ-DU5EY.js";let c=class extends _{get operations(){return this._operations}get updating(){return this._updatingHandles.updating}constructor(e){super(e),this._updatingHandles=new b}initialize(){this.addHandles([v(this._updatingHandles),this._updatingHandles.add((()=>{const e=this.element.georeference;return e?.type==="control-points"?e.controlPoints:null}),(e=>this._elementControlPointsChanged(e)),E)])}_elementControlPointsChanged(e){const t=e?.map((({mapPoint:n})=>n)).filter(f),o=this.view.spatialReference;this._updatingHandles.addPromise(this._whenProjected(t,o,(n=>{if(!n)return void this._replaceOperations(null);const{_operations:s}=this,d=n.map((({x:a,y:h})=>[a,h]));d.push(d[0].slice());const u=new M({rings:[d],spatialReference:o});if(s?.trySetGeometry(u))return void this.onModifiedExternally();const y=this.view.state.viewingMode;this._replaceOperations(new k(T.fromGeometry(u,y),y,(a=>this._operationsGeometryChanged(a))))})))}_operationsGeometryChanged(e){const{element:{georeference:t},_operations:o}=this;if(!o||!t||t.type!=="control-points"||!t.controlPoints)return;const n=o.data.geometry,s=t.controlPoints.map((({mapPoint:a})=>a)).filter(f),d=o.data.components[0].isClosed()?1:0;if(n.rings[0]?.length-d!==s.length)return;const u=n.rings[0].map((([a,h])=>new $({x:a,y:h,spatialReference:n.spatialReference})));u.length-=d;const y=s.map((({spatialReference:a})=>a));this._updatingHandles.addPromise(this._whenProjected(u,y,(a=>this._updateElementControlPoints(a,e))))}_updateElementControlPoints(e,t){const{georeference:o}=this.element;if(!o||!e||o.type!=="control-points"||o.controlPoints?.length!==e?.length)return;const n=o.controlPoints;if(n?.length===e.length)for(let s=0;s<n.length;s++)t&&(n[s].sourcePoint=o.toSource(e[s])),n[s].mapPoint=e[s]}async _whenProjected(e,t,o){if(!e)return void o(e);const{_operations:n,element:{georeference:s}}=this,d=e.map((({spatialReference:a})=>a)),u=Array.isArray(t)?t:new Array(d.length).fill(t);await x(Array.from(d).map(((a,h)=>({source:a,dest:u[h]}))));const y=e.map(((a,h)=>j(a,u[h])));n===this._operations&&s===this.element.georeference&&o(y)}_replaceOperations(e){this._operations&&(this.removeHandles(this._operations),this._operations.destroy()),this._operations=e}};r([i({constructOnly:!0})],c.prototype,"view",void 0),r([i({constructOnly:!0})],c.prototype,"layer",void 0),r([i({constructOnly:!0})],c.prototype,"element",void 0),r([i({constructOnly:!0})],c.prototype,"onModifiedExternally",void 0),r([i()],c.prototype,"_operations",void 0),r([i()],c.prototype,"operations",null),r([i()],c.prototype,"updating",null),c=r([g("esri.views.3d.interactive.editingTools.media.MediaElementControllerControlPoints")],c);let m=class extends _{get operations(){return this._operations}get updating(){return this._updatingHandles.updating}constructor(e){super(e),this._updatingHandles=new b}initialize(){this.addHandles([v(this._updatingHandles),this._updatingHandles.add((()=>this.element.georeference?.coords),(e=>this._elementCoordinatesChanged(e)),E)])}_elementCoordinatesChanged(e){this._updatedElementCoordinates!==e&&this._updatingHandles.addPromise(this._whenProjected(e,this.view.spatialReference,(t=>{if(!t)return void this._replaceOperations(null);const{_operations:o}=this;o?.trySetGeometry(t)?this.onModifiedExternally():this._replaceOperations(z.fromGeometry(t,this.view.state.viewingMode))})))}_operationsGeometryChanged(){const{element:{georeference:e},_operations:t}=this;if(!t||!e)return;const o=t.data.geometry;if(!e.coords)return void this._updateElementCoordinates(o);const n=e.coords.spatialReference;this._updatingHandles.addPromise(this._whenProjected(o,n,(s=>this._updateElementCoordinates(s))))}_updateElementCoordinates(e){const{georeference:t}=this.element;t&&(t.coords=e,this._updatedElementCoordinates=t.coords)}async _whenProjected(e,t,o){if(!e)return void o(e);const{_operations:n,element:{georeference:s}}=this,d=await R(e,t);n===this._operations&&s===this.element.georeference&&o(d)}_replaceOperations(e){this._operations&&(this.removeHandles(this._operations),this._operations.destroy()),this._operations=e,e&&this.addHandles(e.data.on("change",(()=>this._operationsGeometryChanged())),e),this.onModifiedExternally()}};r([i({constructOnly:!0})],m.prototype,"view",void 0),r([i({constructOnly:!0})],m.prototype,"layer",void 0),r([i({constructOnly:!0})],m.prototype,"element",void 0),r([i({constructOnly:!0})],m.prototype,"onModifiedExternally",void 0),r([i()],m.prototype,"_operations",void 0),r([i()],m.prototype,"operations",null),r([i()],m.prototype,"updating",null),m=r([g("esri.views.3d.interactive.editingTools.media.MediaElementControllerShape")],m);function Q(e,t,o){return H(e.allLayerViews.find((n=>n.layer===t)),o)}function H(e,t){if(!e||e.type!=="media-3d"||e.suspended)return!1;const o=e.layer.source;return!!o&&(o instanceof N||o instanceof I?o===t:"hasElement"in o&&o.hasElement(t))}let l=class extends _{grabbableForEvent(){return!0}constructor(e){super(e),this.interactive=!0,this.selectable=!1,this.grabbable=!0,this.grabbing=!1,this.dragging=!1,this.hovering=!0,this.selected=!1,this.cursor=null,this.consumesClicks=!0,this.events=new P.EventEmitter,this.addHandles(O((()=>this.selected),(t=>this.events.emit("select-changed",{action:t?"select":"deselect"})),G))}destroy(){this._set("view",null)}intersectionDistance(e){const{view:t,layer:o,element:n}=this;if(!Q(t,o,n))return null;const s=t.toMap(e,{include:{layer:o,element:n}});return s&&L(s,w,t.renderSpatialReference)?V(w,t.state.camera.eye):null}onElevationChange(){}onViewChange(){}};r([i({constructOnly:!0,nonNullable:!0})],l.prototype,"element",void 0),r([i({constructOnly:!0,nonNullable:!0})],l.prototype,"layer",void 0),r([i({constructOnly:!0,nonNullable:!0})],l.prototype,"view",void 0),r([i()],l.prototype,"interactive",void 0),r([i()],l.prototype,"selectable",void 0),r([i()],l.prototype,"grabbable",void 0),r([i()],l.prototype,"grabbing",void 0),r([i()],l.prototype,"dragging",void 0),r([i()],l.prototype,"hovering",void 0),r([i()],l.prototype,"selected",void 0),r([i()],l.prototype,"cursor",void 0),l=r([g("esri.views.3d.interactive.editingTools.media.MediaElementManipulator3D")],l);const w=S(),C=Symbol();let p=class extends P.EventedAccessor{get operations(){return this._controller?.operations}get elevationInfo(){return{mode:"on-the-ground",offset:0}}get _layerView(){const e=this.view.allLayerViews.find((t=>t.layer===this.layer));return e?.type==="media-3d"?e:null}get visible(){return H(this._layerView,this.element)}get isDraped(){return!0}get origin(){return null}get updating(){return!!this._controller?.updating}get _controllerClass(){return this.tool==="transform"||this.element.georeference?.type!=="control-points"?m:c}constructor(e){super(e),this.tool="transform"}initialize(){this.addHandles([O((()=>this._controllerClass),(e=>this._updateController(e)),D),A((()=>this._layerView),"element-render-changed",(({element:e})=>{this.element===e&&this.emit("committed")}))])}toMap(e){const{layer:t,element:o}=this;return this.view.toMap(e,{include:{layer:t,element:o}})}createManipulator(e){const{view:t,layer:o,element:n}=this;return new l({view:t,layer:o,element:n,...e})}_updateController(e){if(this._controller&&this._controller instanceof e)return;this.removeHandles(C);const{view:t,layer:o,element:n}=this,s=()=>{this.emit("modified-externally")};this._controller=new e({view:t,layer:o,element:n,onModifiedExternally:s}),s(),this.addHandles(v(this._controller),C)}};r([i({constructOnly:!0})],p.prototype,"view",void 0),r([i({constructOnly:!0})],p.prototype,"layer",void 0),r([i({constructOnly:!0})],p.prototype,"element",void 0),r([i()],p.prototype,"tool",void 0),r([i()],p.prototype,"_controller",void 0),r([i()],p.prototype,"elevationInfo",null),r([i()],p.prototype,"_layerView",null),r([i()],p.prototype,"visible",null),r([i()],p.prototype,"updating",null),r([i()],p.prototype,"_controllerClass",null),p=r([g("esri.views.3d.interactive.editingTools.ManipulatedObject3DMediaElement")],p);export{p as ManipulatedObject3DMediaElement};
