import{ti as w,cp as b,bd as $,tj as S,b4 as p,fX as x,c4 as v,nQ as R,aH as C,nE as L,aD as D,lU as I,as as z,tk as E,tl as F,aj as l,ak as a,am as _,tm as j,c2 as k,n as q,tn as G,dd as H,aL as M,bY as T,bk as W,eY as B,kC as P,c1 as U,eZ as Y,p1 as A}from"./chunk-XGpVqsM_.js";import{s as N,h as V}from"./chunk-D0Rb7foR.js";import{p as X}from"./chunk-BS6MVtAd.js";import{R as Z,b as O}from"./chunk-B_0s3AtF.js";function Q(t,e,s,n){const{spatialReference:r}=t;return J(s.map((i=>i.map((o=>{const[h,c]=K(o,e),{absoluteZ:f}=w(h,c,0,r,t,n),m=b(h,c,f);return t.renderCoordsHelper.toRenderCoords(m,r,m),m})))))}function J(t){const e=Z(t),s=new $({width:2,color:p(.1,.2,1,1),innerWidth:1,innerColor:p(.2,.4,1,1),cap:S.ROUND});return e.map((n=>O(s,n)))}function K({x:t,y:e},s){const{extent:n,size:[r,i]}=s;return[t/r*n.width+n.xmin,(i-e)/i*n.height+n.ymin]}function tt(t,e,s){let[n,r,i,o]=[null,null,null,null];for(e.reset(t);!e.done;){const h=e.next();if(h==null)continue;if(!h.visible){e.skipSubtree();continue}const c=h.extent;h.leaf&&h.rendered&&x(c,s)&&(n=g(c[0],n),r=g(c[1],r),i=y(c[2],i),o=y(c[3],o))}return n==null||r==null||i==null||o==null?null:v([n,r,i,o])}function y(t,e){return e==null?t:Math.max(t,e)}function g(t,e){return e==null?t:Math.min(t,e)}class et{constructor(e,s){this.streamlines=e,this._geometries=s,this._object3D=null,this._engineLayer=null}get attached(){return this._object3D!=null&&this._engineLayer!=null}attach(e){const{_geometries:s}=this;if(s==null)return;this.detach();const n=new R(e,{pickable:!1,updatePolicy:C.SYNC}),r=new L({geometries:s});r.visible=!0,n.add(r),this._object3D=r,this._engineLayer=n}detach(){this.attached&&(this._engineLayer=D(this._engineLayer),this._object3D=I(this._object3D))}}let d=class extends z{constructor(t){super(t),this.simulationSettings=null,this.loadImagery=null,this.createGeometry=null}async load(t,e){const s=await this.loadImagery(t,e);if(s==null)return null;const n=this._createFlowFieldFromData(s),r=this._getStreamlines(t,n),i=this.createGeometry(t,r);return new et(r,i)}_createFlowFieldFromData(t){return E(this.simulationSettings,t)}_getStreamlines(t,e){const{size:[s,n]}=t;return F(this.simulationSettings,e,s,n)}};l([a()],d.prototype,"simulationSettings",void 0),l([a()],d.prototype,"loadImagery",void 0),l([a()],d.prototype,"createGeometry",void 0),d=l([_("esri.views.3d.support.flow.StreamlinesStyle3D")],d);let u=class extends X{constructor(t){super(t),this.type="flow",this._preorderIterator=new j,this._abortController=null,this._debouncedLoad=k((async()=>{const{view:e,_style:s}=this;if(s==null)return;const n=this._computeExtent();if(n==null)return;const r={extent:n,timeExtent:this.layer.timeExtent,size:this._viewSizeWithEqualRatio(n),pixelRatio:e.state.contentPixelRatio};this._abortController==null&&(this._abortController=new AbortController);const i=this._abortController,o=await s.load(r,i.signal);q(i.signal),o!=null&&(this._resources?.detach(),o.attach(e.stage),this._resources=o)})),this._loadImagery=(e,s)=>{const{extent:n,size:[r,i],timeExtent:o}=e;return G(this.layer,n,r,i,o,s)},this._createFlowGeometry=(e,s)=>Q(this.view,e,s,this.elevationInfo)}initialize(){this.addHandles([H((()=>this.newStyleRequired),(()=>this._updateStyle()),M)]),this.updatingHandles.add((()=>this._style),(()=>this._triggerLoad())),this._updateStyle(),this.updatingHandles.addWhen((()=>!this.view.basemapTerrain?.updating),(()=>this._triggerLoad()))}destroy(){this._abortController=T(this._abortController),this.clear()}get layer(){return this.layerView.layer}get flowRenderer(){const t=this.layer.renderer;return t?.type!=="flow"?null:t}get elevationInfo(){return new W({mode:"absolute-height",offset:1e3})}get dataBounds(){const{fullExtent:t}=this.layer,{spatialReference:e}=this.view.basemapTerrain,s=B(t,e).geometry;return s==null?null:P(s)}get simulationSettings(){const{flowRenderer:t}=this;return t==null?null:N(t)}get newStyleRequired(){const t=this._style?.simulationSettings,e=this.simulationSettings;return t!=null&&e!=null&&!V(t,e)}doRefresh(){return this._triggerLoad()}clear(){this._resources?.detach(),this._resources=null}_triggerLoad(){return U(this.updatingHandles.addPromise(this._debouncedLoad()))}_updateStyle(){const{simulationSettings:t}=this;t!=null&&(this._style?.destroy(),this._style=new d({simulationSettings:t,loadImagery:this._loadImagery,createGeometry:this._createFlowGeometry}))}_computeExtent(){const t=this.view.basemapTerrain,e=t?.rootTiles;if(e==null||e.length===0)return null;const{spatialReference:s}=t,{dataBounds:n}=this;if(!s||n==null)return null;const r=tt(e,this._preorderIterator,n);return r==null?null:(A(r,n,r),Y(r,s))}_viewSizeWithEqualRatio(t){const e=(t.xmax-t.xmin)/(t.ymax-t.ymin),[s,n]=this.view.size;return s<n?[s,Math.floor(s/e)]:[Math.floor(n*e),n]}get test(){}};l([a()],u.prototype,"type",void 0),l([a()],u.prototype,"_style",void 0),l([a()],u.prototype,"layer",null),l([a()],u.prototype,"flowRenderer",null),l([a()],u.prototype,"elevationInfo",null),l([a()],u.prototype,"dataBounds",null),l([a()],u.prototype,"simulationSettings",null),l([a()],u.prototype,"newStyleRequired",null),u=l([_("esri.views.3d.layers.FlowSubView3D")],u);export{u as b};
