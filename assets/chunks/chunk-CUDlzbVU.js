import{e as mt}from"./chunk-Ci_uqM5T.js";import{b3 as A,aV as J,kw as wt,b2 as q,cj as tt,c$ as X,ck as et,cW as it,gs as ct,ty as yt,tz as It,d0 as lt,b4 as Nt,np as G,ib as ut,d3 as ft,b8 as T}from"./chunk-CuaFhuP3.js";import{RegularEdgeInstancesLayout as z,SilhouetteEdgeInstancesLayout as R,EdgeInputBufferLayout as $t}from"./chunk-D20dqfV_.js";import{bn as At}from"./chunk-Dpk1TJd9.js";class xt{constructor(){this.position0=A(),this.position1=A(),this.faceNormal0=A(),this.faceNormal1=A(),this.componentIndex=0,this.cosAngle=0}}const j=-1;function St(t,n,s){const a=t.vertices.position,i=t.vertices.componentIndex,u=m.position0,d=m.position1,g=m.faceNormal0,I=m.faceNormal1,{edges:r,normals:f}=Ot(t),w=r.length/4,N=n.allocate(w);let V=0;const F=w,x=s?.allocate(F);let U=0,e=0,o=0;W.length=0;for(let p=0;p<w;++p){const v=4*p;a.getVec(r.data[v],u),a.getVec(r.data[v+1],d);const _=W.pushNew();_.index=4*p,_.length=wt(u,d)}W.sort(((p,v)=>v.length-p.length));const l=new Array,c=new Array;W.forAll((({length:p,index:v})=>{const _=r.data[v],ht=r.data[v+1],Q=r.data[v+2],Y=r.data[v+3],Z=Y===j;if(a.getVec(_,u),a.getVec(ht,d),Z){const $=3*Q;q(g,f.data[$],f.data[$+1],f.data[$+2]),tt(I,g),m.componentIndex=i.get(_),m.cosAngle=X(g,I)}else{let $=3*Q;if(q(g,f.data[$],f.data[$+1],f.data[$+2]),$=3*Y,q(I,f.data[$],f.data[$+1],f.data[$+2]),m.componentIndex=i.get(_),m.cosAngle=X(g,I),bt(m,_t))return;m.cosAngle<-.9999&&tt(I,g)}e+=p,o++,Z||vt(m,Mt)?(n.write(N,V++,m),l.push(p)):Lt(m,pt)&&(x&&s&&s.write(x,U++,m),c.push(p))}));const y=new Float32Array(l.reverse()),S=new Float32Array(c.reverse()),b=x&&s?{instancesData:x.slice(0,U),lodInfo:{lengths:S}}:void 0;return{regular:{instancesData:N.slice(0,V),lodInfo:{lengths:y}},silhouette:b,averageEdgeLength:e/o}}function vt(t,n){return t.cosAngle<n}function bt(t,n){return t.cosAngle>n}function Lt(t,n){const s=yt(t.cosAngle);return It(nt,t.position1,t.position0),s*(X(it(Et,t.faceNormal0,t.faceNormal1),nt)>0?-1:1)>n}function Ot(t){const n=t.faces.length/3,s=t.faces,a=t.neighbors,i=t.vertices.position;h.length=H.length=0;for(let u=0;u<n;u++){const d=3*u,g=a[d],I=a[d+1],r=a[d+2],f=s[d],w=s[d+1],N=s[d+2];i.getVec(f,E),i.getVec(w,k),i.getVec(N,C),et(k,k,E),et(C,C,E),it(E,k,C),ct(E,E),H.pushArray(E),(g===j||f<w)&&(h.push(f),h.push(w),h.push(u),h.push(g)),(I===j||w<N)&&(h.push(w),h.push(N),h.push(u),h.push(I)),(r===j||N<f)&&(h.push(N),h.push(f),h.push(u),h.push(r))}return{edges:h,normals:H}}class Vt{constructor(){this.index=0,this.length=0}}const W=new J({allocator:t=>t||new Vt,deallocator:null}),h=new J({deallocator:null}),H=new J({deallocator:null}),m=new xt,Et=A(),nt=A(),E=A(),k=A(),C=A(),pt=lt(4),_t=Math.cos(pt),Bt=lt(35),Mt=Math.cos(Bt);function st(t,n,s){const a=n/3,i=new Uint32Array(s+1),u=new Uint32Array(s+1),d=(e,o)=>{e<o?i[e+1]++:u[o+1]++};for(let e=0;e<a;e++){const o=t[3*e],l=t[3*e+1],c=t[3*e+2];d(o,l),d(l,c),d(c,o)}let g=0,I=0;for(let e=0;e<s;e++){const o=i[e+1],l=u[e+1];i[e+1]=g,u[e+1]=I,g+=o,I+=l}const r=new Uint32Array(6*a),f=i[s],w=(e,o,l)=>{if(e<o){const c=i[e+1]++;r[2*c]=o,r[2*c+1]=l}else{const c=u[o+1]++;r[2*f+2*c]=e,r[2*f+2*c+1]=l}};for(let e=0;e<a;e++){const o=t[3*e],l=t[3*e+1],c=t[3*e+2];w(o,l,e),w(l,c,e),w(c,o,e)}const N=(e,o)=>{const l=2*e,c=o-e;for(let y=1;y<c;y++){const S=r[l+2*y],b=r[l+2*y+1];let p=y-1;for(;p>=0&&r[l+2*p]>S;p--)r[l+2*p+2]=r[l+2*p],r[l+2*p+3]=r[l+2*p+1];r[l+2*p+2]=S,r[l+2*p+3]=b}};for(let e=0;e<s;e++)N(i[e],i[e+1]),N(f+u[e],f+u[e+1]);const V=new Int32Array(3*a),F=(e,o)=>e===t[3*o]?0:e===t[3*o+1]?1:e===t[3*o+2]?2:-1,x=(e,o)=>{const l=F(e,o);V[3*o+l]=-1},U=(e,o,l,c)=>{const y=F(e,o);V[3*o+y]=c;const S=F(l,c);V[3*c+S]=o};for(let e=0;e<s;e++){let o=i[e];const l=i[e+1];let c=u[e];const y=u[e+1];for(;o<l&&c<y;){const S=r[2*o],b=r[2*f+2*c];S===b?(U(e,r[2*o+1],b,r[2*f+2*c+1]),o++,c++):S<b?(x(e,r[2*o+1]),o++):(x(b,r[2*f+2*c+1]),c++)}for(;o<l;)x(e,r[2*o+1]),o++;for(;c<y;)x(r[2*f+2*c],r[2*f+2*c+1]),c++}return V}const K=.7;let dt=class{updateSettings(n){this.settings=n,this._edgeHashFunction=n.reducedPrecision?Ft:Pt}write(n,s,a){D.seed=this._edgeHashFunction(a);const i=D.getIntRange(0,255),u=D.getIntRange(0,this.settings.variants-1),d=D.getFloat(),g=255*(.5*Tt(-(1-Math.min(d/K,1))+Math.max(0,d-K)/(1-K),1.2)+.5);n.position0.setVec(s,a.position0),n.position1.setVec(s,a.position1),n.componentIndex.set(s,a.componentIndex),n.variantOffset.set(s,i),n.variantStroke.set(s,u),n.variantExtension.set(s,g)}};const L=new Float32Array(6),O=new Uint32Array(L.buffer),P=new Uint32Array(1);function Pt(t){return L[0]=t.position0[0],L[1]=t.position0[1],L[2]=t.position0[2],L[3]=t.position1[0],L[4]=t.position1[1],L[5]=t.position1[2],P[0]=31*(31*(31*(31*(31*(166811+O[0])+O[1])+O[2])+O[3])+O[4])+O[5],P[0]}function Ft(t){const n=L;n[0]=B(t.position0[0]),n[1]=B(t.position0[1]),n[2]=B(t.position0[2]),n[3]=B(t.position1[0]),n[4]=B(t.position1[1]),n[5]=B(t.position1[2]),P[0]=5381;for(let s=0;s<O.length;s++)P[0]=31*P[0]+O[s];return P[0]}const ot=1e4;function B(t){return Math.round(t*ot)/ot}function Tt(t,n){return Math.abs(t)**n*Math.sign(t)}class Ut{constructor(){this._commonWriter=new dt}updateSettings(n){this._commonWriter.updateSettings(n)}allocate(n){return z.createBuffer(n)}write(n,s,a){this._commonWriter.write(n,s,a),Nt(M,a.faceNormal0,a.faceNormal1),ct(M,M);const{typedBuffer:i,typedBufferStride:u}=n.normalCompressed;G(i,s,M[0],M[1],M[2],u)}static{this.Layout=z}static{this.glLayout=ut(z,1)}}class Wt{constructor(){this._commonWriter=new dt}updateSettings(n){this._commonWriter.updateSettings(n)}allocate(n){return R.createBuffer(n)}write(n,s,a){this._commonWriter.write(n,s,a);{const{typedBuffer:i,typedBufferStride:u}=n.normalCompressed;G(i,s,a.faceNormal0[0],a.faceNormal0[1],a.faceNormal0[2],u)}{const{typedBuffer:i,typedBufferStride:u}=n.normal2Compressed;G(i,s,a.faceNormal1[0],a.faceNormal1[1],a.faceNormal1[2],u)}}static{this.Layout=R}static{this.glLayout=ut(R,1)}}const M=A(),D=new At;function kt(t){const n=gt(t.data,t.skipDeduplicate,t.indices,t.indicesLength);return at.updateSettings(t.writerSettings),rt.updateSettings(t.writerSettings),St(n,at,rt)}function gt(t,n,s,a){if(n){const d=st(s,a,t.count);return new Ct(s,a,d,t)}const i=mt(t.buffer,t.stride/4,{originalIndices:s}),u=st(i.indices,a,i.uniqueCount);return{faces:i.indices,facesLength:i.indices.length,neighbors:u,vertices:$t.createView(i.buffer)}}class Ct{constructor(n,s,a,i){this.faces=n,this.facesLength=s,this.neighbors=a,this.vertices=i}}const at=new Ut,rt=new Wt,Dt=ft().vec3f(T.POSITION0).vec3f(T.POSITION1),jt=ft().vec3f(T.POSITION0).vec3f(T.POSITION1).u16(T.COMPONENTINDEX),Xt=Object.freeze(Object.defineProperty({__proto__:null,extract:kt,extractComponentsEdgeLocationsLayout:jt,extractEdgeInformation:gt,extractEdgeLocationsLayout:Dt},Symbol.toStringTag,{value:"Module"}));export{Wt as N,Dt as d,Xt as e,kt as f,jt as g,St as p,gt as u,Ut as w};
