import{U as zt,Y as Ut,b8 as O,bi as L,bg as tt,bh as et,jM as Tt,jQ as Ot,bf as Ct,b9 as j,br as jt,ba as Vt,bs as kt,bt as V,n8 as Nt,n9 as Gt,s as Ft,na as Ht,nb as Wt,nc as qt,nd as lt,ky as Q,ne as ut,nf as ht,jO as Zt,ng as Yt,es as Qt,bk as Xt,b3 as I,k3 as Jt,j4 as K,k4 as Kt,jY as te,jX as ee,nh as ne,ni as se,aj as pt,kg as ae,nj as ie,nk as oe,nl as re,nm as ce,nn as le,aq as ue,no as he,b2 as k,e7 as W,eb as dt,cW as Et,gs as nt,np as pe,nq as de,nr as ge,ns as me,kF as fe,nt as ye,cj as be,ck as gt}from"./chunk-CuaFhuP3.js";import{W as X}from"./chunk-Dpk1TJd9.js";import{t as _e,e as mt}from"./chunk-DGkpYqI6.js";import{a as xe}from"./chunk-Bp0h8fOB.js";import{c as Se,a as It,p as At}from"./chunk-BvxomRZN.js";function He(t,e,n){const a=(e.length>0?e[0]:t.length/3)-1,s=Se(t,a,n);if(s!==Tt.Z){t=t.slice();for(let i=0;i<t.length;i+=3)t[i+s]=t[i+2]}return Ot(t,e,3)}function We(t){const e=[[O.POSITION,new L(t.attributeData.position,t.indices,3,!0)]],n=Ct(t.indices.length);return t.attributeData.colorFeature!=null?e.push([O.COLORFEATUREATTRIBUTE,new L([t.attributeData.colorFeature],n,1,!0)]):t.attributeData.color&&e.push([O.COLOR,new L(t.attributeData.color,n,4,!0)]),t.attributeData.uvMapSpace&&e.push([O.UVMAPSPACE,new L(t.attributeData.uvMapSpace,t.indices,4,!0)]),t.attributeData.boundingRect&&e.push([O.BOUNDINGRECT,new L(t.attributeData.boundingRect,t.indices,9,!0)]),new tt(t.material,e,t.mapPositions,et.Mesh,t.attributeData.objectAndLayerIdColor)}function qe(t,e=null){const n=[[O.POSITION,new L(t.attributeData.position,t.indices,3,!0)],[O.UV0,new L(t.attributeData.uv0,t.indices,2,!0)]];return new tt(t.material,n,t.mapPositions,et.Mesh,e)}function Pe(t){switch(t.type){case"extent":if(t instanceof zt)return Ut.fromExtent(t);break;case"polygon":return t}return null}let Ze=class{constructor(e,n,a){this.renderData=e,this.layerViewUid=n,this.graphicUid=a,this.outGeometries=new Array}};function we(t,e,n,a){const s=It(t.rings,!!t.hasZ&&a.mode!=="on-the-ground",At.CCW_IS_HOLE,t.spatialReference),i=j(s.position.length),o=jt(s.position,t.spatialReference,0,i,0,s.position,0,s.position.length/3,e,n,a),c=o!=null;return new Ee(s.position,i,vt(s.polygons,s.position,i),Mt(s.outlines,s.position,i),c,o)}function Qe(t,e){const n=It(t.rings,!1,At.CCW_IS_HOLE),a=Vt(n.position,t.spatialReference,0,n.position,e,0);for(let s=2;s<n.position.length;s+=3)n.position[s]=kt;return{position:n.position,polygons:vt(n.polygons,n.position),outlines:Mt(n.outlines,n.position),projectionSuccess:a}}function Mt(t,e,n=null){return t.filter((({count:a})=>a>1)).map((({index:a,count:s})=>{const i=3*a,o=3*s;return n!=null?new Rt(a,s,V(e,i,o),V(n,i,o)):new st(a,s,V(e,i,o))}))}function vt(t,e,n=null){const a=new Array;for(const{index:s,count:i,holeIndices:o,pathLengths:c}of t){if(i<=1)continue;const l=3*s,_=3*i,y=o.map((d=>d-s)),b=n!=null?new Oe(s,i,V(e,3*s,3*i),V(n,l,_),y,c):new Ce(s,i,V(e,3*s,3*i),y,c);a.push(b)}return a}class st{constructor(e,n,a){this.index=e,this.count=n,this.position=a}}class Rt extends st{constructor(e,n,a,s){super(e,n,a),this.mapPositions=s}}class Oe extends Rt{constructor(e,n,a,s,i,o){super(e,n,a,s),this.holeIndices=i,this.pathLengths=o}}class Ce extends st{constructor(e,n,a,s,i){super(e,n,a),this.holeIndices=s,this.pathLengths=i}}class Ee{constructor(e,n,a,s,i,o){this.position=e,this.mapPositions=n,this.polygons=a,this.outlines=s,this.projectionSuccess=i,this.sampledElevation=o}}const Ie=["polygon","extent"];class Xe extends Nt{constructor(e,n,a,s){super(e,n,a,s,$e(n)),this.ensureDrapedStatus(!1)}async doLoad(){if(!this._drivenProperties.size){const d=Gt(this._getSymbolSize());if(d)throw new Ft("graphics3dextrudesymbollayer:invalid-size",d)}const e=this.symbolLayer,n=e?.material,a=n?.color,s=this._getCombinedOpacityAndColor(a),i=Ht(s),o=s[3],c=this.needsDrivenTransparentPass,l=n?.emissive,_={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,diffuse:i,ambient:i,opacity:o,drivenOpacity:c,hasVertexColors:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:e.castShadows,emissiveStrength:l?.strength??0,emissiveSource:qt.Color,offsetTransparentBackfaces:!0,normalType:Wt.Compressed},y=new lt(_,this._context);y.setParameters({cullFace:y.transparent?Q.None:Q.Back});const b=new lt({..._,cullFace:Q.Back},this._context);this._materials[R.Main]=y,this._materials[R.Bottom]=b}destroy(){super.destroy(),this._materials.length=0}createGraphics3DGraphic(e){const n=e.graphic;if(!this._validateGeometry(n.geometry,Ie,this.symbolLayer.type))return null;const a=this._getVertexOpacityAndColor(e.renderingInfo,this._getFallbackOpacityAndColor(),255),s=this.setGraphicElevationContext(n);return this._createAs3DShape(n,e.renderingInfo,a,s,n.uid)}layerOpacityChanged(e,n){const a=this.symbolLayer?.material?.color,s=this._getCombinedOpacity(a);this._materials[R.Main]?.setParameters({opacity:s}),this._materials[R.Bottom]?.setParameters({opacity:s});const i=this._getLayerOpacity();e?.forEach((o=>n(o)?.layerOpacityChanged(i,this._context.isAsync)))}layerElevationInfoChanged(e,n){return this.updateGraphics3DGraphicElevationInfo(e,n,ut)}slicePlaneEnabledChanged(e,n){return this._materials[R.Main]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),this._materials[R.Bottom]?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),e?.forEach((a=>{const s=n(a);s?.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)})),!0}physicalBasedRenderingChanged(){const e={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0};return this._materials[R.Main]?.setParameters(e),this._materials[R.Bottom]?.setParameters(e),!0}_getExtrusionSize(e){let n;return n=e.size&&this._drivenProperties.size?xe(e.size,2)??0:this._getSymbolSize(),n/=this._context.renderCoordsHelper.unitInMeters,n}applyRendererDiff(e,n){return this._drivenPropertiesChanged(n)?ht.RecreateSymbol:ht.RecreateGraphics}async queryForSnapping(e,n,a,s){const i=this._getExtrusionSize(a)*this._context.renderCoordsHelper.unitInMeters/Zt(n),{objectId:o,target:c}=e,l=X(c);switch(l.z=(l.z??0)+i,e.type){case"edge":{const{start:_,end:y}=e,b=X(_),d=X(y);return b.z=(b.z??0)+i,d.z=(d.z??0)+i,[mt(o,l,1/0,b,d)]}case"vertex":return[_e(o,l,1/0),mt(o,c,1/0,c,l)];default:return[]}}_getSymbolSize(){return this.symbolLayer.size??1}_createAs3DShape(e,n,a,s,i){const o=Pe(e.geometry);if(o==null)return null;if(o.rings.length===0||!o.rings.some((A=>A.length>0)))return this._logGeometryValidationWarnings(o.rings,"rings","ExtrudeSymbol3DLayer"),null;const c=we(o,this._context.elevationProvider,this._context.renderCoordsHelper,s);this._logGeometryCreationWarnings(c,o.rings,"rings","ExtrudeSymbol3DLayer");const l=Yt(o);if(l==null)return null;const _=new Array,y=new Array,b=Qt(),d=K(),E=I(),u=this._context.renderCoordsHelper.viewingMode===Xt.Global;u||this._context.renderCoordsHelper.worldUpAtPosition(null,E),Jt(o.spatialReference,[l.x,l.y,0],d,this._context.renderCoordsHelper.spatialReference);const m=K();Kt(m,d);const g=ee();te(g,m);const{polygons:x,mapPositions:p,position:f}=c,h=new Map,P=this._materials[R.Main];for(const A of x){const D=A.count;if(this._context.clippingExtent&&(ne(A.mapPositions,b),!se(b,this._context.clippingExtent)))continue;const B=Ot(A.mapPositions,A.holeIndices,3);if(B.length===0)continue;const z=B.length,$=6*D,U=pt($+z),q=pt(z),G=j(3*$),at=j(3*$),it=j(3*$),ot=j($);Ae(f,p,B,A,G,it,at,ot,U,q,this._getExtrusionSize(n),E,u),ae(G,G,m);const rt=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:i,layerViewUid:this._context.layerViewUid}),Z=new Te(G,it,ie(at),ot),Y=ft(P,U,U.length-q.length,Z,a,rt),Lt=D,Dt=D,Bt=2*A.count,ct=new je(Lt,Dt,Bt,z/3);$t(Y,ct,d),h.set(Y,ct),_.push(Y,ft(this._materials[R.Bottom],q,0,Z,a,rt)),y.push(Z.heights)}if(_.length===0)return null;const r=new oe({geometries:_,layerViewUid:this._context.layerViewUid,graphicUid:i,isElevationSource:!0});r.transformation=d;const S=re(this.symbolLayer,{opacity:this._getLayerOpacity()}),w=S?new ce(this._materials[R.Main],S,this._context.slicePlaneEnabled):null,M=new le(this,r,null,((A,D,B,z,$)=>Re(A,D,B,z,$,y,h)),s,w);return M.alignedSampledElevation=c.sampledElevation,M.needsElevationUpdates=ut(s.mode),M}_getFallbackOpacityAndColor(){const e=this.symbolLayer?.material?.color;return ue.toUnitRGBA(e)??he}}function ft(t,e,n,a,s,i){const o=Ct(e.length),c=[[O.POSITION,new L(a.positions,e,3,!0)],[O.NORMALCOMPRESSED,new L(a.normals,e,2,!0)],[O.COLOR,new L(s,o,4,!0)]];return new tt(t,c,a.elevation,et.Mesh,i,n)}function Ae(t,e,n,a,s,i,o,c,l,_,y,b,d){const E=n.length/3;let u=2*a.count;Me(t,e,a.index,a.count,n,0,E,s,i,o,c,l,_,u,y,b,d);let m=0,g=2*a.count;u=0;const x=a.pathLengths[0];yt(s,i,c,o,m,x,a.count,g,l,u,y),g+=4*x,u+=2*x,m+=x;for(let p=1;p<a.pathLengths.length;++p){const f=a.pathLengths[p];yt(s,i,c,o,m,f,a.count,g,l,u,y),g+=4*f,u+=2*f,m+=f}}function Me(t,e,n,a,s,i,o,c,l,_,y,b,d,E,u,m,g){be(v,m),l??=[],_??=[],y??=[];const x=u>0?1:-1;let p=3*n,f=0,h=3*f,P=a,r=3*P;for(let M=0;M<a;++M){const A=t[p],D=t[p+1],B=t[p+2];g&&(v[0]=A,v[1]=D,v[2]=B,nt(v,v)),c[h+0]=A,c[h+1]=D,c[h+2]=B;const z=e[p+0],$=e[p+1],U=e[p+2];l[h+0]=z,l[h+1]=$,l[h+2]=U,_[h+0]=-x*v[0],_[h+1]=-x*v[1],_[h+2]=-x*v[2],y[f]=0,c[r+0]=A+u*v[0],c[r+1]=D+u*v[1],c[r+2]=B+u*v[2],l[r+0]=z,l[r+1]=$,l[r+2]=U,y[P]=u,h+=3,r+=3,p+=3,f+=1,P+=1}p=3*i,h=0,r=3*E;const S=u<0?wt:Pt,w=u<0?Pt:wt;for(let M=0;M<o;++M)d[h]=s[p+S[0]],d[h+1]=s[p+S[1]],d[h+2]=s[p+S[2]],b[r]=s[p+w[0]]+a,b[r+1]=s[p+w[1]]+a,b[r+2]=s[p+w[2]]+a,h+=3,r+=3,p+=3}function F(t,e,n,a,s,i,o){a[i]=a[o],o*=3,t[i*=3]=t[o],t[i+1]=t[o+1],t[i+2]=t[o+2],e[i]=e[o],e[i+1]=e[o+1],e[i+2]=e[o+2],n[i]=s[0],n[i+1]=s[1],n[i+2]=s[2]}const N=I();function yt(t,e,n,a,s,i,o,c,l,_,y){e??=[],n??=[],a??=[];let b=s,d=s+1,E=s+o,u=s+o+1,m=c,g=c+1,x=c+2*i,p=c+2*i+1;y<0&&(b=s+o+1,u=s);let f=3*_;for(let h=0;h<i;++h)h===i-1&&(d=s,y>0?u=s+o:b=s+o),ve(t,b,d,E,N),F(t,e,a,n,N,m,b),F(t,e,a,n,N,g,d),F(t,e,a,n,N,x,E),F(t,e,a,n,N,p,u),l[f]=m,l[f+1]=x,l[f+2]=p,l[f+3]=m,l[f+4]=p,l[f+5]=g,f+=6,b++,d++,E++,u++,m+=2,g+=2,x+=2,p+=2}const J=I(),bt=I(),_t=I(),xt=I(),St=I();function ve(t,e,n,a,s){e*=3,n*=3,a*=3,k(J,t[e++],t[e++],t[e++]),k(bt,t[n++],t[n++],t[n++]),k(_t,t[a++],t[a++],t[a++]),gt(xt,bt,J),gt(St,_t,J),Et(s,St,xt),nt(s,s)}const T=I();function Re(t,e,n,a,s,i,o){const c=t.stageObject,l=c.geometries,_=l.length,y=e.mode!=="absolute-height";let b=0;const d=c.transformation,E=de(K(),d);for(let u=0;u<_;u+=2){const m=l[u];if(!ge(m))continue;const g=m.getMutableAttribute(O.POSITION).data,x=i[u/2],p=new me(m.mapPositions),f=g.length/3;let h=!1,P=0;{let r=0;for(let S=0;S<f;S++){T[0]=g[r],T[1]=g[r+1],T[2]=g[r+2],a(p,H),y&&(P+=H.sampledElevation),ye.TESTS_DISABLE_OPTIMIZATIONS?(k(C,p.array[p.offset],p.array[p.offset+1],H.z+x[r/3]),n!=null&&s.toRenderCoords(C,n,C),W(C,C,E)):(k(C,g[r],g[r+1],g[r+2]),W(C,C,d),s.setAltitude(C,H.z+x[r/3]),W(C,C,E)),g[r]=C[0],g[r+1]=C[1],g[r+2]=C[2];const w=Le/s.unitInMeters;(Math.abs(T[0]-g[r])>=w||Math.abs(T[1]-g[r+1])>=w||Math.abs(T[2]-g[r+2])>=w)&&(h=!0),p.offset+=3,r+=3}}if(h){const r=o.get(m);r&&$t(m,r,d),c.geometryVertexAttributeUpdated(l[u],O.NORMALCOMPRESSED),m.invalidateBoundingInfo(),c.geometryVertexAttributeUpdated(l[u],O.POSITION),l[u+1].invalidateBoundingInfo(),c.geometryVertexAttributeUpdated(l[u+1],O.POSITION)}b+=P/f}return b/_}function $t(t,e,n){const a=t.getMutableAttribute(O.POSITION),s=t.getMutableAttribute(O.NORMALCOMPRESSED).data,{topVertexStart:i,topVertexCount:o,topFaceStart:c,topFaceCount:l}=e,_=a.data,y=o,b=t.attributes.get(O.POSITION).indices,d=c+l,E=i+o,u=j(3*y);for(let h=0;h<y;++h){const P=3*h;u[P+0]=0,u[P+1]=0,u[P+2]=0}const m=De,g=Be,x=ze,p=Ue,f=v;for(let h=c;h<d;++h){const P=3*h;for(let r=0;r<3;++r){const S=b[P+r];p[r]=S;const w=3*S;k(C,_[w+0],_[w+1],_[w+2]),W(m[r],C,n)}dt(g,m[1],m[0]),dt(x,m[2],m[0]),Et(f,g,x),nt(f,f);for(let r=0;r<3;++r){const S=3*(p[r]-i);u[S+0]+=f[0],u[S+1]+=f[1],u[S+2]+=f[2]}}for(let h=i;h<E;++h){const P=3*(h-i),r=u[P+0],S=u[P+1],w=u[P+2],M=Math.sqrt(r*r+S*S+w*w);pe(s,h,r/M,S/M,w/M)}}function $e(t){return(t.material?.color?.a??1)===1}const C=I(),v=I(),H=new fe,Pt=[0,2,1],wt=[0,1,2],Le=.01,De=[I(),I(),I()],Be=I(),ze=I(),Ue=[0,0,0];var R;(function(t){t[t.Main=0]="Main",t[t.Bottom=1]="Bottom"})(R||(R={}));class Te{constructor(e,n,a,s){this.positions=e,this.elevation=n,this.normals=a,this.heights=s}}class je{constructor(e,n,a,s){this.topVertexStart=e,this.topVertexCount=n,this.topFaceStart=a,this.topFaceCount=s}}export{qe as a,Pe as b,Qe as c,Ze as g,He as l,We as m,Ae as n,we as p,Xe as s};
