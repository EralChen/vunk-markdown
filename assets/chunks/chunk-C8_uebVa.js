import{cH as h,cI as L,s as y,b7 as S,l as T,C as v}from"./chunk-DM6Pdl6C.js";import{t as F,a as M}from"./chunk-CT3e3I4u.js";import{c as $,n as P,l as d,a as G,e as g,o as x,u as I,i as C,t as f}from"./chunk-BgEynAQD.js";import"./chunk-xyJqyGK2.js";import"./chunk-CnRapvGM.js";/* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              */import"./chunk-SqlbPPT2.js";async function De(t,a){const r=t.instance.portalItem;if(r?.id)return await r.load(a),D(t),t.validateItem&&t.validateItem(r),k(t,a)}function D(t){const a=t.instance.portalItem;if(!a?.type||!t.supportedTypes.includes(a.type))throw new y("portal:invalid-layer-item-type","Invalid layer item type '${type}', expected '${expectedType}'",{type:a?.type,expectedType:t.supportedTypes.join(", ")})}async function k(t,a){const r=t.instance,e=r.portalItem;if(!e)return;const{url:n,title:o}=e,s=h(e,"portal-item");if(r.type==="group")return j(r,s,t);n&&r.type!=="media"&&r.read({url:n},s);const p=new g,i=await b(t,p,a);return i&&r.read(i,s),r.resourceReferences={portalItem:e,paths:s.readResourcePaths??[]},r.type!=="subtype-group"&&r.read({title:o},s),L(r,s)}async function j(t,a,r){const e=t.portalItem;if(!t.sourceIsPortalItem)return;const{title:n,type:o}=e;if(o==="Group Layer"){if(!S(e,"Map"))throw new y("portal:invalid-layer-item-typekeyword","'Group Layer' item without 'Map' type keyword is not supported");return A(t,r)}return t.read({title:n},a),E(t,r)}async function A(t,a){const r=t.portalItem,e=await r.fetchData("json");if(!e)return;if(!a.populateGroupLayer)throw new y("portal:missing-populate-group-layer","Missing populate group layer");const n=h(r,"web-map");t.read(e,n),await a.populateGroupLayer(t,e,{context:n}),t.resourceReferences={portalItem:r,paths:n.readResourcePaths??[]}}async function E(t,a){let r;const{portalItem:e}=t;if(!e)return;const n=e.type,o=a.layerModuleTypeMap;if(!o)throw new y("portal:missing-layer-module-type-map","Layer module type map is required to construct sub layers");switch(n){case"Feature Service":case"Feature Collection":r=o.FeatureLayer;break;case"Stream Service":r=o.StreamLayer;break;case"Scene Service":r=o.SceneLayer;break;default:throw new y("portal:unsupported-item-type-as-group",`The item type '${n}' is not supported as a 'IGroupLayer'`)}const s=new g;let[p,i]=await Promise.all([r(),b(a,s)]),l=()=>p;if(n==="Feature Service"){const u=d(i)?.customParameters;i=e.url?await G(i,e.url,s):{},l=await z(i,o)||l;const c=await H(e.url,{customParameters:u,loadContext:s});return await m(t,l,l,i,o,c)}return n==="Scene Service"&&e.url&&(i=await x(e,i,s)),I(i)>0?await m(t,l,null,i,o):await O(t,l,o)}async function O(t,a,r){const{portalItem:e}=t;if(!e?.url)return;const n=await M(e.url);n&&m(t,a,null,{layers:n.layers?.map(f),tables:n.tables?.map(f)},r)}async function m(t,a,r,e,n,o){let s=e.layers||[];const p=e.tables||[];if(t.portalItem?.type==="Feature Collection"?(s.forEach((i,l)=>{i.id=l,i?.layerDefinition?.type==="Table"&&p.push(i)}),s=s.filter(i=>i?.layerDefinition?.type!=="Table")):(s.reverse(),p.reverse()),s.forEach(i=>{const l=o?.(i);if(l||!o){const u=w(t,a(i),e,i,l);t.add(u)}}),p.length){const i=r?null:await n.FeatureLayer();p.forEach(l=>{const u=o?.(l);if(u||!o){const c=w(t,r?r(l):i,e,l,u);t.tables.add(c)}})}}function w(t,a,r,e,n){const o=t.portalItem,s={portalItem:o.clone(),layerId:e.id};e.url!=null&&(s.url=e.url);const p=new a(s);if("sourceJSON"in p&&(p.sourceJSON=n),p.type!=="subtype-group"&&p.type!=="catalog"&&(p.sublayerTitleMode="service-name"),o.type==="Feature Collection"){const i={origin:"portal-item",portal:o.portal||v.getDefault()};p.read(e,i);const l=r.showLegend;l!=null&&p.read({showLegend:l},i)}return p}async function b(t,a,r){if(t.supportsData===!1)return;const e=t.instance,n=e.portalItem;if(!n)return;let o=null;try{o=await n.fetchData("json",r)}catch{}if(N(e)){let s=null;const p=await R(n,o,a);if((o?.layers||o?.tables)&&p>0){if(e.layerId==null){const i=$(e.type),l=i?.length?P(o,i)[0]:d(o);l&&(e.layerId=l.id)}s=J(o,e),s?.layerType==="OrientedImageryLayer"&&e.type==="oriented-imagery"&&e.supportedSourceTypes.add("Feature Layer"),s&&o.showLegend!=null&&(s.showLegend=o.showLegend)}return p>1&&"sublayerTitleMode"in e&&e.sublayerTitleMode!=="service-name"&&(e.sublayerTitleMode="item-title-and-service-name"),s}return o}async function R(t,a,r){if(a?.layers&&a?.tables)return I(a);const e=T(t.url);if(!e)return 1;const n=await r.fetchServiceMetadata(e.url.path,{customParameters:d(a)?.customParameters}).catch(()=>null);return(a?.layers?.length??n?.layers?.length??0)+(a?.tables?.length??n?.tables?.length??0)}function J(t,a){const{layerId:r}=a,e=t.layers?.find(n=>n.id===r)||t.tables?.find(n=>n.id===r);return e&&q(e,a)?e:null}function N(t){return t.type!=="stream"&&"layerId"in t}function q(t,a){const r="layerType"in t&&t.layerType,{type:e}=a;return!(e==="feature"&&r&&t.layerType!=="ArcGISFeatureLayer"||e==="catalog"&&!r||e==="oriented-imagery"&&!r||e==="subtype-group"&&!r)}async function H(t,a){const{layersJSON:r}=await F(t,a);if(!r)return null;const e=[...r.layers,...r.tables];return n=>e.find(o=>o.id===n.id)}async function z(t,a){const{layers:r,tables:e}=t,n=[...r??[],...e??[]];if(!n.length)return;const o=new Set,s=[];for(const{layerType:l}of n){const u=l??"ArcGISFeatureLayer";if(o.has(u))continue;o.add(u);const c=a[C(u)];s.push(c())}const p=await Promise.all(s),i=new Map;return Array.from(o).forEach((l,u)=>{i.set(l,p[u])}),({layerType:l})=>{const u=l??"ArcGISFeatureLayer";return i.get(u)}}export{De as load};
