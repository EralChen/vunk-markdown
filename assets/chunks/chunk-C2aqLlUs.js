import{de as Ce,me as ne,re as L,kN as U,gQ as v,rF as E,rG as J,rH as k,rI as A,rJ as g,cZ as xe,cX as Te,rK as Me,r4 as Pe,z as Ee,rL as Oe,rM as Ae,gm as Ue,d6 as X,aq as I,s as He,rN as Ie,aJ as oe,rO as Re,aC as le,c3 as Se,rP as Ve,fF as Fe,n7 as ce,rQ as ke,dd as je,bq as De,g3 as Be,nu as Le,ki as $e,jg as de,rR as Ne,ke as Ge,ka as he,rS as ze,rT as K,rU as We,rV as qe,b9 as Q,ix as Je,rW as Xe,rX as ue,rY as Ke,rZ as me,r_ as Qe,pF as Ye,ba as Ze,k8 as et,r$ as Y,be as j,s0 as pe,s1 as tt,cK as st,b3 as it,s2 as rt,s3 as at,s4 as nt,s5 as C,g7 as Z,s6 as ee,o$ as ot,s7 as R,rd as lt,rj as ct,rk as dt,k6 as te,rm as ht,rn as ut,bo as D,s8 as mt,s9 as pt,sa as ge,sb as fe,A as be,df as gt,ai as O,aj as S,al as ft}from"./chunk-CZWLvyZS.js";import{x as bt,n as yt,t as _t,i as wt}from"./chunk-40nWwrij.js";import{f as vt}from"./chunk-Sd1_GN0g.js";import{f as Ct}from"./chunk-9tHIZPPi.js";import{l as xt}from"./chunk-DQoekzYY.js";import{s as Tt}from"./chunk-BTG8-S2g.js";import"./chunk-CPs2Sz-2.js";import"./chunk-B3snLTzY.js";class Mt extends Ce{constructor(e,u,o,c,r,h,d){super(e,0,0,0,u),this.nodesCached=o,this.vboMB=c,this.textureMB=r,this.vboMBCached=h,this.textureMBCached=d}}const Pt={[E.Points]:null,[E.Lines]:null,[E.LineStrip]:null,[E.Triangles]:ne.TRIANGLES,[E.TriangleStrip]:ne.TRIANGLE_STRIP,[E.NotSet]:null},ye={[J.Opaque]:L.Opaque,[J.Mask]:L.Mask,[J.Blend]:L.Blend},Et={[k.Back]:U.Back,[k.Front]:U.Front,[k.None]:U.None,[k.NotSet]:U.Back},Ot={[A.WrapYBit]:{s:v.CLAMP_TO_EDGE,t:v.REPEAT},[A.WrapXBit]:{s:v.REPEAT,t:v.CLAMP_TO_EDGE},[A.WrapXy]:{s:v.REPEAT,t:v.REPEAT},[A.None]:{s:v.CLAMP_TO_EDGE,t:v.CLAMP_TO_EDGE},[A.NotSet]:{s:v.CLAMP_TO_EDGE,t:v.CLAMP_TO_EDGE}},At={[g.U8]:1,[g.I8]:1,[g.U16]:2,[g.I16]:2,[g.U32]:4,[g.I32]:4,[g.F32]:4,[g.F64]:8,[g.Utf8String]:1,[g.NotSet]:1};class Ut{constructor(e){this.type=xe.TILES3D,this.slicePlaneEnabled=!1,this.isGround=!0,this.layerView=e,this.layerViewUid=e.uid}intersect(e,u,o,c,r,h){if(e.options.filteredLayerViewUids.includes(this.layerView.uid))return;const d=e.results,w=e.options.store===Te.ALL,f=this.layerView.view.stage.renderView.componentObjectCollection,m=new Me(h,e.options.normalRequired);this.layerView.objects.forEach((a=>{a.visible&&a.intersectionGeometry&&f.intersect(a,o,c,e.tolerance,null,m,((n,s,p,l)=>{if(s>=0){if(u!=null&&!u(o,c,s))return;const x=y=>{const _=new Oe(this.layerView.layer.uid,(()=>this._createTiles3DGraphic(this.layerView.layer,{})));y.set(this.type,_,s,p)};if(this.isGround&&(d.ground.distance==null||s<d.ground.distance)&&x(d.ground),e.options.isFiltered)return;if((d.min.distance==null||s<d.min.distance)&&x(d.min),(d.max.distance==null||s>d.max.distance)&&x(d.max),w){const y=new Pe(e.ray);x(y),e.results.all.push(y)}}}))}))}_createTiles3DGraphic(e,u){return new Ee({layer:e,sourceLayer:e,attributes:u})}}var b;(function(t){t[t.API=1]="API",t[t.VerboseAPI=2]="VerboseAPI",t[t.Error=3]="Error"})(b||(b={}));class Ht{constructor(){this.handle=0,this.isVisible=!1,this.components=[],this.textureMemoryUsage=0,this.vboMemoryUsage=0,this.cpuMemoryUsage=0,this.textures=[]}get usedMemory(){return this.textureMemoryUsage+this.vboMemoryUsage+this.cpuMemoryUsage}get cachedMemory(){return this.usedMemory}}function B(t){return Math.round(t/1048.576)/1e3}let M=class extends xt(gt){constructor(){super(...arguments),this.type="integrated-mesh-3dtiles",this._compressionTracker=new Ae,this._modifications=new Array,this._visibleGeometryChangedSchedulerHandle=null,this._wasmLayerId=-1,this.ignoresMemoryFactor=!1,this.drapeTargetType=Ue.WithoutRasterImage,this._applySSAO=!X("disable-feature:im-ssao"),this._shadeNormals=!!X("enable-feature:im-shading"),this._lyrHandleToObjects=new Map,this._initialCullFace=new Map,this._suspendedHandle=null,this._dbgFlags=new Set}get hasModifications(){return this._modifications&&this._modifications.length>0}initialize(){if(this._dbgFlags.add(b.Error),this._dbg(b.VerboseAPI,"Tiles3DLayerView3D initialize() called"),this._updatingHandles.add((()=>this.layer.modifications),(()=>this._loadModifications()),I),!this._canProjectWithoutEngine())throw new He("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});const t=Ie(this).then((e=>{this._wasmLayerId=e,this._intersectionHandler=new Ut(this),this.view.sceneIntersectionHelper.addIntersectionHandler(this._intersectionHandler),this._updatingHandles.add((()=>this.slicePlaneEnabled),(o=>this._slicePlaneEnabledChange(o))),this._updatingHandles.add((()=>this._modifications),(()=>this._modificationsChanged()),I),this._updatingHandles.add((()=>this.view.clippingArea),(()=>this._clippingAreaChanged()),I),this._elevationProvider=new bt({view:this.view,layerElevationSource:this,intersectionHandler:this._intersectionHandler}),this.view.elevationProvider.register("im",this._elevationProvider),this.view.basemapTerrain.overlayManager.registerDrapeTarget(this);const u=this.view.resourceController.memoryController.newCache(`t3d-${this.uid}`,(o=>this._onRemoveFromCache(o)));this._memCache=u,this.addHandles([oe((()=>this.layer.elevationInfo),(o=>this._elevationInfoChanged(o)))]),this._suspendedHandle=oe((()=>this.suspended),(o=>this._wasm?.setEnabled(this,!o)),I)}));this.addResolvingPromise(t)}destroy(){this._dbg(b.VerboseAPI,"Tiles3DLayerView3D destroy() called"),Re(this),this._suspendedHandle&&(this._suspendedHandle.remove(),this._suspendedHandle=null),this._intersectionHandler&&(this.view.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler),this._intersectionHandler=null),this._elevationProvider&&(this._elevationProvider.objectsChanged(this._obbs),this.view.elevationProvider.unregister(this._elevationProvider),this._elevationProvider=null),this.view.basemapTerrain.overlayManager.unregisterDrapeTarget(this),this._lyrHandleToObjects.forEach((t=>this.freeObject(t))),this._lyrHandleToObjects.clear(),this._initialCullFace.clear(),this._memCache=le(this._memCache),this._updatingHandles=le(this._updatingHandles),this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null)}_modificationsChanged(){const t=this.layer.spatialReference,e=Ct(this._layerClippingArea,this._modifications,t);this._wasm?.setMeshModifications(this,e,t.wkid)}_clippingAreaChanged(){const t=this.layer.spatialReference,e=Se();this._layerClippingArea=Ve(this.view.clippingArea,e,t)?e:null,this._modificationsChanged()}_visibleGeometryChanged(){this._visibleGeometryChangedSchedulerHandle??=Fe((()=>{this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle=null}))}_slicePlaneEnabledChange(t){this._intersectionHandler&&(this._intersectionHandler.slicePlaneEnabled=t),this.objects.forEach((e=>{const u=this._collection.getMaterial(e);u.commonMaterialParameters.hasSlicePlane=t,u.commonMaterialParameters.cullFace=t?U.None:this._initialCullFace.get(e)}))}_elevationInfoChanged(t){this._wasm?.setLayerOffset(this,ce(t))}get _obbs(){return this.objects.map((t=>this._collection.getComponentObb(t)))}get _wasm(){return ke(this.view)}get wasmLayerId(){return this._wasmLayerId}get usedMemory(){let t=0;return this._lyrHandleToObjects.forEach((e=>{e.isVisible&&(t+=e.usedMemory)})),t}get unloadedMemory(){return 0}get cachedMemory(){let t=0;return this._lyrHandleToObjects.forEach((e=>{e.isVisible||(t+=e.usedMemory)})),t}get visibleAtCurrentScale(){return je(this.layer.effectiveScaleRange,this.view.scale)}get performanceInfo(){let t=0,e=0,u=0,o=0,c=0,r=0;return this._lyrHandleToObjects.forEach((h=>{h.isVisible?(t+=h.textureMemoryUsage,e+=h.vboMemoryUsage,c++):(u+=h.textureMemoryUsage,o+=h.vboMemoryUsage,r++)})),new Mt(this.usedMemory,c,r,B(e),B(t),B(o),B(u))}_canProjectWithoutEngine(){if(this.view.state.viewingMode===De.Local){const t=this.view.renderSpatialReference?.isWebMercator?3857:this.view.renderSpatialReference?.wkid??-1;if(t!==3857&&t!==32662)return!1}return!0}get _stage(){return this.view.stage}get _collection(){return this._stage.renderView.componentObjectCollection}get elevationOffset(){return ce(this.layer.elevationInfo)}get elevationRange(){const t=this.fullExtent;return t?.zmin&&t?.zmax?new Be(t.zmin,t.zmax):null}getElevationRange(t){return null}get fullExtent(){return this.layer.fullExtent}get objects(){return Array.from(this._lyrHandleToObjects.values()).reduce(((t,e)=>t.concat(e.components)),new Array)}isUpdating(){const t=this._wasm;return!(this._wasmLayerId<0||t==null)&&(t.isUpdating(this._wasmLayerId)||this._compressionTracker.compressing)}updatingFlagChanged(){this.notifyChange("updating")}async createRenderable(t){const e=t.meshData;if(e.data==null)throw new Error("meshData.data undefined");if(e.desc=JSON.parse(e.desc),e.desc==null)throw new Error("meshData.desc undefined");const u=Le(e.desc.origin),o=new Array,c=new Map,r=new Ht;r.handle=t.handle,this._lyrHandleToObjects.set(t.handle,r);const h=this.view.basemapTerrain.spatialReference;let d,w;if(this.view.viewingMode==="global"){const s=de();$e(Ne,u,s,h),d=Ge(he(),s),w=ze(he(),d)}else d=K,w=K;const f=de();We(f,f,u);const m=qe(Q(),f);let a=null;const n=Q();if(e.desc.obb){const s=e.desc.obb.quaternion;a=new Je(e.desc.obb.center,e.desc.obb.halfSize,Xe(s[0],s[1],s[2],s[3]))}for(let s=0;s<e.desc.prims.length;s++){const p=e.desc.prims[s];if(this._dbg(b.VerboseAPI,JSON.stringify(p)),Pt[p.ptype]==null||e.data==null){this._dbg(b.VerboseAPI,"[Unsupported Feature] Unsupported primitive mode ("+p.ptype+"). Skipping primitive.");continue}const l=e.desc?.materials&&p.materialId!=null?e.desc.materials[p.materialId]:null,x=l!=null?l.lightingModel:ue.Unlit,{positionView:y,positionAttr:_,normalsView:$,normalsAttr:N,colorAttr:G,texCoord0Attr:V,indicesView:H}=this.getBufferViews(p,e.data.buffer,d);if(_==null||y==null||H==null)continue;const se=new Ke(G!=null,V?me.Default:me.None,$!=null,this._shadeNormals,this._applySSAO),_e=_.data.length/_.size,z=(i,T)=>!i||i.data.length/i.size===_e||(this._dbg(b.Error,`${T} !== numPos. Skipping primitive.`),!1);if(!z(V,"numTexcoord")||!z(G,"numColors")||!z(N,"normals"))continue;const ie=Qe(se);if(a!=null?a=a.clone():(a=Ye(_),Ze(n,a.center,u),a.center=n),d!==K)for(let i=0;i<y.count;i++)y.getVec(i,n),et(n,n,d),y.setVec(i,n);const P=ie.createBuffer(_.data.length);if(Y(j.POSITION,_,null,null,P,0),V!=null){const i=P.getField(j.UV0,pe);tt(V,i,0)}G!=null&&Y(j.COLOR,_,null,null,P,0),N!=null&&Y(j.NORMALCOMPRESSED,N,null,null,P,0);const we=new Uint32Array([0,H.typedBuffer.length]),ve={vertices:{data:P.buffer,count:P.byteLength/ie.stride,layoutParameters:se},positionData:{positions:y.typedBuffer,indices:H.typedBuffer},indices:H.typedBuffer,componentOffsets:we};r.cpuMemoryUsage+=y.count,r.cpuMemoryUsage+=H.count;const re=this.view.renderSpatialReference,W=Q(),q=[1,1,1];yt(m,re,q,h)||this._dbg(b.Error,"Unsupported coordinate system for IM overlay"),st(m,re,W,h);const F=this._collection.createObject(new _t(it(W[0],W[1],q[0],q[1]),new wt(m,w),a,ve));l&&this._collection.updateMaterial(F,(i=>{i.baseColor=l.baseColorFactor,i.usePBR=x===ue.Pbr,i.hasParametersFromSource=!1,i.baseColorTexture=this._getTexture(l.baseColorTex,e,c,r),i.usePBR&&(i.mrrFactors=[l.metallicFactor,l.roughnessFactor,0],i.emissiveBaseColor=l.emissiveFactor??[0,0,0],i.metallicRoughnessTexture=this._getTexture(l.metalTex,e,c,r),i.emissionTexture=this._getTexture(l.emissiveTex,e,c,r),i.occlusionTexture=this._getTexture(l.occlusionTex,e,c,r),i.normalTexture=this._getTexture(l.normalTex,e,c,r)),i.objectOpacity=0,i.alphaDiscardMode=L.Mask;const T=[];i.baseColorTexture&&T.push(i.baseColorTexture.loadPromise),i.usePBR&&i.metallicRoughnessTexture&&T.push(i.metallicRoughnessTexture.loadPromise),i.usePBR&&i.emissionTexture&&T.push(i.emissionTexture.loadPromise),i.usePBR&&i.occlusionTexture&&T.push(i.occlusionTexture.loadPromise),i.usePBR&&i.normalTexture&&T.push(i.normalTexture.loadPromise);const ae=Promise.all(T);o.push(ae),ae.then((()=>{i.alphaDiscardMode=ye[l.alphaMode],i.objectOpacity=1,r.textureMemoryUsage+=i.baseColorTexture?.glTexture?.usedMemory||0,i.usePBR&&(r.textureMemoryUsage+=i.metallicRoughnessTexture?.glTexture?.usedMemory||0,r.textureMemoryUsage+=i.emissionTexture?.glTexture?.usedMemory||0,r.textureMemoryUsage+=i.occlusionTexture?.glTexture?.usedMemory||0,r.textureMemoryUsage+=i.normalTexture?.glTexture?.usedMemory||0)})),i.commonMaterialParameters.doubleSided=l.isDoubleSided,i.commonMaterialParameters.cullFace=l.faceCulling?Et[l.faceCulling]:U.Back,this._initialCullFace.set(F,i.commonMaterialParameters.cullFace),i.commonMaterialParameters.hasSlicePlane=this.slicePlaneEnabled,i.componentParameters.castShadows=rt.All,i.textureAlphaCutoff=l.alphaCutoff??at,i.alphaDiscardMode=ye[l.alphaMode],i.isIntegratedMesh=!0,i.polygonOffsetEnabled=!1,i.hasOccludees=!1,i.ellipsoidMode=nt(this.view.spatialReference)})),r.components.push(F),r.vboMemoryUsage+=this._collection.getObjectGPUMemoryUsage(F)}if(await Promise.all(o),c.forEach((s=>{r.textures.push(s)})),!this._memCache)throw new Error("no memCache");return this._memCache.put(`${r.handle}`,r),{memUsageBytes:r.usedMemory}}freeRenderable(t){const e=this._lyrHandleToObjects.get(t);e&&(this.freeObject(e),this._lyrHandleToObjects.delete(t))}freeObject(t){this._memCache&&this._memCache.pop(`${t.handle}`),t.components.forEach((e=>{t.textures.forEach((u=>{this._stage.removeTexture(u)})),this._collection.destroyObject(e),this._initialCullFace.delete(e)}))}setRenderableVisibility(t,e,u){if(this._memCache){for(let o=0;o<u;++o){const c=t[o],r=e[o];if(!r)continue;const h=this._lyrHandleToObjects.get(c);h&&(this._visibleGeometryChanged(),h.isVisible=r,h.components.forEach((d=>{this._collection.setObjectVisibility(d,r),this._elevationProvider.objectChanged(this._collection.getComponentObb(d))})),this._memCache.pop(`${c}`))}for(let o=0;o<u;++o){const c=t[o],r=e[o];if(r)continue;const h=this._lyrHandleToObjects.get(c);h&&(this._visibleGeometryChanged(),h.isVisible=r,h.components.forEach((d=>{this._collection.setObjectVisibility(d,r),this._elevationProvider.objectChanged(this._collection.getComponentObb(d))})),this._memCache.put(`${c}`,h))}}}_getTexture(t,e,u,o){let c=null;if(t&&e.desc?.images&&e.data?.buffer){const r=e.desc.images[t?.imageId];if(c=u.get(r),!c&&r){const h=this._stage.renderView.renderingContext.parameters.maxMaxAnisotropy,d=!!r.mipCount||h>1,w=Ot[t.wrapMode??A.None];let f=r.alpha?4:3;const m=new Uint8Array(e.data.buffer,r.data.byteOffset,r.data.byteCount);let a=null,n=null,s=null;switch(r.format){case C.Raw:r.pixelFormat===ee.R8?(a=m,f=1,n=""):r.pixelFormat===ee.Rgb8?(a=m,f=3,n=""):r.pixelFormat===ee.Rgba8&&(a=m,f=4,n="");break;case C.Dxt1:a=m,f=3,n=Z.DDS_ENCODING;break;case C.Dxt5:a=m,f=4,n=Z.DDS_ENCODING;break;case C.Basis:a=m,f=3,n=Z.KTX2_ENCODING;break;case C.Png:n="image/png",s=document.createElement("img");break;case C.Jpeg:n="image/jpeg",s=document.createElement("img");break;case C.Etc2:n="image/ktx",s=document.createElement("img");break;case C.Astc:this._dbg(b.Error,"Astc texture not supported");break;case C.Pvrtc:this._dbg(b.Error,"Pvrtc texture not supported")}if(s&&n){const p=new Blob([m],{type:n});s.src=URL.createObjectURL(p),a=s}if(a&&n!=null){const p=X("enable-feature:esri-compress-IM-textures")?{compressionTracker:this._compressionTracker,compressionCallback:l=>{l&&l>0&&(o.textureMemoryUsage-=l)}}:void 0;c=new ot(a,{mipmap:d,maxAnisotropy:h,encoding:n,wrap:w,components:f,compressionOptions:p,noUnpackFlip:!0,width:r.mip0Width,height:r.mip0Height}),this._stage.addTexture(c),u.set(r,c)}}}return c?new Tt(this.view.stage.renderView.textures,c.id):null}getBufferViews(t,e,u){let o,c,r,h,d,w,f,m=null;for(let a=0;a<t.atrbs.length;a++){const n=t.atrbs[a],s=n.view,p=void 0,l=s.byteOffset+s.byteCount,x=s.byteCount/At[s.type],y=[...Array(x).keys()].map((_=>_));try{switch(n.sem){case R.Position:s.ncomp!==3||s.type!==g.F32?this._dbg(b.Error,"[Unsupported Feature] Unsupported view for Position ("+s+")"):(o=new te(e,s.byteOffset,p,l),c=new D(o.typedBuffer,y,3));break;case R.Normal:if(s.ncomp!==3||s.type!==g.F32)this._dbg(b.Error,"[Unsupported Feature] Unsupported view for Normal ("+s+")");else{const _=new te(e,s.byteOffset,p,l),$=mt(_.typedBuffer,u);d=new pt($),w=new D(d.typedBuffer,y,2)}break;case R.TexCoord:s.ncomp!==2||s.type!==g.F32?this._dbg(b.Error,"[Unsupported Feature] Unsupported view for Texcoord ("+s+")"):h===void 0&&(h=new D(new pe(e,s.byteOffset,p,l).typedBuffer,y,2));break;case R.Color:s.ncomp===4?(s.type===g.F32&&(m=new lt(e,s.byteOffset,p,l)),s.type===g.U8&&(m=new ct(e,s.byteOffset,p,l)),s.type===g.U16&&(m=new dt(e,s.byteOffset,p,l))):s.ncomp===3&&(s.type===g.F32&&(m=new te(e,s.byteOffset,p,l)),s.type===g.U8&&(m=new ht(e,s.byteOffset,p,l)),s.type===g.U16&&(m=new ut(e,s.byteOffset,p,l))),m==null?this._dbg(b.VerboseAPI,"[Unsupported Feature] Unsupported view for Color ("+s+")"):r=new D(m.typedBuffer,y,s.ncomp);break;case R.FeatureIndex:break;default:this._dbg(b.VerboseAPI,"[Unsupported Feature] Unsupported semantic ("+n.sem+"). Skipping vertex attribute.")}}catch(_){this._dbg(b.VerboseAPI,"Error Creating buffer ("+_+"). Skipping vertex attribute.")}}if(t.index){const a=t.index.view,n=void 0,s=a.byteOffset+a.byteCount;switch(t.index.view.type){case g.U16:f=new fe(e,a.byteOffset,n,s);break;case g.U32:f=new ge(e,a.byteOffset,n,s);break;case g.U8:default:this._dbg(b.Error,"[Unsupported Feature] index type not supported ("+a.type+").")}}if(f==null&&o!=null){const a=o.count;if(a<65535){const n=new Uint16Array(a);f=new fe(n)}else{const n=new Uint32Array(a);f=new ge(n)}for(let n=0;n<a;n++)f.set(n,n)}return{positionView:o,positionAttr:c,colorAttr:r,texCoord0Attr:h,indicesView:f,normalsView:d,normalsAttr:w}}_loadModifications(){if(this.removeHandles("modifications"),this.layer.modifications==null)return void(this._modifications=[]);const t=this.layer.modifications;this.addHandles(this._updatingHandles.addOnCollectionChange((()=>t),(()=>this._modifications=t.toArray()),I),"modifications")}_onRemoveFromCache(t){this._wasm?.onRenderableEvicted(this,t.handle,t.usedMemory),this.freeRenderable(t.handle)}_dbg(t,e){this._dbgFlags.has(t)&&(t===b.Error?be.getLogger(this).error(e):be.getLogger(this).warn(e))}};O([S({type:[vt]})],M.prototype,"_modifications",void 0),O([S()],M.prototype,"_visibleGeometryChangedSchedulerHandle",void 0),O([S()],M.prototype,"layer",void 0),O([S({readOnly:!0})],M.prototype,"visibleAtCurrentScale",null),O([S()],M.prototype,"elevationOffset",null),M=O([ft("esri.views.3d.layers.IntegratedMesh3DTilesLayerView3D")],M);const Bt=M;export{Bt as default};
