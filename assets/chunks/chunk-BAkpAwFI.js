import{c2 as xe,gc as ae,pE as k,jb as O,fG as x,pl as Ce,dH as Te,p$ as Me,pu as Pe,U as Ee,q0 as Oe,f5 as Ue,b_ as oe,s as J,q1 as Ae,aP as ne,aw as Ie,q2 as le,aJ as ce,et as Re,lG as de,q3 as Se,f6 as Fe,bU as He,eN as Ve,q4 as je,ix as De,hC as he,q5 as Le,it as Be,io as ue,q6 as ke,q7 as X,q8 as Ne,q9 as Ge,bh as K,h1 as $e,qa as qe,qb as ze,qc as me,qd as We,nA as Je,d0 as Xe,il as Ke,bR as V,qe as Ye,bw as Qe,eQ as Ze,qf as et,qg as tt,qh as st,eR as Y,kw as it,pD as rt,pJ as at,pK as ot,ij as Q,pM as nt,pN as lt,bS as j,qi as ct,qj as dt,qk as ht,ql as pe,qm as ge,Y as be,c3 as ut,ar as A,as as D,au as mt}from"./chunk-DT3qbBkM.js";import{x as pt,n as gt,t as bt,i as ft}from"./chunk-CQSWKwZV.js";import{o as P,i as Z,l as L,r as E,t as p,m as yt,d as _t,S as fe,e as C,g as ee,a as I}from"./chunk-QwgNPJGT.js";import{l as wt}from"./chunk-aSfJgA4M.js";import{s as vt}from"./chunk-DvxeUXd7.js";import"./chunk-ByDRce6i.js";import"./chunk-Cokl53l_.js";/* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              *//* empty css              */import"./chunk-SqlbPPT2.js";class xt extends xe{constructor(e,h,r,o,n,u,l){super(e,0,0,0,h),this.nodesCached=r,this.vboMB=o,this.textureMB=n,this.vboMBCached=u,this.textureMBCached=l}}const Ct={[P.Points]:null,[P.Lines]:null,[P.LineStrip]:null,[P.Triangles]:ae.TRIANGLES,[P.TriangleStrip]:ae.TRIANGLE_STRIP,[P.NotSet]:null},ye={[Z.Opaque]:k.Opaque,[Z.Mask]:k.Mask,[Z.Blend]:k.Blend},Tt={[L.Back]:O.Back,[L.Front]:O.Front,[L.None]:O.None,[L.NotSet]:O.Back},Mt={[E.WrapYBit]:{s:x.CLAMP_TO_EDGE,t:x.REPEAT},[E.WrapXBit]:{s:x.REPEAT,t:x.CLAMP_TO_EDGE},[E.WrapXy]:{s:x.REPEAT,t:x.REPEAT},[E.None]:{s:x.CLAMP_TO_EDGE,t:x.CLAMP_TO_EDGE},[E.NotSet]:{s:x.CLAMP_TO_EDGE,t:x.CLAMP_TO_EDGE}},Pt={[p.U8]:1,[p.I8]:1,[p.U16]:2,[p.I16]:2,[p.U32]:4,[p.I32]:4,[p.F32]:4,[p.F64]:8,[p.Utf8String]:1,[p.NotSet]:1};class Et{constructor(e){this.layerUid=[],this.type=Ce.TILES3D,this.slicePlaneEnabled=!1,this.isGround=!0,this.layerView=e,this.layerUid.push(e.layer.uid)}intersect(e,h,r,o,n,u){const l=e.results,y=e.options.store===Te.ALL;if(e.options.filteredLayerUids.includes(this.layerView.layer.uid))return;const g=this.layerView.view._stage.renderView.componentObjectCollection,m=new Me(u??!1,e.options.normalRequired);this.layerView.objects.forEach(a=>{a.visible&&a.intersectionGeometry&&g.intersect(a,r,o,e.tolerance,null,m,(c,s,f,d)=>{if(s>=0){if(h!=null&&!h(r,o,s))return;const T=_=>{const w=new Oe(this.layerView.layer.uid,()=>this._createTiles3DGraphic(this.layerView.layer,{}));_.set(this.type,w,s,f)};if(this.isGround&&(l.ground.dist==null||s<l.ground.dist)&&T(l.ground),e.options.isFiltered)return;if((l.min.dist==null||s<l.min.dist)&&T(l.min),(l.max.dist==null||s>l.max.dist)&&T(l.max),y){const _=Pe(e.ray);T(_),e.results.all.push(_)}}})})}_createTiles3DGraphic(e,h){return new Ee({layer:e,sourceLayer:e,attributes:h})}}var b;(function(t){t[t.API=1]="API",t[t.VerboseAPI=2]="VerboseAPI",t[t.Error=3]="Error"})(b||(b={}));class Ot{constructor(){this.handle=0,this.isVisible=!1,this.components=[],this.texMemoryUsage=0,this.vboMemoryUsage=0,this.cpuMemoryUsage=0,this.textures=[]}get usedMemory(){return this.texMemoryUsage+this.vboMemoryUsage+this.cpuMemoryUsage}get cachedMemory(){return this.usedMemory}}function B(t){return Math.round(t/1048.576)/1e3}let M=class extends wt(ut){constructor(){super(...arguments),this.type="integrated-mesh-3dtiles",this._visibleGeometryChangedSchedulerHandle=null,this._wasmLayerId=-1,this.ignoresMemoryFactor=!1,this.drapeTargetType=Ue.WithoutRasterImage,this._applySSAO=!oe("disable-feature:im-ssao"),this._shadeNormals=!!oe("enable-feature:im-shading"),this._lyrHandleToObjects=new Map,this._initialCullFace=new Map,this._suspendedHandle=null,this._dbgFlags=new Set}initialize(){if(this._dbgFlags.add(b.Error),this._dbg(b.VerboseAPI,"Tiles3DLayerView3D initialize() called"),!this._canProjectWithoutEngine())throw new J("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});const t=Ae(this).then(e=>{this._intersectionHandler=new Et(this),this.view.sceneIntersectionHelper.addIntersectionHandler(this._intersectionHandler),this._updatingHandles.add(()=>this.slicePlaneEnabled,r=>this._slicePlaneEnabledChange(r)),this._elevationProvider=new pt({view:this.view,layerElevationSource:this,intersectionHandler:this._intersectionHandler}),this.view.elevationProvider.register("im",this._elevationProvider),this.view.basemapTerrain.overlayManager.registerDrapeTarget(this),this._wasmLayerId=e;const h=this.view.resourceController.memoryController.newCache(`t3d-${this.uid}`,r=>this._onRemoveFromCache(r));this._memCache=h,this.addHandles([ne(()=>this.layer.elevationInfo,r=>this._elevationInfoChanged(r))]),this._suspendedHandle=ne(()=>this.suspended,r=>this._wasm?.setEnabled(this,!r),Ie)}).catch(e=>{if(le(this),this._wasmLayerId=-1,e===yt)throw new J("tiles3d:addLayer-failure","The 3d tiles layer description was invalid.",{});if(e===_t)throw new J("tiles3d:addLayer-failure","The 3d tiles layer web assembly module failed to download.",{})});this.addResolvingPromise(t)}destroy(){this._dbg(b.VerboseAPI,"Tiles3DLayerView3D destroy() called"),le(this),this._suspendedHandle&&(this._suspendedHandle.remove(),this._suspendedHandle=null),this._intersectionHandler&&(this.view.sceneIntersectionHelper.removeIntersectionHandler(this._intersectionHandler),this._intersectionHandler=null),this._elevationProvider&&(this._elevationProvider.objectsChanged(this._obbs),this.view.elevationProvider.unregister(this._elevationProvider),this._elevationProvider=null),this.view.basemapTerrain.overlayManager.unregisterDrapeTarget(this),this._lyrHandleToObjects.forEach(t=>this.freeObject(t)),this._lyrHandleToObjects.clear(),this._initialCullFace.clear(),this._memCache=ce(this._memCache),this._updatingHandles=ce(this._updatingHandles),this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle&&(this._visibleGeometryChangedSchedulerHandle.remove(),this._visibleGeometryChangedSchedulerHandle=null)}_visibleGeometryChanged(){this._visibleGeometryChangedSchedulerHandle??=Re(()=>{this.emit("visible-geometry-changed"),this._visibleGeometryChangedSchedulerHandle=null})}_slicePlaneEnabledChange(t){this._intersectionHandler&&(this._intersectionHandler.slicePlaneEnabled=t),this.objects.forEach(e=>{const h=this._collection.getMaterial(e);h.commonMaterialParameters.hasSlicePlane=t,h.commonMaterialParameters.cullFace=t?O.None:this._initialCullFace.get(e)})}_elevationInfoChanged(t){this._wasm?.setLayerOffset(this,de(t))}get _obbs(){return this.objects.map(t=>this._collection.getComponentObb(t))}get _wasm(){return Se(this.view)}get wasmLayerId(){return this._wasmLayerId}get usedMemory(){let t=0;return this._lyrHandleToObjects.forEach(e=>{e.isVisible&&(t+=e.usedMemory)}),t}get unloadedMemory(){return 0}get cachedMemory(){let t=0;return this._lyrHandleToObjects.forEach(e=>{e.isVisible||(t+=e.usedMemory)}),t}get visibleAtCurrentScale(){return Fe(this.layer.effectiveScaleRange,this.view.scale)}get performanceInfo(){let t=0,e=0,h=0,r=0,o=0,n=0;return this._lyrHandleToObjects.forEach(u=>{u.isVisible?(t+=u.texMemoryUsage,e+=u.vboMemoryUsage,o++):(h+=u.texMemoryUsage,r+=u.vboMemoryUsage,n++)}),new xt(this.usedMemory,o,n,B(e),B(t),B(r),B(h))}_canProjectWithoutEngine(){if(this.view.state.viewingMode===He.Local){const t=this.view.renderSpatialReference?.isWebMercator?3857:this.view.renderSpatialReference?.wkid??-1;if(t!==3857&&t!==32662)return!1}return!0}get _stage(){return this.view._stage}get _collection(){return this._stage.renderView.componentObjectCollection}get elevationOffset(){return de(this.layer.elevationInfo)}get elevationRange(){const t=this.fullExtent;return t?.zmin&&t?.zmax?new Ve(t.zmin,t.zmax):null}getElevationRange(t){return null}get fullExtent(){return this.layer.fullExtent}get objects(){return Array.from(this._lyrHandleToObjects.values()).reduce((t,e)=>t.concat(e.components),new Array)}isUpdating(){const t=this._wasm;return!(this._wasmLayerId<0||t==null)&&t.isUpdating(this._wasmLayerId)}updatingFlagChanged(){this.notifyChange("updating")}async createRenderable(t){const e=t.meshData;if(e.data==null)throw new Error("meshData.data undefined");if(e.desc=JSON.parse(e.desc),e.desc==null)throw new Error("meshData.desc undefined");const h=je(e.desc.origin),r=new Array,o=new Map,n=new Ot;n.handle=t.handle,this._lyrHandleToObjects.set(t.handle,n);const u=this.view.basemapTerrain.spatialReference;let l,y;if(this.view.viewingMode==="global"){const s=he();De(Le,h,s,u),l=Be(ue(),s),y=ke(ue(),l)}else l=X,y=X;const g=he();Ne(g,g,h);const m=Ge(K(),g);let a=null;const c=K();if(e.desc.obb){const s=e.desc.obb.quaternion;a=new $e(e.desc.obb.center,e.desc.obb.halfSize,qe(s[0],s[1],s[2],s[3]))}for(let s=0;s<e.desc.prims.length;s++){const f=e.desc.prims[s];if(this._dbg(b.VerboseAPI,JSON.stringify(f)),Ct[f.ptype]==null||e.data==null){this._dbg(b.VerboseAPI,"[Unsupported Feature] Unsupported primitive mode ("+f.ptype+"). Skipping primitive.");continue}const d=e.desc?.materials&&f.materialId!=null?e.desc.materials[f.materialId]:null,T=d!=null?d.lightingModel:fe.Unlit,{positionView:_,positionAttr:w,normalsView:N,normalsAttr:G,colorAttr:R,texCoord0Attr:S,indicesView:U}=this.getBufferViews(f,e.data.buffer,l);if(w==null||_==null||U==null)continue;const te=new ze(R!=null,S!=null?me.Default:me.None,N!=null,this._shadeNormals,this._applySSAO),_e=w.data.length/w.size,$=(i,v)=>!i||i.data.length/i.size===_e||(this._dbg(b.Error,`${v} !== numPos. Skipping primitive.`),!1);if(!$(S,"numTexcoord")||!$(R,"numColors")||!$(G,"normals"))continue;const se=We(te);if(a!=null?a=a.clone():(a=Je(w),Xe(c,a.center,h),a.center=c),l!==X)for(let i=0;i<_.count;i++)_.getVec(i,c),Ke(c,c,l),_.setVec(i,c);const q=se.createBuffer(w.data.length),F=new Map([[V.POSITION,w]]);S!=null&&F.set(V.UV0,S),R!=null&&F.set(V.COLOR,R),G!=null&&F.set(V.NORMALCOMPRESSED,G),F.forEach((i,v)=>{i!=null&&Ye(v,i,null,null,q,0)});const we=new Uint32Array([0,U.typedBuffer.length]),ve={vertices:{data:q.buffer,count:q.byteLength/se.stride,layoutParameters:te},positionData:{positions:_.typedBuffer,indices:U.typedBuffer},indices:U.typedBuffer,componentOffsets:we};n.cpuMemoryUsage+=_.count,n.cpuMemoryUsage+=U.count;const ie=this.view.renderSpatialReference,z=K(),W=[1,1,1];gt(m,ie,W,u)||this._dbg(b.Error,"Unsupported coordinate system for IM overlay"),Qe(m,ie,z,u);const H=this._collection.createObject(new bt(Ze(z[0],z[1],W[0],W[1]),new ft(m,y),a,ve));d&&this._collection.updateMaterial(H,i=>{i.baseColor=d.baseColorFactor,i.usePBR=T===fe.Pbr,i.hasParametersFromSource=!1,i.baseColorTexture=this._getTexture(d.baseColorTex,e,o),i.usePBR&&(i.mrrFactors=[d.metallicFactor,d.roughnessFactor,0],i.emissiveFactor=d.emissiveFactor??[0,0,0],i.metallicRoughnessTexture=this._getTexture(d.metalTex,e,o),i.emissionTexture=this._getTexture(d.emissiveTex,e,o),i.occlusionTexture=this._getTexture(d.occlusionTex,e,o),i.normalTexture=this._getTexture(d.normalTex,e,o)),i.objectOpacity=0,i.alphaDiscardMode=k.Mask;const v=[];i.baseColorTexture&&v.push(i.baseColorTexture.loadPromise),i.usePBR&&i.metallicRoughnessTexture&&v.push(i.metallicRoughnessTexture.loadPromise),i.usePBR&&i.emissionTexture&&v.push(i.emissionTexture.loadPromise),i.usePBR&&i.occlusionTexture&&v.push(i.occlusionTexture.loadPromise),i.usePBR&&i.normalTexture&&v.push(i.normalTexture.loadPromise);const re=Promise.all(v);r.push(re),re.then(()=>{i.alphaDiscardMode=ye[d.alphaMode],i.objectOpacity=1,n.texMemoryUsage+=i.baseColorTexture?.glTexture?.usedMemory||0,i.usePBR&&(n.texMemoryUsage+=i.metallicRoughnessTexture?.glTexture?.usedMemory||0,n.texMemoryUsage+=i.emissionTexture?.glTexture?.usedMemory||0,n.texMemoryUsage+=i.occlusionTexture?.glTexture?.usedMemory||0,n.texMemoryUsage+=i.normalTexture?.glTexture?.usedMemory||0)}),i.commonMaterialParameters.doubleSided=d.isDoubleSided,i.commonMaterialParameters.cullFace=d.faceCulling?Tt[d.faceCulling]:O.Back,this._initialCullFace.set(H,i.commonMaterialParameters.cullFace),i.commonMaterialParameters.hasSlicePlane=this.slicePlaneEnabled,i.componentParameters.castShadows=et.All,i.textureAlphaCutoff=d.alphaCutoff??tt,i.alphaDiscardMode=ye[d.alphaMode],i.isIntegratedMesh=!0,i.polygonOffsetEnabled=!1,i.hasOccludees=!1,i.ellipsoidMode=st(this.view.spatialReference)}),n.components.push(H),n.vboMemoryUsage+=this._collection.getObjectGPUMemoryUsage(H)}if(await Promise.all(r),o.forEach(s=>{n.textures.push(s)}),!this._memCache)throw new Error("no memCache");return this._memCache.put(`${n.handle}`,n),{memUsageBytes:n.usedMemory}}freeRenderable(t){const e=this._lyrHandleToObjects.get(t);e&&(this.freeObject(e),this._lyrHandleToObjects.delete(t))}freeObject(t){this._memCache&&this._memCache.pop(`${t.handle}`),t.components.forEach(e=>{t.textures.forEach(h=>{this._stage.remove(h)}),this._collection.destroyObject(e),this._initialCullFace.delete(e)})}setRenderableVisibility(t,e,h){if(this._memCache){for(let r=0;r<h;++r){const o=t[r],n=e[r];if(!n)continue;const u=this._lyrHandleToObjects.get(o);u&&(this._visibleGeometryChanged(),u.isVisible=n,u.components.forEach(l=>{this._collection.setObjectVisibility(l,n),this._elevationProvider.objectChanged(this._collection.getComponentObb(l))}),this._memCache.pop(`${o}`))}for(let r=0;r<h;++r){const o=t[r],n=e[r];if(n)continue;const u=this._lyrHandleToObjects.get(o);u&&(this._visibleGeometryChanged(),u.isVisible=n,u.components.forEach(l=>{this._collection.setObjectVisibility(l,n),this._elevationProvider.objectChanged(this._collection.getComponentObb(l))}),this._memCache.put(`${o}`,u))}}}_getTexture(t,e,h){let r=null;if(t&&e.desc?.images&&e.data?.buffer){const o=e.desc.images[t?.imageId];if(r=h.get(o),!r&&o){const n=this._stage.renderView.renderingContext.parameters.maxMaxAnisotropy,u=!!o.mipCount||n>1,l=Mt[t.wrapMode??E.None];let y=o.alpha?4:3;const g=new Uint8Array(e.data.buffer,o.data.byteOffset,o.data.byteCount);let m=null,a=null,c=null;switch(o.format){case C.Raw:o.pixelFormat===ee.R8?(m=g,y=1,a=""):o.pixelFormat===ee.Rgb8?(m=g,y=3,a=""):o.pixelFormat===ee.Rgba8&&(m=g,y=4,a="");break;case C.Dxt1:m=g,y=3,a=Y.DDS_ENCODING;break;case C.Dxt5:m=g,y=4,a=Y.DDS_ENCODING;break;case C.Basis:m=g,y=3,a=Y.KTX2_ENCODING;break;case C.Png:a="image/png",c=document.createElement("img");break;case C.Jpeg:a="image/jpeg",c=document.createElement("img");break;case C.Etc2:a="image/ktx",c=document.createElement("img");break;case C.Astc:this._dbg(b.Error,"Astc texture not supported");break;case C.Pvrtc:this._dbg(b.Error,"Pvrtc texture not supported")}if(c&&a){const s=new Blob([g],{type:a});c.src=URL.createObjectURL(s),m=c}m&&a!=null&&(r=new it(m,{mipmap:u,maxAnisotropy:n,encoding:a,wrap:l,components:y,noUnpackFlip:!0,width:o.mip0Width,height:o.mip0Height}),this._stage.add(r),h.set(o,r))}}return r?new vt(this.view._stage.renderView.textures,r.id):null}getBufferViews(t,e,h){let r,o,n,u,l,y,g,m=null;for(let a=0;a<t.atrbs.length;a++){const c=t.atrbs[a],s=c.view,f=void 0,d=s.byteOffset+s.byteCount,T=s.byteCount/Pt[s.type],_=[...Array(T).keys()].map(w=>w);try{switch(c.sem){case I.Position:s.ncomp!==3||s.type!==p.F32?this._dbg(b.Error,"[Unsupported Feature] Unsupported view for Position ("+s+")"):(r=new Q(e,s.byteOffset,f,d),o=new j(r.typedBuffer,_,3));break;case I.Normal:if(s.ncomp!==3||s.type!==p.F32)this._dbg(b.Error,"[Unsupported Feature] Unsupported view for Normal ("+s+")");else{const w=new Q(e,s.byteOffset,f,d),N=dt(w.typedBuffer,h);l=new ht(N),y=new j(l.typedBuffer,_,2)}break;case I.TexCoord:s.ncomp!==2||s.type!==p.F32?this._dbg(b.Error,"[Unsupported Feature] Unsupported view for Texcoord ("+s+")"):u===void 0&&(u=new j(new ct(e,s.byteOffset,f,d).typedBuffer,_,2));break;case I.Color:s.ncomp===4?(s.type===p.F32&&(m=new rt(e,s.byteOffset,f,d)),s.type===p.U8&&(m=new at(e,s.byteOffset,f,d)),s.type===p.U16&&(m=new ot(e,s.byteOffset,f,d))):s.ncomp===3&&(s.type===p.F32&&(m=new Q(e,s.byteOffset,f,d)),s.type===p.U8&&(m=new nt(e,s.byteOffset,f,d)),s.type===p.U16&&(m=new lt(e,s.byteOffset,f,d))),m==null?this._dbg(b.VerboseAPI,"[Unsupported Feature] Unsupported view for Color ("+s+")"):n=new j(m.typedBuffer,_,s.ncomp);break;case I.FeatureIndex:break;default:this._dbg(b.VerboseAPI,"[Unsupported Feature] Unsupported semantic ("+c.sem+"). Skipping vertex attribute.")}}catch(w){this._dbg(b.VerboseAPI,"Error Creating buffer ("+w+"). Skipping vertex attribute.")}}if(t.index){const a=t.index.view,c=void 0,s=a.byteOffset+a.byteCount;switch(t.index.view.type){case p.U16:g=new ge(e,a.byteOffset,c,s);break;case p.U32:g=new pe(e,a.byteOffset,c,s);break;case p.U8:default:this._dbg(b.Error,"[Unsupported Feature] index type not supported ("+a.type+").")}}if(g==null&&r!=null){const a=r.count;if(a<65535){const c=new Uint16Array(a);g=new ge(c)}else{const c=new Uint32Array(a);g=new pe(c)}for(let c=0;c<a;c++)g.set(c,c)}return{positionView:r,positionAttr:o,colorAttr:n,texCoord0Attr:u,indicesView:g,normalsView:l,normalsAttr:y}}_onRemoveFromCache(t){this._wasm?.onRenderableEvicted(this,t.handle,t.usedMemory),this.freeRenderable(t.handle)}_dbg(t,e){this._dbgFlags.has(t)&&(t===b.Error?be.getLogger(this).error(e):be.getLogger(this).warn(e))}};A([D()],M.prototype,"_visibleGeometryChangedSchedulerHandle",void 0),A([D()],M.prototype,"layer",void 0),A([D({readOnly:!0})],M.prototype,"visibleAtCurrentScale",null),A([D()],M.prototype,"elevationOffset",null),M=A([mt("esri.views.3d.layers.IntegratedMesh3DTilesLayerView3D")],M);const _s=M;export{_s as default};
