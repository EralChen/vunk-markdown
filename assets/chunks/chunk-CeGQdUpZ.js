const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/chunks/chunk-DSA9lwn_.js","assets/chunks/chunk-B3WnPCbD.js","assets/chunks/chunk-RXqyeZ0u.js","assets/chunks/chunk-hrnPTWHo.js","assets/chunks/chunk-BV9e7tGp.js","assets/chunks/chunk-B92kdZ15.js","assets/chunks/chunk-DsYbGKja.js","assets/chunks/chunk-DP7_WWTp.js","assets/chunks/chunk-DbiObNSB.js","assets/chunks/chunk-BBnM6NiO.js","assets/static/style-35e9a516.OCMtRbrJ.css","assets/chunks/chunk-BULOsRNw.js","assets/chunks/chunk-Dl8XuWVl.js","assets/chunks/chunk-Dq3_Cvzn.js","assets/chunks/chunk-BAQYUxr7.js","assets/chunks/chunk-WhdPFUAK.js","assets/chunks/chunk-BPZTUeWL.js","assets/chunks/chunk-YL5YwaaP.js"])))=>i.map(i=>d[i]);
import{w as U,uk as M,ul as V,um as z,oE as $,gx as D,ak as m,am as L,aq as C,bG as H,ar as G,F as E,as as q,oL as Q,oN as J,df as W,fX as X,N as Y,ez as B,dh as N,e0 as R,uf as S,jD as K,jE as Z,bA as ee}from"./chunk-DbiObNSB.js";import{_ as g}from"./chunk-DsYbGKja.js";import{_ as A}from"./chunk-BBnM6NiO.js";import{a as te,n as re,b as ie}from"./chunk-D0LjTexZ.js";const ne={setAttribute(){},rollback(){},commit(){}};function me(e,r){const t=r.attributes[e.objectIdField];if(t==null)return ne;const i=e.sessions.get(t);if(i)return i;const l=U(r.attributes),a=new Set,d=e.i3sOverrides.createInteractiveEditSession(t),c=new Map,f=(n,u)=>{const p=c.get(n);if(p==null){const y=u.indexOf(t);return c.set(n,y),y}return p};let s=0;const o={setAttribute(n,u){if(s!==0)return;const p=e.fieldsIndex.get(n);if(!p)return;const y=e.attributeStorageInfo.findIndex(b=>b.name===p.name);if(y<0)return;if(!(n in l))throw new Error(`Attribute "${n}" is not an attribute of the edited feature.`);d.setAttribute(y,u);const F=e.attributeStorageInfo[y];let _=!1;a.add(n),e.forEachNode((b,I)=>{const O=f(b,I);if(O===-1)return;const x=e.getAttributeData(b.index);if(x){const v=x[F.name];v&&(v[O]=u,e.setAttributeData(b.index,x,r),_=!0)}}),_&&e.clearMemCache()},rollback(){if(s===0){for(const n of a)this.setAttribute(n,l[n]);d.remove(),s=1,e.sessions.delete(t)}},commit(){s===0&&(d.remove(),s=2,e.sessions.delete(t))}};return e.sessions.set(t,o),o}function oe(e,r,t){const{gidToFeatureInfo:i,oidToFeatureInfo:l,fieldsIndex:a,objectIdField:d,globalIdField:c,featureOrIdentifierList:f}=t;if(!t.featuresResolved&&f!=null){for(const s of f){const o={feature:null,oid:-1,gid:null};if("attributes"in s){o.feature=s;const n=s.attributes;if(n!=null)for(const u in n){if(o.oid!==-1&&o.gid!=null)break;const p=a.normalizeFieldName(u);p===d&&(o.oid=n[u]??-1),p===c&&(o.gid=n[u])}}else o.oid=s.objectId??-1,o.gid=s.globalId;o.gid!=null&&i.set(o.gid,o),o.oid!==-1&&l.set(o.oid,o)}t.featuresResolved=!0}return(e!==-1?l.get(e):null)??(r!=null?i.get(r):null)}function j(e,r,t,i,l=null,a=!0){const d=[],c={gidToFeatureInfo:new Map,oidToFeatureInfo:new Map,featuresResolved:t==null,fieldsIndex:e.fieldsIndex,objectIdField:e.objectIdField,globalIdField:e.globalIdField,featureOrIdentifierList:t};for(const f of r){if(f.error!=null)continue;const s=f.objectId??-1,o=f.globalId,n=(s===-1||a?oe(s,o,c):null)??{feature:null,oid:s,gid:o},u={oid:s===-1?n.oid:s,gid:o??n.gid,feature:n.feature,result:f};d.push(u);const p=u.gid?M(u.gid):null;if(u.oid===-1&&p!=null&&l!=null&&(u.oid=l.get(p)??-1),u.oid===-1&&p!=null){let y=i.get(p);y==null&&(y={gid:u.gid,edits:[]},i.set(p,y)),y.edits.push(u)}}return d}async function he(e,r){const t=new Map,i=j(e,r.addedFeatures,r.edits?.addFeatures,t),l=j(e,r.updatedFeatures,r.edits?.updateFeatures,t),a=j(e,r.deletedFeatures,r.edits?.deleteFeatures,t,r.globalIdToObjectId,!1);return t.size>0&&await se(e,t),{adds:i.filter(d=>d.oid!==-1),updates:l.filter(d=>d.oid!==-1),deletes:a.filter(d=>d.oid!==-1)}}async function se(e,r){const t=e.i3sOverrides.layer.associatedLayer;if(t?.globalIdField==null)return;const i=t.createQuery(),{objectIdField:l,globalIdField:a}=t;i.where=Array.from(r.values()).map(({gid:f})=>`${a}='${f}'`).join(" OR "),i.returnGeometry=!1,i.outFields=[l,a],i.cacheHint=!1;const d=await V(z(t,i));if(!d.ok)return;const c=d.value.features;for(const f of c){const s=f.attributes[a],o=f.attributes[l];if(s==null||o==null||o===-1)continue;const n=r.get(M(s));if(n!=null)for(const u of n.edits)u.oid=o}}function be(e,r){const t=new Map,i=l=>{for(const{oid:a,feature:d}of l){const c=d?.geometry;c?.type==="mesh"&&t.set(a,c)}};i(r.adds),i(r.updates);for(const l of r.deletes)t.set(l.oid,null);for(const[l,a]of t)e.i3sOverrides.updateGeometry(l,a)}function Fe(e,r){const t=ae(e,r),i=le(e,r);if(t.size===0&&i.size===0)return;const l=new Map;for(let u=0;u<e.attributeStorageInfo.length;u++)l.set(e.attributeStorageInfo[u].name,u);let a=!1;t.forEach((u,p)=>{const y=e.getAttributeData(p);let F=!1;u.forEach((_,b)=>{const I=y!=null?y[b]:null,O=l.get(b);for(const{featureIndex:x,value:v,featureId:T}of _)I&&(I[x]=v,F=!0,a=!0),e.i3sOverrides.updateAttributeValue(T,O,v)}),F&&e.setAttributeData(p,y,null)}),a&&e.clearMemCache();const{fieldsIndex:d,i3sOverrides:c,objectIdField:f,globalIdField:s}=e,o=c.layer.associatedLayer?.infoFor3D,n=new Set(o?[...Object.values(o.assetMapFieldRoles),...Object.values(o.transformFieldRoles)]:[]);for(const[u,p]of i){c.featureAdded(u);const{attributes:y}=p;for(const F in y){if(F!==f&&F!==s&&n.has(F))continue;const _=d.normalizeFieldName(F),b=_!=null?l.get(_):null;if(b==null)continue;const I=y[F];c.updateAttributeValue(u,b,I)}}}function le(e,r){const t=new Map,i=r.adds;if(!i||i.length===0||e.globalIdField==null)return t;for(const l of i){const a=l.oid,d=l.feature;d?.geometry?.type==="mesh"&&t.set(a,d)}return t}function ae(e,r){const t=r.updates;if(!t||t.length===0)return new P;const i=new P,l=new Map;for(let a=0;a<e.attributeStorageInfo.length;a++)l.set(e.attributeStorageInfo[a].name,a);return e.forEachNode((a,d)=>{for(const c of t){if(c.feature==null)continue;const f=c.feature,s=c.oid,o=d.indexOf(s);for(const n in f.attributes){const u=e.fieldsIndex.normalizeFieldName(n),p=de(i,a.index,u),y=f.attributes[n];p.push({featureIndex:o,featureId:s,value:y})}}}),i}function de(e,r,t){const i=ue(e,r),l=t!=null&&i.get(t);if(l)return l;const a=new Array;return i.set(t,a),a}function ue(e,r){const t=e.get(r);if(t)return t;const i=new ce;return e.set(r,i),i}const ce=Map,P=Map;function we(){return{requiredFields:{type:[String],readOnly:!0},availableFields:{type:[String],readOnly:!0,get:function(){const{layer:e,layer:{fieldsIndex:r},requiredFields:t}=this;return e.outFields?$(r,[...D(r,e.outFields),...t]):$(r,t)}}}}const k=e=>{const r=e;let t=class extends r{constructor(){super(...arguments),this._updatingHandles=new C,this._numUpdating=0}get updating(){return this._numUpdating>0||this._updatingHandles.updating}destroy(){this._updatingHandles.destroy()}autoUpdateAsync(i,l){const a=H(async d=>{++this._numUpdating;try{const c=await d;this.destroyed||this._set(i,c)}catch{E.getLogger(this).warn(`Async update of "${String(i)}" failed. Async update functions should not throw exceptions.`)}--this._numUpdating});return this._updatingHandles.add(l,a,G)}};return g([m()],t.prototype,"_updatingHandles",void 0),g([m({readOnly:!0})],t.prototype,"updating",null),g([m()],t.prototype,"_numUpdating",void 0),t=g([L("esri.core.AsyncUpdate")],t),t};k(q);let w=class extends k(q){get layer(){return this.layerView.layer}get requiredFields(){const{layerView:{layer:{fieldsIndex:e},definitionExpressionFields:r},rendererFields:t,labelingFields:i,viewFilterFields:l}=this;return $(e,[...r??[],...t??[],...i??[],...l??[]])}constructor(e){super(e)}initialize(){this.addHandles([this.autoUpdateAsync("rendererFields",async()=>{const{fieldsIndex:e,renderer:r}=this.layer;return r?this._getFieldsAsync(t=>r.collectRequiredFields(t,e)):null}),this.autoUpdateAsync("labelingFields",async()=>{const{layer:e}=this;return e.labelsVisible?this._getFieldsAsync(r=>Q(r,e)):null}),this.autoUpdateAsync("viewFilterFields",()=>{const{layer:e,mergedFilter:r}=this.layerView;return this._getFieldsAsync(t=>J(t,e,r))})])}async _getFieldsAsync(e){const r=new Set;try{return await e(r),Array.from(r).sort()}catch(t){return E.getLogger(this).error(t),null}}};g([m()],w.prototype,"layerView",void 0),g([m()],w.prototype,"layer",null),g([m()],w.prototype,"requiredFields",null),g([m()],w.prototype,"rendererFields",void 0),g([m()],w.prototype,"labelingFields",void 0),g([m()],w.prototype,"viewFilterFields",void 0),w=g([L("esri.views.3d.layers.support.SceneLayerViewRequiredFields")],w);let h=class extends W{constructor(){super(...arguments),this.layer=null,this.filter=null,this._geometryOperators=null,this._projectionEngineLoaded=!1,this._abortController=new AbortController}get availableFields(){return[]}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(e){throw new Error("Not implemented")}get maximumNumberOfFeaturesExceeded(){return!1}get layerFilter(){return te(this._layerFilter)}get _layerFilter(){const e=this.layer?.filter;if(e==null||e.geometries.length<1)return null;if(!this._geometryOperators||!this._projectionEngineLoaded&&this._filterNeedsProjectionEngine)return re;const[r,t,i]=this._geometryOperators,l=e.geometries.at(0).spatialReference,a=e.geometries.toArray().map(s=>{let o;try{o=t.execute(s)}catch{return E.getLogger(this).warnOncePerTick("Failed to simplify scene filter mask polygon. Polygon will be ignored."),null}if(!o)return null;if(o.spatialReference.equals(l))return o;try{return X(o,l)}catch{return E.getLogger(this).warnOncePerTick("Failed to project scene filter mask polygon. Polygon will be ignored."),null}}).filter(Y).sort((s,o)=>s.extent.xmin-o.extent.xmin),d=new Set,c=new Array,f=new Array;for(let s of a){const o=s.extent.xmin;if(c.length=0,d.forEach(n=>{if(o>=n.extent.xmax)return f.push(n),void d.delete(n);s.extent.ymin<=n.extent.ymax&&s.extent.ymax>=n.extent.ymin&&r.execute(s,n)&&c.push(n)}),c.length>0){let n;c.push(s);try{n=i.executeMany(c)}catch{E.getLogger(this).warnOncePerTick("Failed to unify filter mask polygons. Polygon will be ignored.");continue}c.pop(),n&&(c.forEach(u=>d.delete(u)),s=n)}d.add(s)}return d.forEach(s=>f.push(s)),f.length>0?{spatialRelationship:e.spatialRelationship,geometries:f}:null}get _filterNeedsProjectionEngine(){const e=this.layer.filter;if(e==null||e.geometries.length<=1)return!1;const r=e.geometries.at(0).spatialReference;return e.geometries.some(({spatialReference:t})=>!t.equals(r)&&!B(t,r))}get layerFilterUpdating(){return ie(this._layerFilter)}initialize(){const{signal:e}=this._abortController;N(()=>this.destroyed||!this._geometryOperators&&this.layer?.filter?.geometries?.length,e).then(async()=>{R(e),this._geometryOperators=await Promise.all([A(()=>import("./chunk-DSA9lwn_.js").then(r=>r.i),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13])),A(()=>import("./chunk-BAQYUxr7.js").then(r=>r.s),__vite__mapDeps([14,3,1,2,4,5,6,7,8,9,10,11,15,13])),A(()=>import("./chunk-BPZTUeWL.js").then(r=>r.u),__vite__mapDeps([16,3,1,2,4,5,6,7,8,9,10,11,17,13]))])}).catch(S),this._projectionEngineLoaded=K(),N(()=>this.destroyed||!this._projectionEngineLoaded&&this._filterNeedsProjectionEngine,e).then(async()=>{R(e),await Z(),this._projectionEngineLoaded=!0}).catch(S)}destroy(){this._abortController=ee(this._abortController)}highlight(e,r){throw new Error("Not implemented")}queryFeatures(e,r){throw new Error("Not implemented")}queryObjectIds(e,r){throw new Error("Not implemented")}queryFeatureCount(e,r){throw new Error("Not implemented")}createQuery(){throw new Error("Not implemented")}queryExtent(e,r){throw new Error("Not implemented")}};g([m()],h.prototype,"layer",void 0),g([m()],h.prototype,"availableFields",null),g([m()],h.prototype,"maximumNumberOfFeatures",null),g([m({readOnly:!0})],h.prototype,"maximumNumberOfFeaturesExceeded",null),g([m()],h.prototype,"filter",void 0),g([m({readOnly:!0})],h.prototype,"layerFilter",null),g([m({readOnly:!0})],h.prototype,"_layerFilter",null),g([m()],h.prototype,"_geometryOperators",void 0),g([m()],h.prototype,"_projectionEngineLoaded",void 0),g([m()],h.prototype,"_filterNeedsProjectionEngine",null),g([m()],h.prototype,"layerFilterUpdating",null),h=g([L("esri.views.layers.SceneLayerView")],h);export{w as a,h as b,we as c,be as d,Fe as f,me as i,he as u};
