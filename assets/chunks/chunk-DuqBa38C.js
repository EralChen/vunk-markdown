import{tc as T,td as H,ar as R,aO as V,Y as q,eF as w,jx as A,fl as M,ai as s,aj as a,al as x,ap as I,b_ as P,aq as y,te as U,bY as N,aC as E,gE as J,gI as m,g8 as C,n as S,dS as D,A as j,le as L,aE as k,aG as z,aH as v,tf as O,tg as B,aN as Z,z as Y,aJ as g,mL as W,dc as K,th as X,fr as ee,aQ as te,aR as ie,aD as re}from"./chunk-CET6Djna.js";import{i as se}from"./chunk-CcEbRgUF.js";import{r as ne,n as ae}from"./chunk-BADwmne0.js";import{H as oe,u as le,e as ue}from"./chunk-EFWiA1C3.js";import{a as pe,p as he,u as de}from"./chunk-gMg-gRKd.js";import{n as F}from"./chunk-Dc8--CBJ.js";import{L as ce}from"./chunk-DLlSE_vX.js";import{e as ye}from"./chunk-BkzMyFvQ.js";import{s as _,e as ge,i as fe}from"./chunk-BJEGZeu-.js";class me{constructor(t){this._cache=t.newCache("QueryEngine",null,-1)}clear(){this._cache.clear()}destroy(){this._cache.destroy()}get(t){return this._cache.get(t)?.items}put(t,n){this._cache.put(t,new _e(n))}get test(){}}class _e{constructor(t){this.items=t}get cachedMemory(){return this.items.reduce(((t,n)=>t+n.usedMemory),T+H)}}const be=ce;let d=class extends R{constructor(e){super(e),this._dataQueryEngineInstance=null}destroy(){this.clear()}get layer(){return this.context.layer}get spatialReference(){return this.context.spatialReference}get _queryGeometryType(){switch(this.layer.geometryType){case"multipoint":case"point":case"polygon":case"polyline":return this.layer.geometryType;case"mesh":return"polygon";default:return}}get defaultQueryJSON(){return new V({outSpatialReference:this.spatialReference}).toJSON()}clear(){return!!this._dataQueryEngineInstance&&(this._dataQueryEngineInstance.destroy(),this._dataQueryEngineInstance=null,!0)}async executeQueryForIdSet(e,t,n){return this._dataQueryEngine.executeQueryForIdSet(this._ensureQueryJSON(e,t),n)}async executeQueryForCount(e,t){return this._dataQueryEngine.executeQueryForCount(this._ensureQueryJSON(e),t)}async executeQueryForExtent(e,t){const{count:n,extent:r}=await this._dataQueryEngine.executeQueryForExtent(this._ensureQueryJSON(e),t);return{count:n,extent:q.fromJSON(r)}}async executeQueryForIds(e,t){return this._dataQueryEngine.executeQueryForIds(this._ensureQueryJSON(e),t)}async executeQueryForLatestObservations(e,t){const n=await this._dataQueryEngine.executeQueryForLatestObservations(this._ensureQueryJSON(e),t),r=w.fromJSON(n);return r.features.forEach((i=>{i.layer=this.layer,i.sourceLayer=this.layer})),r}async executeQuery(e,t){const n=await this._dataQueryEngine.executeQuery(this._ensureQueryJSON(e),t),r=w.fromJSON(n);return r.features.forEach((i=>{i.layer=this.layer,i.sourceLayer=this.layer})),r}_ensureQueryJSON(e,t){let n=this.defaultQueryJSON;if(e!=null&&("outSpatialReference"in e&&!e.outSpatialReference&&(e.outSpatialReference=this.spatialReference),n=e.toJSON(),n.cacheHint=!0),t!=null){const r=t.geometries.map((i=>i.toJSON())).reduce(((i,l)=>(i.rings=i.rings.concat(l.rings),i)));n={...n,cacheHint:!0,sceneFilter:{...t,geometry:r}}}return n}get _dataQueryEngine(){if(this._dataQueryEngineInstance)return this._dataQueryEngineInstance;const{priority:e,layer:t}=this,n="timeInfo"in t&&t.timeInfo?.toJSON()||null,r=ye(t),i=A.toJSON(this._queryGeometryType),l=t.fieldsIndex?.toJSON()||new M([]),u=this.spatialReference.toJSON(),{hasZ:h,hasM:c,featureStore:f,scheduler:Q,memoryController:$}=this.context,G=new me($);return this._dataQueryEngineInstance=new be({hasZ:h,hasM:c,geometryType:i,fieldsIndex:l,timeInfo:n,spatialReference:u,featureIdInfo:r,featureStore:f,scheduler:Q,cache:G,priority:e}),this._dataQueryEngineInstance}};s([a({constructOnly:!0})],d.prototype,"context",void 0),s([a({constructOnly:!0})],d.prototype,"priority",void 0),s([a()],d.prototype,"layer",null),s([a()],d.prototype,"spatialReference",null),s([a()],d.prototype,"_queryGeometryType",null),s([a()],d.prototype,"defaultQueryJSON",null),d=s([x("esri.views.3d.layers.graphics.QueryEngine")],d);class Ee{constructor(t,n,r,i,l,u){this.spatialReference=t,this.layer=n,this.resourceController=r,this._getFeatureStore=i,this.hasZ=l,this.hasM=u}get scheduler(){return this.resourceController.scheduler}get memoryController(){return this.resourceController.memoryController}get featureStore(){return this._getFeatureStore()}}let p=class extends R{constructor(e){super(e),this._frameTask=null,this._queryEngine=null,this._updateRequested=!0,this._updatingHandles=new I,this._abortController=new AbortController}initialize(){const e=P.FILTER_VISIBILITY,{layer:t,view:n}=this._configuration,{featureStore:r}=this.context,{spatialReference:i,resourceController:l}=n,u=this._configuration.hasZ??!1,h=this._configuration.hasM??!1,c=new Ee(i,t,l,(()=>r),u,h);this._queryEngine=new d({context:c,priority:e}),this._frameTask=n.resourceController.scheduler.registerTask(e),this._updatingHandles.add((()=>[this._compositedFeatureFilter,this._sceneFilter]),(()=>this._updateRequested=!0),y),this._updatingHandles.addWhen((()=>!this._frameTask.updating&&this._updateRequested),(()=>{this._frameTask.schedule((()=>this._updateVisibility()),this._abortController.signal).catch(U),this._updateRequested=!1}),y)}destroy(){this._abortController.abort(),this._updatingHandles.destroy(),this.clear(),this._frameTask=N(this._frameTask),this._queryEngine=E(this._queryEngine),this._set("context",null)}get updating(){return this._updateRequested||this._updatingHandles.updating||this._frameTask.updating}get defaultVisibility(){return this._compositedFeatureFilter==null&&this._sceneFilter==null}get _featureFilter(){return"filter"in this._configuration?this._configuration.filter:null}get _effectiveDisplayFilter(){return"effectiveDisplayFilter"in this._configuration?this._configuration.effectiveDisplayFilter:null}get _sceneFilter(){return"layerFilter"in this._configuration?this._configuration.layerFilter:null}get _floorFilter(){return J(this._configuration)}get _timeExtent(){return"timeExtent"in this._configuration?this._configuration.timeExtent:null}get _compositedFeatureFilter(){const{_featureFilter:e,_effectiveDisplayFilter:t,_timeExtent:n,_floorFilter:r}=this;let i=e?.clone();if(t!=null&&(i??=new m,i.where=C(i.where,t.where)),n!=null&&(i??=new m,i.timeExtent=i.timeExtent?.intersection(n)??n),r!=null){i??=new m;const l=i.where==null||i.where==="";i.where=l?r:C(i.where,r)}return i}get _configuration(){return this.context.configuration}reapply(){this._updateRequested=!0}clear(){this._queryEngine.clear(),this.context.clearFeaturesVisibility()}async _updateVisibility(){const{signal:e}=this._abortController,{context:t,_frameTask:n,_sceneFilter:r,_compositedFeatureFilter:i}=this;if(S(e),i==null&&r==null||t.getFeatureCount()===0)return await n.schedule((()=>this.clear()),e);try{const l=await this._updatingHandles.addPromise(this._queryEngine.executeQueryForIdSet(i,r,e));return S(e),await n.schedule((()=>{t.updateFeatureVisibilities((u=>l.has(u)))}),e)}catch(l){return D(l),j.getLogger(this).warn(`FeatureFilter query failed: ${l}`,{error:l}),await n.schedule((()=>{t.setAllFeaturesVisibility(!0)}),e)}}};s([a({constructOnly:!0})],p.prototype,"context",void 0),s([a()],p.prototype,"updating",null),s([a()],p.prototype,"defaultVisibility",null),s([a()],p.prototype,"_featureFilter",null),s([a()],p.prototype,"_effectiveDisplayFilter",null),s([a()],p.prototype,"_sceneFilter",null),s([a()],p.prototype,"_floorFilter",null),s([a()],p.prototype,"_timeExtent",null),s([a()],p.prototype,"_compositedFeatureFilter",null),s([a()],p.prototype,"_configuration",null),s([a()],p.prototype,"_updateRequested",void 0),p=s([x("esri.views.3d.layers.support.FeatureVisibilityFilter")],p);let o=class extends L{constructor(e){super(e),this.type="graphics-3d",this._updatingHandles=new I,this.elevationFeatureExpressionEnabled=!1,this.scaleVisibilityEnabled=!1,this.filterVisibilityEnabled=!1,this.frustumVisibilityEnabled=!1,this.elevationAlignmentEnabled=!1,this.timeExtentEnabled=!1,this.setUidToIdOnAdd=!0,this.dataExtent=null,this.drapeSourceType=k.Features,this.preferredUpdatePolicy=z.ASYNC,this._suspendResumeExtent=null}initialize(){const e=this.owner,t=(this.filterVisibilityEnabled||this.timeExtentEnabled)&&e.layer.geometryType!=="multipatch",n=new oe({owner:this,layer:this.layer,preferredUpdatePolicy:this.preferredUpdatePolicy,elevationFeatureExpressionEnabled:this.elevationFeatureExpressionEnabled,graphicSymbolSupported:!1,hasZ:e.hasZ,hasM:e.hasM,setUidToIdOnAdd:this.setUidToIdOnAdd,componentFactories:{deconflictor:r=>e.view.deconflictor.addGraphicsOwner(r),labeler:(r,i)=>e.view.labeler.addGraphicsOwner(r,i),elevationAlignment:this.elevationAlignmentEnabled?(r,i)=>new he({graphicsCoreOwner:this,graphicsCore:r,queryGraphicUIDsInExtent:i,elevationProvider:e.view.elevationProvider}):null,scaleVisibility:this.scaleVisibilityEnabled?(r,i)=>new le({graphicsCoreOwner:this,layer:this.layer,queryGraphicUIDsInExtent:i,graphicsCore:r,basemapTerrain:e.view.basemapTerrain}):null,filterVisibility:t?r=>new p({context:{...r,configuration:e}}):null,objectStates:r=>new pe(r)}});this._set("graphicsCore",n),this.frustumVisibilityEnabled&&this._set("frustumVisibility",new de({graphicsCoreOwner:this})),this.elevationAlignment&&this._updatingHandles.add((()=>this.layer.elevationInfo),((r,i)=>{v(r,i)&&this._updatingHandles.addPromise(this.graphicsCore.elevationInfoChange())})),this._updatingHandles.add((()=>this.layer.labelsVisible),(()=>this.graphicsCore.updateVisibilityInfo())),this._updatingHandles.add((()=>this.layer.labelingInfo),((r,i)=>{v(r,i)&&this.graphicsCore.updateLabelingInfo()})),this._updatingHandles.add((()=>this.preferredUpdatePolicy),(r=>this.graphicsCore.preferredUpdatePolicy=r)),this.addResolvingPromise(this._initializeAsync())}async _initializeAsync(){await O(this.graphicsCore.initializePromise);const e=this.owner;this._updatingHandles.add((()=>this.renderer),(t=>this._updatingHandles.addPromise(this.graphicsCore.rendererChange(t)))),this._updatingHandles.add((()=>e.fullOpacity),(()=>this.graphicsCore.opacityChange())),this._setupSuspendResumeExtent(),this.updateClippingExtent&&(this._updatingHandles.add((()=>e.view.clippingArea),(()=>this._updateClippingExtent())),this._updateClippingExtent()),this.graphicsCore.startCreateGraphics(),this.graphicsCore.labelsEnabled&&await O(this.graphicsCore.updateLabelingInfo())}destroy(){this._updatingHandles.destroy(),this._set("frustumVisibility",E(this.frustumVisibility)),this._set("graphicsCore",E(this.graphicsCore)),this._set("owner",null)}get layer(){return this.owner.layer}get layerViewUid(){return this.owner.layerViewUid}get dataUpdating(){return this.graphicsCore?.dataUpdating??!1}get renderer(){const{renderer:e,objectIdField:t}=this.layer;if(!e||!t||e.type==="heatmap"||!e.visualVariables)return e;const n=e.visualVariables.findIndex((i=>i.type==="rotation"&&i.valueExpression!=null&&B(i.valueExpression)===t&&(i.axis==null||i.axis==="heading")&&i.rotationType==="geographic"));if(n<0)return e;const r=e.clone();return r.visualVariables?(r.visualVariables.splice(n,1),this._randomRotationRenderers??=new WeakMap,this._randomRotationRenderers.set(r,t),r):e}get scaleVisibility(){return this.graphicsCore?.scaleVisibility}get filterVisibility(){return this.graphicsCore?.filterVisibility}get elevationAlignment(){return this.graphicsCore?.elevationAlignment}get suspendResumeExtentMode(){return this.owner.suspendResumeExtentMode??"computed"}get scaleVisibilitySuspended(){return this.scaleVisibility!=null&&this.scaleVisibility.suspended}get suspended(){return this.owner.suspended}get legendEnabled(){return this.frustumVisibility==null||!this.frustumVisibility.suspended}get suspendInfo(){const e={};return this.scaleVisibilitySuspended&&(e.outsideScaleRange=!0),this.frustumVisibility!=null&&this.frustumVisibility.suspended&&(e.outsideOfView=!0),e}get updating(){return!!(this.graphicsCore?.updating||this.frustumVisibility?.updating||this._updatingHandles.updating)}get updatingRemaining(){return this.graphicsCore?.updatingRemaining??0}get featureStore(){return this.graphicsCore?.featureStore}get view(){return this.owner.view}get loadedGraphics(){return this.owner.loadedGraphics}get fullOpacity(){return this.owner?.fullOpacity}get filter(){return"filter"in this.owner?this.owner.filter:null}get slicePlaneEnabled(){return this.owner.slicePlaneEnabled}get updatePolicy(){return this.owner.updatePolicy}get featureSpatialReference(){return"featureSpatialReference"in this.owner?this.owner.featureSpatialReference:this.owner.view.spatialReference}get graphics3DGraphics(){return this.graphicsCore?.graphics3DGraphics}get graphics3DGraphicsByObjectID(){return this.graphicsCore?.graphics3DGraphicsByObjectID}get symbolUpdateType(){return this.graphicsCore?.symbolUpdateType}get displayFeatureLimit(){const e=this.view.quality,t=this.graphicsCore?.displayFeatureLimit;if(e===1)return t;const n=Math.ceil(t.maximumNumberOfFeatures*e);return new ue(t.maximumTotalNumberOfVertices,n,t.averageSymbolComplexity)}get usedMemory(){return this.graphicsCore?.usedMemory??0}get loadedFeatures(){return this.graphicsCore?.numberOfGraphics??0}get usedMemoryPerFeature(){return this.graphicsCore?.usedMemoryPerGraphic??0}get unprocessedMemoryEstimate(){return this.graphicsCore?.unprocessedMemoryEstimate??0}get performanceInfo(){return this.graphicsCore.performanceInfo}maskOccludee(e){const t=this.graphicsCore?.objectStates;if(!t)return Z();const{set:n,handle:r}=t.acquireOccludeeSet(null);return t.setUid(n,e.uid),r}highlight(e,t=null,n){const r=this.graphicsCore?.objectStates;if(!r)return _;if(n??=re,e instanceof V){const{set:l,handle:u}=r.acquireHighlightSet(n,t);return this.owner.queryObjectIds(e).then((h=>r.setObjectIds(l,h))),u}let i=ge(e);if(i.length===0)return _;if(i[0]instanceof Y){const l=i;if(F(this.layer.fieldsIndex,l[0].attributes,t)==null){const u=l.map((f=>f.uid)),{set:h,handle:c}=r.acquireHighlightSet(n,null);return r.setUids(h,u),c}i=l.map((u=>F(this.layer.fieldsIndex,u.attributes,t)))}if(fe(i[0])){const l=i,{set:u,handle:h}=r.acquireHighlightSet(n,t);return r.setObjectIds(u,l),h}return _}resetObjectStates(){this.graphicsCore?.objectStates?.reset()}whenGraphicBounds(e,t){return this.graphicsCore?.whenGraphicBounds(e,t)}computeAttachmentOrigin(e,t){return this.graphicsCore?.computeAttachmentOrigin(e,t)}notifyGraphicGeometryChanged(e){this.graphicsCore.notifyGraphicGeometryChanged(e)}notifyGraphicVisibilityChanged(e){this.graphicsCore.notifyGraphicVisibilityChanged(e)}notifyContentGeometryUpdate(){this.owner.notifyContentGeometryUpdate?.()}getRenderingInfo(e,t,n){const r=ne(e,{renderer:t,arcade:n});if(r?.color){const i=r.color;i[0]=i[0]/255,i[1]=i[1]/255,i[2]=i[2]/255}if(r!=null&&t!=null&&this._randomRotationRenderers?.has(t)){const i=this._randomRotationRenderers.get(t),l=e.attributes[i],u=new se(0);u.updateFloatArray([l]),u.updateUint8Array([173]),r.heading=8381e-11*u.digest()}return r}getRenderingInfoAsync(e,t,n,r){return ae(e,{renderer:t,arcade:n,...r})}getSymbolLayerSize(e,t){return this.graphicsCore?.getSymbolLayerSize(e,t)}setObjectIdVisibility(e,t){this.graphicsCore?.setObjectIdVisibility(e,t)}refreshFilter(){this.filterVisibility!=null&&this.filterVisibility.reapply()}getGraphics3DGraphicByObjectId(e){return this.graphicsCore?.getGraphics3DGraphicByObjectId(e)}_updateClippingExtent(){const e=this.owner.view.clippingArea;this.graphicsCore.setClippingExtent(e,this.owner.view.spatialReference)&&(this.updateClippingExtent(e)||this.graphicsCore.recreateAllGraphics())}_setupSuspendResumeExtent(){(this.frustumVisibility||this.scaleVisibility)&&this.addHandles(g((()=>this.suspendResumeExtentMode),(()=>{switch(this.removeHandles(b),this.suspendResumeExtentMode){case"computed":this.addHandles([g((()=>this.graphicsCore.computedExtent),(e=>this._updateSuspendResumeExtent(e)),y),g((()=>this.graphicsCore.extentPadding),(()=>this._updateSuspendResumeExtent(this.graphicsCore.computedExtent)))],b);break;case"data":this.addHandles([K((()=>this.dataExtent),(e=>this._updateSuspendResumeExtent(e)),y),g((()=>this.graphicsCore.extentPadding),(()=>this._updateSuspendResumeExtent(this.dataExtent)))],b);break;default:W(this.suspendResumeExtentMode)}}),y))}_updateSuspendResumeExtent(e){e?this._suspendResumeExtentChanged(this._extentToSuspendResumeRect(e,this._suspendResumeExtent)):this._suspendResumeExtentChanged(null)}_extentToSuspendResumeRect(e,t){const n=this.owner.view.spatialReference;if(!e.spatialReference.equals(n)){if(!X(e,n))return;e=ee(e,n)}return te(e,t,ie,this.graphicsCore.extentPadding)}_suspendResumeExtentChanged(e){this.frustumVisibility!=null&&this.frustumVisibility.setExtent(e),this.scaleVisibility!=null&&this.scaleVisibility.setExtent(e)}};s([a()],o.prototype,"type",void 0),s([a({constructOnly:!0})],o.prototype,"owner",void 0),s([a()],o.prototype,"layer",null),s([a()],o.prototype,"layerViewUid",null),s([a({readOnly:!0})],o.prototype,"dataUpdating",null),s([a()],o.prototype,"renderer",null),s([a({constructOnly:!0})],o.prototype,"updateClippingExtent",void 0),s([a({constructOnly:!0})],o.prototype,"elevationFeatureExpressionEnabled",void 0),s([a({constructOnly:!0})],o.prototype,"graphicsCore",void 0),s([a({constructOnly:!0})],o.prototype,"scaleVisibilityEnabled",void 0),s([a({constructOnly:!0})],o.prototype,"filterVisibilityEnabled",void 0),s([a({constructOnly:!0})],o.prototype,"frustumVisibilityEnabled",void 0),s([a({constructOnly:!0})],o.prototype,"elevationAlignmentEnabled",void 0),s([a({constructOnly:!0})],o.prototype,"timeExtentEnabled",void 0),s([a({constructOnly:!0})],o.prototype,"setUidToIdOnAdd",void 0),s([a()],o.prototype,"scaleVisibility",null),s([a()],o.prototype,"filterVisibility",null),s([a()],o.prototype,"elevationAlignment",null),s([a({constructOnly:!0})],o.prototype,"frustumVisibility",void 0),s([a()],o.prototype,"suspendResumeExtentMode",null),s([a()],o.prototype,"dataExtent",void 0),s([a()],o.prototype,"scaleVisibilitySuspended",null),s([a()],o.prototype,"suspended",null),s([a()],o.prototype,"legendEnabled",null),s([a()],o.prototype,"suspendInfo",null),s([a()],o.prototype,"updating",null),s([a()],o.prototype,"updatingRemaining",null),s([a()],o.prototype,"featureStore",null),s([a()],o.prototype,"view",null),s([a()],o.prototype,"loadedGraphics",null),s([a()],o.prototype,"fullOpacity",null),s([a()],o.prototype,"filter",null),s([a()],o.prototype,"slicePlaneEnabled",null),s([a()],o.prototype,"drapeSourceType",void 0),s([a()],o.prototype,"updatePolicy",null),s([a()],o.prototype,"preferredUpdatePolicy",void 0),s([a({readOnly:!0})],o.prototype,"displayFeatureLimit",null),o=s([x("esri.views.3d.layers.graphics.Graphics3DFeatureProcessor")],o);const b="suspendResumeExtentMode";export{o as D,Ee as e,d as h,p as y};
