import{s_ as w,ci as b,b6 as $,s$ as S,aZ as y,fN as x,bZ as v,nw as R,aD as C,nk as D,az as I,lF as L,ao as z,t0 as F,t1 as E,af as l,ag as a,ai as _,t2 as j,bX as q,j as G,t3 as H,d5 as k,aH as W,bR as M,bd as P,eP as T,kn as B,bW as N,eQ as Z,oJ as A}from"./chunk-CuaFhuP3.js";import"./chunk-Dpk1TJd9.js";import{s as U,h as V}from"./chunk-Bk75CnQo.js";import{p as X}from"./chunk-CzCeT6NZ.js";import{R as J,b as O}from"./chunk-DwTaIoG6.js";function Q(t,e,s,n){const{spatialReference:i}=t;return Y(s.map((r=>r.map((o=>{const[h,c]=K(o,e),{absoluteZ:f}=w(h,c,0,i,t,n),m=b(h,c,f);return t.renderCoordsHelper.toRenderCoords(m,i,m),m})))))}function Y(t){const e=J(t),s=new $({width:2,color:y(.1,.2,1,1),innerWidth:1,innerColor:y(.2,.4,1,1),cap:S.ROUND});return e.map((n=>O(s,n)))}function K({x:t,y:e},s){const{extent:n,size:[i,r]}=s;return[t/i*n.width+n.xmin,(r-e)/r*n.height+n.ymin]}function tt(t,e,s){let[n,i,r,o]=[null,null,null,null];for(e.reset(t);!e.done;){const h=e.next();if(h==null)continue;if(!h.visible){e.skipSubtree();continue}const c=h.extent;h.leaf&&h.rendered&&x(c,s)&&(n=g(c[0],n),i=g(c[1],i),r=p(c[2],r),o=p(c[3],o))}return n==null||i==null||r==null||o==null?null:v([n,i,r,o])}function p(t,e){return e==null?t:Math.max(t,e)}function g(t,e){return e==null?t:Math.min(t,e)}class et{constructor(e,s){this.streamlines=e,this._geometries=s,this._object3D=null,this._engineLayer=null}get attached(){return this._object3D!=null&&this._engineLayer!=null}attach(e){const{_geometries:s}=this;if(s==null)return;this.detach();const n=new R(e,{pickable:!1,updatePolicy:C.SYNC}),i=new D({geometries:s});i.visible=!0,n.add(i),this._object3D=i,this._engineLayer=n}detach(){this.attached&&(this._engineLayer=I(this._engineLayer),this._object3D=L(this._object3D))}}let d=class extends z{constructor(t){super(t),this.simulationSettings=null,this.loadImagery=null,this.createGeometry=null}async load(t,e){const s=await this.loadImagery(t,e);if(s==null)return null;const n=this._createFlowFieldFromData(s),i=this._getStreamlines(t,n),r=this.createGeometry(t,i);return new et(i,r)}_createFlowFieldFromData(t){return F(this.simulationSettings,t)}_getStreamlines(t,e){const{size:[s,n]}=t;return E(this.simulationSettings,e,s,n)}};l([a()],d.prototype,"simulationSettings",void 0),l([a()],d.prototype,"loadImagery",void 0),l([a()],d.prototype,"createGeometry",void 0),d=l([_("esri.views.3d.support.flow.StreamlinesStyle3D")],d);let u=class extends X{constructor(t){super(t),this.type="flow",this._preorderIterator=new j,this._abortController=null,this._debouncedLoad=q((async()=>{const{view:e,_style:s}=this;if(s==null)return;const n=this._computeExtent();if(n==null)return;const i={extent:n,timeExtent:this.layer.timeExtent,size:this._viewSizeWithEqualRatio(n),pixelRatio:e.state.contentPixelRatio};this._abortController==null&&(this._abortController=new AbortController);const r=this._abortController,o=await s.load(i,r.signal);G(r.signal),o!=null&&(this._resources?.detach(),o.attach(e.stage),this._resources=o)})),this._loadImagery=(e,s)=>{const{extent:n,size:[i,r],timeExtent:o}=e;return H(this.layer,n,i,r,o,s)},this._createFlowGeometry=(e,s)=>Q(this.view,e,s,this.elevationInfo)}initialize(){this.addHandles([k((()=>this.newStyleRequired),(()=>this._updateStyle()),W)]),this.updatingHandles.add((()=>this._style),(()=>this._triggerLoad())),this._updateStyle(),this.updatingHandles.addWhen((()=>!this.view.basemapTerrain?.updating),(()=>this._triggerLoad()))}destroy(){this._abortController=M(this._abortController),this.clear()}get layer(){return this.layerView.layer}get flowRenderer(){const t=this.layer.renderer;return t?.type!=="flow"?null:t}get elevationInfo(){return new P({mode:"absolute-height",offset:1e3})}get dataBounds(){const{fullExtent:t}=this.layer,{spatialReference:e}=this.view.basemapTerrain,s=T(t,e).geometry;return s==null?null:B(s)}get simulationSettings(){const{flowRenderer:t}=this;return t==null?null:U(t)}get newStyleRequired(){const t=this._style?.simulationSettings,e=this.simulationSettings;return t!=null&&e!=null&&!V(t,e)}doRefresh(){return this._triggerLoad()}clear(){this._resources?.detach(),this._resources=null}_triggerLoad(){return N(this.updatingHandles.addPromise(this._debouncedLoad()))}_updateStyle(){const{simulationSettings:t}=this;t!=null&&(this._style?.destroy(),this._style=new d({simulationSettings:t,loadImagery:this._loadImagery,createGeometry:this._createFlowGeometry}))}_computeExtent(){const t=this.view.basemapTerrain,e=t?.rootTiles;if(e==null||e.length===0)return null;const{spatialReference:s}=t,{dataBounds:n}=this;if(!s||n==null)return null;const i=tt(e,this._preorderIterator,n);return i==null?null:(A(i,n,i),Z(i,s))}_viewSizeWithEqualRatio(t){const e=(t.xmax-t.xmin)/(t.ymax-t.ymin),[s,n]=this.view.size;return s<n?[s,Math.floor(s/e)]:[Math.floor(n*e),n]}get test(){}};l([a()],u.prototype,"type",void 0),l([a()],u.prototype,"_style",void 0),l([a()],u.prototype,"layer",null),l([a()],u.prototype,"flowRenderer",null),l([a()],u.prototype,"elevationInfo",null),l([a()],u.prototype,"dataBounds",null),l([a()],u.prototype,"simulationSettings",null),l([a()],u.prototype,"newStyleRequired",null),u=l([_("esri.views.3d.layers.FlowSubView3D")],u);export{u as b};
