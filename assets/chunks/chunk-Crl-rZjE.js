import{_ as n}from"./chunk-DsYbGKja.js";import{oC as _,ak as o,oD as O,gO as L,am as k,aF as P,eo as F,aL as T,oE as b,gx as D,oF as $,oG as N,oH as S,F as m,oI as U,gj as v,g9 as g,gK as w,oJ as Q,gh as V,oK as j,oL as E,oM as G,oN as x,oO as W,oP as H,oQ as p,oR as A,oS as B,oT as c,dL as z,oU as J,n as R,gy as K}from"./chunk-B0S82j6z.js";import{e as M}from"./chunk-iL5WjyEH.js";import{E as X}from"./chunk-SxxbBSOD.js";import{e as Y}from"./chunk-Dd4Lqn-J.js";function Z(y,i){if(i.type!=="feature"&&i.type!=="subtype-group")return[];if(!i.url)return[];const l="utilityNetworks"in y.map?y.map.utilityNetworks??[]:[];for(const t of l)if(t.isUtilityLayer(i)){const e=i.fieldsIndex.get("assetgroup"),r=i.fieldsIndex.get("assettype");return[e?.name,r?.name].filter(u=>u!=null)}return[]}class ee{constructor(i){this._fieldsIndex=i,this._clauses=[]}async finish(){return{requiresCurrentUser:(await Promise.all(this._clauses)).some(i=>i.currentUserRequired)}}visitClientWhereClause(i){i&&this._clauses.push(_(i,this._fieldsIndex))}visitFeatureReduction(i){if(i)switch(i.type){case"binning":case"cluster":this.visitLabelingInfo(i.labelsVisible,i.labelingInfo)}}visitLabelingInfo(i,l){if(i&&l!=null)for(const t of l)this.visitClientWhereClause(t.where)}visitDisplayFilter(i,l){if(i)for(const t of l?.filters??[])this.visitClientWhereClause(t.where)}visitFilter(i){this.visitClientWhereClause(i?.where)}visitTrackInfo(i){i!=null&&(this.visitLabelingInfo(i?.latestObservations.labelsVisible,i?.latestObservations.labelingInfo),this.visitLabelingInfo(i?.previousObservations.labelsVisible,i?.previousObservations.labelingInfo),this.visitLabelingInfo(i?.trackLines.labelsVisible,i?.trackLines.labelingInfo))}}const ne=y=>{const i=y;let l=class extends i{constructor(...t){super(...t),this._updatingRequiredPromise=null,this.filter=null,this.layer=null,this.requiresCurrentUser=!1,this.requiredFields=[],this.view=null}initialize(){this.addHandles([P(()=>{const t=this.layer,e=this.view;return[t&&"elevationInfo"in t?t.elevationInfo?.featureExpressionInfo:null,t&&"displayField"in t?t.displayField:null,t&&"timeInfo"in t&&t.timeInfo,t&&"renderer"in t&&t.renderer,t&&"labelingInfo"in t&&t.labelingInfo,t&&"floorInfo"in t&&t.floorInfo,e?.requiredFieldsOptions?.featureTitleFields&&t&&"featureTitleFields"in t&&t.featureTitleFields,e?.requiredFieldsOptions?.utilityNetworkFields&&Z(e,t),t.displayFilterInfo,this.displayFilterEnabled,this.filter,this.featureEffect,this.timeExtent,t?.type==="knowledge-graph-sublayer"&&t.parentCompositeLayer.type==="link-chart"&&t.parentCompositeLayer.linkChart?.linkChartProperties.nonspatialDataDisplay?.mode]},()=>this._handleChange(),T),F(()=>this.view?.floors,"change",()=>this._handleChange()),F(()=>this.layer.displayFilterInfo?.filters,"change",()=>this._handleChange()),F(()=>this.layer&&"sublayers"in this.layer?this.layer.sublayers:null,"change",()=>this._handleChange())])}get availableFields(){if(!this.layer)return[];const{layer:t,layer:{fieldsIndex:e},requiredFields:r}=this;return"outFields"in t&&t.outFields?b(e,[...D(e,t.outFields),...r]):b(e,r)}get displayFilterEnabled(){return(this.view?.displayFilterEnabled??!0)&&(!("displayFilterEnabled"in this.layer)||(this.layer?.displayFilterEnabled??!0))}get effectiveDisplayFilter(){const t=this.layer;return this.displayFilterEnabled&&t.displayFilterInfo?$(t.displayFilterInfo,this.view):null}get effectiveDisplayFilterClause(){const t=this.effectiveDisplayFilter?.where??null;return t&&this.hasHighlight?N(t,S(this.layer.objectIdField,this.highlightIds)):t}get featureEffect(){return this.layer&&"featureEffect"in this.layer?this.layer.featureEffect:null}set featureEffect(t){this._override("featureEffect",t)}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(t){m.getLogger(this).error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported")}get maximumNumberOfFeaturesExceeded(){return!1}get signedInUser(){return this.layer?.url?U(this.layer.url):Promise.resolve(null)}highlight(t,e){throw new Error("missing implementation")}createQuery(){const t={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},e=this.filter!=null?this.filter.createQuery(t):new v(t);return"floorInfo"in this.layer&&this.layer.floorInfo&&(e.where=g(e.where,w(this))),this.displayFilterEnabled&&(e.where=g(e.where,this.effectiveDisplayFilter?.where)),this.timeExtent!=null&&(e.timeExtent=e.timeExtent!=null?e.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),e}createAggregateQuery(){const t={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference};return new v(t)}queryFeatures(t,e){throw new Error("missing implementation")}queryObjectIds(t,e){throw new Error("missing implementation")}queryFeatureCount(t,e){throw new Error("missing implementation")}queryExtent(t,e){throw new Error("missing implementation")}async fetchPopupFeaturesFromGraphics(t,e){const r=[],u=new Set;for(const d of t){const s=Q(d.origin),f=V(s,{...e,checkPopupEnabled:!0});f&&(r.push(d),u.add(f))}if(r.length===0||u.size===0)return[];const h=await this._createPopupQuery(u,e);return await j(this.layer,r,h,{hasRequiredFields:(d,s)=>this._popupFeatureHasRequiredFields(d,s),...e})}_handleChange(){const t=Promise.all([this._updateRequiredFields(),this._updateClientWhereClauseRequirements()]).then(()=>{});return this._set("_updatingRequiredPromise",t),t.then(()=>{this._updatingRequiredPromise===t&&this._set("_updatingRequiredPromise",null)}),t}async _updateClientWhereClauseRequirements(){if(!this.layer||!this.view)return;const{layer:t}=this,e=new ee(t.fieldsIndex);if(e.visitFilter(this.filter),"featureReduction"in t&&e.visitFeatureReduction(t.featureReduction),"labelingInfo"in t&&e.visitLabelingInfo(t.labelsVisible,t.labelingInfo),"trackInfo"in t&&e.visitTrackInfo(t.trackInfo),this.view.type==="2d"&&(e.visitFilter(this.featureEffect?.filter),e.visitDisplayFilter(this.displayFilterEnabled,t.displayFilterInfo),"featureReduction"in t&&e.visitFeatureReduction(t.featureReduction)),t.type==="subtype-group")for(const r of t.sublayers)e.visitLabelingInfo(r.labelsVisible,r.labelingInfo);try{const r=await e.finish();this._set("requiresCurrentUser",r.requiresCurrentUser)}catch(r){m.getLogger(this).error(r)}}async _updateRequiredFields(){if(!this.layer||!this.view)return;const t=this.view.type==="3d",{layer:e,layer:{fieldsIndex:r}}=this,u="renderer"in e&&e.renderer,h="orderBy"in e&&e.orderBy,d="featureReduction"in e?e.featureReduction:null,s=new Set,f=[u?u.collectRequiredFields(s,r):null,E(s,e),t&&"elevationInfo"in e?G(s,e):null,this.filter!=null?x(s,e,this.filter):null,t||this.featureEffect==null?null:x(s,e,this.featureEffect.filter),!t&&d?W(s,e,d):null,!t&&h?H(s,e,h):null];if("timeInfo"in e&&e.timeInfo&&this.timeExtent&&p(s,e.fieldsIndex,[e.timeInfo.startField,e.timeInfo.endField]),"timeInfo"in e&&e.timeInfo&&"trackInfo"in e&&e.trackInfo){const{trackInfo:a}=e;p(s,e.fieldsIndex,[e.timeInfo.trackIdField]),e.type!=="feature"&&a.timeField!=="startTimeField"||p(s,e.fieldsIndex,[e.timeInfo.startField]),a.timeField==="endTimeField"&&p(s,e.fieldsIndex,[e.timeInfo.endField]),await A(s,e)}if("floorInfo"in e&&e.floorInfo&&p(s,e.fieldsIndex,[e.floorInfo.floorField]),"featureTitleFields"in e&&this.view?.requiredFieldsOptions?.featureTitleFields&&e.featureTitleFields&&p(s,e.fieldsIndex,e.featureTitleFields),e.type==="feature"&&e.globalIdField&&this.view?.requiredFieldsOptions?.globalIdField&&p(s,e.fieldsIndex,[e.globalIdField]),this.displayFilterEnabled&&f.push(B(s,e,e.displayFilterInfo)),e.type==="feature"&&t&&e.infoFor3D!=null&&(e.globalIdField==null&&m.getLogger(this).error("globalIdField missing on 3DObjectFeatureLayer"),p(s,e.fieldsIndex,[e.globalIdField])),e.type==="subtype-group"){c(s,r,e.subtypeField);const a=e.sublayers.map(I=>Promise.all([I.renderer?.collectRequiredFields(s,r),E(s,I)]));f.push(Promise.all(a))}if(e.type==="catalog-footprint"&&e.parent){const a=e.parent;p(s,r,[a.itemNameField,a.itemSourceField,a.itemTypeField,a.maxScaleField,a.minScaleField])}e.type==="knowledge-graph-sublayer"&&e.parentCompositeLayer.type==="link-chart"&&c(s,r,X);const q=await Promise.allSettled(f);if(t)c(s,r,e.objectIdField);else for(const a of M(Y(e)))c(s,r,a);t&&"displayField"in e&&e.displayField&&c(s,r,e.displayField);for(const a of q)a.status==="rejected"&&m.getLogger(this).error(a.reason);const C=Array.from(s).sort();this._set("requiredFields",C)}_popupFeatureHasRequiredFields(t,e){return z(t,e)}async _createPopupQuery(t,e){const r=this.layer.createQuery(),u=new Set;let h=this.layer.geometryType==="point";for(const d of t){if(!h){const f=await J(d);R(e),h=(f&&f.arcadeUtils.hasGeometryOperations(d))??!1}const s=await K(this.layer,d);R(e);for(const f of s)u.add(f)}return r.returnGeometry=h,r.returnZ=h,r.returnM=h,r.outFields=Array.from(u),r.outSpatialReference=this.view.spatialReference,"floorInfo"in this.layer&&this.layer.floorInfo&&(r.where=g(r.where,w(this))),r}canResume(){return!!super.canResume()&&(this.timeExtent==null||!this.timeExtent.isEmpty)}getTest(){}get test(){}};return n([o()],l.prototype,"_updatingRequiredPromise",void 0),n([o({readOnly:!0})],l.prototype,"availableFields",null),n([o({readOnly:!0})],l.prototype,"displayFilterEnabled",null),n([o({readOnly:!0})],l.prototype,"effectiveDisplayFilter",null),n([o({readOnly:!0})],l.prototype,"effectiveDisplayFilterClause",null),n([o({type:O})],l.prototype,"featureEffect",null),n([o({type:L})],l.prototype,"filter",void 0),n([o()],l.prototype,"layer",void 0),n([o({type:Number})],l.prototype,"maximumNumberOfFeatures",null),n([o({readOnly:!0,type:Boolean})],l.prototype,"maximumNumberOfFeaturesExceeded",null),n([o()],l.prototype,"requiresCurrentUser",void 0),n([o({readOnly:!0})],l.prototype,"requiredFields",void 0),n([o({readOnly:!0})],l.prototype,"signedInUser",null),n([o()],l.prototype,"suspended",void 0),n([o()],l.prototype,"view",void 0),l=n([k("esri.views.layers.FeatureLayerView")],l),l};export{ne as Q};
