import{_ as l}from"./chunk-DsYbGKja.js";import{mW as fe,as as re,aI as W,uF as Ve,F as G,aF as y,aG as m,uG as d,uH as $,ak as r,am as H,uI as be,mM as De,dc as Me,aL as x,aH as L,oc as b,uJ as u,uK as D,cr as Se,uL as Ce,d4 as C,uM as F,d2 as S,qV as J,bZ as Q,cN as c,b2 as O,b1 as X,uN as Z,c_ as U,cW as k,b0 as K,d0 as R,uO as Te,uP as f,e6 as Y,n2 as Ee,gG as ee,np as $e,bB as te,cS as xe,cU as ke,a$ as oe,uQ as he,kW as ue,a_ as Le,uR as pe,fL as ie}from"./chunk-DbiObNSB.js";import{e as He}from"./chunk-dqCCKSlX.js";import{L as ze,U as Ge,R as Oe,w as ce,_ as Re,j as de,h as ye,r as ae,t as Ie,n as Ae,a as Be,x as P,s as j,c as Fe,u as Ue,d as Ke,l as je,e as _e,f as ve,o as qe,g as Ne}from"./chunk-B-aqwxbl.js";import{a as We,j as Je}from"./chunk-D_OTJ5pz.js";import{l as Qe,n as Xe}from"./chunk-DR3IsF1_.js";import{h as se,b as Ze}from"./chunk-NinVsiIN.js";import{m as Ye,M as we,r as I,t as A,p as et,f as tt,h as it,j as at}from"./chunk-C7hN79_K.js";import{P as T}from"./chunk-FzKxVjab.js";import{o as st,m as nt,f as lt,d as rt,y as ot}from"./chunk-BCKP4JSU.js";import{p as E}from"./chunk-CTyU4wrK.js";import{o as ht}from"./chunk-CDrBP97I.js";import{h as ut}from"./chunk-CCavR4OV.js";import"./chunk-BBnM6NiO.js";/* empty css              */import"./chunk-BDC69tvl.js";import"./chunk-D6ZZRc_-.js";import"./chunk-BaOeg_Jz.js";import"./chunk-DVrHAASS.js";import"./chunk-CMcg_YFh.js";import"./chunk-B70CFV-J.js";import"./chunk-D_KPum8l.js";import"./chunk-Dnsx54yR.js";import"./chunk-pTXIOXm3.js";import"./chunk-CmKkBG9o.js";function pt(e){switch(e.type){case"building-scene":case"catalog":case"catalog-dynamic-group":case"catalog-footprint":case"csv":case"dimension":case"feature":case"gaussian-splat":case"geo-rss":case"geojson":case"graphics":case"group":case"integrated-mesh":case"integrated-mesh-3dtiles":case"kml":case"knowledge-graph":case"link-chart":case"knowledge-graph-sublayer":case"line-of-sight":case"map-notes":case"ogc-feature":case"oriented-imagery":case"point-cloud":case"route":case"scene":case"stream":case"viewshed":case"voxel":case"subtype-group":case"unknown":case"unsupported":case"wfs":case"parquet":case null:case"imagery":case"imagery-tile":return!1;case"base-dynamic":case"base-elevation":case"base-tile":case"bing-maps":case"elevation":case"map-image":case"media":case"open-street-map":case"tile":case"vector-tile":case"video":case"wcs":case"web-tile":case"wms":case"wmts":return!0;default:return fe(e.type),!1}}let w=class extends re{constructor(e){super(e),this._internalChange=!1,this._currentSlicePlane=null}initialize(){this.addHandles(this.analysis.excludedLayers.on("before-add",e=>{const t=e.item;t!=null&&(t instanceof W||t instanceof Ve)?t instanceof W&&pt(t)?(G.getLogger(this).error("excludedLayers",`Layer '${t.title}, id:${t.id}' of type '${t.type}' can not be individually excluded from slicing. Use 'excludeGroundSurface' instead.`),e.preventDefault()):this.analysis.excludedLayers.includes(t)&&e.preventDefault():(G.getLogger(this).error("excludedLayers","Invalid layer type, layer must derive from Layer or BuildingComponentSublayer"),e.preventDefault())})),yt(this.view,this),this.addHandles([y(()=>this.analysisViewData.plane,()=>{this._internalChange||this._updateSlicePlaneFromBoundedPlane(),this._updateLayerViews()},m),y(()=>this.analysis.excludeGroundSurface,()=>this._updateLayerViews(),m),this.analysis.excludedLayers.on("change",()=>this._updateLayerViews()),y(()=>[this.analysisViewData.active,this.analysisViewData.visible],()=>{this._updateActiveController(),this._updateViewSlicePlane(),this._updateViewSlicePlaneDecoration()},m),y(()=>this._allLayerAndSubLayerViews,()=>this._updateLayerViews())]),this.addHandles([y(()=>this.analysis.shape,()=>{this._internalChange||(this._updateBoundedPlaneFromSlicePlane(),this._updateViewSlicePlane())},m),y(()=>this.analysis.origin?.type!=="web-scene",()=>this._updateViewSlicePlaneDecoration(),m)],"analysis"),this._updateActiveController(),this._updateBoundedPlaneFromSlicePlane(),this._updateViewSlicePlane(),this._updateViewSlicePlaneDecoration()}destroy(){this.analysisViewData.active&&(this.analysisViewData.active=!1,this.view.slice.plane=null,this._updateActiveController(),this._updateViewSlicePlane()),_t(this.view,this),this.set("view",null)}get _allLayerAndSubLayerViews(){const e=this.view.allLayerViews.items;return e.concat(e.filter(ze).flatMap(({sublayerViews:t})=>t.items))}_updateBoundedPlaneFromSlicePlane(){const e=this.analysis.shape,t=this._currentSlicePlane;if(t==null&&e==null||t!=null&&e!=null&&e.equals(t))return;let i=null,a=null;if(e?.position!=null){const s=e.position.spatialReference,n=Ge(e,this.view);n==null&&We(this.analysis,s,G.getLogger(this)),i=Oe(n,this.view,{tiltEnabled:this.analysis.tiltEnabled},d()),i!=null&&(a=new $({heading:e.heading,tilt:e.tilt,position:e.position,width:e.width,height:e.height}))}this._currentSlicePlane=a,this._internalChange=!0,this.analysisViewData.plane=i,this._internalChange=!1}_updateSlicePlaneFromBoundedPlane(){const e=this.analysisViewData.plane,t=ce(e,this.view,this.view.spatialReference,new $);let i=null;t!=null&&(i=new $({heading:t.heading,tilt:t.tilt,position:t.position,width:t.width,height:t.height})),this._currentSlicePlane=i,this._internalChange=!0,this.analysis.shape=t,this._internalChange=!1,this._updateViewSlicePlane()}_updateActiveController(){if(B)return;const e=N(this.view);if(e)if(this.analysisViewData.active)e.activeController!=null&&e.activeController!==this?(B=!0,e.activeController.analysisViewData.active=!1,B=!1):e.activeController!=null&&e.activeController,this._updateLayerViews(),e.activeController=this;else{if(e.activeController!=null&&e.activeController!==this)return;e.activeController!=null&&e.activeController===this&&(e.activeController=null,this._updateLayerViews())}}_updateViewSlicePlane(){ct(this.view)}_updateViewSlicePlaneDecoration(){dt(this.view)}_updateLayerViews(){const e=this.analysisViewData.plane!=null&&this.analysisViewData.visible&&this.analysisViewData.active,t=[],i=a=>{"layers"in a?a.layers.forEach(i):t.push(a)};this.analysis.excludedLayers.forEach(i),this.view.allLayerViews.forEach(a=>{a.destroyed||("slicePlaneEnabled"in a&&(a.slicePlaneEnabled=e&&!t.includes(a.layer)),"sublayerViews"in a&&a.sublayerViews.forEach(s=>{s.slicePlaneEnabled=e&&!t.includes(s.sublayer)}))}),this.view.basemapTerrain!=null&&(this.view.basemapTerrain.slicePlaneEnabled=e&&!this.analysis.excludeGroundSurface)}};l([r()],w.prototype,"view",void 0),l([r()],w.prototype,"analysis",void 0),l([r()],w.prototype,"analysisViewData",void 0),l([r()],w.prototype,"_allLayerAndSubLayerViews",null),w=l([H("esri.views.3d.analysis.Slice.SliceController")],w);const g=new Map;let B=!1;function ct(e){const t=N(e),i=t?.activeController;i?.analysisViewData.plane!=null&&i.analysisViewData.visible?e.slice.plane=i.analysisViewData.plane:e.slice.plane=null}function dt(e){const t=N(e),i=t?.activeController;e.slice.isDecoration=i?.analysis.origin?.type!=="web-scene"}function yt(e,t){g.has(e)||g.set(e,{all:[],activeController:null}),g.get(e)?.all.push(t)}function N(e){return g.get(e)}function _t(e,t){if(!g.has(e))throw new Error("view expected in global slice register");const i=g.get(e),a=i?.all.lastIndexOf(t)??-1;if(!i||a===-1)throw new Error("controller expected in global slice register");i.all.splice(a,1),i.all.length===0&&g.delete(e)}var q;let o=class extends st{static{q=this}constructor(e){super(e),this._clock=be,this._previewPlaneOpacity=1,this.removeIncompleteOnCancel=!1,this._mode="none",this.shiftManipulator=null,this.rotateHeadingManipulator=null,this.rotateTiltManipulator=null,this.resizeManipulators=null,this._frameTask=null,this._pointerMoveTimerMs=Ye,this._prevPointerMoveTimeout=null,this._previewPlaneGridVisualElement=null,this._previewPlaneOutlineVisualElement=null,this._startPlane=d(),this._previewPlane=null,this._activeKeyModifiers={},this._lastCursorPosition=De(),this._resizeHandles=[{direction:[1,0]},{direction:[1,1]},{direction:[0,1]},{direction:[-1,1]},{direction:[-1,0]},{direction:[-1,-1]},{direction:[0,-1]},{direction:[1,-1]}],this._intersector=ht(e.view.state.viewingMode)}initialize(){if(this.analysis==null)throw new Error("SliceTool requires valid analysis, but null was provided.");const e=n=>{this._updateManipulatorsInteractive(n),n.grabbing||(this.analysisViewData.plane!=null&&u(this.analysisViewData.plane,this._startPlane),this.inputState=null)},t=new Re(this.view,1);this.shiftManipulator=t,this.manipulators.add(t),this.addHandles([this._createShiftDragPipeline(t),t.events.on("grab-changed",n=>{this._onShiftGrab(n),e(t)})]);const i=!this.view.stage?.renderView.renderingContext.driverTest.svgPremultipliesAlpha.result,a=new se(this.view,(n,h)=>Qe(this.view.stage.textures,{accentColor:n,contrastColor:h,preMultiplyAlpha:i}));this.rotateHeadingManipulator=a,this.manipulators.add(a),this.addHandles([this._createRotateHeadingDragPipeline(a),a.events.on("grab-changed",n=>{this._onRotateHeadingGrab(n),e(a)})]);const s=new se(this.view,(n,h)=>Xe(this.view.stage.textures,{accentColor:n,contrastColor:h,preMultiplyAlpha:i}));this.rotateTiltManipulator=s,this.manipulators.add(s),this.addHandles([this._createRotateTiltDragPipeline(s),s.events.on("grab-changed",n=>{this._onRotateTiltGrab(n),e(s)})]),this.resizeManipulators=this._resizeHandles.map((n,h)=>{const _=new Ze(this.view,n);return this.addHandles([this._createResizeDragPipeline(_),_.events.on("grab-changed",V=>{this._onResizeGrab(V,h),e(_)})]),_}),this.manipulators.addMany(this.resizeManipulators),this._previewPlaneGridVisualElement=de(this.view),this._previewPlaneOutlineVisualElement=ye(this.view),this._previewPlaneOutlineVisualElement.width=we,this.addHandles(y(()=>[this.analysisViewData.plane,this.analysis.tiltEnabled],()=>this._updateManipulators(),m)),this.addHandles([Me(()=>this.state==="sliced",()=>{this.finishToolCreation(),this.stop()},x),y(()=>this.view.state.camera,()=>this._onCameraChange())])}destroy(){this._removeFrameTask(),this._clearPointerMoveTimeout(),this._previewPlaneOutlineVisualElement=L(this._previewPlaneOutlineVisualElement),this._previewPlaneGridVisualElement=L(this._previewPlaneGridVisualElement)}get state(){const e=!!this.analysisViewData.plane,t=!!this.inputState;return e?e&&t?"slicing":e&&!t?"sliced":"ready":"ready"}get cursor(){return this.active?this._placingSlicePlane||this.mode==="exclude"?"crosshair":this._creatingPointerId!=null?"grabbing":null:null}set analysis(e){if(e==null)throw new Error("SliceTool requires valid analysis, but null was provided.");this.removeHandles("analysis"),this._set("analysis",e)}get mode(){return this._mode}static{this.disableEngineLayers=!1}get inputState(){return this._get("inputState")}set inputState(e){this._set("inputState",e),this.analysisViewData.showGrid=e!=null&&e.type==="resize",this._updateMaterials()}get _placingSlicePlane(){return this.active&&!this.inputState&&this._mode==="place"}get _creatingPointerId(){return this.inputState!=null&&this.inputState.type==="shift"?this.inputState.creatingPointerId:null}start(e){this._finishToolCreationIfValid(),this._mode=e,this.active||(this.view.activeTool=this)}stop(){this.active&&(this.view.activeTool=null)}onActivate(){this._finishToolCreationIfValid(),this._mode==="none"&&this.analysisViewData.plane==null&&(this._mode="place")}onDeactivate(){this._mode="none",this._updatePreviewPlane(null)}onShow(){this._updateVisibility(!0)}onHide(){this._updateVisibility(!1)}_updateVisibility(e){this._updateManipulators(),e||this._clearPointerMoveTimeout()}onInputEvent(e){switch(e.type){case"pointer-drag":if(!le(e))return;this._placingSlicePlane?this._onClickPlacePlane(e)&&e.stopPropagation():this._onPointerDrag(e)&&e.stopPropagation();break;case"pointer-move":this._onPointerMove(e);break;case"pointer-up":this._onPointerUp(e)&&e.stopPropagation();break;case"immediate-click":if(!le(e))return;this._mode==="exclude"?e.defer(async()=>{await this._onClickExcludeLayer(e)&&e.stopPropagation()}):this._onClickPlacePlane(e)&&e.stopPropagation();break;case"drag":this.inputState&&e.stopPropagation();break;case"key-down":this._onKeyDown(e)&&e.stopPropagation();break;case"key-up":this._onKeyUp(e)&&e.stopPropagation()}}onEditableChange(){this.analysisViewData.editable=this.internallyEditable}_onPointerDrag(e){const t=this.inputState;if(e.pointerId===this._creatingPointerId&&t!=null&&t.type==="shift"){const i=b(e);return this.shiftManipulator.events.emit("drag",{action:t.hasBeenDragged?"update":"start",pointerType:e.pointerType,start:i,screenPoint:i}),t.hasBeenDragged=!0,!0}return!1}_onPointerMove(e){this._lastCursorPosition.x=e.x,this._lastCursorPosition.y=e.y,this._resetPointerMoveTimeout(),e.pointerType!=="touch"&&this._updatePreviewPlane(b(e),this._activeKeyModifiers)}_onCameraChange(){this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),this._updateManipulators()}_onPointerUp(e){if(e.pointerId===this._creatingPointerId&&this.analysisViewData.plane!=null){const t=b(e);return this.shiftManipulator.events.emit("drag",{action:"end",start:t,screenPoint:t}),u(this.analysisViewData.plane,this._startPlane),this.inputState=null,!0}return!1}_onClickPlacePlane(e){if(!this._placingSlicePlane)return!1;const t=b(e),i=d();if(this._pickPlane(t,!1,this._activeKeyModifiers,i)){if(e.type==="pointer-drag"){const a=D(this.view.state.camera,t,M);this.inputState=ne(a,e.pointerId,i.origin,i)}return u(i,this._startPlane),this.analysis.shape=ce(i,this.view,this.view.spatialReference,new $),e.type!=="pointer-drag"&&this.stop(),!0}return!1}async _onClickExcludeLayer(e){if(this.mode!=="exclude")return!1;const t=await this.view.hitTest(b(e)),i=t.results.at(0);if(i){const a=i.type==="graphic"&&i.graphic;if(a){const s=Ce(a.origin)??a.sourceLayer??a.layer;s&&s.type!=="subtype-sublayer"&&this.analysis.excludedLayers.push(s)}}else t.ground.layer?this.analysis.excludedLayers.push(t.ground.layer):this.analysis.excludeGroundSurface=!0;return this.stop(),!0}_onKeyDown(e){return(e.key===I||e.key===A)&&(this._activeKeyModifiers[e.key]=!0,this._previewPlane!=null&&this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),!0)}_onKeyUp(e){return!(e.key!==I&&e.key!==A||!this._activeKeyModifiers[e.key])&&(delete this._activeKeyModifiers[e.key],this._previewPlane!=null&&this._updatePreviewPlane(this._lastCursorPosition,this._activeKeyModifiers),!0)}_onShiftGrab(e){if(e.action!=="start"||this.analysisViewData.plane==null||!e.screenPoint)return;const t=D(this.view.state.camera,e.screenPoint,M);u(this.analysisViewData.plane,this._startPlane),this.inputState=ne(t,null,this.shiftManipulator.renderLocation,this.analysisViewData.plane)}_createShiftDragPipeline(e){return E(e,(t,i,a)=>{const s=this.inputState;if(s==null||s.type!=="shift")return;const n=this.analysisViewData.plane!=null?u(this.analysisViewData.plane,d()):null;i.next(T(this.view,s.shiftPlane)).next(this._shiftDragAdjustSensitivity(s)).next(this._shiftDragUpdatePlane(s)),a.next(()=>{n!=null&&this._updateBoundedPlane(n)})})}_shiftDragAdjustSensitivity(e){return t=>{if(this.analysisViewData.plane==null)return null;const i=.001,a=Math.min((1-Math.abs(C(F(this.analysisViewData.plane),t.ray.direction)/S(t.ray.direction)))/i,1),s=-J(this._startPlane.plane,t.renderEnd),n=-J(this._startPlane.plane,e.startPoint);return e.depth=e.depth*(1-a)+s*a-n,t}}_shiftDragUpdatePlane(e){return()=>{if(this.analysisViewData.plane==null)return;const t=Q(c.get(),this._startPlane.origin),i=Q(c.get(),F(this._startPlane));O(i,i,-e.depth),X(i,i,t);const a=Z(i,this.analysisViewData.plane.basis1,this.analysisViewData.plane.basis2,d());this._updateBoundedPlane(a)}}_onRotateHeadingGrab(e){if(e.action!=="start"||this.analysisViewData.plane==null||!e.screenPoint)return;const t=ae(this.analysisViewData.plane,this.view.renderCoordsHelper,1,U()),i=D(this.view.state.camera,e.screenPoint,M),a=K();k(t,i,a)&&(u(this.analysisViewData.plane,this._startPlane),this.inputState={type:"rotate",rotatePlane:t,startPoint:a})}_createRotateHeadingDragPipeline(e){return E(e,(t,i,a)=>{const s=this.inputState;if(s==null||s.type!=="rotate")return;const n=this.analysisViewData.plane!=null?u(this.analysisViewData.plane,d()):null;i.next(T(this.view,s.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(s)).next(this._rotateDragUpdatePlaneFromRotate()),a.next(()=>{n!=null&&this._updateBoundedPlane(n)})})}_onRotateTiltGrab(e){if(e.action!=="start"||this.analysisViewData.plane==null||!e.screenPoint)return;const t=ae(this.analysisViewData.plane,this.view.renderCoordsHelper,2,U()),i=D(this.view.state.camera,e.screenPoint,M),a=K();k(t,i,a)&&(u(this.analysisViewData.plane,this._startPlane),this.inputState={type:"rotate",rotatePlane:t,startPoint:a})}_createRotateTiltDragPipeline(e){return E(e,(t,i,a)=>{const s=this.inputState;if(s==null||s.type!=="rotate")return;const n=this.analysisViewData.plane!=null?u(this.analysisViewData.plane,d()):null;i.next(T(this.view,s.rotatePlane)).next(this._rotateDragRenderPlaneToRotate(s)).next(this._rotateDragUpdatePlaneFromRotate()),a.next(()=>{n!=null&&this._updateBoundedPlane(n)})})}_rotateDragRenderPlaneToRotate(e){return t=>{if(this.analysisViewData.plane==null)return null;const i=R(e.rotatePlane),a=Je(e.startPoint,t.renderEnd,this.analysisViewData.plane.origin,i);return{...t,rotateAxis:i,rotateAngle:a}}}_rotateDragUpdatePlaneFromRotate(){return e=>{if(this.analysisViewData.plane==null)return;const t=Te(f.get(),e.rotateAngle,e.rotateAxis);if(t==null)return;const i=Y(c.get(),this._startPlane.basis1,t),a=Y(c.get(),this._startPlane.basis2,t),s=Z(this.analysisViewData.plane.origin,i,a,d());this._updateBoundedPlane(s)}}_onResizeGrab(e,t){if(e.action!=="start"||this.analysisViewData.plane==null||!e.screenPoint)return;const i=D(this.view.state.camera,e.screenPoint,M),a=c.get();k(this.analysisViewData.plane.plane,i,a)&&(u(this.analysisViewData.plane,this._startPlane),this.inputState={type:"resize",activeHandleIdx:t,startPoint:Ee(a)})}_createResizeDragPipeline(e){return E(e,(t,i,a)=>{const s=this.inputState;if(s==null||s.type!=="resize"||this.analysisViewData.plane==null)return;const n=u(this.analysisViewData.plane,d());i.next(T(this.view,this.analysisViewData.plane.plane)).next(this._resizeDragUpdatePlane(s)),a.next(()=>{this._updateBoundedPlane(n)})})}_resizeDragUpdatePlane(e){return t=>{if(this.analysisViewData.plane==null)return;const i=this._resizeHandles[e.activeHandleIdx],a=Ie(i,e.startPoint,t.renderEnd,this.view.state.camera,this._startPlane,u(this.analysisViewData.plane));this._updateBoundedPlane(a)}}_updateBoundedPlane(e){const t=this.analysisViewData;if(t==null)throw new Error("valid internal object expected");t.plane=e}_updatePreviewPlane(e,t={}){if(this.mode==="exclude")return;let i=this._previewPlane;if(this._previewPlane=null,e==null)return this._removeFrameTask(),void this._updateManipulators();if(this.active){const a=i??d();if(i=i!=null?u(i,vt):null,this._pickPlane(e,!0,t,a)){const s=tt;let n=!1;i!=null&&(n=C(R(i.plane),R(a.plane))<s||C(ee(c.get(),i.basis1),ee(c.get(),a.basis1))<s),n&&(this._previewPlaneOpacity=0),this._previewPlane=a}}this._previewPlane!=null&&this._frameTask==null&&this._previewPlaneOpacity===0?this._frameTask=$e({update:({deltaTime:a})=>{this._previewPlaneOpacity=Math.min(this._previewPlaneOpacity+a/(1e3*et),1),this._updateManipulators(),this._previewPlaneOpacity===1&&this._removeFrameTask()}}):this._previewPlane==null&&this._frameTask!=null?this._removeFrameTask():this._previewPlane!=null&&this._updateManipulators()}_removeFrameTask(){this._frameTask=te(this._frameTask)}_pickMinResult(e){const t=xe(e,ke.get());return this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(t,this._intersector),this._intersector.results.min}_pickPlane(e,t,i,a){const s=this._pickMinResult(e),n=c.get();if(!s.getIntersectionPoint(n))return!1;const h=s.getTransformedNormal(c.get()),_=this.view.state.camera;C(h,_.viewForward)>0&&O(h,h,-1);const V=Ae(n,_),ge=(t?1:-1)*V*it,z=O(c.get(),h,ge);X(z,z,n);const Pe=this.analysis.tiltEnabled?3:0,me=i[I]?2:i[A]?1:Pe;return Be(z,h,V,V,_,me,this.view.renderCoordsHelper,a),!0}_clearPointerMoveTimeout(){this._prevPointerMoveTimeout=te(this._prevPointerMoveTimeout)}_resetPointerMoveTimeout(){this._clearPointerMoveTimeout(),this.shiftManipulator.state|=P,this.rotateHeadingManipulator.state|=P,this.rotateTiltManipulator.state|=P,this._prevPointerMoveTimeout=this._clock.setTimeout(()=>{this.shiftManipulator.state&=~P,this.rotateHeadingManipulator.state&=~P,this.rotateTiltManipulator.state&=~P},this._pointerMoveTimerMs)}_updateManipulators(){if(q.disableEngineLayers)return;let e,t,i=!1;if(this.analysisViewData.plane!=null)e=this.analysisViewData.plane,t=this._previewPlane??e,i=!1;else{if(this._previewPlane==null)return this._setManipulatorVisibility(!1),void this._setPreviewPlaneVisibility(!1);t=e=this._previewPlane,i=!0}if(this._setManipulatorVisibility(!i),!i){const a=j(e,f.get());Fe(this.shiftManipulator,a,e,this.view.state.camera),Ue(this.rotateHeadingManipulator,a,e,this.view.renderCoordsHelper),Ke(this.rotateTiltManipulator,a,e),this.resizeManipulators.forEach((s,n)=>je(s,this._resizeHandles[n],a,e))}this._setPreviewPlaneVisibility(!this._creatingPointerId&&(i||this._mode==="place")),this._updatePreviewPlaneTransform(t),this._updateMaterials()}_setManipulatorVisibility(e){this.shiftManipulator.available=e,this.rotateHeadingManipulator.available=e,this.rotateTiltManipulator.available=e&&this.analysis.tiltEnabled,this.resizeManipulators.forEach(t=>t.available=e)}_updatePreviewPlaneTransform(e){const t=j(e,f.get()),i=oe(c.get(),S(e.basis1),S(e.basis2),1),a=he(f.get(),i),s=ue(a,t,a);this._previewPlaneOutlineVisualElement.transform=s,this._previewPlaneGridVisualElement.transform=s}_setPreviewPlaneVisibility(e){const t=this._previewPlaneOutlineVisualElement,i=this._previewPlaneGridVisualElement;e&&(t.attached=!0,i.attached=!0),t.visible=e,i.visible=e}_updateMaterials(){const e=_e(this.view.effectiveTheme);e[3]*=this._previewPlaneOpacity;const t=Le(ve);t[3]*=this._previewPlaneOpacity,this._previewPlaneOutlineVisualElement.color=e,this._previewPlaneGridVisualElement.backgroundColor=t,this._previewPlaneGridVisualElement.gridColor=pe}_updateManipulatorsInteractive(e){if(!e.grabbing)return this.shiftManipulator.interactive=!0,this.rotateHeadingManipulator.interactive=!0,this.rotateTiltManipulator.interactive=!0,void this.resizeManipulators.forEach(t=>{t.interactive=!0});this.shiftManipulator.interactive=this.shiftManipulator===e,this.rotateHeadingManipulator.interactive=this.rotateHeadingManipulator===e,this.rotateTiltManipulator.interactive=this.rotateTiltManipulator===e,this.resizeManipulators.forEach(t=>{t.interactive=t===e})}_finishToolCreationIfValid(){this.analysis.valid&&this.finishToolCreation()}get test(){return{plane:this.analysisViewData.plane,setPointerMoveTimerMs:e=>{this._pointerMoveTimerMs=e}}}};function ne(e,t,i,a){const s=qe(i,F(a),e.direction,U()),n=K();return k(s,e,n)?{type:"shift",creatingPointerId:t,hasBeenDragged:!1,shiftPlane:s,depth:0,startPoint:n}:null}function le(e){return e.pointerType!=="mouse"||e.button===0}l([r()],o.prototype,"_clock",void 0),l([r({constructOnly:!0})],o.prototype,"view",void 0),l([r()],o.prototype,"analysisViewData",void 0),l([r({readOnly:!0})],o.prototype,"state",null),l([r({readOnly:!0})],o.prototype,"cursor",null),l([r()],o.prototype,"analysis",null),l([r()],o.prototype,"removeIncompleteOnCancel",void 0),l([r()],o.prototype,"_mode",void 0),l([r()],o.prototype,"mode",null),l([r({value:null})],o.prototype,"inputState",null),l([r()],o.prototype,"_placingSlicePlane",null),l([r()],o.prototype,"_creatingPointerId",null),o=q=l([H("esri.views.3d.analysis.Slice.SliceTool")],o);const vt=d(),M=Se();let v=class extends re{constructor(e){super(e),this._gridVisualElement=null,this._outlineVisualElement=null,this.showGrid=!1,this.preview=!0}initialize(){const e=this.analysisViewData;if(e==null)throw new Error("expected internal object to be valid");this._gridVisualElement=de(this.view),this._outlineVisualElement=ye(this.view),this.addHandles([y(()=>{const t=e.plane!=null&&this.analysisViewData.visible,{active:i}=this.analysisViewData,{preview:a,showGrid:s,view:n}=this,{effectiveTheme:h}=n;return{visible:t,active:i,preview:a,showGrid:s,gridColor:Ne(h),outlineColor:_e(h)}},t=>this._updateMaterials(t),x),y(()=>e.plane,t=>this._updatePlane(t),x),ie(this._gridVisualElement),ie(this._outlineVisualElement),y(()=>this.analysis?.origin?.type!=="web-scene",t=>{this._gridVisualElement.isDecoration=t,this._outlineVisualElement.isDecoration=t},x)])}destroy(){this.set("view",null)}_updatePlane(e){if(e==null)return;this._gridVisualElement.attached=!0,this._outlineVisualElement.attached=!0;const t=oe(c.get(),S(e.basis1),S(e.basis2),1),i=he(f.get(),t),a=j(e,f.get()),s=ue(i,a,i);this._outlineVisualElement.transform=s,this._gridVisualElement.transform=s}_updateMaterials({visible:e,active:t,preview:i,showGrid:a,gridColor:s,outlineColor:n}){this._outlineVisualElement.color=n,this._outlineVisualElement.width=i?we:at,this._outlineVisualElement.stipplePattern=t?null:ut(5),this._gridVisualElement.backgroundColor=ve,this._gridVisualElement.gridColor=a?s:pe,this._gridVisualElement.visible=e,this._outlineVisualElement.visible=e}};l([r()],v.prototype,"view",void 0),l([r()],v.prototype,"analysis",void 0),l([r()],v.prototype,"analysisViewData",void 0),l([r()],v.prototype,"showGrid",void 0),l([r()],v.prototype,"preview",void 0),v=l([H("esri.views.3d.analysis.Slice.SliceVisualization")],v);let p=class extends He{constructor(e){super(e),this.type="slice-view-3d",this.analysis=null,this.tool=null,this.plane=null,this.active=!0,this.userOperation=null,this._analysisVisualization=null,this._analysisController=null}initialize(){this._analysisVisualization=new v({view:this.view,analysis:this.analysis,analysisViewData:this}),this._analysisController=new w({view:this.view,analysis:this.analysis,analysisViewData:this}),this.addHandles(nt(this,o))}destroy(){lt(this),this._analysisVisualization=L(this._analysisVisualization),this._analysisController=L(this._analysisController)}get visible(){return super.visible}set visible(e){super.visible=e}get interactive(){return super.interactive}set interactive(e){super.interactive=e}get editable(){return!this._analysisVisualization.preview}set editable(e){this._analysisVisualization.preview=!e}get showGrid(){return this._analysisVisualization?.showGrid??!1}set showGrid(e){this._analysisVisualization&&(this._analysisVisualization.showGrid=e)}get testData(){}place(e){return this.active=!0,rt(this,{placementOptions:e,onToolActivated:t=>t.start("place")})}async pickLayerToExclude(e){return this.active=!0,ot(this,{abortOptions:e,onToolActivated:t=>t.start("exclude")})}};l([r({readOnly:!0})],p.prototype,"type",void 0),l([r({constructOnly:!0,nonNullable:!0})],p.prototype,"analysis",void 0),l([r()],p.prototype,"tool",void 0),l([r()],p.prototype,"plane",void 0),l([r()],p.prototype,"active",void 0),l([r()],p.prototype,"editable",null),l([r()],p.prototype,"showGrid",null),l([r()],p.prototype,"userOperation",void 0),l([r()],p.prototype,"_analysisVisualization",void 0),l([r()],p.prototype,"_analysisController",void 0),p=l([H("esri.views.3d.analysis.SliceAnalysisView3D")],p);const Ft=p;export{Ft as default};
